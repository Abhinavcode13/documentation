<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3393px" preserveAspectRatio="none" style="width:1862px;height:3393px;" version="1.1" viewBox="0 0 1862 3393" width="1862px" zoomAndPan="magnify"><defs><filter height="300%" id="f1dhjlgyl949y3" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="267" x="798.5" y="22.9951">2.1.1. Fulfil Handler Consume (Success)</text><rect fill="#FFFFE0" height="3347.8906" style="stroke: #A80036; stroke-width: 1.0;" width="1699.5" x="29" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="829.75" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="74" y="195.125"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="3181.1641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="344" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="908" y="3081.8828"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1174" y="3179.9531"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="150.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="677.25"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="967.7109"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="1536.5156"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="1740.3125"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="150.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="2067.9063"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="136.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="2301.1016"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="2537.1641"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="92.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="706.3828"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="996.8438"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="1565.6484"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="1769.4453"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="2097.0391"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="2330.2344"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="2566.2969"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="3167.1641" style="stroke: #000000; stroke-width: 2.0;" width="1838" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="3136.0313" style="stroke: #000000; stroke-width: 2.0;" width="1818" x="23" y="156.8594"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="105.5313" style="stroke: #000000; stroke-width: 2.0;" width="458" x="264" y="240.125"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="74.3984" style="stroke: #000000; stroke-width: 2.0;" width="438" x="274" y="264.2578"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="91.5313" style="stroke: #000000; stroke-width: 2.0;" width="837.5" x="274" y="359.6563"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="102.5313" style="stroke: #000000; stroke-width: 2.0;" width="982.5" x="274" y="465.1875"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="1091.1953" style="stroke: #000000; stroke-width: 2.0;" width="1587" x="244" y="581.7188"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="780.7344" style="stroke: #000000; stroke-width: 2.0;" width="1545" x="254" y="885.1797"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="360.0703" style="stroke: #000000; stroke-width: 2.0;" width="1002.5" x="264" y="1118.375"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="243" x="274" y="1142.5078"/><rect fill="#FFFFFF" height="106.3359" style="stroke: none; stroke-width: 1.0;" width="1002.5" x="264" y="1208.7734"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="77.5313" style="stroke: #000000; stroke-width: 2.0;" width="982.5" x="274" y="1230.5781"/><rect fill="#FFFFFF" height="88.0703" style="stroke: none; stroke-width: 1.0;" width="1002.5" x="264" y="1315.1094"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="219" x="274" y="1336.9141"/><rect fill="#FFFFFF" height="75.2656" style="stroke: none; stroke-width: 1.0;" width="1002.5" x="264" y="1403.1797"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="323" x="274" y="1412.1797"/><rect fill="#FFFFFF" height="180.4688" style="stroke: none; stroke-width: 1.0;" width="1545" x="254" y="1485.4453"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="1545.0391" style="stroke: #000000; stroke-width: 2.0;" width="1528" x="254" y="1686.9141"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="243.3281" style="stroke: #000000; stroke-width: 2.0;" width="1503" x="264" y="1990.375"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="212.1953" style="stroke: #000000; stroke-width: 2.0;" width="1483" x="274" y="2014.5078"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="197.9297" style="stroke: #000000; stroke-width: 2.0;" width="1480" x="274" y="2247.7031"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="765.3203" style="stroke: #000000; stroke-width: 2.0;" width="1508" x="264" y="2459.6328"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="182.7969" style="stroke: #000000; stroke-width: 2.0;" width="1488" x="274" y="2483.7656"/><rect fill="#FFFFFF" height="105.0703" style="stroke: none; stroke-width: 1.0;" width="1508" x="264" y="3119.8828"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="76.2656" style="stroke: #000000; stroke-width: 2.0;" width="982.5" x="274" y="3141.6875"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="1818" x="23" y="3238.9531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="79" x2="79" y1="115.7266" y2="3316.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="349" x2="349" y1="115.7266" y2="3316.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="912.5" x2="912.5" y1="115.7266" y2="3316.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1053.5" x2="1053.5" y1="115.7266" y2="3316.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1178.5" x2="1178.5" y1="115.7266" y2="3316.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1302.5" x2="1302.5" y1="115.7266" y2="3316.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1680.5" x2="1680.5" y1="115.7266" y2="3316.8906"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="37" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="33" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="40" y="100.4248">Fulfil-Topic</text><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="37" y="3315.8906"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="33" y="3319.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="40" y="3339.8857">Fulfil-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="124" x="284" y="112.4248">Fulfil Event Handler</text><ellipse cx="349" cy="83.4297" fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="345,71.4297,351,66.4297,349,71.4297,351,76.4297,345,71.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="124" x="284" y="3328.8857">Fulfil Event Handler</text><ellipse cx="349" cy="3348.1875" fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="345,3336.1875,351,3331.1875,349,3336.1875,351,3341.1875,345,3336.1875" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="834.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="830.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="143" x="837.5" y="100.4248">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="834.5" y="3315.8906"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="830.5" y="3319.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="143" x="837.5" y="3339.8857">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="88" x="1009.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="88" x="1005.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="74" x="1012.5" y="100.4248">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="88" x="1009.5" y="3315.8906"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="88" x="1005.5" y="3319.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="74" x="1012.5" y="3339.8857">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1115.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1111.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="1118.5" y="100.4248">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1115.5" y="3315.8906"/><rect fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1111.5" y="3319.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="1118.5" y="3339.8857">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1256.5" y="112.4248">Position DAO</text><ellipse cx="1302.5" cy="83.4297" fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1290.5" x2="1314.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1256.5" y="3328.8857">Position DAO</text><ellipse cx="1302.5" cy="3348.1875" fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1290.5" x2="1314.5" y1="3362.1875" y2="3362.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1636.5" y="112.4248">Central Store</text><path d="M1662.5,63.4297 C1662.5,53.4297 1680.5,53.4297 1680.5,53.4297 C1680.5,53.4297 1698.5,53.4297 1698.5,63.4297 L1698.5,89.4297 C1698.5,99.4297 1680.5,99.4297 1680.5,99.4297 C1680.5,99.4297 1662.5,99.4297 1662.5,89.4297 L1662.5,63.4297 " fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1662.5,63.4297 C1662.5,73.4297 1680.5,73.4297 1680.5,73.4297 C1680.5,73.4297 1698.5,73.4297 1698.5,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1636.5" y="3328.8857">Central Store</text><path d="M1662.5,3342.1875 C1662.5,3332.1875 1680.5,3332.1875 1680.5,3332.1875 C1680.5,3332.1875 1698.5,3332.1875 1698.5,3342.1875 L1698.5,3368.1875 C1698.5,3378.1875 1680.5,3378.1875 1680.5,3378.1875 C1680.5,3378.1875 1662.5,3378.1875 1662.5,3368.1875 L1662.5,3342.1875 " fill="#FEFECE" filter="url(#f1dhjlgyl949y3)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1662.5,3342.1875 C1662.5,3352.1875 1680.5,3352.1875 1680.5,3352.1875 C1680.5,3352.1875 1698.5,3352.1875 1698.5,3342.1875 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="74" y="195.125"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="3181.1641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="344" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="908" y="3081.8828"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1174" y="3179.9531"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="150.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="677.25"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="967.7109"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="1536.5156"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="1740.3125"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="150.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="2067.9063"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="136.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="2301.1016"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1297.5" y="2537.1641"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="92.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="706.3828"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="996.8438"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="1565.6484"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="1769.4453"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="2097.0391"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="2330.2344"/><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1675.5" y="2566.2969"/><path d="M13,132.7266 L265,132.7266 L265,139.7266 L255,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3167.1641" style="stroke: #000000; stroke-width: 2.0;" width="1838" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="28" y="145.7935">Fulfil Handler Consume (Success)</text><path d="M23,156.8594 L86,156.8594 L86,163.8594 L76,173.8594 L23,173.8594 L23,156.8594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3136.0313" style="stroke: #000000; stroke-width: 2.0;" width="1818" x="23" y="156.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="38" y="169.9263">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="101" y="169.0698">[Consume Single Message]</text><polygon fill="#A80036" points="95,191.125,85,195.125,95,199.125,91,195.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="89" x2="343" y1="195.125" y2="195.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="101" y="190.0591">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="112" y="190.0591">Consume Fulfil event message for Payer</text><path d="M264,240.125 L347,240.125 L347,247.125 L337,257.125 L264,257.125 L264,240.125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="105.5313" style="stroke: #000000; stroke-width: 2.0;" width="458" x="264" y="240.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="279" y="253.1919">break</text><path d="M274,264.2578 L412,264.2578 L412,271.2578 L402,281.2578 L274,281.2578 L274,264.2578 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.3984" style="stroke: #000000; stroke-width: 2.0;" width="438" x="274" y="264.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93" x="289" y="277.3247">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="396" y1="317.6563" y2="317.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="396" y1="317.6563" y2="330.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="355" x2="396" y1="330.6563" y2="330.6563"/><polygon fill="#A80036" points="365,326.6563,355,330.6563,365,334.6563,361,330.6563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="361" y="305.0239">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="372" y="297.4575">Validate event - Rule: type == 'fulfil' &amp;&amp; action == 'commit'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="372" y="312.5903">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="452" y="312.5903">2001</text><path d="M274,359.6563 L484,359.6563 L484,366.6563 L474,376.6563 L274,376.6563 L274,359.6563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="91.5313" style="stroke: #000000; stroke-width: 2.0;" width="837.5" x="274" y="359.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="289" y="372.7231">Persist Event Information</text><polygon fill="#A80036" points="1041.5,393.9219,1051.5,397.9219,1041.5,401.9219,1045.5,397.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="1047.5" y1="397.9219" y2="397.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="361" y="392.856">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="372" y="392.856">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="40.2656" style="stroke: #000000; stroke-width: 2.0;" width="819.5" x="281" y="405.9219"/><polygon fill="#EEEEEE" points="281,405.9219,345,405.9219,345,412.9219,335,422.9219,281,422.9219,281,405.9219" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="294" y="419.9888">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="602.25" y="438.9888">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="27" x="751.25" y="438.9888">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="751.25" x2="778.25" y1="440.9888" y2="440.9888"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="778.25" y="438.9888">}</text><path d="M274,465.1875 L488,465.1875 L488,472.1875 L478,482.1875 L274,482.1875 L274,465.1875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="102.5313" style="stroke: #000000; stroke-width: 2.0;" width="982.5" x="274" y="465.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="289" y="478.2544">Validate FSPIOP-Signature</text><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="55.3984" style="stroke: #000000; stroke-width: 2.0;" width="964.5" x="281" y="507.3203"/><polygon fill="#EEEEEE" points="281,507.3203,345,507.3203,345,514.3203,335,524.3203,281,524.3203,281,507.3203" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="294" y="521.3872">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="529.75" y="540.3872">Validate message.content.headers.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="731.75" y="540.3872">FSPIOP-Signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="846.75" y="540.3872">{</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-signature-validation.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-signature-validation.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="141" x="851.75" y="540.3872">seq-signature-validation</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="851.75" x2="992.75" y1="542.3872" y2="542.3872"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="992.75" y="540.3872">}</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="529.75" y="555.52">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="609.75" y="555.52">3105/3106</text><path d="M244,581.7188 L575,581.7188 L575,588.7188 L565,598.7188 L244,598.7188 L244,581.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1091.1953" style="stroke: #000000; stroke-width: 2.0;" width="1587" x="244" y="581.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="286" x="259" y="594.7856">Validate Transfer Fulfilment Duplicate Check</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="396" y1="619.9844" y2="619.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="396" y1="619.9844" y2="632.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="355" x2="396" y1="632.9844" y2="632.9844"/><polygon fill="#A80036" points="365,628.9844,355,632.9844,365,636.9844,361,632.9844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="361" y="614.9185">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="372" y="614.9185">Generate transferFulfilmentId uuid</text><polygon fill="#A80036" points="1285.5,673.25,1295.5,677.25,1285.5,681.25,1289.5,677.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="1291.5" y1="677.25" y2="677.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="361" y="664.6177">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="341" x="372" y="657.0513">Request to retrieve transfer fulfilment hashes by transferId</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="372" y="672.1841">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="446" y="672.1841">2003</text><polygon fill="#A80036" points="1663.5,702.3828,1673.5,706.3828,1663.5,710.3828,1667.5,706.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1307.5" x2="1669.5" y1="706.3828" y2="706.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="1314.5" y="701.3169">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="1325.5" y="701.3169">Request Transfer fulfilment duplicate message hashes</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1549,719.3828,1811,719.3828,1821,745.3828,1811,772.3828,1549,772.3828,1539,745.3828,1549,719.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="1551" y="735.4497">SELET transferId, hash</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1551" y="750.5825">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="220" x="1589" y="750.5825">transferFulfilmentDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="1551" y="765.7153">WHERE transferId = request.params.id</text><polygon fill="#A80036" points="1318.5,794.9141,1308.5,798.9141,1318.5,802.9141,1314.5,798.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1312.5" x2="1679.5" y1="798.9141" y2="798.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="1324.5" y="793.8481">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1335.5" y="793.8481">Return existing hashes</text><polygon fill="#A80036" points="365,824.0469,355,828.0469,365,832.0469,361,828.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="359" x2="1301.5" y1="828.0469" y2="828.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="371" y="822.981">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="382" y="822.981">Return (list of) transfer fulfil messages hash(es)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="396" y1="857.1797" y2="857.1797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="396" y1="857.1797" y2="870.1797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="355" x2="396" y1="870.1797" y2="870.1797"/><polygon fill="#A80036" points="365,866.1797,355,870.1797,365,874.1797,361,870.1797" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="361" y="852.1138">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="529" x="372" y="852.1138">Loop the list of returned hashes and compare each entry with the calculated message hash</text><path d="M254,885.1797 L317,885.1797 L317,892.1797 L307,902.1797 L254,902.1797 L254,885.1797 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="780.7344" style="stroke: #000000; stroke-width: 2.0;" width="1545" x="254" y="885.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="269" y="898.2466">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="332" y="897.3901">[Hash matched]</text><polygon fill="#A80036" points="1041.5,919.4453,1051.5,923.4453,1041.5,927.4453,1045.5,923.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="1047.5" y1="923.4453" y2="923.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="918.3794">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="379" y="918.3794">Publish event information (for duplicate) ( Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="27" x="773" y="918.3794">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="773" x2="800" y1="920.3794" y2="920.3794"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="800" y="918.3794">} )</text><polygon fill="#A80036" points="1285.5,963.7109,1295.5,967.7109,1285.5,971.7109,1289.5,967.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="1291.5" y1="967.7109" y2="967.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="955.0786">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="379" y="947.5122">Request to retrieve Transfer Fulfilment and Transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="379" y="962.645">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="453" y="962.645">2003</text><polygon fill="#A80036" points="1663.5,992.8438,1673.5,996.8438,1663.5,1000.8438,1667.5,996.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1307.5" x2="1669.5" y1="996.8438" y2="996.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1314.5" y="991.7778">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="1332.5" y="991.7778">Request to retrieve Transfer Fulfilment and Transfer state</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1618,1009.8438,1742,1009.8438,1752,1028.8438,1742,1047.8438,1618,1047.8438,1608,1028.8438,1618,1009.8438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="1620" y="1025.9106">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1620" y="1041.0435">transferStateChange</text><polygon fill="#A80036" points="1318.5,1070.2422,1308.5,1074.2422,1318.5,1078.2422,1314.5,1074.2422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1312.5" x2="1679.5" y1="1074.2422" y2="1074.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1324.5" y="1069.1763">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="1342.5" y="1069.1763">Return Transfer Fulfilment and Transfer state</text><polygon fill="#A80036" points="365,1099.375,355,1103.375,365,1107.375,361,1103.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="359" x2="1301.5" y1="1103.375" y2="1103.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="371" y="1098.3091">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="389" y="1098.3091">Return Transfer Fulfilment and Transfer state</text><path d="M264,1118.375 L327,1118.375 L327,1125.375 L317,1135.375 L264,1135.375 L264,1118.375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="360.0703" style="stroke: #000000; stroke-width: 2.0;" width="1002.5" x="264" y="1118.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="279" y="1131.4419">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="342" y="1130.5854">[transferFulfilment.isValid == 0]</text><path d="M274,1142.5078 L357,1142.5078 L357,1149.5078 L347,1159.5078 L274,1159.5078 L274,1142.5078 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="243" x="274" y="1142.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="289" y="1155.5747">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="396" y1="1180.7734" y2="1180.7734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="396" y1="1180.7734" y2="1193.7734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="355" x2="396" y1="1193.7734" y2="1193.7734"/><polygon fill="#A80036" points="365,1189.7734,355,1193.7734,365,1197.7734,361,1193.7734" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="1175.7075">15</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="379" y="1175.7075">Error handling:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="477" y="1175.7075">3106</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="264" x2="1266.5" y1="1209.7734" y2="1209.7734"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="241" x="269" y="1219.9839">[transferState IN ['COMMITTED', 'ABORTED']]</text><path d="M274,1230.5781 L357,1230.5781 L357,1237.5781 L347,1247.5781 L274,1247.5781 L274,1230.5781 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="77.5313" style="stroke: #000000; stroke-width: 2.0;" width="982.5" x="274" y="1230.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="289" y="1243.645">break</text><rect fill="#FFFFFF" filter="url(#f1dhjlgyl949y3)" height="55.3984" style="stroke: #000000; stroke-width: 2.0;" width="964.5" x="281" y="1247.7109"/><polygon fill="#EEEEEE" points="281,1247.7109,345,1247.7109,345,1254.7109,335,1264.7109,281,1264.7109,281,1247.7109" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="294" y="1261.7778">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="626.75" y="1280.7778">Send notification to Participant (Payee) {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-prepare-1.1.4.a.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-prepare-1.1.4.a.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="37" x="858.75" y="1280.7778">1.1.4.a</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="858.75" x2="895.75" y1="1282.7778" y2="1282.7778"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="895.75" y="1280.7778">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="629.75" y="1295.9106"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="264" x2="1266.5" y1="1316.1094" y2="1316.1094"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="269" y="1326.3198">[transferState NOT 'RESERVED']</text><path d="M274,1336.9141 L357,1336.9141 L357,1343.9141 L347,1353.9141 L274,1353.9141 L274,1336.9141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="219" x="274" y="1336.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="289" y="1349.981">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="396" y1="1375.1797" y2="1375.1797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="396" y1="1375.1797" y2="1388.1797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="355" x2="396" y1="1388.1797" y2="1388.1797"/><polygon fill="#A80036" points="365,1384.1797,355,1388.1797,365,1392.1797,361,1388.1797" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="1370.1138">16</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="379" y="1370.1138">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="453" y="1370.1138">2001</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="264" x2="1266.5" y1="1404.1797" y2="1404.1797"/><path d="M274,1412.1797 L357,1412.1797 L357,1419.1797 L347,1429.1797 L274,1429.1797 L274,1412.1797 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="323" x="274" y="1412.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="289" y="1425.2466">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="396" y1="1450.4453" y2="1450.4453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="396" y1="1450.4453" y2="1463.4453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="355" x2="396" y1="1463.4453" y2="1463.4453"/><polygon fill="#A80036" points="365,1459.4453,355,1463.4453,365,1467.4453,361,1463.4453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="1445.3794">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="379" y="1445.3794">Allow previous request to complete</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="254" x2="1799" y1="1486.4453" y2="1486.4453"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="259" y="1496.6558">[Hash not matched]</text><polygon fill="#A80036" points="1285.5,1532.5156,1295.5,1536.5156,1285.5,1540.5156,1289.5,1536.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="1291.5" y1="1536.5156" y2="1536.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="1523.8833">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="379" y="1516.3169">Request to persist transfer hash</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="379" y="1531.4497">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="459" y="1531.4497">2003</text><polygon fill="#A80036" points="1663.5,1561.6484,1673.5,1565.6484,1663.5,1569.6484,1667.5,1565.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1307.5" x2="1669.5" y1="1565.6484" y2="1565.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1314.5" y="1560.5825">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="1332.5" y="1560.5825">Persist hash</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1582,1608.6484,1779,1608.6484,1789,1619.6484,1779,1631.6484,1582,1631.6484,1572,1619.6484,1582,1608.6484" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="1584" y="1624.7153">transferFulfilmentDuplicateCheck</text><polygon fill="#A80036" points="365,1653.9141,355,1657.9141,365,1661.9141,361,1657.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="359" x2="1301.5" y1="1657.9141" y2="1657.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="371" y="1652.8481">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="389" y="1652.8481">Return success</text><path d="M254,1686.9141 L552,1686.9141 L552,1693.9141 L542,1703.9141 L254,1703.9141 L254,1686.9141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1545.0391" style="stroke: #000000; stroke-width: 2.0;" width="1528" x="254" y="1686.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="253" x="269" y="1699.981">Validate and persist Transfer Fulfilment</text><polygon fill="#A80036" points="1285.5,1736.3125,1295.5,1740.3125,1285.5,1744.3125,1289.5,1740.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="1291.5" y1="1740.3125" y2="1740.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="1727.6802">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="379" y="1720.1138">Request information for the validate checks</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="379" y="1735.2466">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="453" y="1735.2466">2003</text><polygon fill="#A80036" points="1663.5,1765.4453,1673.5,1769.4453,1663.5,1773.4453,1667.5,1769.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1307.5" x2="1669.5" y1="1769.4453" y2="1769.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1314.5" y="1764.3794">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1332.5" y="1764.3794">Fetch from database</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1655,1782.4453,1705,1782.4453,1715,1793.4453,1705,1805.4453,1655,1805.4453,1645,1793.4453,1655,1782.4453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1657" y="1798.5122">transfer</text><polygon fill="#A80036" points="1318.5,1827.7109,1308.5,1831.7109,1318.5,1835.7109,1314.5,1831.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1312.5" x2="1679.5" y1="1831.7109" y2="1831.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1324.5" y="1826.645">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1345.5" y="1826.645"/><polygon fill="#A80036" points="365,1856.8438,355,1860.8438,365,1864.8438,361,1860.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="359" x2="1301.5" y1="1860.8438" y2="1860.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="371" y="1855.7778">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="389" y="1855.7778">Return transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="396" y1="1905.1094" y2="1905.1094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="396" y1="1905.1094" y2="1918.1094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="355" x2="396" y1="1918.1094" y2="1918.1094"/><polygon fill="#A80036" points="365,1914.1094,355,1918.1094,365,1922.1094,361,1918.1094" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="1892.4771">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="425" x="379" y="1884.9106">Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="379" y="1900.0435">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="453" y="1900.0435">2001</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="396" y1="1962.375" y2="1962.375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="396" y1="1962.375" y2="1975.375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="355" x2="396" y1="1975.375" y2="1975.375"/><polygon fill="#A80036" points="365,1971.375,355,1975.375,365,1979.375,361,1975.375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="1949.7427">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="379" y="1942.1763">Validate expirationDate</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="379" y="1957.3091">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="453" y="1957.3091">3303</text><path d="M264,1990.375 L331,1990.375 L331,1997.375 L321,2007.375 L264,2007.375 L264,1990.375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="243.3281" style="stroke: #000000; stroke-width: 2.0;" width="1503" x="264" y="1990.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="279" y="2003.4419">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="226" x="346" y="2002.5854">[Transfer.ilpCondition validate successful]</text><path d="M274,2014.5078 L552,2014.5078 L552,2021.5078 L542,2031.5078 L274,2031.5078 L274,2014.5078 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="212.1953" style="stroke: #000000; stroke-width: 2.0;" width="1483" x="274" y="2014.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="233" x="289" y="2027.5747">Request current Settlement Window</text><polygon fill="#A80036" points="1285.5,2063.9063,1295.5,2067.9063,1285.5,2071.9063,1289.5,2067.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="1291.5" y1="2067.9063" y2="2067.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="2055.2739">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="355" x="379" y="2047.7075">Request to retrieve current/latest transfer settlement window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="379" y="2062.8403">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="453" y="2062.8403">2003</text><polygon fill="#A80036" points="1663.5,2093.0391,1673.5,2097.0391,1663.5,2101.0391,1667.5,2097.0391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1307.5" x2="1669.5" y1="2097.0391" y2="2097.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1314.5" y="2091.9731">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="1332.5" y="2091.9731">Fetch settlementWindowId</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1624,2110.0391,1737,2110.0391,1747,2121.0391,1737,2133.0391,1624,2133.0391,1614,2121.0391,1624,2110.0391" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="1626" y="2126.106">settlementWindow</text><polygon fill="#A80036" points="1318.5,2155.3047,1308.5,2159.3047,1318.5,2163.3047,1314.5,2159.3047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1312.5" x2="1679.5" y1="2159.3047" y2="2159.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1324.5" y="2154.2388">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1345.5" y="2154.2388"/><polygon fill="#A80036" points="365,2214.7031,355,2218.7031,365,2222.7031,361,2218.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="359" x2="1301.5" y1="2218.7031" y2="2218.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="371" y="2198.5044">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="446" x="389" y="2183.3716">Return settlementWindowId to be appended during transferFulfilment insert</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="35" x="389" y="2198.5044">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="424" y="2198.5044">: During settlement design make sure transfers in 'RECEIVED-FULFIL'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="389" y="2213.6372">state are updated to the next settlement window</text><path d="M274,2247.7031 L430,2247.7031 L430,2254.7031 L420,2264.7031 L274,2264.7031 L274,2247.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="197.9297" style="stroke: #000000; stroke-width: 2.0;" width="1480" x="274" y="2247.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="289" y="2260.77">Persist fulfilment</text><polygon fill="#A80036" points="1285.5,2297.1016,1295.5,2301.1016,1285.5,2305.1016,1289.5,2301.1016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="1291.5" y1="2301.1016" y2="2301.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="2288.4692">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="379" y="2280.9028">Persist fulfilment with the result of the above check (transferFulfilment.isValid)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="379" y="2296.0356">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="453" y="2296.0356">2003</text><polygon fill="#A80036" points="1663.5,2326.2344,1673.5,2330.2344,1663.5,2334.2344,1667.5,2330.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1307.5" x2="1669.5" y1="2330.2344" y2="2330.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1314.5" y="2325.1685">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1332.5" y="2325.1685">Persist to database</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1626,2373.2344,1734,2373.2344,1744,2392.2344,1734,2411.2344,1626,2411.2344,1616,2392.2344,1626,2373.2344" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="1628" y="2389.3013">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="1628" y="2404.4341">transferExtension</text><polygon fill="#A80036" points="365,2433.6328,355,2437.6328,365,2441.6328,361,2437.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="359" x2="1301.5" y1="2437.6328" y2="2437.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="371" y="2432.5669">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="389" y="2432.5669">Return success</text><path d="M264,2459.6328 L327,2459.6328 L327,2466.6328 L317,2476.6328 L264,2476.6328 L264,2459.6328 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="765.3203" style="stroke: #000000; stroke-width: 2.0;" width="1508" x="264" y="2459.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="279" y="2472.6997">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="226" x="342" y="2471.8433">[Transfer.ilpCondition validate successful]</text><path d="M274,2483.7656 L709,2483.7656 L709,2490.7656 L699,2500.7656 L274,2500.7656 L274,2483.7656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="182.7969" style="stroke: #000000; stroke-width: 2.0;" width="1488" x="274" y="2483.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="390" x="289" y="2496.8325">Persist Transfer State (with transferState='RECEIVED-FULFIL')</text><polygon fill="#A80036" points="1285.5,2533.1641,1295.5,2537.1641,1285.5,2541.1641,1289.5,2537.1641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="1291.5" y1="2537.1641" y2="2537.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="2524.5317">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="379" y="2516.9653">Request to persist transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="379" y="2532.0981">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="453" y="2532.0981">2003</text><polygon fill="#A80036" points="1663.5,2562.2969,1673.5,2566.2969,1663.5,2570.2969,1667.5,2566.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1307.5" x2="1669.5" y1="2566.2969" y2="2566.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1314.5" y="2561.231">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="1332.5" y="2561.231">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f1dhjlgyl949y3)" points="1618,2609.2969,1742,2609.2969,1752,2620.2969,1742,2632.2969,1618,2632.2969,1608,2620.2969,1618,2609.2969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1620" y="2625.3638">transferStateChange</text><polygon fill="#A80036" points="365,2654.5625,355,2658.5625,365,2662.5625,361,2658.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="359" x2="1301.5" y1="2658.5625" y2="2658.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="371" y="2653.4966">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="389" y="2653.4966">Return success</text><path d="M359,2678.5625 L359,3051.5625 L638,3051.5625 L638,2688.5625 L628,2678.5625 L359,2678.5625 " fill="#FFFF00" filter="url(#f1dhjlgyl949y3)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M628,2678.5625 L628,2688.5625 L638,2688.5625 L628,2678.5625 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="365" y="2695.6294">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="365" y="2710.7622">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="377" y="2725.895">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="377" y="2741.0278">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="377" y="2756.1606">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="377" y="2771.2935">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="377" y="2786.4263">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="389" y="2801.5591">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="389" y="2816.6919">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="377" y="2831.8247">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="377" y="2846.9575">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="389" y="2862.0903">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="401" y="2877.2231">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="401" y="2892.356">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="401" y="2907.4888">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="401" y="2922.6216">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="401" y="2937.7544">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="401" y="2952.8872">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="413" y="2968.02">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="413" y="2983.1528">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="401" y="2998.2856">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="389" y="3013.4185">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="377" y="3028.5513">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="365" y="3043.6841">}</text><polygon fill="#A80036" points="896,3077.8828,906,3081.8828,896,3085.8828,900,3081.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="902" y1="3081.8828" y2="3081.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="3076.8169">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="379" y="3076.8169">Route &amp; Publish Position event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="264" x2="1772" y1="3120.8828" y2="3120.8828"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="209" x="269" y="3131.0933">[Validate Fulfil Transfer not successful]</text><path d="M274,3141.6875 L357,3141.6875 L357,3148.6875 L347,3158.6875 L274,3158.6875 L274,3141.6875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.2656" style="stroke: #000000; stroke-width: 2.0;" width="982.5" x="274" y="3141.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="289" y="3154.7544">break</text><polygon fill="#A80036" points="1162,3175.9531,1172,3179.9531,1162,3183.9531,1166,3179.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="354" x2="1168" y1="3179.9531" y2="3179.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="361" y="3174.8872">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="379" y="3174.8872">Route &amp; Publish Notification event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1841" y1="3239.9531" y2="3239.9531"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143" x="28" y="3250.1636">[Consume Batch Messages]</text><path d="M136,3258.7578 L136,3283.7578 L335,3283.7578 L335,3268.7578 L325,3258.7578 L136,3258.7578 " fill="#ADD8E6" filter="url(#f1dhjlgyl949y3)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M325,3258.7578 L325,3268.7578 L335,3268.7578 L325,3258.7578 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="142" y="3275.8247">To be delivered by future story</text><!--
@startuml
title 2.1.1. Fulfil Handler Consume (Success)
autonumber
collections "Fulfil-Topic" as TOPIC_FULFIL
control "Fulfil Event Handler" as FULF_HANDLER
collections "Event-Topic" as TOPIC_EVENT
collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
database "Central Store" as DB
box "Central Service" #LightYellow
    participant TOPIC_FULFIL
    participant FULF_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENT
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box
activate FULF_HANDLER
group Fulfil Handler Consume (Success)
    alt Consume Single Message
        TOPIC_FULFIL <- FULF_HANDLER: Consume Fulfil event message for Payer
        activate TOPIC_FULFIL
        deactivate TOPIC_FULFIL
        break
            group Validate Event
                FULF_HANDLER <-> FULF_HANDLER: Validate event - Rule: type == 'fulfil' && action == 'commit'\n<color #FF0000><b>Error codes:</b> 2001</color>
            end
        end
        group Persist Event Information
            FULF_HANDLER -> TOPIC_EVENT: Publish event information
            ref over FULF_HANDLER, TOPIC_EVENT:  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg 9.1.0]]}
        end
        group Validate FSPIOP-Signature
            |||
            ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: Validate message.content.headers.**FSPIOP-Signature** {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-signature-validation.svg seq-signature-validation]]} \n<color #FF0000><b>Error codes:</b> 3105/3106</color>
        end
        group Validate Transfer Fulfilment Duplicate Check
            FULF_HANDLER -> FULF_HANDLER: Generate transferFulfilmentId uuid
            FULF_HANDLER -> POS_DAO: Request to retrieve transfer fulfilment hashes by transferId\n<color #FF0000><b>Error code:</b> 2003</color>
            activate POS_DAO
            POS_DAO -> DB: Request Transfer fulfilment duplicate message hashes
            hnote over DB #lightyellow
                SELET transferId, hash
                FROM **transferFulfilmentDuplicateCheck**
                WHERE transferId = request.params.id
            end note
            activate DB
            POS_DAO <- - DB: Return existing hashes
            deactivate DB
            POS_DAO - -> FULF_HANDLER: Return (list of) transfer fulfil messages hash(es)
            deactivate POS_DAO
            FULF_HANDLER -> FULF_HANDLER: Loop the list of returned hashes and compare each entry with the calculated message hash
            alt Hash matched
                FULF_HANDLER -> TOPIC_EVENT: Publish event information (for duplicate) ( Event Handler Consume {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg 9.1.0]]} )
                FULF_HANDLER -> POS_DAO: Request to retrieve Transfer Fulfilment and Transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Request to retrieve Transfer Fulfilment and Transfer state
                hnote over DB #lightyellow
                    transferFulfilment
                    transferStateChange
                end note
                activate DB
                POS_DAO <- - DB: Return Transfer Fulfilment and Transfer state
                deactivate DB
                POS_DAO - -> FULF_HANDLER: Return Transfer Fulfilment and Transfer state
                deactivate POS_DAO
                alt transferFulfilment.isValid == 0
                    break
                        FULF_HANDLER <-> FULF_HANDLER: <color #FF0000><b>Error handling:</b> 3106</color>
                    end
                else transferState IN ['COMMITTED', 'ABORTED']
                    break
                        ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: Send notification to Participant (Payee) {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-prepare-1.1.4.a.svg 1.1.4.a]]} \n
                    end
                else transferState NOT 'RESERVED'
                    break
                        FULF_HANDLER <-> FULF_HANDLER: <color #FF0000><b>Error code:</b> 2001</color>
                    end
                else
                    break
                        FULF_HANDLER <-> FULF_HANDLER: Allow previous request to complete
                    end
                end
            else Hash not matched
                FULF_HANDLER -> POS_DAO: Request to persist transfer hash\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist hash
                hnote over DB #lightyellow
                    transferFulfilmentDuplicateCheck
                end note
                activate DB
                deactivate DB
                POS_DAO - -> FULF_HANDLER: Return success
                deactivate POS_DAO
            end
        end
        group Validate and persist Transfer Fulfilment
            FULF_HANDLER -> POS_DAO: Request information for the validate checks\n<color #FF0000><b>Error code:</b> 2003</color>
            activate POS_DAO
            POS_DAO -> DB: Fetch from database
            activate DB
            hnote over DB #lightyellow
                transfer
            end note
            DB - -> POS_DAO
            deactivate DB
            FULF_HANDLER <- - POS_DAO: Return transfer
            deactivate POS_DAO
            FULF_HANDLER ->FULF_HANDLER: Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)\n<color #FF0000><b>Error code:</b> 2001</color>
            FULF_HANDLER -> FULF_HANDLER: Validate expirationDate\n<color #FF0000><b>Error code:</b> 3303</color>

            opt Transfer.ilpCondition validate successful
                group Request current Settlement Window
                    FULF_HANDLER -> POS_DAO: Request to retrieve current/latest transfer settlement window\n<color #FF0000><b>Error code:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Fetch settlementWindowId
                    activate DB
                    hnote over DB #lightyellow
                        settlementWindow
                    end note
                    DB - -> POS_DAO
                    deactivate DB
                    FULF_HANDLER <- - POS_DAO: Return settlementWindowId to be appended during transferFulfilment insert\n**TODO**: During settlement design make sure transfers in 'RECEIVED-FULFIL'\nstate are updated to the next settlement window
                    deactivate POS_DAO
                end
            end

            group Persist fulfilment
                FULF_HANDLER -> POS_DAO: Persist fulfilment with the result of the above check (transferFulfilment.isValid)\n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist to database
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    transferFulfilment
                    transferExtension
                end note
                FULF_HANDLER <- - POS_DAO: Return success
                deactivate POS_DAO
            end

            alt Transfer.ilpCondition validate successful
                group Persist Transfer State (with transferState='RECEIVED-FULFIL')
                    FULF_HANDLER -> POS_DAO: Request to persist transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Persist transfer state
                    activate DB
                    hnote over DB #lightyellow
                        transferStateChange
                    end note
                    deactivate DB
                    POS_DAO - -> FULF_HANDLER: Return success
                    deactivate POS_DAO
                end

                note right of FULF_HANDLER #yellow
                    Message:
                    {
                        id: <ID>,
                        from: <transferHeaders.FSPIOP-Source>,
                        to: <transferHeaders.FSPIOP-Destination>,
                        type: application/json,
                        content: {
                            headers: <transferHeaders>,
                            payload: <transferMessage>
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                responseTo: <previous.uuid>,
                                type: position,
                                action: commit,
                                createdAt: <timestamp>,
                                state: {
                                    status: "success",
                                    code: 0
                                }
                            }
                        }
                    }
                end note
                FULF_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payee
                activate TOPIC_TRANSFER_POSITION
                deactivate TOPIC_TRANSFER_POSITION
            else Validate Fulfil Transfer not successful
                break
                    FULF_HANDLER -> TOPIC_NOTIFICATIONS: Route & Publish Notification event for Payee
                    activate TOPIC_NOTIFICATIONS
                    deactivate TOPIC_NOTIFICATIONS
                end
            end
        end
    else Consume Batch Messages
        note left of FULF_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate FULF_HANDLER
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
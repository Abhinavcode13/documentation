<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1911px" preserveAspectRatio="none" style="width:1284px;height:1911px;" version="1.1" viewBox="0 0 1284 1911" width="1284px" zoomAndPan="magnify"><defs><filter height="300%" id="f15pbs70dxkkrt" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="402" x="442" y="22.9951">6.1.2. Close Settlement Window (closeSettlementWindow)</text><rect fill="#FFB6C1" height="1865.8906" style="stroke: #A80036; stroke-width: 1.0;" width="107" x="49" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="64" y="46.3638">Central HUB</text><rect fill="#90EE90" height="1865.8906" style="stroke: #A80036; stroke-width: 1.0;" width="432" x="269" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="123" x="423.5" y="46.3638">Settlement Service</text><rect fill="#FFFFE0" height="1865.8906" style="stroke: #A80036; stroke-width: 1.0;" width="110" x="933.5" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="104" x="936.5" y="46.3638">Central Services</text><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="1635.1641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="146.7266"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="1505.3672" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="344.5" y="276.5234"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="197.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="636.5" y="537.9844"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="634.3203" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="636.5" y="803.4453"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="983.5" y="567.1172"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="983.5" y="1110.0391"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="92.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="983.5" y="1216.5703"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="1643.1641" style="stroke: #000000; stroke-width: 2.0;" width="1261" x="12" y="153.7266"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="161.0625" style="stroke: #000000; stroke-width: 2.0;" width="635" x="43" y="333.6563"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="1039.8438" style="stroke: #000000; stroke-width: 2.0;" width="1241" x="22" y="750.0469"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="591.1875" style="stroke: #000000; stroke-width: 2.0;" width="677" x="576" y="818.4453"/><rect fill="#FFFFFF" height="185.0625" style="stroke: none; stroke-width: 1.0;" width="1241" x="22" y="1604.8281"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="102" x2="102" y1="136.7266" y2="1813.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="349" x2="349" y1="136.7266" y2="1813.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="641" x2="641" y1="136.7266" y2="1813.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="988.5" x2="988.5" y1="136.7266" y2="1813.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="53" y="133.4248">Hub Employee</text><ellipse cx="102.5" cy="63.4297" fill="#FEFECE" filter="url(#f15pbs70dxkkrt)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M102.5,71.4297 L102.5,98.4297 M89.5,79.4297 L115.5,79.4297 M102.5,98.4297 L89.5,113.4297 M102.5,98.4297 L115.5,113.4297 " fill="none" filter="url(#f15pbs70dxkkrt)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="53" y="1825.8857">Hub Employee</text><ellipse cx="102.5" cy="1839.1875" fill="#FEFECE" filter="url(#f15pbs70dxkkrt)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M102.5,1847.1875 L102.5,1874.1875 M89.5,1855.1875 L115.5,1855.1875 M102.5,1874.1875 L89.5,1889.1875 M102.5,1874.1875 L115.5,1889.1875 " fill="none" filter="url(#f15pbs70dxkkrt)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="273" y="133.4248">Settlement Service API</text><path d="M329,92.4297 L329,116.4297 M329,104.4297 L346,104.4297 " fill="none" filter="url(#f15pbs70dxkkrt)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="358" cy="104.4297" fill="#FEFECE" filter="url(#f15pbs70dxkkrt)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="273" y="1825.8857">Settlement Service API</text><path d="M329,1833.1875 L329,1857.1875 M329,1845.1875 L346,1845.1875 " fill="none" filter="url(#f15pbs70dxkkrt)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="358" cy="1845.1875" fill="#FEFECE" filter="url(#f15pbs70dxkkrt)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="586" y="133.4248">Settlement DAO</text><ellipse cx="641.5" cy="104.4297" fill="#FEFECE" filter="url(#f15pbs70dxkkrt)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="629.5" x2="653.5" y1="118.4297" y2="118.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="586" y="1825.8857">Settlement DAO</text><ellipse cx="641.5" cy="1845.1875" fill="#FEFECE" filter="url(#f15pbs70dxkkrt)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="629.5" x2="653.5" y1="1859.1875" y2="1859.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="944.5" y="133.4248">Central Store</text><path d="M970.5,84.4297 C970.5,74.4297 988.5,74.4297 988.5,74.4297 C988.5,74.4297 1006.5,74.4297 1006.5,84.4297 L1006.5,110.4297 C1006.5,120.4297 988.5,120.4297 988.5,120.4297 C988.5,120.4297 970.5,120.4297 970.5,110.4297 L970.5,84.4297 " fill="#FEFECE" filter="url(#f15pbs70dxkkrt)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M970.5,84.4297 C970.5,94.4297 988.5,94.4297 988.5,94.4297 C988.5,94.4297 1006.5,94.4297 1006.5,84.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="944.5" y="1825.8857">Central Store</text><path d="M970.5,1839.1875 C970.5,1829.1875 988.5,1829.1875 988.5,1829.1875 C988.5,1829.1875 1006.5,1829.1875 1006.5,1839.1875 L1006.5,1865.1875 C1006.5,1875.1875 988.5,1875.1875 988.5,1875.1875 C988.5,1875.1875 970.5,1875.1875 970.5,1865.1875 L970.5,1839.1875 " fill="#FEFECE" filter="url(#f15pbs70dxkkrt)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M970.5,1839.1875 C970.5,1849.1875 988.5,1849.1875 988.5,1849.1875 C988.5,1849.1875 1006.5,1849.1875 1006.5,1839.1875 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="1635.1641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="146.7266"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="1505.3672" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="344.5" y="276.5234"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="197.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="636.5" y="537.9844"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="634.3203" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="636.5" y="803.4453"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="983.5" y="567.1172"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="983.5" y="1110.0391"/><rect fill="#FFFFFF" filter="url(#f15pbs70dxkkrt)" height="92.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="983.5" y="1216.5703"/><path d="M12,153.7266 L220,153.7266 L220,160.7266 L210,170.7266 L12,170.7266 L12,153.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1643.1641" style="stroke: #000000; stroke-width: 2.0;" width="1261" x="12" y="153.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="163" x="27" y="166.7935">Close Settlement Window</text><path d="M112,175.8594 L112,245.8594 L249,245.8594 L249,185.8594 L239,175.8594 L112,175.8594 " fill="#FFFF00" filter="url(#f15pbs70dxkkrt)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M239,175.8594 L239,185.8594 L249,185.8594 L239,175.8594 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="118" y="192.9263">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="130" y="208.0591">"state": "CLOSED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="130" y="223.1919">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="118" y="238.3247">}</text><polygon fill="#A80036" points="332.5,272.5234,342.5,276.5234,332.5,280.5234,336.5,276.5234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="338.5" y1="276.5234" y2="276.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="114.5" y="271.4575">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="125.5" y="271.4575">POST - /settlementWindows/{id}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="354.5" x2="396.5" y1="305.6563" y2="305.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396.5" x2="396.5" y1="305.6563" y2="318.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="355.5" x2="396.5" y1="318.6563" y2="318.6563"/><polygon fill="#A80036" points="365.5,314.6563,355.5,318.6563,365.5,322.6563,361.5,318.6563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="361.5" y="300.5903">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="372.5" y="300.5903">Validate payload and requested state</text><path d="M43,333.6563 L126,333.6563 L126,340.6563 L116,350.6563 L43,350.6563 L43,333.6563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="161.0625" style="stroke: #000000; stroke-width: 2.0;" width="635" x="43" y="333.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="58" y="346.7231">break</text><path d="M359,355.7891 L359,455.7891 L664,455.7891 L664,365.7891 L654,355.7891 L359,355.7891 " fill="#FFFF00" filter="url(#f15pbs70dxkkrt)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M654,355.7891 L654,365.7891 L664,365.7891 L654,355.7891 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="365" y="372.856">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="377" y="387.9888">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="389" y="403.1216">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="389" y="418.2544">"errorDescription": "Invalid payload or state"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="377" y="433.3872">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="365" y="448.52">}</text><polygon fill="#A80036" points="118.5,482.7188,108.5,486.7188,118.5,490.7188,114.5,486.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="343.5" y1="486.7188" y2="486.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="124.5" y="481.6528">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="135.5" y="481.6528">Respond HTTP - 400 (Bad Request)</text><polygon fill="#A80036" points="624.5,533.9844,634.5,537.9844,624.5,541.9844,628.5,537.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="354.5" x2="630.5" y1="537.9844" y2="537.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="361.5" y="525.3521">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="372.5" y="517.7856">Get requested settlementWindow and state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="372.5" y="532.9185">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="446.5" y="532.9185">2001</text><polygon fill="#A80036" points="971.5,563.1172,981.5,567.1172,971.5,571.1172,975.5,567.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="646.5" x2="977.5" y1="567.1172" y2="567.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="653.5" y="562.0513">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="664.5" y="562.0513">Get settlementWindow state</text><polygon fill="#FFFFE0" filter="url(#f15pbs70dxkkrt)" points="781,610.1172,1196,610.1172,1206,659.1172,1196,708.1172,781,708.1172,771,659.1172,781,610.1172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="783" y="626.1841">SELECT sw.settlementWindowId, swsc.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="804" y="641.3169">swsc.reason, sw.createdDate, swsc.createdDate changedDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="783" y="656.4497">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="821" y="656.4497">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="946" y="656.4497">AS sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="783" y="671.5825">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="204" x="813" y="671.5825">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1020" y="671.5825">AS swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="783" y="686.7153">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="783" y="701.8481">WHERE sw.settlementWindowId = {id}</text><polygon fill="#A80036" points="365.5,731.0469,355.5,735.0469,365.5,739.0469,361.5,735.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="359.5" x2="640.5" y1="735.0469" y2="735.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="371.5" y="729.981">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="382.5" y="729.981">Return result</text><path d="M22,750.0469 L85,750.0469 L85,757.0469 L75,767.0469 L22,767.0469 L22,750.0469 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1039.8438" style="stroke: #000000; stroke-width: 2.0;" width="1241" x="22" y="750.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="37" y="763.1138">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="361" x="100" y="762.2573">[settlementWindow found &amp;&amp; settlementWindowStateId == 'OPEN']</text><polygon fill="#A80036" points="624.5,799.4453,634.5,803.4453,624.5,807.4453,628.5,803.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="354.5" x2="630.5" y1="803.4453" y2="803.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="361.5" y="790.813">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="372.5" y="783.2466">Close current window and open a new one</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="372.5" y="798.3794">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="446.5" y="798.3794">2001</text><path d="M576,818.4453 L726,818.4453 L726,825.4453 L716,835.4453 L576,835.4453 L576,818.4453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="591.1875" style="stroke: #000000; stroke-width: 2.0;" width="677" x="576" y="818.4453"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="591" y="831.5122">DB TRANSACTION</text><path d="M651,840.5781 L651,865.5781 L881,865.5781 L881,850.5781 L871,840.5781 L651,840.5781 " fill="#D3D3D3" filter="url(#f15pbs70dxkkrt)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M871,840.5781 L871,850.5781 L881,850.5781 L871,840.5781 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="14" x="657" y="857.645">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="674" y="857.645">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="822" y="857.645">= now()</text><polygon fill="#A80036" points="976.5,891.8438,986.5,895.8438,976.5,899.8438,980.5,895.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="646.5" x2="982.5" y1="895.8438" y2="895.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="653.5" y="890.7778">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="664.5" y="890.7778">Close requested window</text><polygon fill="#FFFFE0" filter="url(#f15pbs70dxkkrt)" points="770,908.8438,1206,908.8438,1216,934.8438,1206,961.8438,770,961.8438,760,934.8438,770,908.8438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="772" y="924.9106">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="204" x="852" y="924.9106">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="793" y="940.0435">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="772" y="955.1763">VALUES ({id}, {payload.state}, {payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="657.5,984.375,647.5,988.375,657.5,992.375,653.5,988.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="651.5" x2="987.5" y1="988.375" y2="988.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="663.5" y="983.3091">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="674.5" y="983.3091">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="717.5" y="983.3091">settlementWindowStateChangeId</text><polygon fill="#A80036" points="976.5,1013.5078,986.5,1017.5078,976.5,1021.5078,980.5,1017.5078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="646.5" x2="982.5" y1="1017.5078" y2="1017.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="653.5" y="1012.4419">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="671.5" y="1012.4419">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f15pbs70dxkkrt)" points="800,1030.5078,1177,1030.5078,1187,1056.5078,1177,1083.5078,800,1083.5078,790,1056.5078,800,1030.5078" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="802" y="1046.5747">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="852" y="1046.5747">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="373" x="802" y="1061.7075">SET currentStateChangeId = {settlementWindowStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="802" y="1076.8403">WHERE settlementWindowId = {id}</text><polygon fill="#A80036" points="971.5,1106.0391,981.5,1110.0391,971.5,1114.0391,975.5,1110.0391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="646.5" x2="977.5" y1="1110.0391" y2="1110.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="653.5" y="1104.9731">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="671.5" y="1104.9731">Create new settlementWindow</text><polygon fill="#FFFFE0" filter="url(#f15pbs70dxkkrt)" points="821,1123.0391,1156,1123.0391,1166,1142.0391,1156,1161.0391,821,1161.0391,811,1142.0391,821,1123.0391" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="823" y="1139.106">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="903" y="1139.106">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="1028" y="1139.106">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="823" y="1154.2388">VALUES ({payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="657.5,1183.4375,647.5,1187.4375,657.5,1191.4375,653.5,1187.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="651.5" x2="987.5" y1="1187.4375" y2="1187.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="663.5" y="1182.3716">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="681.5" y="1182.3716">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="724.5" y="1182.3716">settlementWindowId</text><polygon fill="#A80036" points="971.5,1212.5703,981.5,1216.5703,971.5,1220.5703,975.5,1216.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="646.5" x2="977.5" y1="1216.5703" y2="1216.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="653.5" y="1211.5044">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="671.5" y="1211.5044">Insert intial state for the created window</text><polygon fill="#FFFFE0" filter="url(#f15pbs70dxkkrt)" points="744,1229.5703,1233,1229.5703,1243,1255.5703,1233,1282.5703,744,1282.5703,734,1255.5703,744,1229.5703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="746" y="1245.6372">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="204" x="826" y="1245.6372">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="767" y="1260.77">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="485" x="746" y="1275.9028">VALUES ({settlementWindowId}, 'OPEN', {payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="657.5,1305.1016,647.5,1309.1016,657.5,1313.1016,653.5,1309.1016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="651.5" x2="987.5" y1="1309.1016" y2="1309.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="663.5" y="1304.0356">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="681.5" y="1304.0356">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="245" x="724.5" y="1304.0356">newSettlementWindowStateChangeId</text><polygon fill="#A80036" points="976.5,1334.2344,986.5,1338.2344,976.5,1342.2344,980.5,1338.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="646.5" x2="982.5" y1="1338.2344" y2="1338.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="653.5" y="1333.1685">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="671.5" y="1333.1685">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f15pbs70dxkkrt)" points="787,1351.2344,1190,1351.2344,1200,1377.2344,1190,1404.2344,787,1404.2344,777,1377.2344,787,1351.2344" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="789" y="1367.3013">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="839" y="1367.3013">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="399" x="789" y="1382.4341">SET currentStateChangeId = {newSettlementWindowStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="789" y="1397.5669">WHERE settlementWindowId = {settlementWindowId}</text><polygon fill="#A80036" points="365.5,1433.7656,355.5,1437.7656,365.5,1441.7656,361.5,1437.7656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="359.5" x2="640.5" y1="1437.7656" y2="1437.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="371.5" y="1432.6997">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="389.5" y="1432.6997">Return success</text><path d="M78,1450.7656 L78,1565.7656 L335,1565.7656 L335,1460.7656 L325,1450.7656 L78,1450.7656 " fill="#FFFF00" filter="url(#f15pbs70dxkkrt)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M325,1450.7656 L325,1460.7656 L335,1460.7656 L325,1450.7656 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="84" y="1467.8325">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="96" y="1482.9653">"id": settlementWindowId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="96" y="1498.0981">"state": 'OPEN',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="96" y="1513.231">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="96" y="1528.3638">"createdDate": transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="96" y="1543.4966">"changedDate": transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="84" y="1558.6294">}</text><polygon fill="#A80036" points="118.5,1592.8281,108.5,1596.8281,118.5,1600.8281,114.5,1596.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="343.5" y1="1596.8281" y2="1596.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="124.5" y="1591.7622">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="142.5" y="1591.7622">Respond HTTP - 201 (Created)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="22" x2="1263" y1="1605.8281" y2="1605.8281"/><path d="M359,1611.8281 L359,1636.8281 L480,1636.8281 L480,1621.8281 L470,1611.8281 L359,1611.8281 " fill="#D3D3D3" filter="url(#f15pbs70dxkkrt)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M470,1611.8281 L470,1621.8281 L480,1621.8281 L470,1611.8281 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="365" y="1628.895">Log ERROR event</text><path d="M32,1650.9609 L32,1750.9609 L335,1750.9609 L335,1660.9609 L325,1650.9609 L32,1650.9609 " fill="#FFFF00" filter="url(#f15pbs70dxkkrt)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M325,1650.9609 L325,1660.9609 L335,1660.9609 L325,1650.9609 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="38" y="1668.0278">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="50" y="1683.1606">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="62" y="1698.2935">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="62" y="1713.4263">"errorDescription": "Client error description"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="50" y="1728.5591">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="38" y="1743.6919">}</text><polygon fill="#A80036" points="113.5,1777.8906,103.5,1781.8906,113.5,1785.8906,109.5,1781.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="107.5" x2="348.5" y1="1781.8906" y2="1781.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="119.5" y="1776.8247">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="137.5" y="1776.8247">Respond HTTP - 4xx (Client error)</text><!--
@startuml
title 6.1.2. Close Settlement Window (closeSettlementWindow)

autonumber 

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Close Settlement Window
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "state": "CLOSED",
            "reason": <string>
        }
    end note

    OPERATOR -> SSAPI: POST - /settlementWindows/{id}
    activate SSAPI
    SSAPI -> SSAPI: Validate payload and requested state
    break
        note right of SSAPI #yellow
            {
                "errorInformation": {
                    "errorCode": <integer>,
                    "errorDescription": "Invalid payload or state"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 400 (Bad Request)
    end
    SSAPI -> SETTLE_DAO: Get requested settlementWindow and state\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Get settlementWindow state
    activate DB
    hnote over DB #lightyellow
        SELECT sw.settlementWindowId, swsc.settlementWindowStateId, 
               swsc.reason, sw.createdDate, swsc.createdDate changedDate
        FROM **settlementWindow** AS sw
        JOIN **settlementWindowStateChange** AS swsc
        ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
        WHERE sw.settlementWindowId = {id}
    end hnote
    deactivate DB
    SETTLE_DAO - -> SSAPI: Return result
    deactivate SETTLE_DAO

    alt settlementWindow found && settlementWindowStateId == 'OPEN'
        SSAPI -> SETTLE_DAO: Close current window and open a new one\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            note right of SETTLE_DAO #lightgray
                let **transactionTimestamp** = now()
            end note

            SETTLE_DAO -> DB: Close requested window
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES ({id}, {payload.state}, {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementWindowStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            hnote over DB #lightyellow
                UPDATE **settlementWindow**
                SET currentStateChangeId = {settlementWindowStateChangeId}
                WHERE settlementWindowId = {id}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Create new settlementWindow
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindow** (reason, createdDate)
                VALUES ({payload.reason}, {transactionTimestamp})
            end note
            SETTLE_DAO <- - DB: Return **settlementWindowId**
            deactivate DB

            SETTLE_DAO -> DB: Insert intial state for the created window
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES ({settlementWindowId}, 'OPEN', {payload.reason}, {transactionTimestamp})
            end note
            SETTLE_DAO <- - DB: Return **newSettlementWindowStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            hnote over DB #lightyellow
                UPDATE **settlementWindow**
                SET currentStateChangeId = {newSettlementWindowStateChangeId}
                WHERE settlementWindowId = {settlementWindowId}
            end hnote
            deactivate DB
        end
        SSAPI <- - SETTLE_DAO: Return success
        deactivate SETTLE_DAO

        note left of SSAPI #yellow
            {
                "id": settlementWindowId,
                "state": 'OPEN',
                "reason": payload.reason,
                "createdDate": transactionTimestamp,
                "changedDate": transactionTimestamp
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 201 (Created)
    else
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                "errorInformation": {
                    "errorCode": <integer>,
                    "errorDescription": "Client error description"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
        deactivate SSAPI
        deactivate OPERATOR
    end
end
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
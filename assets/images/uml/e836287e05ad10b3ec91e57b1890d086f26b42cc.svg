<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1469px" preserveAspectRatio="none" style="width:1368px;height:1469px;" version="1.1" viewBox="0 0 1368 1469" width="1368px" zoomAndPan="magnify"><defs><filter height="300%" id="f1rbes2jri2gmg" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="411" x="479.5" y="22.9951">5.2.2. Record Funds Out Commit (recordFundsOutCommit)</text><rect fill="#FFB6C1" height="1424.5625" style="stroke: #A80036; stroke-width: 1.0;" width="107" x="19" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="34" y="46.3638">Central HUB</text><rect fill="#FFFFE0" height="1424.5625" style="stroke: #A80036; stroke-width: 1.0;" width="860.5" x="271" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="652.25" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="546.9844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="320.5" y="291.6563"/><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="116.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="537.5" y="692.8438"/><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="1215.8359" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="721.5" y="146.7266"/><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="450.6563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="855.5" y="896.9063"/><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1078.5" y="974.3047"/><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="1201.8359" style="stroke: #000000; stroke-width: 2.0;" width="1344" x="13" y="153.7266"/><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="407.5234" style="stroke: #000000; stroke-width: 2.0;" width="552" x="795" y="911.9063"/><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="376.3906" style="stroke: #000000; stroke-width: 2.0;" width="532" x="805" y="936.0391"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="72" x2="72" y1="136.7266" y2="1372.5625"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="325" x2="325" y1="136.7266" y2="1372.5625"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="542" x2="542" y1="136.7266" y2="1372.5625"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="726" x2="726" y1="136.7266" y2="1372.5625"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="860" x2="860" y1="136.7266" y2="1372.5625"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1083.5" x2="1083.5" y1="136.7266" y2="1372.5625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="23" y="133.4248">Hub Employee</text><ellipse cx="72.5" cy="63.4297" fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M72.5,71.4297 L72.5,98.4297 M59.5,79.4297 L85.5,79.4297 M72.5,98.4297 L59.5,113.4297 M72.5,98.4297 L85.5,113.4297 " fill="none" filter="url(#f1rbes2jri2gmg)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="23" y="1384.5576">Hub Employee</text><ellipse cx="72.5" cy="1397.8594" fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M72.5,1405.8594 L72.5,1432.8594 M59.5,1413.8594 L85.5,1413.8594 M72.5,1432.8594 L59.5,1447.8594 M72.5,1432.8594 L85.5,1447.8594 " fill="none" filter="url(#f1rbes2jri2gmg)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="275" y="117.1279">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="68" x="290.5" y="133.4248">Admin API</text><path d="M305,76.1328 L305,100.1328 M305,88.1328 L322,88.1328 " fill="none" filter="url(#f1rbes2jri2gmg)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="334" cy="88.1328" fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="275" y="1384.5576">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="68" x="290.5" y="1400.8545">Admin API</text><path d="M305,1408.1563 L305,1432.1563 M305,1420.1563 L322,1420.1563 " fill="none" filter="url(#f1rbes2jri2gmg)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="334" cy="1420.1563" fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="151" x="467" y="97.4297"/><rect fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="151" x="463" y="101.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="137" x="470" y="121.4248">Admin-Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="151" x="467" y="1371.5625"/><rect fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="151" x="463" y="1375.5625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="137" x="470" y="1395.5576">Admin-Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="135" x="656" y="133.4248">Admin Event Handler</text><ellipse cx="726.5" cy="104.4297" fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="722.5,92.4297,728.5,87.4297,726.5,92.4297,728.5,97.4297,722.5,92.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="135" x="656" y="1384.5576">Admin Event Handler</text><ellipse cx="726.5" cy="1403.8594" fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="722.5,1391.8594,728.5,1386.8594,726.5,1391.8594,728.5,1396.8594,722.5,1391.8594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="815" y="133.4248">Transfer DAO</text><ellipse cx="860.5" cy="104.4297" fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="848.5" x2="872.5" y1="118.4297" y2="118.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="815" y="1384.5576">Transfer DAO</text><ellipse cx="860.5" cy="1403.8594" fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="848.5" x2="872.5" y1="1417.8594" y2="1417.8594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1039.5" y="133.4248">Central Store</text><path d="M1065.5,84.4297 C1065.5,74.4297 1083.5,74.4297 1083.5,74.4297 C1083.5,74.4297 1101.5,74.4297 1101.5,84.4297 L1101.5,110.4297 C1101.5,120.4297 1083.5,120.4297 1083.5,120.4297 C1083.5,120.4297 1065.5,120.4297 1065.5,110.4297 L1065.5,84.4297 " fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1065.5,84.4297 C1065.5,94.4297 1083.5,94.4297 1083.5,94.4297 C1083.5,94.4297 1101.5,94.4297 1101.5,84.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1039.5" y="1384.5576">Central Store</text><path d="M1065.5,1397.8594 C1065.5,1387.8594 1083.5,1387.8594 1083.5,1387.8594 C1083.5,1387.8594 1101.5,1387.8594 1101.5,1397.8594 L1101.5,1423.8594 C1101.5,1433.8594 1083.5,1433.8594 1083.5,1433.8594 C1083.5,1433.8594 1065.5,1433.8594 1065.5,1423.8594 L1065.5,1397.8594 " fill="#FEFECE" filter="url(#f1rbes2jri2gmg)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1065.5,1397.8594 C1065.5,1407.8594 1083.5,1407.8594 1083.5,1407.8594 C1083.5,1407.8594 1101.5,1407.8594 1101.5,1397.8594 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="546.9844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="320.5" y="291.6563"/><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="116.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="537.5" y="692.8438"/><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="1215.8359" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="721.5" y="146.7266"/><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="450.6563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="855.5" y="896.9063"/><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1078.5" y="974.3047"/><path d="M13,153.7266 L223,153.7266 L223,160.7266 L213,170.7266 L13,170.7266 L13,153.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1201.8359" style="stroke: #000000; stroke-width: 2.0;" width="1344" x="13" y="153.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="28" y="166.7935">Record Funds Out Commit</text><path d="M77,175.8594 L77,245.8594 L317,245.8594 L317,185.8594 L307,175.8594 L77,175.8594 " fill="#FFFF00" filter="url(#f1rbes2jri2gmg)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M307,175.8594 L307,185.8594 L317,185.8594 L307,175.8594 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="83" y="192.9263">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="95" y="208.0591">"action": "recordFundsOutCommit",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="95" y="223.1919">"reason": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="83" y="238.3247">}</text><polygon fill="#A80036" points="308.5,287.6563,318.5,291.6563,308.5,295.6563,312.5,291.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="314.5" y1="291.6563" y2="291.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="79.5" y="279.0239">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="90.5" y="271.4575">PUT - /participants/{name}/accounts/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="123.5" y="286.5903">{id}/transfers/{transferId}</text><path d="M335,304.6563 L335,646.6563 L589,646.6563 L589,314.6563 L579,304.6563 L335,304.6563 " fill="#FFFF00" filter="url(#f1rbes2jri2gmg)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M579,304.6563 L579,314.6563 L589,314.6563 L579,304.6563 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="341" y="321.7231">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="341" y="336.856">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="353" y="351.9888">id: &lt;payload.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="353" y="367.1216">from: "Hub",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="353" y="382.2544">to: "dfspName",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="353" y="397.3872">type: "application/json"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="353" y="412.52">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="365" y="427.6528">headers: &lt;payloadHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="365" y="442.7856">payload: &lt;payloadMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="353" y="457.9185">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="353" y="473.0513">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="365" y="488.1841">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="377" y="503.3169">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="377" y="518.4497">responseTo: "",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="377" y="533.5825">type: "transfer",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="377" y="548.7153">action: "recordFundsOutCommit",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="377" y="563.8481">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="377" y="578.981">state: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="365" y="594.1138">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="353" y="609.2466">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="353" y="624.3794">pp: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="341" y="639.5122">}</text><polygon fill="#A80036" points="525.5,688.8438,535.5,692.8438,525.5,696.8438,529.5,692.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="330.5" x2="531.5" y1="692.8438" y2="692.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="337.5" y="680.2114">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="348.5" y="672.645">Route &amp; Publish Prepare event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="348.5" y="687.7778">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="422.5" y="687.7778">2003</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="547.5" x2="589.5" y1="752.2422" y2="752.2422"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="589.5" x2="589.5" y1="752.2422" y2="765.2422"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="548.5" x2="589.5" y1="765.2422" y2="765.2422"/><polygon fill="#A80036" points="558.5,761.2422,548.5,765.2422,558.5,769.2422,554.5,765.2422" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="554.5" y="732.0435">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="565.5" y="716.9106">Ensure event is replicated</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="565.5" y="732.0435">as configured (ACKS=all)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="565.5" y="747.1763">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="639.5" y="747.1763">2003</text><polygon fill="#A80036" points="341.5,805.5078,331.5,809.5078,341.5,813.5078,337.5,809.5078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="335.5" x2="541.5" y1="809.5078" y2="809.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="347.5" y="796.8755">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="358.5" y="789.3091">Respond replication acks</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="358.5" y="804.4419">have been received</text><polygon fill="#A80036" points="83.5,834.6406,73.5,838.6406,83.5,842.6406,79.5,838.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="77.5" x2="324.5" y1="838.6406" y2="838.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="89.5" y="833.5747">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="100.5" y="833.5747">Respond HTTP - 202 (Accepted)</text><polygon fill="#A80036" points="553.5,863.7734,543.5,867.7734,553.5,871.7734,549.5,867.7734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="547.5" x2="720.5" y1="867.7734" y2="867.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="559.5" y="862.7075">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="570.5" y="862.7075">Consume message</text><polygon fill="#A80036" points="843.5,892.9063,853.5,896.9063,843.5,900.9063,847.5,896.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="731.5" x2="849.5" y1="896.9063" y2="896.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="738.5" y="891.8403">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="749.5" y="891.8403">Commit transfer</text><path d="M795,911.9063 L945,911.9063 L945,918.9063 L935,928.9063 L795,928.9063 L795,911.9063 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="407.5234" style="stroke: #000000; stroke-width: 2.0;" width="552" x="795" y="911.9063"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="810" y="924.9731">DB TRANSACTION</text><path d="M805,936.0391 L1051,936.0391 L1051,943.0391 L1041,953.0391 L805,953.0391 L805,936.0391 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="376.3906" style="stroke: #000000; stroke-width: 2.0;" width="532" x="805" y="936.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="201" x="820" y="949.106">Reconciliation Transfer Commit</text><polygon fill="#A80036" points="1066.5,970.3047,1076.5,974.3047,1066.5,978.3047,1070.5,974.3047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="865.5" x2="1072.5" y1="974.3047" y2="974.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="872.5" y="969.2388">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="883.5" y="969.2388">Insert transferFulfilment record</text><polygon fill="#FFFFE0" filter="url(#f1rbes2jri2gmg)" points="849,1017.3047,1317,1017.3047,1327,1058.3047,1317,1100.3047,849,1100.3047,839,1058.3047,849,1017.3047" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="851" y="1033.3716">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="119" x="931" y="1033.3716">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="863" y="1048.5044">(transferFulfilmentId, transferId, ilpFulfilment,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="341" x="863" y="1063.6372">completedDate, isValid, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="464" x="851" y="1078.77">VALUES ({transferFulfilmentId}, {payload.transferId}, 0, {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="863" y="1093.9028">1, NULL, {transactionTimestamp})</text><rect fill="#FFFFFF" filter="url(#f1rbes2jri2gmg)" height="176.4609" style="stroke: #000000; stroke-width: 2.0;" width="314.5" x="812" y="1130.9688"/><polygon fill="#EEEEEE" points="812,1130.9688,876,1130.9688,876,1137.9688,866,1147.9688,812,1147.9688,812,1130.9688" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="825" y="1145.0356">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="211" x="838.75" y="1164.0356">transferStateAndPositionUpdate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="1052.75" y="1164.0356">{</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-recfunds-5.1.0.b-transferStateAndPositionUpdate.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-recfunds-5.1.0.b-transferStateAndPositionUpdate.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="38" x="1057.75" y="1164.0356">5.1.0.b</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="1057.75" x2="1095.75" y1="1166.0356" y2="1166.0356"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="1095.75" y="1164.0356">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="9" x="838.75" y="1179.1685">({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="850.75" y="1194.3013">transferId: {payload.transferId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="850.75" y="1209.4341">transferStateId: "COMMITTED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="850.75" y="1224.5669">reason: {payload.reason},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="850.75" y="1239.6997">createdDate: {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="850.75" y="1254.8325">drUpdated: false,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="850.75" y="1269.9653">crUpdated: true</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="838.75" y="1285.0981">}, trx)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="841.75" y="1300.231"/><polygon fill="#A80036" points="742.5,1343.5625,732.5,1347.5625,742.5,1351.5625,738.5,1347.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="736.5" x2="859.5" y1="1347.5625" y2="1347.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="748.5" y="1342.4966">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="759.5" y="1342.4966">Finished await</text><!--
@startuml
title 5.2.2. Record Funds Out Commit (recordFundsOutCommit)

autonumber


actor "Hub Employee" as OPERATOR
boundary "Central Service\n Admin API" as CS_ADMIN_API
collections "Admin-Transfer-Topic" as TOPIC_ADMIN_TRANSFER
control "Admin Event Handler" as ADMIN_HANDLER
entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Central Service" #LightYellow
    participant CS_ADMIN_API
	participant TOPIC_ADMIN_TRANSFER
    participant ADMIN_HANDLER
    participant TRANSFER_DAO
    participant DB
end box

activate ADMIN_HANDLER
group Record Funds Out Commit
    note right of OPERATOR #yellow
        {
            "action": "recordFundsOutCommit",
            "reason": "string"
        }
    end note
    OPERATOR -> CS_ADMIN_API: PUT - /participants/{name}/accounts/\n           {id}/transfers/{transferId}
    activate CS_ADMIN_API

    note right of CS_ADMIN_API #yellow
        Message:
        {
            id: <payload.transferId>
            from: "Hub",
            to: "dfspName",
            type: "application/json"
            content: {
                headers: <payloadHeaders>,
                payload: <payloadMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: "",
                    type: "transfer",
                    action: "recordFundsOutCommit",
                    createdAt: <timestamp>,
                    state: ""
                }
            },
            pp: ""
        }
    end note
    CS_ADMIN_API -> TOPIC_ADMIN_TRANSFER: Route & Publish Prepare event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_ADMIN_TRANSFER
    TOPIC_ADMIN_TRANSFER <-> TOPIC_ADMIN_TRANSFER: Ensure event is replicated\nas configured (ACKS=all)\n<color #FF0000><b>Error code:</b> 2003</color>
    TOPIC_ADMIN_TRANSFER - -> CS_ADMIN_API: Respond replication acks\nhave been received
    deactivate TOPIC_ADMIN_TRANSFER
    CS_ADMIN_API - - -> OPERATOR: Respond HTTP - 202 (Accepted)
    deactivate CS_ADMIN_API

    TOPIC_ADMIN_TRANSFER <- ADMIN_HANDLER: Consume message
    ADMIN_HANDLER -> TRANSFER_DAO: Commit transfer
    activate TRANSFER_DAO
    group <color #blue>DB TRANSACTION</color>
        group Reconciliation Transfer Commit
            TRANSFER_DAO -> DB: Insert transferFulfilment record
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **transferFulfilment**
                    (transferFulfilmentId, transferId, ilpFulfilment,
                    completedDate, isValid, settlementWindowId, createdDate)
                VALUES ({transferFulfilmentId}, {payload.transferId}, 0, {transactionTimestamp},
                    1, NULL, {transactionTimestamp})
            end hnote
            |||
            ref over TRANSFER_DAO, DB:**transferStateAndPositionUpdate** {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-recfunds-5.1.0.b-transferStateAndPositionUpdate.svg 5.1.0.b]]} \n({\n    transferId: {payload.transferId},\n    transferStateId: "COMMITTED",\n    reason: {payload.reason},\n    createdDate: {transactionTimestamp},\n    drUpdated: false,\n    crUpdated: true\n}, trx)\n
        end
    end
    ADMIN_HANDLER <- - TRANSFER_DAO: Finished await
    deactivate TRANSFER_DAO
end
deactivate ADMIN_HANDLER
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
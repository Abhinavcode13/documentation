<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1548px" preserveAspectRatio="none" style="width:1738px;height:1548px;" version="1.1" viewBox="0 0 1738 1548" width="1738px" zoomAndPan="magnify"><defs><filter height="300%" id="f1k6tb0gajl4r3" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="363" x="688.5" y="22.9951">1.1.2.b. Position Handler Consume (batch messages)</text><rect fill="#FFFFE0" height="1503.2344" style="stroke: #A80036; stroke-width: 1.0;" width="1654.5" x="19" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="797.25" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="100.5" y="170.9922"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="1336.5078" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="447.5" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="995.5" y="1410.2344"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1342.5" y="449.0547"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1342.5" y="683.8516"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1444" y="865.5156"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1620.5" y="478.1875"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1620.5" y="712.9844"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1620.5" y="894.6484"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="1322.5078" style="stroke: #000000; stroke-width: 2.0;" width="1714" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="789.5" x="367" y="215.9922"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="1061.5781" style="stroke: #000000; stroke-width: 2.0;" width="1360" x="357" y="386.6563"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="402.4609" style="stroke: #000000; stroke-width: 2.0;" width="1327" x="367" y="410.7891"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="167.6641" style="stroke: #000000; stroke-width: 2.0;" width="1340" x="367" y="827.25"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="105" x2="105" y1="115.7266" y2="1472.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="452" x2="452" y1="115.7266" y2="1472.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1000.5" x2="1000.5" y1="115.7266" y2="1472.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1106.5" x2="1106.5" y1="115.7266" y2="1472.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1223.5" x2="1223.5" y1="115.7266" y2="1472.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1347.5" x2="1347.5" y1="115.7266" y2="1472.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1448.5" x2="1448.5" y1="115.7266" y2="1472.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1625.5" x2="1625.5" y1="115.7266" y2="1472.2344"/><rect fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="27" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="23" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="143" x="30" y="100.4248">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="27" y="1471.2344"/><rect fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="23" y="1475.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="143" x="30" y="1495.2295">topic-transfer-position</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="145" x="377" y="112.4248">Position Event Handler</text><ellipse cx="452.5" cy="83.4297" fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="448.5,71.4297,454.5,66.4297,452.5,71.4297,454.5,76.4297,448.5,71.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="145" x="377" y="1484.2295">Position Event Handler</text><ellipse cx="452.5" cy="1503.5313" fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="448.5,1491.5313,454.5,1486.5313,452.5,1491.5313,454.5,1496.5313,448.5,1491.5313" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="948.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="944.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="951.5" y="100.4248">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="948.5" y="1471.2344"/><rect fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="944.5" y="1475.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="951.5" y="1495.2295">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="74" x="1066.5" y="112.4248">Event-Topic</text><ellipse cx="1106.5" cy="83.4297" fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1094.5" x2="1118.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="74" x="1066.5" y="1484.2295">Event-Topic</text><ellipse cx="1106.5" cy="1503.5313" fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1094.5" x2="1118.5" y1="1517.5313" y2="1517.5313"/><rect fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1160.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1156.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="1163.5" y="100.4248">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1160.5" y="1471.2344"/><rect fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1156.5" y="1475.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="1163.5" y="1495.2295">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1301.5" y="112.4248">Position DAO</text><ellipse cx="1347.5" cy="83.4297" fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1335.5" x2="1359.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1301.5" y="1484.2295">Position DAO</text><ellipse cx="1347.5" cy="1503.5313" fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1335.5" x2="1359.5" y1="1517.5313" y2="1517.5313"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="1403.5" y="112.4248">Transfer DAO</text><ellipse cx="1449" cy="83.4297" fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1437" x2="1461" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="1403.5" y="1484.2295">Transfer DAO</text><ellipse cx="1449" cy="1503.5313" fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1437" x2="1461" y1="1517.5313" y2="1517.5313"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1581.5" y="112.4248">Central Store</text><path d="M1607.5,63.4297 C1607.5,53.4297 1625.5,53.4297 1625.5,53.4297 C1625.5,53.4297 1643.5,53.4297 1643.5,63.4297 L1643.5,89.4297 C1643.5,99.4297 1625.5,99.4297 1625.5,99.4297 C1625.5,99.4297 1607.5,99.4297 1607.5,89.4297 L1607.5,63.4297 " fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1607.5,63.4297 C1607.5,73.4297 1625.5,73.4297 1625.5,73.4297 C1625.5,73.4297 1643.5,73.4297 1643.5,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1581.5" y="1484.2295">Central Store</text><path d="M1607.5,1497.5313 C1607.5,1487.5313 1625.5,1487.5313 1625.5,1487.5313 C1625.5,1487.5313 1643.5,1487.5313 1643.5,1497.5313 L1643.5,1523.5313 C1643.5,1533.5313 1625.5,1533.5313 1625.5,1533.5313 C1625.5,1533.5313 1607.5,1533.5313 1607.5,1523.5313 L1607.5,1497.5313 " fill="#FEFECE" filter="url(#f1k6tb0gajl4r3)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1607.5,1497.5313 C1607.5,1507.5313 1625.5,1507.5313 1625.5,1507.5313 C1625.5,1507.5313 1643.5,1507.5313 1643.5,1497.5313 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="100.5" y="170.9922"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="1336.5078" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="447.5" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="995.5" y="1410.2344"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1342.5" y="449.0547"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1342.5" y="683.8516"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1444" y="865.5156"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1620.5" y="478.1875"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1620.5" y="712.9844"/><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1620.5" y="894.6484"/><path d="M13,132.7266 L225,132.7266 L225,139.7266 L215,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1322.5078" style="stroke: #000000; stroke-width: 2.0;" width="1714" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="167" x="28" y="145.7935">Position Handler Consume</text><polygon fill="#A80036" points="121.5,166.9922,111.5,170.9922,121.5,174.9922,117.5,170.9922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115.5" x2="446.5" y1="170.9922" y2="170.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="127.5" y="165.9263">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="138.5" y="165.9263">Consume Position event batch of messages for Payer</text><path d="M367,215.9922 L577,215.9922 L577,222.9922 L567,232.9922 L367,232.9922 L367,215.9922 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="789.5" x="367" y="215.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="382" y="229.0591">Persist Event Information</text><polygon fill="#A80036" points="1094.5,275.2578,1104.5,279.2578,1094.5,283.2578,1098.5,279.2578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="457.5" x2="1100.5" y1="279.2578" y2="279.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="464.5" y="274.1919">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="475.5" y="274.1919">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1k6tb0gajl4r3)" height="55.3984" style="stroke: #000000; stroke-width: 2.0;" width="771.5" x="374" y="287.2578"/><polygon fill="#EEEEEE" points="374,287.2578,438,287.2578,438,294.2578,428,304.2578,374,304.2578,374,287.2578" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="387" y="301.3247">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="669.75" y="320.3247">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="27" x="818.75" y="320.3247">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="818.75" x2="845.75" y1="322.3247" y2="322.3247"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="845.75" y="320.3247">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="672.75" y="335.4575"/><path d="M357,386.6563 L430,386.6563 L430,393.6563 L420,403.6563 L357,403.6563 L357,386.6563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1061.5781" style="stroke: #000000; stroke-width: 2.0;" width="1360" x="357" y="386.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="372" y="399.7231">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="147" x="445" y="398.8667">[for each message in batch]</text><path d="M367,410.7891 L651,410.7891 L651,417.7891 L641,427.7891 L367,427.7891 L367,410.7891 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="402.4609" style="stroke: #000000; stroke-width: 2.0;" width="1327" x="367" y="410.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="239" x="382" y="423.856">Calculate position and persist change</text><polygon fill="#A80036" points="1330.5,445.0547,1340.5,449.0547,1330.5,453.0547,1334.5,449.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="457.5" x2="1336.5" y1="449.0547" y2="449.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="464.5" y="443.9888">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="475.5" y="443.9888">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1608.5,474.1875,1618.5,478.1875,1608.5,482.1875,1612.5,478.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1352.5" x2="1614.5" y1="478.1875" y2="478.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="1359.5" y="473.1216">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="1370.5" y="473.1216">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1k6tb0gajl4r3)" points="1577,521.1875,1674,521.1875,1684,532.1875,1674,544.1875,1577,544.1875,1567,532.1875,1577,521.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1579" y="537.2544">transferPosition</text><polygon fill="#A80036" points="468.5,566.4531,458.5,570.4531,468.5,574.4531,464.5,570.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="462.5" x2="1346.5" y1="570.4531" y2="570.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="474.5" y="565.3872">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="485.5" y="565.3872">Return latest position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="457.5" x2="499.5" y1="599.5859" y2="599.5859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="499.5" x2="499.5" y1="599.5859" y2="612.5859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="458.5" x2="499.5" y1="612.5859" y2="612.5859"/><polygon fill="#A80036" points="468.5,608.5859,458.5,612.5859,468.5,616.5859,464.5,612.5859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="464.5" y="594.52">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="390" x="475.5" y="594.52">Calculate latest position (lpos) by incrementing transfer for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="457.5" x2="499.5" y1="641.7188" y2="641.7188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="499.5" x2="499.5" y1="641.7188" y2="654.7188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="458.5" x2="499.5" y1="654.7188" y2="654.7188"/><polygon fill="#A80036" points="468.5,650.7188,458.5,654.7188,468.5,658.7188,464.5,654.7188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="464.5" y="636.6528">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="513" x="475.5" y="636.6528">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#A80036" points="1330.5,679.8516,1340.5,683.8516,1330.5,687.8516,1334.5,683.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="457.5" x2="1336.5" y1="683.8516" y2="683.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="464.5" y="678.7856">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="475.5" y="678.7856">Request to persist latest position for Payer</text><polygon fill="#A80036" points="1608.5,708.9844,1618.5,712.9844,1608.5,716.9844,1612.5,712.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1352.5" x2="1614.5" y1="712.9844" y2="712.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="1359.5" y="707.9185">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="1370.5" y="707.9185">Persist latest position to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1k6tb0gajl4r3)" points="1577,755.9844,1674,755.9844,1684,766.9844,1674,778.9844,1577,778.9844,1567,766.9844,1577,755.9844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="1579" y="772.0513">transferPosition</text><polygon fill="#A80036" points="468.5,801.25,458.5,805.25,468.5,809.25,464.5,805.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="462.5" x2="1346.5" y1="805.25" y2="805.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="474.5" y="800.1841">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="492.5" y="800.1841">Return success</text><path d="M367,827.25 L902,827.25 L902,834.25 L892,844.25 L367,844.25 L367,827.25 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="167.6641" style="stroke: #000000; stroke-width: 2.0;" width="1340" x="367" y="827.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="490" x="382" y="840.3169">Persist Transfer State (with transferState='RESERVED' on position check pass)</text><polygon fill="#A80036" points="1432,861.5156,1442,865.5156,1432,869.5156,1436,865.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="457.5" x2="1438" y1="865.5156" y2="865.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="464.5" y="860.4497">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="482.5" y="860.4497">Request to persist batch transfer</text><polygon fill="#A80036" points="1608.5,890.6484,1618.5,894.6484,1608.5,898.6484,1612.5,894.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1454" x2="1614.5" y1="894.6484" y2="894.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1461" y="889.5825">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="1479" y="889.5825">Persist batch transfer</text><polygon fill="#FFFFE0" filter="url(#f1k6tb0gajl4r3)" points="1563,937.6484,1687,937.6484,1697,948.6484,1687,960.6484,1563,960.6484,1553,948.6484,1563,937.6484" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1565" y="953.7153">transferStateChange</text><polygon fill="#A80036" points="468.5,982.9141,458.5,986.9141,468.5,990.9141,464.5,986.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="462.5" x2="1448" y1="986.9141" y2="986.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="474.5" y="981.8481">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="492.5" y="981.8481">Return success</text><path d="M462,1006.9141 L462,1379.9141 L699,1379.9141 L699,1016.9141 L689,1006.9141 L462,1006.9141 " fill="#FFFF00" filter="url(#f1k6tb0gajl4r3)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M689,1006.9141 L689,1016.9141 L699,1016.9141 L689,1006.9141 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="468" y="1023.981">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="468" y="1039.1138">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="480" y="1054.2466">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="480" y="1069.3794">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="480" y="1084.5122">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="480" y="1099.645">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="480" y="1114.7778">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="492" y="1129.9106">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="492" y="1145.0435">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="480" y="1160.1763">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="480" y="1175.3091">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="492" y="1190.4419">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="504" y="1205.5747">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="504" y="1220.7075">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="504" y="1235.8403">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="504" y="1250.9731">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="504" y="1266.106">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="504" y="1281.2388">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="516" y="1296.3716">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="516" y="1311.5044">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="504" y="1326.6372">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="492" y="1341.77">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="480" y="1356.9028">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="468" y="1372.0356">}</text><polygon fill="#A80036" points="983.5,1406.2344,993.5,1410.2344,983.5,1414.2344,987.5,1410.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="457.5" x2="989.5" y1="1410.2344" y2="1410.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="464.5" y="1405.1685">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="482.5" y="1405.1685">Publish Transfer event</text><!--
@startuml
title 1.1.2.b. Position Handler Consume (batch messages)

autonumber


collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
entity "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_TRANSFER_POSITION
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant TRANS_DAO
    participant DB
end box

activate POS_HANDLER
group Position Handler Consume
    TOPIC_TRANSFER_POSITION <- POS_HANDLER: Consume Position event batch of messages for Payer
    activate TOPIC_TRANSFER_POSITION
    deactivate TOPIC_TRANSFER_POSITION

    group Persist Event Information
        |||
        POS_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over POS_HANDLER, TOPIC_EVENTS : Event Handler Consume {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg 9.1.0]]} \n
        |||
    end

    loop for each message in batch
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) by incrementing transfer for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            
            POS_HANDLER -> POS_DAO: Request to persist latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist latest position to DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        group Persist Transfer State (with transferState='RESERVED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist batch transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist batch transfer
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end
        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
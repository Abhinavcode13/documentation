<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="5584px" preserveAspectRatio="none" style="width:1612px;height:5584px;" version="1.1" viewBox="0 0 1612 5584" width="1612px" zoomAndPan="magnify"><defs><filter height="300%" id="fjoi852c0kfq7" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="363" x="625.5" y="22.9951">3.1.1. Timeout Handler Consume (incl. Bulk Transfer)</text><rect fill="#FFFFE0" height="5539.5234" style="stroke: #A80036; stroke-width: 1.0;" width="1261" x="49" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="630.5" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="5361.2031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="105" y="128.0234"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="330" y="4264.9844"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="330" y="5430.2266"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="451" y="3546.6016"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="674.5" y="4863.1719"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="287.8594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="792" y="632.6797"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="792" y="980.8047"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="1591.8906" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="792" y="1176.7344"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="181.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1026" y="318.0859"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="122.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="347.2188"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="661.8125"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="1009.9375"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="1272.1328"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="1545.9922"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="1850.1172"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="2123.9766"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="380.0547" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="2359.4375"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="5354.2031" style="stroke: #000000; stroke-width: 2.0;" width="1588" x="13" y="135.0234"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="106.6641" style="stroke: #000000; stroke-width: 2.0;" width="575" x="43" y="159.1563"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="300.5938" style="stroke: #000000; stroke-width: 2.0;" width="1366" x="33" y="279.8203"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="380" x="43" y="514.1484"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="334.125" style="stroke: #000000; stroke-width: 2.0;" width="1497" x="43" y="594.4141"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="181.9297" style="stroke: #000000; stroke-width: 2.0;" width="1405" x="43" y="942.5391"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="1638.1563" style="stroke: #000000; stroke-width: 2.0;" width="1548" x="43" y="1138.4688"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="1139.5703" style="stroke: #000000; stroke-width: 2.0;" width="840" x="741" y="1191.7344"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="2691.6016" style="stroke: #000000; stroke-width: 2.0;" width="748" x="23" y="2790.625"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="2635.4688" style="stroke: #000000; stroke-width: 2.0;" width="728" x="33" y="2839.7578"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="1439.0938" style="stroke: #000000; stroke-width: 2.0;" width="470" x="43" y="2863.8906"/><rect fill="#FFFFFF" height="718.3828" style="stroke: none; stroke-width: 1.0;" width="470" x="43" y="3584.6016"/><rect fill="#FFFFFF" height="1165.2422" style="stroke: none; stroke-width: 1.0;" width="728" x="33" y="4309.9844"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="1136.4375" style="stroke: #000000; stroke-width: 2.0;" width="708" x="43" y="4331.7891"/><rect fill="#FFFFFF" height="567.0547" style="stroke: none; stroke-width: 1.0;" width="708" x="43" y="4901.1719"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="110" x2="110" y1="118.0234" y2="5506.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="335" x2="335" y1="118.0234" y2="5506.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="456" x2="456" y1="118.0234" y2="5506.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="560" x2="560" y1="118.0234" y2="5506.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="679" x2="679" y1="118.0234" y2="5506.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="797" x2="797" y1="118.0234" y2="5506.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1031" x2="1031" y1="118.0234" y2="5506.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1262" x2="1262" y1="118.0234" y2="5506.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="53" y="98.4248">Transfer Timeout</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="82" y="114.7217">Handler</text><ellipse cx="110" cy="69.4297" fill="#FEFECE" filter="url(#fjoi852c0kfq7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="106,57.4297,112,52.4297,110,57.4297,112,62.4297,106,57.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="53" y="5518.2217">Transfer Timeout</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="82" y="5534.5186">Handler</text><ellipse cx="110" cy="5553.8203" fill="#FEFECE" filter="url(#fjoi852c0kfq7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="106,5541.8203,112,5536.8203,110,5541.8203,112,5546.8203,106,5541.8203" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="275" y="62.4297"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="271" y="66.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="312.5" y="86.4248">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="278" y="102.7217">transfer-position</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="275" y="5505.2266"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="271" y="5509.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="312.5" y="5529.2217">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="278" y="5545.5186">transfer-position</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="413" y="62.4297"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="409" y="66.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="433.5" y="86.4248">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="416" y="102.7217">notification</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="413" y="5505.2266"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="409" y="5509.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="433.5" y="5529.2217">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="416" y="5545.5186">notification</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="517" y="78.7266"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="513" y="82.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="520" y="102.7217">topic-event</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="517" y="5505.2266"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="513" y="5509.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="520" y="5529.2217">topic-event</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="622" y="62.4297"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="618" y="66.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="657" y="86.4248">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="625" y="102.7217">bulk-processing</text><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="622" y="5505.2266"/><rect fill="#FEFECE" filter="url(#fjoi852c0kfq7)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="618" y="5509.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="657" y="5529.2217">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="625" y="5545.5186">bulk-processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="751" y="114.7217">Position DAO</text><ellipse cx="797" cy="85.7266" fill="#FEFECE" filter="url(#fjoi852c0kfq7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="785" x2="809" y1="99.7266" y2="99.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="751" y="5518.2217">Position DAO</text><ellipse cx="797" cy="5537.5234" fill="#FEFECE" filter="url(#fjoi852c0kfq7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="785" x2="809" y1="5551.5234" y2="5551.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="983" y="114.7217">Segment DAO</text><ellipse cx="1031" cy="85.7266" fill="#FEFECE" filter="url(#fjoi852c0kfq7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1019" x2="1043" y1="99.7266" y2="99.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="983" y="5518.2217">Segment DAO</text><ellipse cx="1031" cy="5537.5234" fill="#FEFECE" filter="url(#fjoi852c0kfq7)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1019" x2="1043" y1="5551.5234" y2="5551.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1218" y="114.7217">Central Store</text><path d="M1244,65.7266 C1244,55.7266 1262,55.7266 1262,55.7266 C1262,55.7266 1280,55.7266 1280,65.7266 L1280,91.7266 C1280,101.7266 1262,101.7266 1262,101.7266 C1262,101.7266 1244,101.7266 1244,91.7266 L1244,65.7266 " fill="#FEFECE" filter="url(#fjoi852c0kfq7)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1244,65.7266 C1244,75.7266 1262,75.7266 1262,75.7266 C1262,75.7266 1280,75.7266 1280,65.7266 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1218" y="5518.2217">Central Store</text><path d="M1244,5531.5234 C1244,5521.5234 1262,5521.5234 1262,5521.5234 C1262,5521.5234 1280,5521.5234 1280,5531.5234 L1280,5557.5234 C1280,5567.5234 1262,5567.5234 1262,5567.5234 C1262,5567.5234 1244,5567.5234 1244,5557.5234 L1244,5531.5234 " fill="#FEFECE" filter="url(#fjoi852c0kfq7)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1244,5531.5234 C1244,5541.5234 1262,5541.5234 1262,5541.5234 C1262,5541.5234 1280,5541.5234 1280,5531.5234 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="5361.2031" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="105" y="128.0234"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="330" y="4264.9844"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="330" y="5430.2266"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="451" y="3546.6016"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="674.5" y="4863.1719"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="287.8594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="792" y="632.6797"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="792" y="980.8047"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="1591.8906" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="792" y="1176.7344"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="181.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1026" y="318.0859"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="122.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="347.2188"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="661.8125"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="1009.9375"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="1272.1328"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="1545.9922"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="1850.1172"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="2123.9766"/><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="380.0547" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1257" y="2359.4375"/><path d="M13,135.0234 L225,135.0234 L225,142.0234 L215,152.0234 L13,152.0234 L13,135.0234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="5354.2031" style="stroke: #000000; stroke-width: 2.0;" width="1588" x="13" y="135.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="167" x="28" y="148.0903">Timeout Handler Consume</text><path d="M43,159.1563 L253,159.1563 L253,166.1563 L243,176.1563 L43,176.1563 L43,159.1563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.6641" style="stroke: #000000; stroke-width: 2.0;" width="575" x="43" y="159.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="58" y="172.2231">Persist Event Information</text><polygon fill="#A80036" points="548.5,193.4219,558.5,197.4219,548.5,201.4219,552.5,197.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="554.5" y1="197.4219" y2="197.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="122" y="192.356">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="133" y="192.356">Publish event information</text><rect fill="#FFFFFF" filter="url(#fjoi852c0kfq7)" height="55.3984" style="stroke: #000000; stroke-width: 2.0;" width="557" x="50" y="205.4219"/><polygon fill="#EEEEEE" points="50,205.4219,114,205.4219,114,212.4219,104,222.4219,50,222.4219,50,205.4219" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="63" y="219.4888">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="260" y="238.4888">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="263" y="253.6216"/><path d="M33,279.8203 L556,279.8203 L556,286.8203 L546,296.8203 L33,296.8203 L33,279.8203 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="300.5938" style="stroke: #000000; stroke-width: 2.0;" width="1366" x="33" y="279.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="478" x="48" y="292.8872">Get previous checkpoint of last record processed (Lower limit for inclusion)</text><polygon fill="#A80036" points="1014,314.0859,1024,318.0859,1014,322.0859,1018,318.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="1020" y1="318.0859" y2="318.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="122" y="313.02">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="133" y="313.02">Get last segment as @intervalMin</text><polygon fill="#A80036" points="1245,343.2188,1255,347.2188,1245,351.2188,1249,347.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1036" x2="1251" y1="347.2188" y2="347.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="1043" y="342.1528">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="1054" y="342.1528">Get last segment as @intervalMin</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="1144,360.2188,1379,360.2188,1389,401.2188,1379,443.2188,1144,443.2188,1134,401.2188,1144,360.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="1146" y="376.2856">SELECT value INTO @intervalMin</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1146" y="391.4185">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="55" x="1184" y="391.4185">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="1146" y="406.5513">WHERE segmentType = 'timeout'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1146" y="421.6841">AND enumeration = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="1146" y="436.8169">AND tableName = 'transferStateChange'</text><polygon fill="#A80036" points="1047,466.0156,1037,470.0156,1047,474.0156,1043,470.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1041" x2="1261" y1="470.0156" y2="470.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="1053" y="464.9497">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1064" y="464.9497">Return @intervalMin</text><polygon fill="#A80036" points="126,495.1484,116,499.1484,126,503.1484,122,499.1484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="1030" y1="499.1484" y2="499.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="132" y="494.0825">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="143" y="494.0825">Return @intervalMin</text><path d="M43,514.1484 L110,514.1484 L110,521.1484 L100,531.1484 L43,531.1484 L43,514.1484 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="380" x="43" y="514.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="58" y="527.2153">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="293" x="125" y="526.3589">[@intervalMin IS NULL =&gt; segment record NOT FOUND]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="157" y1="552.4141" y2="552.4141"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="157" x2="157" y1="552.4141" y2="565.4141"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="116" x2="157" y1="565.4141" y2="565.4141"/><polygon fill="#A80036" points="126,561.4141,116,565.4141,126,569.4141,122,565.4141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="122" y="547.3481">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="133" y="547.3481">Set @intervalMin = 0</text><path d="M43,594.4141 L160,594.4141 L160,601.4141 L150,611.4141 L43,611.4141 L43,594.4141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="334.125" style="stroke: #000000; stroke-width: 2.0;" width="1497" x="43" y="594.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="58" y="607.481">Do Cleanup</text><polygon fill="#A80036" points="780,628.6797,790,632.6797,780,636.6797,784,632.6797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="786" y1="632.6797" y2="632.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="122" y="627.6138">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="133" y="627.6138">Clean up transferTimeout from finalised transfers</text><polygon fill="#A80036" points="1245,657.8125,1255,661.8125,1245,665.8125,1249,661.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="802" x2="1251" y1="661.8125" y2="661.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="809" y="656.7466">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="820" y="656.7466">Clean up transferTimeout from finalised transfers</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="1003,704.8125,1520,704.8125,1530,798.8125,1520,893.8125,1003,893.8125,993,798.8125,1003,704.8125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="1005" y="720.8794">DELETE tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1005" y="736.0122">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="1043" y="736.0122">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="1151" y="736.0122">AS tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="513" x="1005" y="751.145">JOIN (SELECT tsc.transferId, MAX(tsc.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1023" y="766.2778">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="1061" y="766.2778">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1169" y="766.2778">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1023" y="781.4106">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1053" y="781.4106">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1191" y="781.4106">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="1023" y="796.5435">ON tsc.transferId = tt1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="1023" y="811.6763">GROUP BY transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="1005" y="826.8091">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1005" y="841.9419">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1035" y="841.9419">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1173" y="841.9419">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="1005" y="857.0747">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="1005" y="872.2075">WHERE tsc.transferStateId IN ('RECEIVED_FULFIL', 'COMMITTED', 'FAILED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="458" x="1017" y="887.3403">, 'EXPIRED', 'REJECTED', 'EXPIRED_PREPARED', 'EXPIRED_RESERVED', 'ABORTED')</text><polygon fill="#A80036" points="126,916.5391,116,920.5391,126,924.5391,122,920.5391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="796" y1="920.5391" y2="920.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="132" y="915.4731">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="143" y="915.4731">Return success</text><path d="M43,942.5391 L405,942.5391 L405,949.5391 L395,959.5391 L43,959.5391 L43,942.5391 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="181.9297" style="stroke: #000000; stroke-width: 2.0;" width="1405" x="43" y="942.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="317" x="58" y="955.606">Determine IntervalMax (Upper limit for inclusion)</text><polygon fill="#A80036" points="780,976.8047,790,980.8047,780,984.8047,784,980.8047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="786" y1="980.8047" y2="980.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="122" y="975.7388">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="140" y="975.7388">Get last transferStateChangeId as @intervalMax</text><polygon fill="#A80036" points="1245,1005.9375,1255,1009.9375,1245,1013.9375,1249,1009.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="802" x2="1251" y1="1009.9375" y2="1009.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="809" y="1004.8716">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="827" y="1004.8716">Get last transferStateChangeId as @intervalMax</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="1096,1022.9375,1428,1022.9375,1438,1041.9375,1428,1060.9375,1096,1060.9375,1086,1041.9375,1096,1022.9375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="1098" y="1039.0044">SELECT MAX(transferStateChangeId) INTO @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1098" y="1054.1372">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1136" y="1054.1372">transferStateChange</text><polygon fill="#A80036" points="813,1083.3359,803,1087.3359,813,1091.3359,809,1087.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="807" x2="1261" y1="1087.3359" y2="1087.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="819" y="1082.27">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="837" y="1082.27">Return @intervalMax</text><polygon fill="#A80036" points="126,1112.4688,116,1116.4688,126,1120.4688,122,1116.4688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="796" y1="1116.4688" y2="1116.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="132" y="1111.4028">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="150" y="1111.4028">Return @intervalMax</text><path d="M43,1138.4688 L385,1138.4688 L385,1145.4688 L375,1155.4688 L43,1155.4688 L43,1138.4688 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1638.1563" style="stroke: #000000; stroke-width: 2.0;" width="1548" x="43" y="1138.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="297" x="58" y="1151.5356">Prepare data and return the list for expiration</text><polygon fill="#A80036" points="780,1172.7344,790,1176.7344,780,1180.7344,784,1176.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="786" y1="1176.7344" y2="1176.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="122" y="1171.6685">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="140" y="1171.6685">Prepare data and get transfers to be expired</text><path d="M741,1191.7344 L891,1191.7344 L891,1198.7344 L881,1208.7344 L741,1208.7344 L741,1191.7344 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1139.5703" style="stroke: #000000; stroke-width: 2.0;" width="840" x="741" y="1191.7344"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="756" y="1204.8013">DB TRANSACTION</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="802" x2="844" y1="1230" y2="1230"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="844" y1="1230" y2="1243"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="803" x2="844" y1="1243" y2="1243"/><polygon fill="#A80036" points="813,1239,803,1243,813,1247,809,1243" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="809" y="1224.9341">15</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="827" y="1224.9341">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="975" y="1224.9341">= now()</text><polygon fill="#A80036" points="1245,1268.1328,1255,1272.1328,1245,1276.1328,1249,1272.1328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="802" x2="1251" y1="1272.1328" y2="1272.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="809" y="1267.0669">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="827" y="1267.0669">Insert all new transfers still in processing state</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="1022,1315.1328,1501,1315.1328,1511,1409.1328,1501,1504.1328,1022,1504.1328,1012,1409.1328,1022,1315.1328" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="1024" y="1331.1997">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="1104" y="1331.1997">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="1209" y="1331.1997">(transferId, expirationDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="1024" y="1346.3325">SELECT t.transferId, t.expirationDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1024" y="1361.4653">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="53" x="1062" y="1361.4653">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1118" y="1361.4653">t</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="475" x="1024" y="1376.5981">JOIN (SELECT transferId, MAX(transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1042" y="1391.731">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1080" y="1391.731">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="1042" y="1406.8638">WHERE transferStateChangeId &gt; @intervalMin</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="1042" y="1421.9966">AND transferStateChangeId &lt;= @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="1042" y="1437.1294">GROUP BY transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="1024" y="1452.2622">ON ts.transferId = t.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1024" y="1467.395">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1054" y="1467.395">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1192" y="1467.395">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="1024" y="1482.5278">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="373" x="1024" y="1497.6606">WHERE tsc.transferStateId IN ('RECEIVED_PREPARE', 'RESERVED')</text><polygon fill="#A80036" points="1245,1541.9922,1255,1545.9922,1245,1549.9922,1249,1545.9922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="802" x2="1251" y1="1545.9922" y2="1545.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="809" y="1533.3599">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="827" y="1525.7935">Insert transfer state ABORTED for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="827" y="1540.9263">expired RECEIVED_PREPARE transfers</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="964,1588.9922,1560,1588.9922,1570,1697.9922,1560,1807.9922,964,1807.9922,954,1697.9922,964,1588.9922" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="966" y="1605.0591">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1046" y="1605.0591">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="592" x="966" y="1620.1919">SELECT tt.transferId, 'EXPIRED_PREPARED' AS transferStateId, 'Aborted by Timeout Handler' AS reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="966" y="1635.3247">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="1004" y="1635.3247">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="1112" y="1635.3247">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="966" y="1650.4575">JOIN (</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="416" x="1003" y="1650.4575">-- Following subquery is reused 3 times and may be optimized if needed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="493" x="984" y="1665.5903">SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="984" y="1680.7231">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1022" y="1680.7231">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="1160" y="1680.7231">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="984" y="1695.856">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="1014" y="1695.856">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1122" y="1695.856">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="984" y="1710.9888">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="984" y="1726.1216">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="966" y="1741.2544">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="966" y="1756.3872">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="996" y="1756.3872">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1134" y="1756.3872">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="966" y="1771.52">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="966" y="1786.6528">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="966" y="1801.7856">AND tsc.transferStateId = 'RECEIVED_PREPARE'</text><polygon fill="#A80036" points="1245,1846.1172,1255,1850.1172,1245,1854.1172,1249,1850.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="802" x2="1251" y1="1850.1172" y2="1850.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="809" y="1837.4849">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="827" y="1829.9185">Insert transfer state EXPIRED for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="827" y="1845.0513">expired RESERVED transfers</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="963,1893.1172,1561,1893.1172,1571,1995.1172,1561,2097.1172,963,2097.1172,953,1995.1172,963,1893.1172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="965" y="1909.1841">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1045" y="1909.1841">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="594" x="965" y="1924.3169">SELECT tt.transferId, 'RESERVED_TIMEOUT' AS transferStateId, 'Expired by Timeout Handler' AS reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="965" y="1939.4497">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="1003" y="1939.4497">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="1111" y="1939.4497">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="965" y="1954.5825">JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="983" y="1969.7153">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1021" y="1969.7153">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="1159" y="1969.7153">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="983" y="1984.8481">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="1013" y="1984.8481">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1121" y="1984.8481">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="983" y="1999.981">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="983" y="2015.1138">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="965" y="2030.2466">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="965" y="2045.3794">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="995" y="2045.3794">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1133" y="2045.3794">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="965" y="2060.5122">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="965" y="2075.645">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="965" y="2090.7778">AND tsc.transferStateId = 'RESERVED'</text><polygon fill="#A80036" points="1245,2119.9766,1255,2123.9766,1245,2127.9766,1249,2123.9766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="802" x2="1251" y1="2123.9766" y2="2123.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="809" y="2118.9106">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="827" y="2118.9106">Update segment table to be used for the next run</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="1072,2166.9766,1451,2166.9766,1461,2245.9766,1451,2325.9766,1072,2325.9766,1062,2245.9766,1072,2166.9766" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1074" y="2183.0435">IF @intervalMin = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="1086" y="2198.1763">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="1086" y="2213.3091">INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="55" x="1120" y="2213.3091">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="1175" y="2213.3091">(segmentType, enumeration, tableName, value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="1086" y="2228.4419">VALUES ('timeout', 0, 'transferStateChange', @intervalMax)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1074" y="2243.5747">ELSE</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="1086" y="2258.7075">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="55" x="1136" y="2258.7075">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="1086" y="2273.8403">SET value = @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="1086" y="2288.9731">WHERE segmentType = 'timeout'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1086" y="2304.106">AND enumeration = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="1086" y="2319.2388">AND tableName = 'transferStateChange'</text><polygon fill="#A80036" points="1245,2355.4375,1255,2359.4375,1245,2363.4375,1249,2359.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="802" x2="1251" y1="2359.4375" y2="2359.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="809" y="2354.3716">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="827" y="2354.3716">Get list of transfers to be expired with current state</text><polygon fill="#FFFFE0" filter="url(#fjoi852c0kfq7)" points="996,2372.4375,1527,2372.4375,1537,2542.4375,1527,2712.4375,996,2712.4375,986,2542.4375,996,2372.4375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="998" y="2388.5044">SELECT tt.*, tsc.transferStateId, tp1.participantCurrencyId payerParticipantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="1022" y="2403.6372">tp2.participantCurrencyId payeeParticipantId, bta.bulkTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="998" y="2418.77">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="1036" y="2418.77">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="1144" y="2418.77">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="527" x="998" y="2433.9028">JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1022" y="2449.0356">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1060" y="2449.0356">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="1198" y="2449.0356">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1022" y="2464.1685">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="1052" y="2464.1685">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1160" y="2464.1685">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="1022" y="2479.3013">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1022" y="2494.4341">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="998" y="2509.5669">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="998" y="2524.6997">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1028" y="2524.6997">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="1166" y="2524.6997">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="998" y="2539.8325">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="998" y="2554.9653">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="1028" y="2554.9653">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1157" y="2554.9653">tp1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="998" y="2570.0981">ON tp1.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="998" y="2585.231">AND tp1.transferParticipantRoleTypeId = {PAYER_DFSP}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="998" y="2600.3638">AND tp1.ledgerEntryTypeId = {PRINCIPLE_VALUE}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="998" y="2615.4966">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="1028" y="2615.4966">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1157" y="2615.4966">tp2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="998" y="2630.6294">ON tp2.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="998" y="2645.7622">AND tp2.transferParticipantRoleTypeId = {PAYEE_DFSP}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="998" y="2660.895">AND tp2.ledgerEntryTypeId = {PRINCIPLE_VALUE}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="998" y="2676.0278">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1057" y="2676.0278">bulkTransferAssociation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1214" y="2676.0278">bta</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="998" y="2691.1606">ON bta.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="998" y="2706.2935">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><polygon fill="#A80036" points="813,2735.4922,803,2739.4922,813,2743.4922,809,2739.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="807" x2="1261" y1="2739.4922" y2="2739.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="819" y="2734.4263">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="837" y="2734.4263">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="128" x="880" y="2734.4263">transferTimeoutList</text><polygon fill="#A80036" points="126,2764.625,116,2768.625,126,2772.625,122,2768.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="796" y1="2768.625" y2="2768.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="132" y="2763.5591">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="150" y="2763.5591">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="128" x="193" y="2763.5591">transferTimeoutList</text><path d="M23,2790.625 L96,2790.625 L96,2797.625 L86,2807.625 L23,2807.625 L23,2790.625 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2691.6016" style="stroke: #000000; stroke-width: 2.0;" width="748" x="23" y="2790.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="38" y="2803.6919">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="153" x="111" y="2802.8354">[for each transfer in the list]</text><path d="M33,2839.7578 L96,2839.7578 L96,2846.7578 L86,2856.7578 L33,2856.7578 L33,2839.7578 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2635.4688" style="stroke: #000000; stroke-width: 2.0;" width="728" x="33" y="2839.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="48" y="2852.8247">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="343" x="111" y="2851.9683">[transferTimeoutList.bulkTransferId == NULL (Regular Transfer)]</text><path d="M43,2863.8906 L106,2863.8906 L106,2870.8906 L96,2880.8906 L43,2880.8906 L43,2863.8906 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1439.0938" style="stroke: #000000; stroke-width: 2.0;" width="470" x="43" y="2863.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="58" y="2876.9575">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="121" y="2876.1011">[transferStateId == 'RECEIVED_PREPARE']</text><path d="M120,2886.0234 L120,3516.0234 L476,3516.0234 L476,2896.0234 L466,2886.0234 L120,2886.0234 " fill="#FFFF00" filter="url(#fjoi852c0kfq7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M466,2886.0234 L466,2896.0234 L476,2896.0234 L466,2886.0234 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="126" y="2903.0903">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="126" y="2918.2231">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="138" y="2933.356">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="138" y="2948.4888">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="138" y="2963.6216">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="138" y="2978.7544">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="138" y="2993.8872">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="59" x="150" y="3009.02">headers: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="162" y="3024.1528">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="162" y="3039.2856">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="162" y="3054.4185">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="162" y="3069.5513">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="162" y="3084.6841">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="162" y="3099.8169">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="162" y="3114.9497">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="162" y="3130.0825">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="162" y="3145.2153">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="162" y="3160.3481">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="150" y="3175.481">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="150" y="3190.6138">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="162" y="3205.7466">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="174" y="3220.8794">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="174" y="3236.0122">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="174" y="3251.145">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="162" y="3266.2778">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="150" y="3281.4106">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="138" y="3296.5435">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="138" y="3311.6763">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="150" y="3326.8091">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="162" y="3341.9419">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="162" y="3357.0747">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="162" y="3372.2075">action: timeout-received,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="162" y="3387.3403">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="162" y="3402.4731">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="174" y="3417.606">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="174" y="3432.7388">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="174" y="3447.8716">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="162" y="3463.0044">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="150" y="3478.1372">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="138" y="3493.27">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="126" y="3508.4028">}</text><polygon fill="#A80036" points="439,3542.6016,449,3546.6016,439,3550.6016,443,3546.6016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="445" y1="3546.6016" y2="3546.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="122" y="3541.5356">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="140" y="3541.5356">Publish Notification event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="513" y1="3585.6016" y2="3585.6016"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="48" y="3595.812">[transferStateId == 'RESERVED']</text><path d="M120,3604.4063 L120,4234.4063 L476,4234.4063 L476,3614.4063 L466,3604.4063 L120,3604.4063 " fill="#FFFF00" filter="url(#fjoi852c0kfq7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M466,3604.4063 L466,3614.4063 L476,3614.4063 L466,3604.4063 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="126" y="3621.4731">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="126" y="3636.606">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="138" y="3651.7388">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="138" y="3666.8716">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="138" y="3682.0044">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="138" y="3697.1372">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="138" y="3712.27">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="59" x="150" y="3727.4028">headers: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="162" y="3742.5356">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="162" y="3757.6685">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="162" y="3772.8013">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="162" y="3787.9341">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="162" y="3803.0669">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="162" y="3818.1997">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="162" y="3833.3325">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="162" y="3848.4653">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="162" y="3863.5981">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="162" y="3878.731">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="150" y="3893.8638">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="150" y="3908.9966">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="162" y="3924.1294">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="174" y="3939.2622">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="174" y="3954.395">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="174" y="3969.5278">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="162" y="3984.6606">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="150" y="3999.7935">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="138" y="4014.9263">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="138" y="4030.0591">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="150" y="4045.1919">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="162" y="4060.3247">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="162" y="4075.4575">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="162" y="4090.5903">action: timeout-reserved,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="162" y="4105.7231">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="162" y="4120.856">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="174" y="4135.9888">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="174" y="4151.1216">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="174" y="4166.2544">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="162" y="4181.3872">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="150" y="4196.52">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="138" y="4211.6528">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="126" y="4226.7856">}</text><polygon fill="#A80036" points="318,4260.9844,328,4264.9844,318,4268.9844,322,4264.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="324" y1="4264.9844" y2="4264.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="122" y="4259.9185">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="140" y="4259.9185">Route &amp; Publish Position event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="761" y1="4310.9844" y2="4310.9844"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="38" y="4321.1948">[Individual Transfer from a Bulk]</text><path d="M43,4331.7891 L106,4331.7891 L106,4338.7891 L96,4348.7891 L43,4348.7891 L43,4331.7891 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1136.4375" style="stroke: #000000; stroke-width: 2.0;" width="708" x="43" y="4331.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="58" y="4344.856">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="121" y="4343.9995">[transferStateId == 'RECEIVED_PREPARE']</text><path d="M120,4353.9219 L120,4832.9219 L476,4832.9219 L476,4363.9219 L466,4353.9219 L120,4353.9219 " fill="#FFFF00" filter="url(#fjoi852c0kfq7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M466,4353.9219 L466,4363.9219 L476,4363.9219 L466,4353.9219 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="126" y="4370.9888">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="126" y="4386.1216">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="138" y="4401.2544"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="138" y="4401.2544">id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="149" y="4401.2544">: &lt;transferTimeoutList.bulkTransferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="138" y="4416.3872"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="59" x="138" y="4416.3872">transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="197" y="4416.3872">: &lt;transferTimeoutList.transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="138" y="4431.52">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="138" y="4446.6528">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="138" y="4461.7856">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="138" y="4476.9185">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="150" y="4492.0513">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="150" y="4507.1841">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="162" y="4522.3169">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="174" y="4537.4497">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="174" y="4552.5825">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="174" y="4567.7153">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="162" y="4582.8481">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="150" y="4597.981">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="138" y="4613.1138">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="138" y="4628.2466">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="150" y="4643.3794">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="162" y="4658.5122">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="162" y="4673.645">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="162" y="4688.7778">action: timeout-received,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="162" y="4703.9106">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="162" y="4719.0435">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="174" y="4734.1763">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="174" y="4749.3091">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="174" y="4764.4419">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="162" y="4779.5747">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="150" y="4794.7075">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="138" y="4809.8403">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="126" y="4824.9731">}</text><polygon fill="#A80036" points="662.5,4859.1719,672.5,4863.1719,662.5,4867.1719,666.5,4863.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="668.5" y1="4863.1719" y2="4863.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="122" y="4858.106">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="140" y="4858.106">Publish to Bulk Processing topic</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="751" y1="4902.1719" y2="4902.1719"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="48" y="4912.3823">[transferStateId == 'RESERVED']</text><path d="M120,4920.9766 L120,5399.9766 L476,5399.9766 L476,4930.9766 L466,4920.9766 L120,4920.9766 " fill="#FFFF00" filter="url(#fjoi852c0kfq7)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M466,4920.9766 L466,4930.9766 L476,4930.9766 L466,4920.9766 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="126" y="4938.0435">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="126" y="4953.1763">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="138" y="4968.3091"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="138" y="4968.3091">id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="149" y="4968.3091">: &lt;transferTimeoutList.bulkTransferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="138" y="4983.4419"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="59" x="138" y="4983.4419">transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="197" y="4983.4419">: &lt;transferTimeoutList.transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="138" y="4998.5747">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="138" y="5013.7075">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="138" y="5028.8403">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="138" y="5043.9731">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="150" y="5059.106">headers: &lt;bulkTransferHeaders&gt;,,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="150" y="5074.2388">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="162" y="5089.3716">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="174" y="5104.5044">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="174" y="5119.6372">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="174" y="5134.77">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="162" y="5149.9028">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="150" y="5165.0356">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="138" y="5180.1685">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="138" y="5195.3013">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="150" y="5210.4341">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="162" y="5225.5669">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="162" y="5240.6997">type: bulk-position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="162" y="5255.8325">action: timeout-reserved,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="162" y="5270.9653">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="162" y="5286.0981">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="174" y="5301.231">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="174" y="5316.3638">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="174" y="5331.4966">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="162" y="5346.6294">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="150" y="5361.7622">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="138" y="5376.895">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="126" y="5392.0278">}</text><polygon fill="#A80036" points="318,5426.2266,328,5430.2266,318,5434.2266,322,5430.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="324" y1="5430.2266" y2="5430.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="122" y="5425.1606">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="140" y="5425.1606">Route &amp; Publish Position event</text><!--
@startuml
title 3.1.1. Timeout Handler Consume (incl. Bulk Transfer)

autonumber


control "Transfer Timeout\nHandler" as TIMEOUT_HANDLER
collections "topic-\ntransfer-position" as TOPIC_TRANSFER_POSITION
collections "topic-\nnotification" as NOTIFICATIONS_TOPIC
collections "topic-event" as EVENT_TOPIC
collections "topic-\nbulk-processing" as BULK_PROCESSING_TOPIC
entity "Segment DAO" as SEGMENT_DAO
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TIMEOUT_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant NOTIFICATIONS_TOPIC
    participant EVENT_TOPIC
    participant BULK_PROCESSING_TOPIC
    participant POS_DAO
    participant SEGMENT_DAO
    participant DB
end box


group Timeout Handler Consume
    activate TIMEOUT_HANDLER
    group Persist Event Information
        TIMEOUT_HANDLER -> EVENT_TOPIC: Publish event information
        ref over TIMEOUT_HANDLER, EVENT_TOPIC :  Event Handler Consume\n
    end

    group Get previous checkpoint of last record processed (Lower limit for inclusion)
        TIMEOUT_HANDLER -> SEGMENT_DAO: Get last segment as @intervalMin
        activate SEGMENT_DAO
        SEGMENT_DAO -> DB: Get last segment as @intervalMin
        hnote over DB #lightyellow
            SELECT value INTO @intervalMin
            FROM **segment**
            WHERE segmentType = 'timeout'
            AND enumeration = 0
            AND tableName = 'transferStateChange'
        end note
        activate DB
        DB - -> SEGMENT_DAO: Return @intervalMin
        deactivate DB
        SEGMENT_DAO - -> TIMEOUT_HANDLER: Return @intervalMin
        deactivate SEGMENT_DAO
        opt @intervalMin IS NULL => segment record NOT FOUND
            TIMEOUT_HANDLER->TIMEOUT_HANDLER: Set @intervalMin = 0
        end
    end

    group Do Cleanup
        TIMEOUT_HANDLER -> POS_DAO: Clean up transferTimeout from finalised transfers
        activate POS_DAO
        POS_DAO -> DB: Clean up transferTimeout from finalised transfers
        hnote over DB #lightyellow
            DELETE tt
            FROM **transferTimeout** AS tt
            JOIN (SELECT tsc.transferId, MAX(tsc.transferStateChangeId) maxTransferStateChangeId
                  FROM **transferTimeout** tt1
                  JOIN **transferStateChange** tsc
                  ON tsc.transferId = tt1.transferId
                  GROUP BY transferId) ts
            ON ts.transferId = tt.transferId
            JOIN **transferStateChange** tsc
            ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
            WHERE tsc.transferStateId IN ('RECEIVED_FULFIL', 'COMMITTED', 'FAILED'
                , 'EXPIRED', 'REJECTED', 'EXPIRED_PREPARED', 'EXPIRED_RESERVED', 'ABORTED')
        end note
        activate DB
        deactivate DB
        POS_DAO - -> TIMEOUT_HANDLER: Return success
        deactivate POS_DAO
    end

    group Determine IntervalMax (Upper limit for inclusion)
        TIMEOUT_HANDLER -> POS_DAO: Get last transferStateChangeId as @intervalMax
        activate POS_DAO
        POS_DAO -> DB: Get last transferStateChangeId as @intervalMax
        hnote over DB #lightyellow
            SELECT MAX(transferStateChangeId) INTO @intervalMax
            FROM **transferStateChange**
        end note
        activate DB
        DB - -> POS_DAO: Return @intervalMax
        deactivate DB
        POS_DAO - -> TIMEOUT_HANDLER: Return @intervalMax
        deactivate POS_DAO
    end

    
    group Prepare data and return the list for expiration
        TIMEOUT_HANDLER -> POS_DAO: Prepare data and get transfers to be expired
        activate POS_DAO
        group <color #blue>DB TRANSACTION</color>
            POS_DAO <-> POS_DAO: **transactionTimestamp** = now()
            POS_DAO -> DB: Insert all new transfers still in processing state
            hnote over DB #lightyellow
                INSERT INTO **transferTimeout**(transferId, expirationDate)
                SELECT t.transferId, t.expirationDate
                FROM **transfer** t
                JOIN (SELECT transferId, MAX(transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange**
                      WHERE transferStateChangeId > @intervalMin
                      AND transferStateChangeId <= @intervalMax
                      GROUP BY transferId) ts
                ON ts.transferId = t.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tsc.transferStateId IN ('RECEIVED_PREPARE', 'RESERVED')
            end note
            activate DB
            deactivate DB

            POS_DAO -> DB: Insert transfer state ABORTED for\nexpired RECEIVED_PREPARE transfers
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange**
                SELECT tt.transferId, 'EXPIRED_PREPARED' AS transferStateId, 'Aborted by Timeout Handler' AS reason
                FROM **transferTimeout** tt
                JOIN ( <color #FF0000>- - Following subquery is reused 3 times and may be optimized if needed</color>
                      SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange** tsc1
                      JOIN **transferTimeout** tt1
                      ON tt1.transferId = tsc1.transferId
                      GROUP BY tsc1.transferId) ts
                ON ts.transferId = tt.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tt.expirationDate < {transactionTimestamp}
                AND tsc.transferStateId = 'RECEIVED_PREPARE'
            end note
            activate DB
            deactivate DB

            POS_DAO -> DB: Insert transfer state EXPIRED for\nexpired RESERVED transfers
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange**
                SELECT tt.transferId, 'RESERVED_TIMEOUT' AS transferStateId, 'Expired by Timeout Handler' AS reason
                FROM **transferTimeout** tt
                JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange** tsc1
                      JOIN **transferTimeout** tt1
                      ON tt1.transferId = tsc1.transferId
                      GROUP BY tsc1.transferId) ts
                ON ts.transferId = tt.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tt.expirationDate < {transactionTimestamp}
                AND tsc.transferStateId = 'RESERVED'
            end note
            activate DB
            deactivate DB

            POS_DAO -> DB: Update segment table to be used for the next run
            hnote over DB #lightyellow
                IF @intervalMin = 0
                    INSERT
                    INTO **segment**(segmentType, enumeration, tableName, value)
                    VALUES ('timeout', 0, 'transferStateChange', @intervalMax)
                ELSE
                    UPDATE **segment**
                    SET value = @intervalMax
                    WHERE segmentType = 'timeout'
                    AND enumeration = 0
                    AND tableName = 'transferStateChange'
            end note
            activate DB
            deactivate DB
        end

        POS_DAO -> DB: Get list of transfers to be expired with current state
        hnote over DB #lightyellow
            SELECT tt.*, tsc.transferStateId, tp1.participantCurrencyId payerParticipantId, 
                    tp2.participantCurrencyId payeeParticipantId, bta.bulkTransferId
            FROM **transferTimeout** tt
            JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                    FROM **transferStateChange** tsc1
                    JOIN **transferTimeout** tt1
                    ON tt1.transferId = tsc1.transferId
                    GROUP BY tsc1.transferId) ts
            ON ts.transferId = tt.transferId
            JOIN **transferStateChange** tsc
            ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
            JOIN **transferParticipant** tp1
            ON tp1.transferId = tt.transferId
            AND tp1.transferParticipantRoleTypeId = {PAYER_DFSP}
            AND tp1.ledgerEntryTypeId = {PRINCIPLE_VALUE}
            JOIN **transferParticipant** tp2
            ON tp2.transferId = tt.transferId
            AND tp2.transferParticipantRoleTypeId = {PAYEE_DFSP}
            AND tp2.ledgerEntryTypeId = {PRINCIPLE_VALUE}
            LEFT JOIN **bulkTransferAssociation** bta
            ON bta.transferId = tt.transferId
            WHERE tt.expirationDate < {transactionTimestamp}
        end note
        activate DB
        POS_DAO <- - DB: Return **transferTimeoutList**
        deactivate DB
        POS_DAO - -> TIMEOUT_HANDLER: Return **transferTimeoutList**
        deactivate POS_DAO
    end

    loop for each transfer in the list
        |||
        alt transferTimeoutList.bulkTransferId == NULL (Regular Transfer)
            alt transferStateId == 'RECEIVED_PREPARE'
                note right of TIMEOUT_HANDLER #yellow
                    Message:
                    {
                        id: <transferId>,
                        from: <payerParticipantId>,
                        to: <payeeParticipantId>,
                        type: application/json,
                        content: {
                            headers: {
                                Content-Length: <Content-Length>,
                                Content-Type: <Content-Type>,
                                Date: <Date>,
                                X-Forwarded-For: <X-Forwarded-For>,
                                FSPIOP-Source: <FSPIOP-Source>,
                                FSPIOP-Destination: <FSPIOP-Destination>,
                                FSPIOP-Encryption: <FSPIOP-Encryption>,
                                FSPIOP-Signature: <FSPIOP-Signature>,
                                FSPIOP-URI: <FSPIOP-URI>,
                                FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
                            },
                            payload: {
                                "errorInformation": {
                                    "errorCode": 3303,
                                    "errorDescription": "Transfer expired",
                                    "extensionList": <transferMessage.extensionList>
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                type: notification,
                                action: timeout-received,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: <errorInformation.errorCode>
                                    description: <errorInformation.errorDescription>
                                }
                            }
                        }
                    }
                end note
                TIMEOUT_HANDLER -> NOTIFICATIONS_TOPIC: Publish Notification event
                activate NOTIFICATIONS_TOPIC
                deactivate NOTIFICATIONS_TOPIC
            else transferStateId == 'RESERVED'
                note right of TIMEOUT_HANDLER #yellow
                    Message:
                    {
                        id: <transferId>,
                        from: <payerParticipantId>,
                        to: <payeeParticipantId>,
                        type: application/json,
                        content: {
                            headers: {
                                Content-Length: <Content-Length>,
                                Content-Type: <Content-Type>,
                                Date: <Date>,
                                X-Forwarded-For: <X-Forwarded-For>,
                                FSPIOP-Source: <FSPIOP-Source>,
                                FSPIOP-Destination: <FSPIOP-Destination>,
                                FSPIOP-Encryption: <FSPIOP-Encryption>,
                                FSPIOP-Signature: <FSPIOP-Signature>,
                                FSPIOP-URI: <FSPIOP-URI>,
                                FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
                            },
                            payload: {
                                "errorInformation": {
                                    "errorCode": 3303,
                                    "errorDescription": "Transfer expired",
                                    "extensionList": <transferMessage.extensionList>
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                type: position,
                                action: timeout-reserved,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: <errorInformation.errorCode>
                                    description: <errorInformation.errorDescription>
                                }
                            }
                        }
                    }
                end note
                TIMEOUT_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event
                activate TOPIC_TRANSFER_POSITION
                deactivate TOPIC_TRANSFER_POSITION
            end
        else Individual Transfer from a Bulk
            alt transferStateId == 'RECEIVED_PREPARE'
                note right of TIMEOUT_HANDLER #yellow
                    Message:
                    {
                        <color #red>id</color>: <transferTimeoutList.bulkTransferId>,
                        <color #red>transferId</color>: <transferTimeoutList.transferId>,
                        from: <payerParticipantId>,
                        to: <payeeParticipantId>,
                        type: application/json,
                        content: {
                            headers: <bulkTransferHeaders>,
                            payload: {
                                "errorInformation": {
                                    "errorCode": 3303,
                                    "errorDescription": "Transfer expired",
                                    "extensionList": <transferMessage.extensionList>
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                type: bulk-processing,
                                action: timeout-received,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: <errorInformation.errorCode>
                                    description: <errorInformation.errorDescription>
                                }
                            }
                        }
                    }
                end note
                TIMEOUT_HANDLER -> BULK_PROCESSING_TOPIC: Publish to Bulk Processing topic
                activate BULK_PROCESSING_TOPIC
                deactivate BULK_PROCESSING_TOPIC
            else transferStateId == 'RESERVED'
                note right of TIMEOUT_HANDLER #yellow
                    Message:
                    {
                        <color #red>id</color>: <transferTimeoutList.bulkTransferId>,
                        <color #red>transferId</color>: <transferTimeoutList.transferId>,
                        from: <payerParticipantId>,
                        to: <payeeParticipantId>,
                        type: application/json,
                        content: {
                            headers: <bulkTransferHeaders>,,
                            payload: {
                                "errorInformation": {
                                    "errorCode": 3303,
                                    "errorDescription": "Transfer expired",
                                    "extensionList": <transferMessage.extensionList>
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                type: bulk-position,
                                action: timeout-reserved,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: <errorInformation.errorCode>
                                    description: <errorInformation.errorDescription>
                                }
                            }
                        }
                    }
                end note
                TIMEOUT_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event
                activate TOPIC_TRANSFER_POSITION
                deactivate TOPIC_TRANSFER_POSITION
            end
        end
    end

    deactivate TIMEOUT_HANDLER
end
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
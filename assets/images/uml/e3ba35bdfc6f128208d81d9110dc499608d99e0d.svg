<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3161px" preserveAspectRatio="none" style="width:1271px;height:3161px;" version="1.1" viewBox="0 0 1271 3161" width="1271px" zoomAndPan="magnify"><defs><filter height="300%" id="fosmwa0sby7f8" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="327" x="473" y="22.9951">6.2.6. Settlement Abort (abortSettlementById)</text><rect fill="#FFB6C1" height="3116.6875" style="stroke: #A80036; stroke-width: 1.0;" width="107" x="136" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="151" y="46.3638">Central HUB</text><rect fill="#90EE90" height="3116.6875" style="stroke: #A80036; stroke-width: 1.0;" width="392" x="311" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="123" x="445.5" y="46.3638">Settlement Service</text><rect fill="#FFFFE0" height="3116.6875" style="stroke: #A80036; stroke-width: 1.0;" width="110" x="930.5" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="104" x="933.5" y="46.3638">Central Services</text><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="2907.9609" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="184.5" y="146.7266"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="2756.1641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="386.5" y="276.5234"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="2358.7734" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="638.5" y="320.7891"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="137.9297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="349.9219"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="749.3984"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="153.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="993.3984"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="228.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="1352.6563"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="183.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="1610.5156"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="1847.1094"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="1980.6406"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="2194.7031"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="2328.2344"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="92.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="2451.6328"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="2573.2969"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="2893.9609" style="stroke: #000000; stroke-width: 2.0;" width="1248" x="12" y="153.7266"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="797.5391" style="stroke: #000000; stroke-width: 2.0;" width="682" x="568" y="502.8516"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="131.9297" style="stroke: #000000; stroke-width: 2.0;" width="351" x="643" y="550.3984"/><rect fill="#FFFFFF" height="268.1328" style="stroke: none; stroke-width: 1.0;" width="682" x="568" y="689.3281"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="239.3281" style="stroke: #000000; stroke-width: 2.0;" width="565" x="578" y="711.1328"/><rect fill="#FFFFFF" height="342.9297" style="stroke: none; stroke-width: 1.0;" width="682" x="568" y="957.4609"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="131.9297" style="stroke: #000000; stroke-width: 2.0;" width="450" x="643" y="1161.4609"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="1337.0391" style="stroke: #000000; stroke-width: 2.0;" width="645" x="568" y="1314.3906"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="242.9297" style="stroke: #000000; stroke-width: 2.0;" width="625" x="578" y="1808.8438"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="242.9297" style="stroke: #000000; stroke-width: 2.0;" width="585" x="578" y="2156.4375"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="231.0625" style="stroke: #000000; stroke-width: 2.0;" width="565" x="578" y="2413.3672"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="346.125" style="stroke: #000000; stroke-width: 2.0;" width="514" x="22" y="2694.5625"/><rect fill="#FFFFFF" height="200.1953" style="stroke: none; stroke-width: 1.0;" width="514" x="22" y="2840.4922"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="189" x2="189" y1="136.7266" y2="3064.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="391" x2="391" y1="136.7266" y2="3064.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="643" x2="643" y1="136.7266" y2="3064.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="985.5" x2="985.5" y1="136.7266" y2="3064.6875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="140" y="133.4248">Hub Employee</text><ellipse cx="189.5" cy="63.4297" fill="#FEFECE" filter="url(#fosmwa0sby7f8)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M189.5,71.4297 L189.5,98.4297 M176.5,79.4297 L202.5,79.4297 M189.5,98.4297 L176.5,113.4297 M189.5,98.4297 L202.5,113.4297 " fill="none" filter="url(#fosmwa0sby7f8)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="140" y="3076.6826">Hub Employee</text><ellipse cx="189.5" cy="3089.9844" fill="#FEFECE" filter="url(#fosmwa0sby7f8)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M189.5,3097.9844 L189.5,3124.9844 M176.5,3105.9844 L202.5,3105.9844 M189.5,3124.9844 L176.5,3139.9844 M189.5,3124.9844 L202.5,3139.9844 " fill="none" filter="url(#fosmwa0sby7f8)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="315" y="133.4248">Settlement Service API</text><path d="M371,92.4297 L371,116.4297 M371,104.4297 L388,104.4297 " fill="none" filter="url(#fosmwa0sby7f8)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="400" cy="104.4297" fill="#FEFECE" filter="url(#fosmwa0sby7f8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="315" y="3076.6826">Settlement Service API</text><path d="M371,3083.9844 L371,3107.9844 M371,3095.9844 L388,3095.9844 " fill="none" filter="url(#fosmwa0sby7f8)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="400" cy="3095.9844" fill="#FEFECE" filter="url(#fosmwa0sby7f8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="588" y="133.4248">Settlement DAO</text><ellipse cx="643.5" cy="104.4297" fill="#FEFECE" filter="url(#fosmwa0sby7f8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="631.5" x2="655.5" y1="118.4297" y2="118.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="588" y="3076.6826">Settlement DAO</text><ellipse cx="643.5" cy="3095.9844" fill="#FEFECE" filter="url(#fosmwa0sby7f8)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="631.5" x2="655.5" y1="3109.9844" y2="3109.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="941.5" y="133.4248">Central Store</text><path d="M967.5,84.4297 C967.5,74.4297 985.5,74.4297 985.5,74.4297 C985.5,74.4297 1003.5,74.4297 1003.5,84.4297 L1003.5,110.4297 C1003.5,120.4297 985.5,120.4297 985.5,120.4297 C985.5,120.4297 967.5,120.4297 967.5,110.4297 L967.5,84.4297 " fill="#FEFECE" filter="url(#fosmwa0sby7f8)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M967.5,84.4297 C967.5,94.4297 985.5,94.4297 985.5,94.4297 C985.5,94.4297 1003.5,94.4297 1003.5,84.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="941.5" y="3076.6826">Central Store</text><path d="M967.5,3089.9844 C967.5,3079.9844 985.5,3079.9844 985.5,3079.9844 C985.5,3079.9844 1003.5,3079.9844 1003.5,3089.9844 L1003.5,3115.9844 C1003.5,3125.9844 985.5,3125.9844 985.5,3125.9844 C985.5,3125.9844 967.5,3125.9844 967.5,3115.9844 L967.5,3089.9844 " fill="#FEFECE" filter="url(#fosmwa0sby7f8)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M967.5,3089.9844 C967.5,3099.9844 985.5,3099.9844 985.5,3099.9844 C985.5,3099.9844 1003.5,3099.9844 1003.5,3089.9844 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="2907.9609" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="184.5" y="146.7266"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="2756.1641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="386.5" y="276.5234"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="2358.7734" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="638.5" y="320.7891"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="137.9297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="349.9219"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="749.3984"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="153.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="993.3984"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="228.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="1352.6563"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="183.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="1610.5156"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="1847.1094"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="1980.6406"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="2194.7031"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="2328.2344"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="92.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="2451.6328"/><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="980.5" y="2573.2969"/><path d="M12,153.7266 L169,153.7266 L169,160.7266 L159,170.7266 L12,170.7266 L12,153.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2893.9609" style="stroke: #000000; stroke-width: 2.0;" width="1248" x="12" y="153.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="27" y="166.7935">Settlement Abort</text><path d="M199,175.8594 L199,245.8594 L409,245.8594 L409,185.8594 L399,175.8594 L199,175.8594 " fill="#FFFF00" filter="url(#fosmwa0sby7f8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M399,175.8594 L399,185.8594 L409,185.8594 L399,175.8594 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="205" y="192.9263">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="217" y="208.0591">"state": "ABORTED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="217" y="223.1919">"reason": {abortReasonString}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="205" y="238.3247">}</text><polygon fill="#A80036" points="374.5,272.5234,384.5,276.5234,374.5,280.5234,378.5,276.5234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="194.5" x2="380.5" y1="276.5234" y2="276.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="201.5" y="271.4575">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="212.5" y="271.4575">PUT - /settlement/{id}</text><polygon fill="#A80036" points="626.5,316.7891,636.5,320.7891,626.5,324.7891,630.5,320.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396.5" x2="632.5" y1="320.7891" y2="320.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="403.5" y="308.1567">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="414.5" y="300.5903">abortSettlementById facade method</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="414.5" y="315.7231">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="488.5" y="315.7231">2001</text><polygon fill="#A80036" points="968.5,345.9219,978.5,349.9219,968.5,353.9219,972.5,349.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="648.5" x2="974.5" y1="349.9219" y2="349.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="655.5" y="344.856">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="666.5" y="344.856">Retrieve settlement information</text><polygon fill="#FFFFE0" filter="url(#fosmwa0sby7f8)" points="812,362.9219,1159,362.9219,1169,411.9219,1159,460.9219,812,460.9219,802,411.9219,812,362.9219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="814" y="378.9888">SELECT s.settlementId, ssc.settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="826" y="394.1216">ssc.reason, ssc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="814" y="409.2544">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="852" y="409.2544">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="6" x="927" y="409.2544">s</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="814" y="424.3872">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="844" y="424.3872">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1001" y="424.3872">ssc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="814" y="439.52">ON ssc.settlementStateChangeId = s.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="814" y="454.6528">WHERE s.settlementId = {id}</text><polygon fill="#A80036" points="659.5,483.8516,649.5,487.8516,659.5,491.8516,655.5,487.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="653.5" x2="984.5" y1="487.8516" y2="487.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="665.5" y="482.7856">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="676.5" y="482.7856">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="719.5" y="482.7856">settlementData</text><path d="M568,502.8516 L631,502.8516 L631,509.8516 L621,519.8516 L568,519.8516 L568,502.8516 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="797.5391" style="stroke: #000000; stroke-width: 2.0;" width="682" x="568" y="502.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="583" y="515.9185">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="372" x="646" y="515.062">[settlementData.settlementStateId == 'PS_TRANSFERS_COMMITTED'||</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="270" x="646" y="527.8667">settlementData.settlementStateId == 'SETTLING'||</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="256" x="646" y="540.6714">settlementData.settlementStateId == 'SETTLED']</text><path d="M643,550.3984 L726,550.3984 L726,557.3984 L716,567.3984 L643,567.3984 L643,550.3984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="131.9297" style="stroke: #000000; stroke-width: 2.0;" width="351" x="643" y="550.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="658" y="563.4653">break</text><path d="M653,572.5313 L653,672.5313 L980,672.5313 L980,582.5313 L970,572.5313 L653,572.5313 " fill="#FFFF00" filter="url(#fosmwa0sby7f8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M970,572.5313 L970,582.5313 L980,582.5313 L970,572.5313 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="659" y="589.5981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="671" y="604.731">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="683" y="619.8638">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="683" y="634.9966">"errorDescription": "State change is not allowed"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="671" y="650.1294">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="659" y="665.2622">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="568" x2="1250" y1="690.3281" y2="690.3281"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="266" x="573" y="700.5386">[settlementData.settlementStateId == 'ABORTED']</text><path d="M578,711.1328 L661,711.1328 L661,718.1328 L651,728.1328 L578,728.1328 L578,711.1328 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="239.3281" style="stroke: #000000; stroke-width: 2.0;" width="565" x="578" y="711.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="593" y="724.1997">break</text><polygon fill="#A80036" points="968.5,745.3984,978.5,749.3984,968.5,753.3984,972.5,749.3984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="648.5" x2="974.5" y1="749.3984" y2="749.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="655.5" y="744.3325">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="666.5" y="744.3325">Append additional info at settlement level</text><polygon fill="#FFFFE0" filter="url(#fosmwa0sby7f8)" points="848,792.3984,1123,792.3984,1133,818.3984,1123,845.3984,848,845.3984,838,818.3984,848,792.3984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="850" y="808.4653">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="930" y="808.4653">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="862" y="823.5981">(settlementId, settlementStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="850" y="838.731">VALUES ({id}, 'ABORTED', {abortReasonString})</text><path d="M653,855.7969 L653,940.7969 L863,940.7969 L863,865.7969 L853,855.7969 L653,855.7969 " fill="#FFFF00" filter="url(#fosmwa0sby7f8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M853,855.7969 L853,865.7969 L863,865.7969 L853,855.7969 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="659" y="872.8638">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="671" y="887.9966">"id": {id},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="671" y="903.1294">"state": 'ABORTED',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="671" y="918.2622">"reason": {abortReasonString}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="659" y="933.395">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="568" x2="1250" y1="958.4609" y2="958.4609"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="351" x="573" y="968.6714">[settlementData.settlementStateId == 'PS_TRANSFERS_RESERVED']</text><polygon fill="#A80036" points="968.5,989.3984,978.5,993.3984,968.5,997.3984,972.5,993.3984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="648.5" x2="974.5" y1="993.3984" y2="993.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="655.5" y="988.3325">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="666.5" y="988.3325">Find account in PS_TRANSFERS_COMMITTED</text><polygon fill="#FFFFE0" filter="url(#fosmwa0sby7f8)" points="740,1006.3984,1230,1006.3984,1240,1062.3984,1230,1119.3984,740,1119.3984,730,1062.3984,740,1006.3984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="742" y="1022.4653">SELECT spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="742" y="1037.5981">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="780" y="1037.5981">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="20" x="986" y="1037.5981">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="742" y="1052.731">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="285" x="772" y="1052.731">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1060" y="1052.731">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="486" x="742" y="1067.8638">ON spcsc.settlementParticipantCurrencyStateChangeId = spc.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="742" y="1082.9966">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="742" y="1098.1294">AND spcsc.settlementStateId = 'PS_TRANSFERS_COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="742" y="1113.2622">LIMIT 1</text><polygon fill="#A80036" points="659.5,1142.4609,649.5,1146.4609,659.5,1150.4609,655.5,1146.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="653.5" x2="984.5" y1="1146.4609" y2="1146.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="665.5" y="1141.395">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="676.5" y="1141.395">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="177" x="719.5" y="1141.395">transferCommittedAccount</text><path d="M643,1161.4609 L726,1161.4609 L726,1168.4609 L716,1178.4609 L643,1178.4609 L643,1161.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="131.9297" style="stroke: #000000; stroke-width: 2.0;" width="450" x="643" y="1161.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="658" y="1174.5278">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="228" x="741" y="1173.6714">[transferCommittedAccount != undefined]</text><path d="M653,1183.5938 L653,1283.5938 L1079,1283.5938 L1079,1193.5938 L1069,1183.5938 L653,1183.5938 " fill="#FFFF00" filter="url(#fosmwa0sby7f8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1069,1183.5938 L1069,1193.5938 L1079,1193.5938 L1069,1183.5938 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="659" y="1200.6606">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="671" y="1215.7935">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="683" y="1230.9263">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="381" x="683" y="1246.0591">"errorDescription": "At least one settlement transfer is committed"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="671" y="1261.1919">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="659" y="1276.3247">}</text><path d="M568,1314.3906 L718,1314.3906 L718,1321.3906 L708,1331.3906 L568,1331.3906 L568,1314.3906 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1337.0391" style="stroke: #000000; stroke-width: 2.0;" width="645" x="568" y="1314.3906"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="583" y="1327.4575">DB TRANSACTION</text><polygon fill="#A80036" points="968.5,1348.6563,978.5,1352.6563,968.5,1356.6563,972.5,1352.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="648.5" x2="974.5" y1="1352.6563" y2="1352.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="655.5" y="1347.5903">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="666.5" y="1347.5903">Retrive settlement accounts information</text><polygon fill="#FFFFE0" filter="url(#fosmwa0sby7f8)" points="808,1365.6563,1162,1365.6563,1172,1459.6563,1162,1554.6563,808,1554.6563,798,1459.6563,808,1365.6563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="810" y="1381.7231">SELECT pc.participantId, spc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="822" y="1396.856">spcsc.settlementStateId, spcsc.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="822" y="1411.9888">spcsc.createdDate, spc.netAmount, pc.currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="822" y="1427.1216">spc.settlementParticipantCurrencyId AS</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1055" y="1427.1216">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="810" y="1442.2544">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="848" y="1442.2544">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="20" x="1054" y="1442.2544">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="810" y="1457.3872">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="285" x="840" y="1457.3872">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1128" y="1457.3872">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="810" y="1472.52">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="810" y="1487.6528">spc.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="810" y="1502.7856">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="840" y="1502.7856">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="14" x="974" y="1502.7856">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="810" y="1517.9185">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="810" y="1533.0513">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="810" y="1548.1841">FOR UPDATE</text><polygon fill="#A80036" points="659.5,1577.3828,649.5,1581.3828,659.5,1585.3828,655.5,1581.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="653.5" x2="984.5" y1="1581.3828" y2="1581.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="665.5" y="1576.3169">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="676.5" y="1576.3169">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="153" x="719.5" y="1576.3169">settlementAccountsList</text><polygon fill="#A80036" points="968.5,1606.5156,978.5,1610.5156,968.5,1614.5156,972.5,1610.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="648.5" x2="974.5" y1="1610.5156" y2="1610.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="655.5" y="1605.4497">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="673.5" y="1605.4497">Retrive settlement windows information</text><polygon fill="#FFFFE0" filter="url(#fosmwa0sby7f8)" points="778,1623.5156,1193,1623.5156,1203,1695.5156,1193,1767.5156,778,1767.5156,768,1695.5156,778,1623.5156" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="780" y="1639.5825">SELECT ssw.settlementWindowId, swsc.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="792" y="1654.7153">swsc.reason, swsc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="780" y="1669.8481">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="195" x="818" y="1669.8481">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1016" y="1669.8481">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="780" y="1684.981">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="810" y="1684.981">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="935" y="1684.981">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="780" y="1700.1138">ON sw.settlementWindow = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="780" y="1715.2466">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="204" x="810" y="1715.2466">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1017" y="1715.2466">swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="780" y="1730.3794">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="780" y="1745.5122">WHERE ssw.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="780" y="1760.645">FOR UPDATE</text><polygon fill="#A80036" points="659.5,1789.8438,649.5,1793.8438,659.5,1797.8438,655.5,1793.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="653.5" x2="984.5" y1="1793.8438" y2="1793.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="665.5" y="1788.7778">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="683.5" y="1788.7778">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="726.5" y="1788.7778">windowsList</text><path d="M578,1808.8438 L980,1808.8438 L980,1815.8438 L970,1825.8438 L578,1825.8438 L578,1808.8438 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="242.9297" style="stroke: #000000; stroke-width: 2.0;" width="625" x="578" y="1808.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="357" x="593" y="1821.9106">Bulk insert settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="968.5,1843.1094,978.5,1847.1094,968.5,1851.1094,972.5,1847.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="648.5" x2="974.5" y1="1847.1094" y2="1847.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="655.5" y="1842.0435">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="673.5" y="1842.0435">Insert settlementParticipantCurrencyStateChange</text><polygon fill="#FFFFE0" filter="url(#fosmwa0sby7f8)" points="858,1860.1094,1112,1860.1094,1122,1871.1094,1112,1883.1094,858,1883.1094,848,1871.1094,858,1860.1094" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="860" y="1876.1763">settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="659.5,1905.375,649.5,1909.375,659.5,1913.375,655.5,1909.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="653.5" x2="984.5" y1="1909.375" y2="1909.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="665.5" y="1904.3091">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="683.5" y="1904.3091">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="726.5" y="1904.3091">spcscIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="648.5" x2="690.5" y1="1938.5078" y2="1938.5078"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="690.5" y1="1938.5078" y2="1951.5078"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="649.5" x2="690.5" y1="1951.5078" y2="1951.5078"/><polygon fill="#A80036" points="659.5,1947.5078,649.5,1951.5078,659.5,1955.5078,655.5,1951.5078" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="655.5" y="1933.4419">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="673.5" y="1933.4419">Merge spcscIdList into settlementAccountsList</text><polygon fill="#A80036" points="968.5,1976.6406,978.5,1980.6406,968.5,1984.6406,972.5,1980.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="648.5" x2="974.5" y1="1980.6406" y2="1980.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="655.5" y="1975.5747">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="673.5" y="1975.5747">Update all pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#fosmwa0sby7f8)" points="787,2023.6406,1183,2023.6406,1193,2034.6406,1183,2046.6406,787,2046.6406,777,2034.6406,787,2023.6406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="789" y="2039.7075">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="839" y="2039.7075">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1042" y="2039.7075">.currentStateChangeIds</text><rect fill="#FFFFFF" filter="url(#fosmwa0sby7f8)" height="85.6641" style="stroke: #000000; stroke-width: 2.0;" width="443.5" x="585" y="2058.7734"/><polygon fill="#EEEEEE" points="585,2058.7734,649,2058.7734,649,2065.7734,639,2075.7734,585,2075.7734,585,2058.7734" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="598" y="2072.8403">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="645.75" y="2091.8403">Settlement Transfer Abort {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.4-abort.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.4-abort.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="27" x="803.75" y="2091.8403">6.3.4</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="803.75" x2="830.75" y1="2093.8403" y2="2093.8403"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="830.75" y="2091.8403">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="648.75" y="2106.9731"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="42" x="645.75" y="2122.106">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="687.75" y="2122.106">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="648.75" y="2137.2388"/><path d="M578,2156.4375 L899,2156.4375 L899,2163.4375 L889,2173.4375 L578,2173.4375 L578,2156.4375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="242.9297" style="stroke: #000000; stroke-width: 2.0;" width="585" x="578" y="2156.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="276" x="593" y="2169.5044">Bulk insert settlementWindowStateChange</text><polygon fill="#A80036" points="968.5,2190.7031,978.5,2194.7031,968.5,2198.7031,972.5,2194.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="648.5" x2="974.5" y1="2194.7031" y2="2194.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="655.5" y="2189.6372">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="673.5" y="2189.6372">Insert settlementWindowStateChange</text><polygon fill="#FFFFE0" filter="url(#fosmwa0sby7f8)" points="892,2207.7031,1079,2207.7031,1089,2218.7031,1079,2230.7031,892,2230.7031,882,2218.7031,892,2207.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="894" y="2223.77">settlementWindowStateChange</text><polygon fill="#A80036" points="659.5,2252.9688,649.5,2256.9688,659.5,2260.9688,655.5,2256.9688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="653.5" x2="984.5" y1="2256.9688" y2="2256.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="665.5" y="2251.9028">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="683.5" y="2251.9028">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="66" x="726.5" y="2251.9028">swscIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="648.5" x2="690.5" y1="2286.1016" y2="2286.1016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="690.5" x2="690.5" y1="2286.1016" y2="2299.1016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="649.5" x2="690.5" y1="2299.1016" y2="2299.1016"/><polygon fill="#A80036" points="659.5,2295.1016,649.5,2299.1016,659.5,2303.1016,655.5,2299.1016" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="655.5" y="2281.0356">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="673.5" y="2281.0356">Merge swscIdList into windowList</text><polygon fill="#A80036" points="968.5,2324.2344,978.5,2328.2344,968.5,2332.2344,972.5,2328.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="648.5" x2="974.5" y1="2328.2344" y2="2328.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="655.5" y="2323.1685">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="673.5" y="2323.1685">Update all pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#fosmwa0sby7f8)" points="828,2371.2344,1143,2371.2344,1153,2382.2344,1143,2394.2344,828,2394.2344,818,2382.2344,828,2371.2344" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="830" y="2387.3013">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="880" y="2387.3013">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1002" y="2387.3013">.currentStateChangeIds</text><path d="M578,2413.3672 L820,2413.3672 L820,2420.3672 L810,2430.3672 L578,2430.3672 L578,2413.3672 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="231.0625" style="stroke: #000000; stroke-width: 2.0;" width="565" x="578" y="2413.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="593" y="2426.4341">Insert settlementStateChange</text><polygon fill="#A80036" points="968.5,2447.6328,978.5,2451.6328,968.5,2455.6328,972.5,2451.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="648.5" x2="974.5" y1="2451.6328" y2="2451.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="655.5" y="2446.5669">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="673.5" y="2446.5669">Insert settlementStateChange</text><polygon fill="#FFFFE0" filter="url(#fosmwa0sby7f8)" points="848,2464.6328,1123,2464.6328,1133,2490.6328,1123,2517.6328,848,2517.6328,838,2490.6328,848,2464.6328" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="850" y="2480.6997">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="930" y="2480.6997">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="862" y="2495.8325">(settlementId, settlementStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="850" y="2510.9653">VALUES ({id}, 'ABORTED', {abortReasonString})</text><polygon fill="#A80036" points="659.5,2540.1641,649.5,2544.1641,659.5,2548.1641,655.5,2544.1641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="653.5" x2="984.5" y1="2544.1641" y2="2544.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="665.5" y="2539.0981">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="683.5" y="2539.0981">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="726.5" y="2539.0981">settlementStateChangeId</text><polygon fill="#A80036" points="968.5,2569.2969,978.5,2573.2969,968.5,2577.2969,972.5,2573.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="648.5" x2="974.5" y1="2573.2969" y2="2573.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="655.5" y="2568.231">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="673.5" y="2568.231">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#fosmwa0sby7f8)" points="856,2616.2969,1115,2616.2969,1125,2627.2969,1115,2639.2969,856,2639.2969,846,2627.2969,856,2616.2969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="858" y="2632.3638">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="908" y="2632.3638">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="980" y="2632.3638">.currentStateChangeId</text><polygon fill="#A80036" points="407.5,2675.5625,397.5,2679.5625,407.5,2683.5625,403.5,2679.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401.5" x2="642.5" y1="2679.5625" y2="2679.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="413.5" y="2674.4966">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="431.5" y="2674.4966">Return facade method result</text><path d="M22,2694.5625 L85,2694.5625 L85,2701.5625 L75,2711.5625 L22,2711.5625 L22,2694.5625 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="346.125" style="stroke: #000000; stroke-width: 2.0;" width="514" x="22" y="2694.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="37" y="2707.6294">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="48" x="100" y="2706.7729">[success]</text><path d="M167,2716.6953 L167,2801.6953 L377,2801.6953 L377,2726.6953 L367,2716.6953 L167,2716.6953 " fill="#FFFF00" filter="url(#fosmwa0sby7f8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M367,2716.6953 L367,2726.6953 L377,2726.6953 L367,2716.6953 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="173" y="2733.7622">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="185" y="2748.895">"id": {id},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="185" y="2764.0278">"state": 'ABORTED',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="185" y="2779.1606">"reason": {abortReasonString}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="173" y="2794.2935">}</text><polygon fill="#A80036" points="205.5,2828.4922,195.5,2832.4922,205.5,2836.4922,201.5,2832.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="199.5" x2="385.5" y1="2832.4922" y2="2832.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="211.5" y="2827.4263">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="229.5" y="2827.4263">Respond HTTP - 200 (OK)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="22" x2="536" y1="2841.4922" y2="2841.4922"/><path d="M401,2847.4922 L401,2872.4922 L522,2872.4922 L522,2857.4922 L512,2847.4922 L401,2847.4922 " fill="#D3D3D3" filter="url(#fosmwa0sby7f8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M512,2847.4922 L512,2857.4922 L522,2857.4922 L512,2847.4922 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="407" y="2864.5591">Log ERROR event</text><path d="M32,2886.625 L32,2986.625 L377,2986.625 L377,2896.625 L367,2886.625 L32,2886.625 " fill="#FFFF00" filter="url(#fosmwa0sby7f8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M367,2886.625 L367,2896.625 L377,2896.625 L367,2886.625 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="38" y="2903.6919">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="50" y="2918.8247">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="62" y="2933.9575">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="62" y="2949.0903">"errorDescription": "Client/Server error description"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="50" y="2964.2231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="38" y="2979.356">}</text><polygon fill="#A80036" points="205.5,3028.6875,195.5,3032.6875,205.5,3036.6875,201.5,3032.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="199.5" x2="390.5" y1="3032.6875" y2="3032.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="211.5" y="3020.0552">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="229.5" y="3012.4888">Respond HTTP 4xx or 5xx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="229.5" y="3027.6216">(Client/Server error)</text><!--
@startuml
title 6.2.6. Settlement Abort (abortSettlementById)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Settlement Abort
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "state": "ABORTED",
            "reason": {abortReasonString}
        }
    end note

    OPERATOR -> SSAPI: PUT - /settlement/{id}
    activate SSAPI
    SSAPI -> SETTLE_DAO: abortSettlementById facade method\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO

    SETTLE_DAO -> DB: Retrieve settlement information
    activate DB
    hnote over DB #lightyellow
        SELECT s.settlementId, ssc.settlementStateId,
            ssc.reason, ssc.createdDate
        FROM **settlement** s
        JOIN **settlementStateChange** ssc
        ON ssc.settlementStateChangeId = s.currentStateChangeId
        WHERE s.settlementId = {id}
    end hnote
    SETTLE_DAO <- - DB: Return **settlementData**
    deactivate DB

    alt settlementData.settlementStateId == 'PS_TRANSFERS_COMMITTED'||\nsettlementData.settlementStateId == 'SETTLING'||\nsettlementData.settlementStateId == 'SETTLED'
    break
        note right of SETTLE_DAO #yellow
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "State change is not allowed"
                }
            }
        end note
    end
    else settlementData.settlementStateId == 'ABORTED'
    break
        SETTLE_DAO -> DB: Append additional info at settlement level
        activate DB
        deactivate DB
        hnote over DB #lightyellow
            INSERT INTO **settlementStateChange**
                (settlementId, settlementStateId, reason)
            VALUES ({id}, 'ABORTED', {abortReasonString})
        end hnote

        note right of SETTLE_DAO #yellow
            {
                "id": {id},
                "state": 'ABORTED',
                "reason": {abortReasonString}
            }
        end note
    end
    else settlementData.settlementStateId == 'PS_TRANSFERS_RESERVED'
        SETTLE_DAO -> DB: Find account in PS_TRANSFERS_COMMITTED
        activate DB
        hnote over DB #lightyellow
            SELECT spc.participantCurrencyId
            FROM **settlementParticipantCurrency** spc
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId = spc.currentStateChangeId
            WHERE spc.settlementId = {id}
            AND spcsc.settlementStateId = 'PS_TRANSFERS_COMMITTED'
            LIMIT 1
        end hnote
        SETTLE_DAO <- - DB: Return **transferCommittedAccount**
        deactivate DB
        break transferCommittedAccount != undefined
            note right of SETTLE_DAO #yellow
                {
                    errorInformation: {
                        "errorCode": <integer>,
                        "errorDescription": "At least one settlement transfer is committed"
                    }
                }
            end note
        end
    end

    group <color #blue>DB TRANSACTION</color>
        SETTLE_DAO -> DB: Retrive settlement accounts information
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId,
                spcsc.settlementStateId, spcsc.reason,
                spcsc.createdDate, spc.netAmount, pc.currencyId,
                spc.settlementParticipantCurrencyId AS <color #0000FF>key</color>
            FROM **settlementParticipantCurrency** spc
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId =
            spc.currentStateChangeId
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementAccountsList**
        deactivate DB

        SETTLE_DAO -> DB: Retrive settlement windows information
        activate DB
        hnote over DB #lightyellow
            SELECT ssw.settlementWindowId, swsc.settlementWindowStateId,
                swsc.reason, swsc.createdDate
            FROM **settlementSettlementWindow** ssw
            JOIN **settlementWindow** sw
            ON sw.settlementWindow = ssw.settlementWindowId
            JOIN **settlementWindowStateChange** swsc
            ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
            WHERE ssw.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **windowsList**
        deactivate DB

        group Bulk insert settlementParticipantCurrencyStateChange
            SETTLE_DAO -> DB: Insert settlementParticipantCurrencyStateChange
            activate DB
            hnote over DB #lightyellow
                settlementParticipantCurrencyStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **spcscIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge spcscIdList into settlementAccountsList

            SETTLE_DAO -> DB: Update all pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**.currentStateChangeIds
            end hnote
            deactivate DB
        end

        ref over SETTLE_DAO, DB: Settlement Transfer Abort {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.4-abort.svg 6.3.4]]}\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n

        group Bulk insert settlementWindowStateChange
            SETTLE_DAO -> DB: Insert settlementWindowStateChange
            activate DB
            hnote over DB #lightyellow
                settlementWindowStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **swscIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge swscIdList into windowList

            SETTLE_DAO -> DB: Update all pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**.currentStateChangeIds
            end hnote
            deactivate DB
        end

        group Insert settlementStateChange
            SETTLE_DAO -> DB: Insert settlementStateChange
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementStateChange**
                    (settlementId, settlementStateId, reason)
                VALUES ({id}, 'ABORTED', {abortReasonString})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlement**.currentStateChangeId
            end hnote
            deactivate DB
        end
    end
    SSAPI <- - SETTLE_DAO: Return facade method result
    deactivate SETTLE_DAO

    alt success
        note left of SSAPI #yellow
            {
                "id": {id},
                "state": 'ABORTED',
                "reason": {abortReasonString}
            }
        end note

        SSAPI - -> OPERATOR: Respond HTTP - 200 (OK)
      else
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "Client/Server error description"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP 4xx or 5xx\n(Client/Server error)
        deactivate SSAPI
    end
end
deactivate OPERATOR
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
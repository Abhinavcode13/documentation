<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1328px" preserveAspectRatio="none" style="width:624px;height:1328px;" version="1.1" viewBox="0 0 624 1328" width="624px" zoomAndPan="magnify"><defs><filter height="300%" id="f1xdekkn052pgd" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="488" x="68.5" y="22.9951">5.1.0.a. Reconciliation transfer prepare (reconciliationTransferPrepare)</text><rect fill="#FFFFE0" height="1283.1094" style="stroke: #A80036; stroke-width: 1.0;" width="362.5" x="19" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="151.25" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="328.5" y="170.9922"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="328.5" y="278.3906"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="328.5" y="446.3203"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="328.5" y="782.7188"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="328.5" y="1026.3125"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="328.5" y="1163.9766"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="1102.3828" style="stroke: #000000; stroke-width: 2.0;" width="599" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="140.4688" style="stroke: #000000; stroke-width: 2.0;" width="308" x="63" y="614.1172"/><rect fill="#FFFFFF" height="69.0703" style="stroke: none; stroke-width: 1.0;" width="308" x="63" y="685.5156"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="68" x2="68" y1="115.7266" y2="1252.1094"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="333.5" x2="333.5" y1="115.7266" y2="1252.1094"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="23" y="112.4248">Transfer DAO</text><ellipse cx="68.5" cy="83.4297" fill="#FEFECE" filter="url(#f1xdekkn052pgd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="56.5" x2="80.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="23" y="1264.1045">Transfer DAO</text><ellipse cx="68.5" cy="1283.4063" fill="#FEFECE" filter="url(#f1xdekkn052pgd)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="56.5" x2="80.5" y1="1297.4063" y2="1297.4063"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="289.5" y="112.4248">Central Store</text><path d="M315.5,63.4297 C315.5,53.4297 333.5,53.4297 333.5,53.4297 C333.5,53.4297 351.5,53.4297 351.5,63.4297 L351.5,89.4297 C351.5,99.4297 333.5,99.4297 333.5,99.4297 C333.5,99.4297 315.5,99.4297 315.5,89.4297 L315.5,63.4297 " fill="#FEFECE" filter="url(#f1xdekkn052pgd)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M315.5,63.4297 C315.5,73.4297 333.5,73.4297 333.5,73.4297 C333.5,73.4297 351.5,73.4297 351.5,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="289.5" y="1264.1045">Central Store</text><path d="M315.5,1277.4063 C315.5,1267.4063 333.5,1267.4063 333.5,1267.4063 C333.5,1267.4063 351.5,1267.4063 351.5,1277.4063 L351.5,1303.4063 C351.5,1313.4063 333.5,1313.4063 333.5,1313.4063 C333.5,1313.4063 315.5,1313.4063 315.5,1303.4063 L315.5,1277.4063 " fill="#FEFECE" filter="url(#f1xdekkn052pgd)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M315.5,1277.4063 C315.5,1287.4063 333.5,1287.4063 333.5,1287.4063 C333.5,1287.4063 351.5,1287.4063 351.5,1277.4063 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="328.5" y="170.9922"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="328.5" y="278.3906"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="328.5" y="446.3203"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="328.5" y="782.7188"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="328.5" y="1026.3125"/><rect fill="#FFFFFF" filter="url(#f1xdekkn052pgd)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="328.5" y="1163.9766"/><path d="M13,132.7266 L341,132.7266 L341,139.7266 L331,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1102.3828" style="stroke: #000000; stroke-width: 2.0;" width="599" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="283" x="28" y="145.7935">reconciliationTransferPrepare (payload, trx)</text><polygon fill="#A80036" points="316.5,166.9922,326.5,170.9922,316.5,174.9922,320.5,170.9922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="68.5" x2="322.5" y1="170.9922" y2="170.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="75.5" y="165.9263">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="86.5" y="165.9263">Insert transferDuplicateCheck</text><polygon fill="#FFFFE0" filter="url(#f1xdekkn052pgd)" points="75,213.9922,592,213.9922,602,232.9922,592,251.9922,75,251.9922,65,232.9922,75,213.9922" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="77" y="230.0591">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="157" y="230.0591">transferDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="314" y="230.0591">(transferId, hash, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="513" x="77" y="245.1919">VALUES ({payload.transferId}, hashCode({payload.transferId}), {transactionTimestamp})</text><polygon fill="#A80036" points="316.5,274.3906,326.5,278.3906,316.5,282.3906,320.5,278.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="68.5" x2="322.5" y1="278.3906" y2="278.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="75.5" y="273.3247">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="86.5" y="273.3247">Insert transfer</text><polygon fill="#FFFFE0" filter="url(#f1xdekkn052pgd)" points="141,321.3906,526,321.3906,536,370.3906,526,419.3906,141,419.3906,131,370.3906,141,321.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="143" y="337.4575">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="53" x="223" y="337.4575">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="279" y="337.4575">(transferId, amount, currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="155" y="352.5903">ilpCondition, expirationDate, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="143" y="367.7231">VALUES ({payload.transferId}, {payload.amount.amount},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="155" y="382.856">{payload.amount.curency}, 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="155" y="397.9888">{new Date()+Config.INTERNAL_TRANSFER_VALIDITY_SECONDS},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="155" y="413.1216">{transactionTimestamp})</text><polygon fill="#A80036" points="316.5,442.3203,326.5,446.3203,316.5,450.3203,320.5,446.3203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="68.5" x2="322.5" y1="446.3203" y2="446.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="75.5" y="441.2544">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="86.5" y="441.2544">Retrieve hub reconciliation account</text><polygon fill="#FFFFE0" filter="url(#f1xdekkn052pgd)" points="164,489.3203,503,489.3203,513,530.3203,503,572.3203,164,572.3203,154,530.3203,164,489.3203" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="335" x="166" y="505.3872">SELECT participantCurrencyId AS reconciliationAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="166" y="520.52">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="204" y="520.52">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="166" y="535.6528">WHERE participantId = 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="166" y="550.7856">AND currencyId = {payload.amount.currency}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="166" y="565.9185">LIMIT 1</text><polygon fill="#A80036" points="79.5,595.1172,69.5,599.1172,79.5,603.1172,75.5,599.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="73.5" x2="332.5" y1="599.1172" y2="599.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="85.5" y="594.0513">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="96.5" y="594.0513">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="139.5" y="594.0513">reconciliationAccountId</text><path d="M63,614.1172 L126,614.1172 L126,621.1172 L116,631.1172 L63,631.1172 L63,614.1172 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="140.4688" style="stroke: #000000; stroke-width: 2.0;" width="308" x="63" y="614.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="78" y="627.1841">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="214" x="141" y="626.3276">[payload.action == 'RECORD_FUNDS_IN']</text><path d="M73,636.25 L73,676.25 L345,676.25 L345,646.25 L335,636.25 L73,636.25 " fill="#D3D3D3" filter="url(#f1xdekkn052pgd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M335,636.25 L335,646.25 L345,646.25 L335,636.25 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="79" y="653.3169">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="200" y="653.3169">= 'RECORD_FUNDS_IN'</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="79" y="668.4497">amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="132" y="668.4497">=</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="142" y="668.4497">payload.amount.amount</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="63" x2="371" y1="686.5156" y2="686.5156"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="277" x="68" y="696.7261">[payload.action == 'RECORD_FUNDS_OUT_PREPARE']</text><path d="M73,705.3203 L73,745.3203 L357,745.3203 L357,715.3203 L347,705.3203 L73,705.3203 " fill="#D3D3D3" filter="url(#f1xdekkn052pgd)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M347,705.3203 L347,715.3203 L357,715.3203 L347,705.3203 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="79" y="722.3872">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="200" y="722.3872">= 'RECORD_FUNDS_OUT'</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="79" y="737.52">amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="132" y="737.52">=</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="142" y="737.52">-payload.amount.amount</text><polygon fill="#A80036" points="316.5,778.7188,326.5,782.7188,316.5,786.7188,320.5,782.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="68.5" x2="322.5" y1="782.7188" y2="782.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="75.5" y="777.6528">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="86.5" y="777.6528">Insert transferParticipant records</text><polygon fill="#FFFFE0" filter="url(#f1xdekkn052pgd)" points="87,825.7188,580,825.7188,590,912.7188,580,999.7188,87,999.7188,77,912.7188,87,825.7188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="89" y="841.7856">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="169" y="841.7856">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="101" y="856.9185">(transferId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="101" y="872.0513">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="89" y="887.1841">VALUES (payload.transferId, reconciliationAccountId, 'HUB',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="101" y="902.3169">{ledgerEntryTypeId}, {amount}, {transactionTimestamp})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="92" y="917.4497"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="89" y="932.5825">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="169" y="932.5825">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="101" y="947.7153">(transferId, participantCurrencyId, transferParticipantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="101" y="962.8481">ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="489" x="89" y="977.981">VALUES ({payload.transferId}, {payload.participantCurrencyId}, 'DFSP_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="101" y="993.1138">{ledgerEntryTypeId}, {-amount}, {transactionTimestamp})</text><polygon fill="#A80036" points="316.5,1022.3125,326.5,1026.3125,316.5,1030.3125,320.5,1026.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="68.5" x2="322.5" y1="1026.3125" y2="1026.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="75.5" y="1021.2466">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="86.5" y="1021.2466">Insert transferStateChange record</text><polygon fill="#FFFFE0" filter="url(#f1xdekkn052pgd)" points="181,1069.3125,485,1069.3125,495,1103.3125,485,1137.3125,181,1137.3125,171,1103.3125,181,1069.3125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="183" y="1085.3794">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="263" y="1085.3794">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="195" y="1100.5122">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="183" y="1115.645">VALUES ({payload.transferId}, 'RECEIVED_PREPARE',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="195" y="1130.7778">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="316.5,1159.9766,326.5,1163.9766,316.5,1167.9766,320.5,1163.9766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="68.5" x2="322.5" y1="1163.9766" y2="1163.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="75.5" y="1158.9106">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="86.5" y="1158.9106">Save externalReference and extensions</text><polygon fill="#FFFFE0" filter="url(#f1xdekkn052pgd)" points="279,1206.9766,387,1206.9766,397,1217.9766,387,1229.9766,279,1229.9766,269,1217.9766,279,1206.9766" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="281" y="1223.0435">transferExtension</text><!--
@startuml
title 5.1.0.a. Reconciliation transfer prepare (reconciliationTransferPrepare)

autonumber


entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TRANSFER_DAO
    participant DB
end box

group reconciliationTransferPrepare (payload, trx)
    TRANSFER_DAO -> DB: Insert transferDuplicateCheck
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        INSERT INTO **transferDuplicateCheck** (transferId, hash, createdDate)
        VALUES ({payload.transferId}, hashCode({payload.transferId}), {transactionTimestamp})
    end hnote

    TRANSFER_DAO -> DB: Insert transfer
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        INSERT INTO **transfer** (transferId, amount, currencyId,
            ilpCondition, expirationDate, createdDate)
        VALUES ({payload.transferId}, {payload.amount.amount},
            {payload.amount.curency}, 0,
            {new Date()+Config.INTERNAL_TRANSFER_VALIDITY_SECONDS},
            {transactionTimestamp})
    end hnote

    TRANSFER_DAO -> DB: Retrieve hub reconciliation account
    activate DB
    hnote over DB #lightyellow
        SELECT participantCurrencyId AS reconciliationAccountId
        FROM **participantCurrency**
        WHERE participantId = 1
        AND currencyId = {payload.amount.currency}
        LIMIT 1
    end hnote
    deactivate DB
    TRANSFER_DAO <- - DB: Return **reconciliationAccountId**

    alt payload.action == 'RECORD_FUNDS_IN'
        note right of TRANSFER_DAO #lightgray
            **ledgerEntryTypeId** = 'RECORD_FUNDS_IN'
            **amount** = <color #blue>payload.amount.amount</color>
        end note
    else payload.action == 'RECORD_FUNDS_OUT_PREPARE'
        note right of TRANSFER_DAO #lightgray
            **ledgerEntryTypeId** = 'RECORD_FUNDS_OUT'
            **amount** = <color #red>-payload.amount.amount</color>
        end note
    end

    TRANSFER_DAO -> DB: Insert transferParticipant records
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        INSERT INTO **transferParticipant**
            (transferId, participantCurrencyId, transferParticipantRoleTypeId,
            ledgerEntryTypeId, amount, createdDate)
        VALUES (payload.transferId, reconciliationAccountId, 'HUB',
            {ledgerEntryTypeId}, {amount}, {transactionTimestamp})

        INSERT INTO **transferParticipant**
            (transferId, participantCurrencyId, transferParticipantRoleTypeId,
            ledgerEntryTypeId, amount, createdDate)
        VALUES ({payload.transferId}, {payload.participantCurrencyId}, 'DFSP_SETTLEMENT',
            {ledgerEntryTypeId}, {-amount}, {transactionTimestamp})
    end hnote

    TRANSFER_DAO -> DB: Insert transferStateChange record
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        INSERT INTO **transferStateChange**
            (transferId, transferStateId, reason, createdDate)
        VALUES ({payload.transferId}, 'RECEIVED_PREPARE',
            {payload.reason}, {transactionTimestamp})
    end hnote

    TRANSFER_DAO -> DB: Save externalReference and extensions
    activate DB
    deactivate DB
    hnote over DB #lightyellow
        transferExtension
    end hnote
end
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
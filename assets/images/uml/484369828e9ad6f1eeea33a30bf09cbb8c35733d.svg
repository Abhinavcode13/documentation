<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3573px" preserveAspectRatio="none" style="width:1391px;height:3573px;" version="1.1" viewBox="0 0 1391 3573" width="1391px" zoomAndPan="magnify"><defs><filter height="300%" id="f13svlmu8vby5z" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="352" x="520.5" y="22.9951">6.2.1. Trigger Settlement Event (createSettlement)</text><rect fill="#FFB6C1" height="3527.7813" style="stroke: #A80036; stroke-width: 1.0;" width="107" x="67" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="82" y="46.3638">Central HUB</text><rect fill="#90EE90" height="3527.7813" style="stroke: #A80036; stroke-width: 1.0;" width="354" x="286" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="123" x="401.5" y="46.3638">Settlement Service</text><rect fill="#FFFFE0" height="3527.7813" style="stroke: #A80036; stroke-width: 1.0;" width="110" x="1000.5" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="104" x="1003.5" y="46.3638">Central Services</text><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="3297.0547" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="115.5" y="146.7266"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="3061.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="361.5" y="382.4531"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="181.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575.5" y="426.7188"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="1874.3594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575.5" y="892.375"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="122.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="455.8516"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="984.7734"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="1091.3047"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="1198.7031"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="137.9297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="1533.0938"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="107.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="1700.1563"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="1909.3516"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="107.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="2031.8828"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="2225.9453"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="107.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="2348.4766"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="2485.2734"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="122.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="2614.8047"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="3305.0547" style="stroke: #000000; stroke-width: 2.0;" width="1368" x="12" y="153.7266"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="202.1953" style="stroke: #000000; stroke-width: 2.0;" width="597" x="356" y="622.7813"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="101.6641" style="stroke: #000000; stroke-width: 2.0;" width="525" x="366" y="716.3125"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="2612.8047" style="stroke: #000000; stroke-width: 2.0;" width="1348" x="22" y="838.9766"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="1679.2969" style="stroke: #000000; stroke-width: 2.0;" width="845" x="515" y="907.375"/><rect fill="#FFFFFF" height="185.0625" style="stroke: none; stroke-width: 1.0;" width="1348" x="22" y="3266.7188"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="120" x2="120" y1="136.7266" y2="3475.7813"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="366" x2="366" y1="136.7266" y2="3475.7813"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="580" x2="580" y1="136.7266" y2="3475.7813"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1055.5" x2="1055.5" y1="136.7266" y2="3475.7813"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="71" y="133.4248">Hub Employee</text><ellipse cx="120.5" cy="63.4297" fill="#FEFECE" filter="url(#f13svlmu8vby5z)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M120.5,71.4297 L120.5,98.4297 M107.5,79.4297 L133.5,79.4297 M120.5,98.4297 L107.5,113.4297 M120.5,98.4297 L133.5,113.4297 " fill="none" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="71" y="3487.7764">Hub Employee</text><ellipse cx="120.5" cy="3501.0781" fill="#FEFECE" filter="url(#f13svlmu8vby5z)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M120.5,3509.0781 L120.5,3536.0781 M107.5,3517.0781 L133.5,3517.0781 M120.5,3536.0781 L107.5,3551.0781 M120.5,3536.0781 L133.5,3551.0781 " fill="none" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="290" y="133.4248">Settlement Service API</text><path d="M346,92.4297 L346,116.4297 M346,104.4297 L363,104.4297 " fill="none" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="375" cy="104.4297" fill="#FEFECE" filter="url(#f13svlmu8vby5z)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="290" y="3487.7764">Settlement Service API</text><path d="M346,3495.0781 L346,3519.0781 M346,3507.0781 L363,3507.0781 " fill="none" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="375" cy="3507.0781" fill="#FEFECE" filter="url(#f13svlmu8vby5z)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="525" y="133.4248">Settlement DAO</text><ellipse cx="580.5" cy="104.4297" fill="#FEFECE" filter="url(#f13svlmu8vby5z)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="568.5" x2="592.5" y1="118.4297" y2="118.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="525" y="3487.7764">Settlement DAO</text><ellipse cx="580.5" cy="3507.0781" fill="#FEFECE" filter="url(#f13svlmu8vby5z)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="568.5" x2="592.5" y1="3521.0781" y2="3521.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1011.5" y="133.4248">Central Store</text><path d="M1037.5,84.4297 C1037.5,74.4297 1055.5,74.4297 1055.5,74.4297 C1055.5,74.4297 1073.5,74.4297 1073.5,84.4297 L1073.5,110.4297 C1073.5,120.4297 1055.5,120.4297 1055.5,120.4297 C1055.5,120.4297 1037.5,120.4297 1037.5,110.4297 L1037.5,84.4297 " fill="#FEFECE" filter="url(#f13svlmu8vby5z)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1037.5,84.4297 C1037.5,94.4297 1055.5,94.4297 1055.5,94.4297 C1055.5,94.4297 1073.5,94.4297 1073.5,84.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1011.5" y="3487.7764">Central Store</text><path d="M1037.5,3501.0781 C1037.5,3491.0781 1055.5,3491.0781 1055.5,3491.0781 C1055.5,3491.0781 1073.5,3491.0781 1073.5,3501.0781 L1073.5,3527.0781 C1073.5,3537.0781 1055.5,3537.0781 1055.5,3537.0781 C1055.5,3537.0781 1037.5,3537.0781 1037.5,3527.0781 L1037.5,3501.0781 " fill="#FEFECE" filter="url(#f13svlmu8vby5z)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1037.5,3501.0781 C1037.5,3511.0781 1055.5,3511.0781 1055.5,3511.0781 C1055.5,3511.0781 1073.5,3511.0781 1073.5,3501.0781 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="3297.0547" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="115.5" y="146.7266"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="3061.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="361.5" y="382.4531"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="181.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575.5" y="426.7188"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="1874.3594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575.5" y="892.375"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="122.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="455.8516"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="984.7734"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="1091.3047"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="1198.7031"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="137.9297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="1533.0938"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="107.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="1700.1563"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="1909.3516"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="107.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="2031.8828"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="2225.9453"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="107.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="2348.4766"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="2485.2734"/><rect fill="#FFFFFF" filter="url(#f13svlmu8vby5z)" height="122.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="2614.8047"/><path d="M12,153.7266 L216,153.7266 L216,160.7266 L206,170.7266 L12,170.7266 L12,153.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3305.0547" style="stroke: #000000; stroke-width: 2.0;" width="1368" x="12" y="153.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="27" y="166.7935">Trigger Settlement Event</text><path d="M130,175.8594 L130,351.8594 L298,351.8594 L298,185.8594 L288,175.8594 L130,175.8594 " fill="#FFFF00" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M288,175.8594 L288,185.8594 L298,185.8594 L288,175.8594 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="136" y="192.9263">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="148" y="208.0591">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="148" y="223.1919">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="160" y="238.3247">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37" x="172" y="253.4575">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="160" y="268.5903">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="160" y="283.7231">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="37" x="172" y="298.856">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="160" y="313.9888">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="148" y="329.1216">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="136" y="344.2544">}</text><polygon fill="#A80036" points="349.5,378.4531,359.5,382.4531,349.5,386.4531,353.5,382.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="125.5" x2="355.5" y1="382.4531" y2="382.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="132.5" y="377.3872">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="143.5" y="377.3872">POST - /settlements</text><polygon fill="#A80036" points="563.5,422.7188,573.5,426.7188,563.5,430.7188,567.5,426.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="371.5" x2="569.5" y1="426.7188" y2="426.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="378.5" y="414.0864">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="389.5" y="406.52">Request settlementWindow(s)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="389.5" y="421.6528">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="463.5" y="421.6528">2001</text><polygon fill="#A80036" points="1038.5,451.8516,1048.5,455.8516,1038.5,459.8516,1042.5,455.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="1044.5" y1="455.8516" y2="455.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="592.5" y="450.7856">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="603.5" y="450.7856">Retrieve settlementWindow(s)</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="818,468.8516,1292,468.8516,1302,509.8516,1292,551.8516,818,551.8516,808,509.8516,818,468.8516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="470" x="820" y="484.9185">SELECT sw.settlementWindowId, swsc.settlementWindowStateId, sw.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="820" y="500.0513">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="858" y="500.0513">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="983" y="500.0513">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="820" y="515.1841">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="204" x="850" y="515.1841">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1057" y="515.1841">swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="820" y="530.3169">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="820" y="545.4497">WHERE sw.settlementWindowId IN {payload.settlementWindows.idList}</text><polygon fill="#A80036" points="596.5,574.6484,586.5,578.6484,596.5,582.6484,592.5,578.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590.5" x2="1054.5" y1="578.6484" y2="578.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="602.5" y="573.5825">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="613.5" y="573.5825">Return data</text><polygon fill="#A80036" points="382.5,603.7813,372.5,607.7813,382.5,611.7813,378.5,607.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="376.5" x2="579.5" y1="607.7813" y2="607.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="388.5" y="602.7153">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="399.5" y="602.7153">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85" x="442.5" y="602.7153">windowsData</text><path d="M356,622.7813 L762,622.7813 L762,629.7813 L752,639.7813 L356,639.7813 L356,622.7813 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="202.1953" style="stroke: #000000; stroke-width: 2.0;" width="597" x="356" y="622.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="361" x="371" y="635.8481">Validate all requested windows are found and applicable</text><path d="M376,644.9141 L376,699.9141 L939,699.9141 L939,654.9141 L929,644.9141 L376,644.9141 " fill="#D3D3D3" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M929,644.9141 L929,654.9141 L939,654.9141 L929,644.9141 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="542" x="382" y="661.981">let allSettlementWindowsFound = payload.settlementWindows.length == windowsData.length</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="382" y="677.1138">let allSettlementWindowsApplicable = true</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="382" y="692.2466">let settlementWindow</text><path d="M366,716.3125 L439,716.3125 L439,723.3125 L429,733.3125 L366,733.3125 L366,716.3125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="101.6641" style="stroke: #000000; stroke-width: 2.0;" width="525" x="366" y="716.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="381" y="729.3794">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107" x="454" y="728.5229">[w IN windowsData]</text><path d="M376,738.4453 L376,808.4453 L877,808.4453 L877,748.4453 L867,738.4453 L376,738.4453 " fill="#D3D3D3" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M867,738.4453 L867,748.4453 L877,748.4453 L867,738.4453 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="382" y="755.5122">settlementWindow = windowsData[w]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="480" x="382" y="770.645">if (settlementWindow.state != 'CLOSED' &amp;&amp; settlementWindow.state != 'ABORTED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="394" y="785.7778">allSettlementWindowsApplicable = false</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="382" y="800.9106">}</text><path d="M22,838.9766 L85,838.9766 L85,845.9766 L75,855.9766 L22,855.9766 L22,838.9766 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2612.8047" style="stroke: #000000; stroke-width: 2.0;" width="1348" x="22" y="838.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="37" y="852.0435">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="357" x="100" y="851.187">[allSettlementWindowsFound &amp;&amp; allSettlementWindowsApplicable]</text><polygon fill="#A80036" points="563.5,888.375,573.5,892.375,563.5,896.375,567.5,892.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="371.5" x2="569.5" y1="892.375" y2="892.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="378.5" y="879.7427">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="389.5" y="872.1763">Create settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="389.5" y="887.3091">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="463.5" y="887.3091">2001</text><path d="M515,907.375 L665,907.375 L665,914.375 L655,924.375 L515,924.375 L515,907.375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1679.2969" style="stroke: #000000; stroke-width: 2.0;" width="845" x="515" y="907.375"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="530" y="920.4419">DB TRANSACTION</text><path d="M590,929.5078 L590,954.5078 L820,954.5078 L820,939.5078 L810,929.5078 L590,929.5078 " fill="#D3D3D3" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M810,929.5078 L810,939.5078 L820,939.5078 L810,929.5078 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="14" x="596" y="946.5747">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="613" y="946.5747">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="761" y="946.5747">= now()</text><polygon fill="#A80036" points="1038.5,980.7734,1048.5,984.7734,1038.5,988.7734,1042.5,984.7734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="1044.5" y1="984.7734" y2="984.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="592.5" y="979.7075">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="603.5" y="979.7075">Insert new settlement</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="902,997.7734,1208,997.7734,1218,1016.7734,1208,1035.7734,902,1035.7734,892,1016.7734,902,997.7734" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="904" y="1013.8403">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="984" y="1013.8403">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="1059" y="1013.8403">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="904" y="1028.9731">VALUES ({payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="596.5,1058.1719,586.5,1062.1719,596.5,1066.1719,592.5,1062.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590.5" x2="1054.5" y1="1062.1719" y2="1062.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="602.5" y="1057.106">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="613.5" y="1057.106">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="86" x="656.5" y="1057.106">settlementId</text><polygon fill="#A80036" points="1038.5,1087.3047,1048.5,1091.3047,1038.5,1095.3047,1042.5,1091.3047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="1044.5" y1="1091.3047" y2="1091.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="592.5" y="1086.2388">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="603.5" y="1086.2388">Associate settlement windows with the settlement</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="771,1134.3047,1340,1134.3047,1350,1153.3047,1340,1172.3047,771,1172.3047,761,1153.3047,771,1134.3047" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="773" y="1150.3716">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="195" x="853" y="1150.3716">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="1051" y="1150.3716">(settlementId, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="499" x="773" y="1165.5044">VALUES ({settlementId}, {payload.settlementWindows.idList}, {transactionTimestamp})</text><polygon fill="#A80036" points="1038.5,1194.7031,1048.5,1198.7031,1038.5,1202.7031,1042.5,1198.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="1044.5" y1="1198.7031" y2="1198.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="592.5" y="1193.6372">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="610.5" y="1193.6372">Populate settlementTransferParticipant with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="827,1241.7031,1284,1241.7031,1294,1373.7031,1284,1506.7031,827,1506.7031,817,1373.7031,827,1241.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="829" y="1257.77">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="909" y="1257.77">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="850" y="1272.9028">(settlementId, settlementWindowId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422" x="853" y="1288.0356">transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="450" x="829" y="1303.1685">SELECT ssw.settlementId, ssw.settlementWindowId, tp.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="424" x="850" y="1318.3013">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId, SUM(tp.amount),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="850" y="1333.4341">{transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="829" y="1348.5669">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="195" x="867" y="1348.5669">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1065" y="1348.5669">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="829" y="1363.6997">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="119" x="859" y="1363.6997">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="981" y="1363.6997">AS tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="829" y="1378.8325">ON tf.settlementWindowId = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="829" y="1393.9653">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="859" y="1393.9653">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="997" y="1393.9653">AS tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="829" y="1409.0981">ON tsc.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="829" y="1424.231">AND tsc.transferStateId = ‘COMMITTED’</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="829" y="1439.3638">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="859" y="1439.3638">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="988" y="1439.3638">AS tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="829" y="1454.4966">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="829" y="1469.6294">WHERE ssw.settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="829" y="1484.7622">GROUP BY ssw.settlementWindowId, tp.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="856" y="1499.895">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId</text><polygon fill="#A80036" points="1038.5,1529.0938,1048.5,1533.0938,1038.5,1537.0938,1042.5,1533.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="1044.5" y1="1533.0938" y2="1533.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="592.5" y="1528.0278">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="610.5" y="1528.0278">Populate settlementParticipantCurrency with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="810,1546.0938,1301,1546.0938,1311,1595.0938,1301,1644.0938,810,1644.0938,800,1595.0938,810,1546.0938" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="812" y="1562.1606">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="892" y="1562.1606">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="833" y="1577.2935">(settlementId, participantCurrencyId, createdDate, netAmount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="487" x="812" y="1592.4263">SELECT settlementId, participantCurrencyId, {transactionTimestamp}, SUM(amount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="812" y="1607.5591">FROM settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="812" y="1622.6919">WHERE settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="812" y="1637.8247">GROUP BY settlementId, participantCurrencyId</text><polygon fill="#A80036" points="596.5,1667.0234,586.5,1671.0234,596.5,1675.0234,592.5,1671.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590.5" x2="1054.5" y1="1671.0234" y2="1671.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="602.5" y="1665.9575">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="620.5" y="1665.9575">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="714.5" y="1665.9575">settlementParticipantCurrencyIdList</text><polygon fill="#A80036" points="1038.5,1696.1563,1048.5,1700.1563,1038.5,1704.1563,1042.5,1700.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="1044.5" y1="1700.1563" y2="1700.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="592.5" y="1695.0903">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="610.5" y="1695.0903">Insert initial settlement accounts state 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="828,1713.1563,1283,1713.1563,1293,1747.1563,1283,1781.1563,828,1781.1563,818,1747.1563,828,1713.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="830" y="1729.2231">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="285" x="910" y="1729.2231">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="430" x="851" y="1744.356">(settlementParticipantCurrencyId, settlementStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="419" x="830" y="1759.4888">VALUES ({settlementParticipantCurrencyIdList}, 'PENDING_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="851" y="1774.6216">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="596.5,1803.8203,586.5,1807.8203,596.5,1811.8203,592.5,1807.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590.5" x2="1054.5" y1="1807.8203" y2="1807.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="602.5" y="1802.7544">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="620.5" y="1802.7544">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="322" x="714.5" y="1802.7544">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="627.5" y1="1867.2188" y2="1867.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="627.5" x2="627.5" y1="1867.2188" y2="1880.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="586.5" x2="627.5" y1="1880.2188" y2="1880.2188"/><polygon fill="#A80036" points="596.5,1876.2188,586.5,1880.2188,596.5,1884.2188,592.5,1880.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="592.5" y="1847.02">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="610.5" y="1831.8872">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="610.5" y="1847.02">to settlementParticipantCurrencyIdList in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="610.5" y="1862.1528">issue the following update in one knex command</text><polygon fill="#A80036" points="1038.5,1905.3516,1048.5,1909.3516,1038.5,1913.3516,1042.5,1909.3516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="1044.5" y1="1909.3516" y2="1909.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="592.5" y="1904.2856">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="610.5" y="1904.2856">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="821,1952.3516,1290,1952.3516,1300,1978.3516,1290,2005.3516,821,2005.3516,811,1978.3516,821,1952.3516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="823" y="1968.4185">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="873" y="1968.4185">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="459" x="823" y="1983.5513">SET currentStateChangeId = {settlementParticipantCurrencyStateChangeIdList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="465" x="823" y="1998.6841">WHERE settlementParticipantCurrencyId = {settlementParticipantCurrencyIdList}</text><polygon fill="#A80036" points="1038.5,2027.8828,1048.5,2031.8828,1038.5,2035.8828,1042.5,2031.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="1044.5" y1="2031.8828" y2="2031.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="592.5" y="2026.8169">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="610.5" y="2026.8169">Insert new state for settlementWindow 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="837,2044.8828,1273,2044.8828,1283,2078.8828,1273,2112.8828,837,2112.8828,827,2078.8828,837,2044.8828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="839" y="2060.9497">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="204" x="919" y="2060.9497">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="860" y="2076.0825">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="409" x="839" y="2091.2153">VALUES ({payload.settlementWindows.idList}, 'PENDING_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="860" y="2106.3481">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="596.5,2135.5469,586.5,2139.5469,596.5,2143.5469,592.5,2139.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590.5" x2="1054.5" y1="2139.5469" y2="2139.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="602.5" y="2134.481">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="620.5" y="2134.481">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="241" x="714.5" y="2134.481">settlementWindowStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="627.5" y1="2183.8125" y2="2183.8125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="627.5" x2="627.5" y1="2183.8125" y2="2196.8125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="586.5" x2="627.5" y1="2196.8125" y2="2196.8125"/><polygon fill="#A80036" points="596.5,2192.8125,586.5,2196.8125,596.5,2200.8125,592.5,2196.8125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="592.5" y="2171.1802">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="610.5" y="2163.6138">Merge settlementWindowStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="610.5" y="2178.7466">to payload.settlementWindows.idList</text><polygon fill="#A80036" points="1038.5,2221.9453,1048.5,2225.9453,1038.5,2229.9453,1042.5,2225.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="1044.5" y1="2225.9453" y2="2225.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="592.5" y="2220.8794">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="610.5" y="2220.8794">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="826,2268.9453,1285,2268.9453,1295,2294.9453,1285,2321.9453,826,2321.9453,816,2294.9453,826,2268.9453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="828" y="2285.0122">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="878" y="2285.0122">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="828" y="2300.145">SET currentStateChangeId = {settlementWindowStateChangeIdList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="455" x="828" y="2315.2778">WHERE settlementParticipantCurrencyId = {payload.settlementWindows.idList}</text><polygon fill="#A80036" points="1038.5,2344.4766,1048.5,2348.4766,1038.5,2352.4766,1042.5,2348.4766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="1044.5" y1="2348.4766" y2="2348.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="592.5" y="2343.4106">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="328" x="610.5" y="2343.4106">Insert initial state for settlement 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="885,2361.4766,1225,2361.4766,1235,2395.4766,1225,2429.4766,885,2429.4766,875,2395.4766,885,2361.4766" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="887" y="2377.5435">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="967" y="2377.5435">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="908" y="2392.6763">(settlementId, settlementStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="887" y="2407.8091">VALUES ({settlementId}, ‘PENDING_SETTLEMENT’,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="908" y="2422.9419">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="596.5,2452.1406,586.5,2456.1406,596.5,2460.1406,592.5,2456.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590.5" x2="1054.5" y1="2456.1406" y2="2456.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="602.5" y="2451.0747">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="620.5" y="2451.0747">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="663.5" y="2451.0747">settlementStateChangeId</text><polygon fill="#A80036" points="1038.5,2481.2734,1048.5,2485.2734,1038.5,2489.2734,1042.5,2485.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="1044.5" y1="2485.2734" y2="2485.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="592.5" y="2480.2075">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="610.5" y="2480.2075">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="891,2528.2734,1220,2528.2734,1230,2554.2734,1220,2581.2734,891,2581.2734,881,2554.2734,891,2528.2734" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="893" y="2544.3403">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="943" y="2544.3403">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="893" y="2559.4731">SET currentStateChangeId = {settlementStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="893" y="2574.606">WHERE settlementId = {settlementId}</text><polygon fill="#A80036" points="1038.5,2610.8047,1048.5,2614.8047,1038.5,2618.8047,1042.5,2614.8047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="1044.5" y1="2614.8047" y2="2614.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="592.5" y="2609.7388">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="610.5" y="2609.7388">Select account data for response</text><polygon fill="#FFFFE0" filter="url(#f13svlmu8vby5z)" points="814,2627.8047,1296,2627.8047,1306,2668.8047,1296,2710.8047,814,2710.8047,804,2668.8047,814,2627.8047" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="478" x="816" y="2643.8716">SELECT pc.participantId, spc.participantCurrencyId, spc.netAmount, pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="816" y="2659.0044">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="854" y="2659.0044">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="20" x="1060" y="2659.0044">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="816" y="2674.1372">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="846" y="2674.1372">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="14" x="980" y="2674.1372">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="816" y="2689.27">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="816" y="2704.4028">WHERE spc.settlementId = {settlementId}</text><polygon fill="#A80036" points="596.5,2733.6016,586.5,2737.6016,596.5,2741.6016,592.5,2737.6016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590.5" x2="1054.5" y1="2737.6016" y2="2737.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="602.5" y="2732.5356">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="620.5" y="2732.5356">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="663.5" y="2732.5356">accountData</text><polygon fill="#A80036" points="382.5,2762.7344,372.5,2766.7344,382.5,2770.7344,378.5,2766.7344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="376.5" x2="579.5" y1="2766.7344" y2="2766.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="388.5" y="2761.6685">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="406.5" y="2761.6685">Construct and return result</text><path d="M32,2779.7344 L32,3227.7344 L352,3227.7344 L352,2789.7344 L342,2779.7344 L32,2779.7344 " fill="#FFFF00" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M342,2779.7344 L342,2789.7344 L352,2789.7344 L342,2779.7344 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="38" y="2796.8013">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="50" y="2811.9341">"id": settlementId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="50" y="2827.0669">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="50" y="2842.1997">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="62" y="2857.3325">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="74" y="2872.4653">"id": windowsData.settlementWindowIdList,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="74" y="2887.5981">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="74" y="2902.731">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="74" y="2917.8638">"createdDate": windowsData.createdDateList,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="74" y="2932.9966">"changedDate": transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="62" y="2948.1294">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="50" y="2963.2622">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="50" y="2978.395">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="62" y="2993.5278">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="74" y="3008.6606">"id": accountData.participantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="74" y="3023.7935">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="86" y="3038.9263">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="98" y="3054.0591">"id": accountData.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="98" y="3069.1919">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="98" y="3084.3247">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="98" y="3099.4575">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="110" y="3114.5903">"amount": accountData.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="110" y="3129.7231">"currency": accountData.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="98" y="3144.856">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="86" y="3159.9888">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="74" y="3175.1216">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="62" y="3190.2544">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="50" y="3205.3872">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="38" y="3220.52">}</text><polygon fill="#A80036" points="136.5,3254.7188,126.5,3258.7188,136.5,3262.7188,132.5,3258.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="130.5" x2="360.5" y1="3258.7188" y2="3258.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="142.5" y="3253.6528">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="160.5" y="3253.6528">Respond HTTP - 201 (Created)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="22" x2="1370" y1="3267.7188" y2="3267.7188"/><path d="M376,3273.7188 L376,3298.7188 L497,3298.7188 L497,3283.7188 L487,3273.7188 L376,3273.7188 " fill="#D3D3D3" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M487,3273.7188 L487,3283.7188 L497,3283.7188 L487,3273.7188 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="382" y="3290.7856">Log ERROR event</text><path d="M49,3312.8516 L49,3412.8516 L352,3412.8516 L352,3322.8516 L342,3312.8516 L49,3312.8516 " fill="#FFFF00" filter="url(#f13svlmu8vby5z)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M342,3312.8516 L342,3322.8516 L352,3322.8516 L342,3312.8516 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="55" y="3329.9185">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="67" y="3345.0513">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="79" y="3360.1841">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="79" y="3375.3169">"errorDescription": "Client error description"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="67" y="3390.4497">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="55" y="3405.5825">}</text><polygon fill="#A80036" points="131.5,3439.7813,121.5,3443.7813,131.5,3447.7813,127.5,3443.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="125.5" x2="365.5" y1="3443.7813" y2="3443.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="137.5" y="3438.7153">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="155.5" y="3438.7153">Respond HTTP - 4xx (Client error)</text><!--
@startuml
title 6.2.1. Trigger Settlement Event (createSettlement)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Trigger Settlement Event
activate OPERATOR
    note right of OPERATOR #yellow
        {
            "reason": "string",
            "settlementWindows": [
                {
                    "id": 1,
                },
                {
                    "id": 2,
                }
            ]
        }
    end note
    OPERATOR -> SSAPI: POST - /settlements
    activate SSAPI

    SSAPI-> SETTLE_DAO: Request settlementWindow(s)\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Retrieve settlementWindow(s)
    activate DB
    hnote over DB #lightyellow
        SELECT sw.settlementWindowId, swsc.settlementWindowStateId, sw.createdDate
        FROM **settlementWindow** sw
        JOIN **settlementWindowStateChange** swsc
        ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
        WHERE sw.settlementWindowId IN {payload.settlementWindows.idList}
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **windowsData**
    deactivate SETTLE_DAO

    group Validate all requested windows are found and applicable
        note right of SSAPI #lightgray
            let allSettlementWindowsFound = payload.settlementWindows.length == windowsData.length
            let allSettlementWindowsApplicable = true
            let settlementWindow
        end note
        loop w IN windowsData
            note right of SSAPI #lightgray
                settlementWindow = windowsData[w]
                if (settlementWindow.state != 'CLOSED' && settlementWindow.state != 'ABORTED') {
                    allSettlementWindowsApplicable = false
                }
            end note
        end loop
    end

    alt allSettlementWindowsFound && allSettlementWindowsApplicable
        SSAPI ->SETTLE_DAO: Create settlement\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            note right of SETTLE_DAO #lightgray
                let **transactionTimestamp** = now()
            end note

            SETTLE_DAO -> DB: Insert new settlement
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlement** (reason, createdDate)
                VALUES ({payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementId**
            deactivate DB

            SETTLE_DAO -> DB: Associate settlement windows with the settlement
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementSettlementWindow** (settlementId, settlementWindowId, createdDate)
                VALUES ({settlementId}, {payload.settlementWindows.idList}, {transactionTimestamp})
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Populate settlementTransferParticipant with aggregated data
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementTransferParticipant**
                       (settlementId, settlementWindowId, participantCurrencyId,
                        transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)
                SELECT ssw.settlementId, ssw.settlementWindowId, tp.participantCurrencyId, 
                       tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId, SUM(tp.amount),
                       {transactionTimestamp}
                FROM **settlementSettlementWindow** ssw
                JOIN **transferFulfilment** AS tf
                ON tf.settlementWindowId = ssw.settlementWindowId
                JOIN **transferStateChange** AS tsc
                ON tsc.transferId = tf.transferId 
                AND tsc.transferStateId = ‘COMMITTED’
                JOIN **transferParticipant** AS tp
                ON tp.transferId = tf.transferId
                WHERE ssw.settlementId = {settlementId}
                GROUP BY ssw.settlementWindowId, tp.participantCurrencyId, 
                         tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Populate settlementParticipantCurrency with aggregated data
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementParticipantCurrency**
                       (settlementId, participantCurrencyId, createdDate, netAmount)
                SELECT settlementId, participantCurrencyId, {transactionTimestamp}, SUM(amount)
                FROM settlementTransferParticipant
                WHERE settlementId = {settlementId}
                GROUP BY settlementId, participantCurrencyId
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementParticipantCurrencyIdList**
            deactivate DB

            SETTLE_DAO -> DB: Insert initial settlement accounts state 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementParticipantCurrencyStateChange**
                       (settlementParticipantCurrencyId, settlementStateId, reason, createdDate)
                VALUES ({settlementParticipantCurrencyIdList}, 'PENDING_SETTLEMENT',
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB
            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto settlementParticipantCurrencyIdList in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId = {settlementParticipantCurrencyStateChangeIdList}
                WHERE settlementParticipantCurrencyId = {settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Insert new state for settlementWindow 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES ({payload.settlementWindows.idList}, 'PENDING_SETTLEMENT',
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementWindowStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge settlementWindowStateChangeIdList\nto payload.settlementWindows.idList

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**
                SET currentStateChangeId = {settlementWindowStateChangeIdList}
                WHERE settlementParticipantCurrencyId = {payload.settlementWindows.idList}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Insert initial state for settlement 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementStateChange**
                       (settlementId, settlementStateId, reason, createdDate)
                VALUES ({settlementId}, ‘PENDING_SETTLEMENT’,
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlement**
                SET currentStateChangeId = {settlementStateChangeId}
                WHERE settlementId = {settlementId}
            end hnote
            deactivate DB
        end

        SETTLE_DAO -> DB: Select account data for response
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId, spc.netAmount, pc.currencyId
            FROM **settlementParticipantCurrency** spc
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {settlementId}
        end hnote
        SETTLE_DAO <- - DB: Return **accountData**
        deactivate DB

        SSAPI <- - SETTLE_DAO: Construct and return result
        deactivate SETTLE_DAO
        note left of SSAPI #yellow
            {
                "id": settlementId,
                "state": "PENDING_SETTLEMENT",
                "settlementWindows": [
                    {
                        "id": windowsData.settlementWindowIdList,
                        "state": "PENDING_SETTLEMENT",
                        "reason": payload.reason,
                        "createdDate": windowsData.createdDateList,
                        "changedDate": transactionTimestamp
                    }
                ],
                "participants": [
                    {
                        "id": accountData.participantId,
                        "accounts": [
                            {
                                "id": accountData.participantCurrencyId,
                                "state": "PENDING_SETTLEMENT",
                                "reason": payload.reason,
                                "netSettlementAmount": {
                                    "amount": accountData.netAmount,
                                    "currency": accountData.currencyId
                                }
                            }
                        ]
                    }
                ]
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 201 (Created)
    else
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "Client error description"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
        deactivate SSAPI
        deactivate OPERATOR
    end
end
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
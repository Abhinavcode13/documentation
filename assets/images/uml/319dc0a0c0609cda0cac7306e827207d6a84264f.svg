<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="6042px" preserveAspectRatio="none" style="width:1546px;height:6042px;" version="1.1" viewBox="0 0 1546 6042" width="1546px" zoomAndPan="magnify"><defs><filter height="300%" id="fliqrzwmbjbfe" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="663" x="442.5" y="22.9951">2.3.2. Abort Position Handler Consume (single message, includes individual transfers from Bulk)</text><rect fill="#FFFFE0" height="5997.5313" style="stroke: #A80036; stroke-width: 1.0;" width="1280" x="49" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="640" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="5830.8047" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="104" y="125.7266"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="620" y="2163.8125"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="620" y="3249.1875"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="620" y="4208.7031"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="620" y="5330.4766"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="738.5" y="1596.7578"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="738.5" y="3725.4453"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="738.5" y="5897.5313"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="856" y="210.2578"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="514.5234" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="856" y="528.8516"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="856" y="2276.2109"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="182.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="856" y="2579.6719"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="856" y="4321.1016"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="182.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="856" y="4594.2969"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="239.3906"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="582.1172"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="715.6484"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="823.0469"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="2305.3438"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="2632.9375"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="4350.2344"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="4647.5625"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="5816.8047" style="stroke: #000000; stroke-width: 2.0;" width="1522" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="2051.9531" style="stroke: #000000; stroke-width: 2.0;" width="1492" x="33" y="156.8594"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="618.0547" style="stroke: #000000; stroke-width: 2.0;" width="1472" x="43" y="433.3203"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="471.3906" style="stroke: #000000; stroke-width: 2.0;" width="700" x="805" y="543.8516"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="1136.4375" style="stroke: #000000; stroke-width: 2.0;" width="772" x="43" y="1065.375"/><rect fill="#FFFFFF" height="567.0547" style="stroke: none; stroke-width: 1.0;" width="772" x="43" y="1634.7578"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="2030.8906" style="stroke: #000000; stroke-width: 2.0;" width="1377" x="23" y="2222.8125"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="286.3281" style="stroke: #000000; stroke-width: 2.0;" width="1347" x="43" y="2484.1406"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="139.6641" style="stroke: #000000; stroke-width: 2.0;" width="575" x="805" y="2594.6719"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="1462.2344" style="stroke: #000000; stroke-width: 2.0;" width="792" x="33" y="2784.4688"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="954.8438" style="stroke: #000000; stroke-width: 2.0;" width="772" x="43" y="2808.6016"/><rect fill="#FFFFFF" height="476.2578" style="stroke: none; stroke-width: 1.0;" width="772" x="43" y="3287.1875"/><rect fill="#FFFFFF" height="476.2578" style="stroke: none; stroke-width: 1.0;" width="792" x="33" y="3770.4453"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="1674.8281" style="stroke: #000000; stroke-width: 2.0;" width="1367" x="33" y="4267.7031"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="286.3281" style="stroke: #000000; stroke-width: 2.0;" width="1347" x="43" y="4498.7656"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="139.6641" style="stroke: #000000; stroke-width: 2.0;" width="575" x="805" y="4609.2969"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="1136.4375" style="stroke: #000000; stroke-width: 2.0;" width="772" x="43" y="4799.0938"/><rect fill="#FFFFFF" height="567.0547" style="stroke: none; stroke-width: 1.0;" width="772" x="43" y="5368.4766"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="109" x2="109" y1="115.7266" y2="5966.5313"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="625" x2="625" y1="115.7266" y2="5966.5313"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="743" x2="743" y1="115.7266" y2="5966.5313"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="861" x2="861" y1="115.7266" y2="5966.5313"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1281" x2="1281" y1="115.7266" y2="5966.5313"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="53" y="112.4248">Position Handler</text><ellipse cx="109" cy="83.4297" fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="105,71.4297,111,66.4297,109,71.4297,111,76.4297,105,71.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="53" y="5978.5264">Position Handler</text><ellipse cx="109" cy="5997.8281" fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="105,5985.8281,111,5980.8281,109,5985.8281,111,5990.8281,105,5985.8281" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="582" y="60.1328"/><rect fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="578" y="64.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="602.5" y="84.1279">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="585" y="100.4248">notification</text><rect fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="582" y="5965.5313"/><rect fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="578" y="5969.5313"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="602.5" y="5989.5264">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="585" y="6005.8232">notification</text><rect fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="686" y="60.1328"/><rect fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="682" y="64.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="721" y="84.1279">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="689" y="100.4248">bulk-processing</text><rect fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="686" y="5965.5313"/><rect fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="682" y="5969.5313"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="721" y="5989.5264">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="689" y="6005.8232">bulk-processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="815" y="112.4248">Position DAO</text><ellipse cx="861" cy="83.4297" fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="849" x2="873" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="815" y="5978.5264">Position DAO</text><ellipse cx="861" cy="5997.8281" fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="849" x2="873" y1="6011.8281" y2="6011.8281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1237" y="112.4248">Central Store</text><path d="M1263,63.4297 C1263,53.4297 1281,53.4297 1281,53.4297 C1281,53.4297 1299,53.4297 1299,63.4297 L1299,89.4297 C1299,99.4297 1281,99.4297 1281,99.4297 C1281,99.4297 1263,99.4297 1263,89.4297 L1263,63.4297 " fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1263,63.4297 C1263,73.4297 1281,73.4297 1281,73.4297 C1281,73.4297 1299,73.4297 1299,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1237" y="5978.5264">Central Store</text><path d="M1263,5991.8281 C1263,5981.8281 1281,5981.8281 1281,5981.8281 C1281,5981.8281 1299,5981.8281 1299,5991.8281 L1299,6017.8281 C1299,6027.8281 1281,6027.8281 1281,6027.8281 C1281,6027.8281 1263,6027.8281 1263,6017.8281 L1263,5991.8281 " fill="#FEFECE" filter="url(#fliqrzwmbjbfe)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1263,5991.8281 C1263,6001.8281 1281,6001.8281 1281,6001.8281 C1281,6001.8281 1299,6001.8281 1299,5991.8281 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="5830.8047" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="104" y="125.7266"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="620" y="2163.8125"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="620" y="3249.1875"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="620" y="4208.7031"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="620" y="5330.4766"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="738.5" y="1596.7578"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="738.5" y="3725.4453"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="738.5" y="5897.5313"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="856" y="210.2578"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="514.5234" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="856" y="528.8516"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="856" y="2276.2109"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="182.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="856" y="2579.6719"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="856" y="4321.1016"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="182.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="856" y="4594.2969"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="239.3906"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="582.1172"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="715.6484"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="823.0469"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="2305.3438"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="2632.9375"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="4350.2344"/><rect fill="#FFFFFF" filter="url(#fliqrzwmbjbfe)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1276" y="4647.5625"/><path d="M13,132.7266 L264,132.7266 L264,139.7266 L254,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="5816.8047" style="stroke: #000000; stroke-width: 2.0;" width="1522" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="28" y="145.7935">Abort Position Handler Consume</text><path d="M33,156.8594 L100,156.8594 L100,163.8594 L90,173.8594 L33,173.8594 L33,156.8594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2051.9531" style="stroke: #000000; stroke-width: 2.0;" width="1492" x="33" y="156.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="48" y="169.9263">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="362" x="115" y="169.0698">[type IN ['position','bulk-position'] &amp;&amp; action == 'timeout-reserved']</text><polygon fill="#A80036" points="844,206.2578,854,210.2578,844,214.2578,848,210.2578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="850" y1="210.2578" y2="210.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="121" y="197.6255">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="132" y="190.0591">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="132" y="205.1919">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="206" y="205.1919">2003</text><polygon fill="#A80036" points="1264,235.3906,1274,239.3906,1264,243.3906,1268,239.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866" x2="1270" y1="239.3906" y2="239.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="873" y="234.3247">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="884" y="234.3247">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fliqrzwmbjbfe)" points="1219,252.3906,1343,252.3906,1353,271.3906,1343,290.3906,1219,290.3906,1209,271.3906,1219,252.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1221" y="268.4575">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="1221" y="283.5903">transferParticipant</text><polygon fill="#A80036" points="877,312.7891,867,316.7891,877,320.7891,873,316.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="871" x2="1280" y1="316.7891" y2="316.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="883" y="311.7231">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="894" y="311.7231">Return current state of transfer from DB</text><polygon fill="#A80036" points="125,341.9219,115,345.9219,125,349.9219,121,345.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="119" x2="860" y1="345.9219" y2="345.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="131" y="340.856">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="142" y="340.856">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="156" y1="405.3203" y2="405.3203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="156" x2="156" y1="405.3203" y2="418.3203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="156" y1="418.3203" y2="418.3203"/><polygon fill="#A80036" points="125,414.3203,115,418.3203,125,422.3203,121,418.3203" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="121" y="385.1216">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="132" y="369.9888">Validate current state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="132" y="385.1216">(transferStateChange.transferStateId == 'RESERVED_TIMEOUT')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="132" y="400.2544">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="206" y="400.2544">2001</text><path d="M43,433.3203 L356,433.3203 L356,440.3203 L346,450.3203 L43,450.3203 L43,433.3203 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="618.0547" style="stroke: #000000; stroke-width: 2.0;" width="1472" x="43" y="433.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="268" x="58" y="446.3872">Persist Position change and Transfer state</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="156" y1="471.5859" y2="471.5859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="156" x2="156" y1="471.5859" y2="484.5859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="156" y1="484.5859" y2="484.5859"/><polygon fill="#A80036" points="125,480.5859,115,484.5859,125,488.5859,121,484.5859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="121" y="466.52">6</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="132" y="466.52">transferStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="237" y="466.52">= 'EXPIRED_RESERVED'</text><polygon fill="#A80036" points="844,524.8516,854,528.8516,844,532.8516,848,528.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="850" y1="528.8516" y2="528.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="121" y="516.2192">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="132" y="508.6528">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="132" y="523.7856">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="206" y="523.7856">2003</text><path d="M805,543.8516 L1071,543.8516 L1071,550.8516 L1061,560.8516 L805,560.8516 L805,543.8516 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="471.3906" style="stroke: #000000; stroke-width: 2.0;" width="700" x="805" y="543.8516"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="820" y="556.9185">DB TRANSACTION IMPLEMENTATION</text><polygon fill="#A80036" points="1264,578.1172,1274,582.1172,1264,586.1172,1268,582.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866" x2="1270" y1="582.1172" y2="582.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="873" y="577.0513">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="884" y="577.0513">Select participantPosition.value FOR UPDATE for payerCurrencyId</text><polygon fill="#FFFFE0" filter="url(#fliqrzwmbjbfe)" points="1224,595.1172,1338,595.1172,1348,606.1172,1338,618.1172,1224,618.1172,1214,606.1172,1224,595.1172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1226" y="611.1841">participantPosition</text><polygon fill="#A80036" points="877,640.3828,867,644.3828,877,648.3828,873,644.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="871" x2="1280" y1="644.3828" y2="644.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="883" y="639.3169">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="894" y="639.3169">Return participantPosition</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="866" x2="908" y1="673.5156" y2="673.5156"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="908" x2="908" y1="673.5156" y2="686.5156"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="867" x2="908" y1="686.5156" y2="686.5156"/><polygon fill="#A80036" points="877,682.5156,867,686.5156,877,690.5156,873,686.5156" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="873" y="668.4497">10</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="891" y="668.4497">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="984" y="668.4497">= participantPosition - payload.amount.amount</text><polygon fill="#A80036" points="1264,711.6484,1274,715.6484,1264,719.6484,1268,715.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866" x2="1270" y1="715.6484" y2="715.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="873" y="710.5825">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="891" y="710.5825">Persist latestPosition to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#fliqrzwmbjbfe)" points="1191,758.6484,1370,758.6484,1380,777.6484,1370,796.6484,1191,796.6484,1181,777.6484,1191,758.6484" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="1193" y="774.7153">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1243" y="774.7153">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1193" y="789.8481">SET value = latestPosition</text><polygon fill="#A80036" points="1264,819.0469,1274,823.0469,1264,827.0469,1268,823.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866" x2="1270" y1="823.0469" y2="823.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="873" y="817.981">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="891" y="817.981">Persist participant position change and state change</text><polygon fill="#FFFFE0" filter="url(#fliqrzwmbjbfe)" points="1076,866.0469,1485,866.0469,1495,938.0469,1485,1010.0469,1076,1010.0469,1066,938.0469,1076,866.0469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="1078" y="882.1138">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1124" y="882.1138">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1262" y="882.1138"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="1078" y="897.2466">VALUES (transferStateId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1081" y="912.3794"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="1078" y="927.5122">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="1124" y="927.5122">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="399" x="1078" y="942.645">SET participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="405" x="1078" y="957.7778">transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1078" y="972.9106">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="1078" y="988.0435">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="1078" y="1003.1763">createdDate = new Date()</text><polygon fill="#A80036" points="125,1039.375,115,1043.375,125,1047.375,121,1043.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="119" x2="860" y1="1043.375" y2="1043.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="131" y="1038.3091">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="149" y="1038.3091">Return success</text><path d="M43,1065.375 L106,1065.375 L106,1072.375 L96,1082.375 L43,1082.375 L43,1065.375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1136.4375" style="stroke: #000000; stroke-width: 2.0;" width="772" x="43" y="1065.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="58" y="1078.4419">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="121" y="1077.5854">[If type == 'bulk-position']</text><path d="M119,1087.5078 L119,1550.5078 L475,1550.5078 L475,1097.5078 L465,1087.5078 L119,1087.5078 " fill="#FFFF00" filter="url(#fliqrzwmbjbfe)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M465,1087.5078 L465,1097.5078 L475,1097.5078 L465,1087.5078 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="125" y="1104.5747">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="1119.7075">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="137" y="1134.8403">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="1149.9731">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="137" y="1165.106">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="137" y="1180.2388">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="149" y="1195.3716">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="149" y="1210.5044">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="161" y="1225.6372">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="173" y="1240.77">"errorCode": 3300,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="173" y="1255.9028">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="173" y="1271.0356">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="161" y="1286.1685">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="149" y="1301.3013">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="137" y="1316.4341">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="137" y="1331.5669">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="149" y="1346.6997">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="161" y="1361.8325">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="161" y="1376.9653">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="161" y="1392.0981">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="161" y="1407.231">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="161" y="1422.3638">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="161" y="1437.4966">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="173" y="1452.6294">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="173" y="1467.7622">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="173" y="1482.895">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="161" y="1498.0278">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="149" y="1513.1606">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="137" y="1528.2935">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="125" y="1543.4263">}</text><polygon fill="#A80036" points="726.5,1592.7578,736.5,1596.7578,726.5,1600.7578,730.5,1596.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="732.5" y1="1596.7578" y2="1596.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="1584.1255">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="337" x="139" y="1576.5591">Publish Transfer event to Bulk Processing Topic (for Payer)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="139" y="1591.6919">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="219" y="1591.6919">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="815" y1="1635.7578" y2="1635.7578"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="48" y="1645.9683">[If type == 'position']</text><path d="M119,1654.5625 L119,2117.5625 L475,2117.5625 L475,1664.5625 L465,1654.5625 L119,1654.5625 " fill="#FFFF00" filter="url(#fliqrzwmbjbfe)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M465,1654.5625 L465,1664.5625 L475,1664.5625 L465,1654.5625 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="125" y="1671.6294">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="1686.7622">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="137" y="1701.895">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="1717.0278">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="137" y="1732.1606">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="137" y="1747.2935">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="149" y="1762.4263">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="149" y="1777.5591">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="161" y="1792.6919">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="173" y="1807.8247">"errorCode": 3300,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="173" y="1822.9575">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="173" y="1838.0903">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="161" y="1853.2231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="149" y="1868.356">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="137" y="1883.4888">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="137" y="1898.6216">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="149" y="1913.7544">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="161" y="1928.8872">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="161" y="1944.02">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="161" y="1959.1528">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="161" y="1974.2856">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="161" y="1989.4185">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="161" y="2004.5513">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="173" y="2019.6841">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="173" y="2034.8169">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="173" y="2049.9497">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="161" y="2065.0825">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="149" y="2080.2153">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="137" y="2095.3481">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="125" y="2110.481">}</text><polygon fill="#A80036" points="608,2159.8125,618,2163.8125,608,2167.8125,612,2163.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="614" y1="2163.8125" y2="2163.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="2151.1802">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="139" y="2143.6138">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="139" y="2158.7466">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="213" y="2158.7466">2003</text><path d="M23,2222.8125 L90,2222.8125 L90,2229.8125 L80,2239.8125 L23,2239.8125 L23,2222.8125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2030.8906" style="stroke: #000000; stroke-width: 2.0;" width="1377" x="23" y="2222.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="2235.8794">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="359" x="105" y="2235.0229">[type IN ['position','bulk-position'] &amp;&amp; (action IN ['reject', 'abort'])]</text><polygon fill="#A80036" points="844,2272.2109,854,2276.2109,844,2280.2109,848,2276.2109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="850" y1="2276.2109" y2="2276.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="2263.5786">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="139" y="2256.0122">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="139" y="2271.145">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="213" y="2271.145">2003</text><polygon fill="#A80036" points="1264,2301.3438,1274,2305.3438,1264,2309.3438,1268,2305.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866" x2="1270" y1="2305.3438" y2="2305.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="873" y="2300.2778">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="891" y="2300.2778">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fliqrzwmbjbfe)" points="1219,2318.3438,1343,2318.3438,1353,2329.3438,1343,2341.3438,1219,2341.3438,1209,2329.3438,1219,2318.3438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1221" y="2334.4106">transferStateChange</text><polygon fill="#A80036" points="877,2363.6094,867,2367.6094,877,2371.6094,873,2367.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="871" x2="1280" y1="2367.6094" y2="2367.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="883" y="2362.5435">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="901" y="2362.5435">Return current state of transfer from DB</text><polygon fill="#A80036" points="125,2392.7422,115,2396.7422,125,2400.7422,121,2396.7422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="119" x2="860" y1="2396.7422" y2="2396.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="131" y="2391.6763">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="149" y="2391.6763">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="156" y1="2456.1406" y2="2456.1406"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="156" x2="156" y1="2456.1406" y2="2469.1406"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="156" y1="2469.1406" y2="2469.1406"/><polygon fill="#A80036" points="125,2465.1406,115,2469.1406,125,2473.1406,121,2469.1406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="2435.9419">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="139" y="2420.8091">Validate current state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="472" x="139" y="2435.9419">(transferStateChange.transferStateId IN ['RECEIVED_REJECT', 'RECEIVED_ERROR'])</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="139" y="2451.0747">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="213" y="2451.0747">2001</text><path d="M43,2484.1406 L356,2484.1406 L356,2491.1406 L346,2501.1406 L43,2501.1406 L43,2484.1406 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="286.3281" style="stroke: #000000; stroke-width: 2.0;" width="1347" x="43" y="2484.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="268" x="58" y="2497.2075">Persist Position change and Transfer state</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="156" y1="2522.4063" y2="2522.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="156" x2="156" y1="2522.4063" y2="2535.4063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="156" y1="2535.4063" y2="2535.4063"/><polygon fill="#A80036" points="125,2531.4063,115,2535.4063,125,2539.4063,121,2535.4063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="2517.3403">21</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="139" y="2517.3403">transferStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="244" y="2517.3403">= (action == 'reject' ? 'ABORTED_REJECTED' : 'ABORTED_ERROR' )</text><polygon fill="#A80036" points="844,2575.6719,854,2579.6719,844,2583.6719,848,2579.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="850" y1="2579.6719" y2="2579.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="2567.0396">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="139" y="2559.4731">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="139" y="2574.606">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="213" y="2574.606">2003</text><path d="M805,2594.6719 L1168,2594.6719 L1168,2601.6719 L1158,2611.6719 L805,2611.6719 L805,2594.6719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="139.6641" style="stroke: #000000; stroke-width: 2.0;" width="575" x="805" y="2594.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="52" x="820" y="2607.7388">Refer to</text><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="875" y="2607.7388">DB TRANSACTION IMPLEMENTATION</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="1099" y="2607.7388">above</text><polygon fill="#A80036" points="1264,2628.9375,1274,2632.9375,1264,2636.9375,1268,2632.9375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866" x2="1270" y1="2632.9375" y2="2632.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="873" y="2627.8716">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="891" y="2627.8716">Persist to database</text><polygon fill="#FFFFE0" filter="url(#fliqrzwmbjbfe)" points="1201,2675.9375,1360,2675.9375,1370,2701.9375,1360,2728.9375,1201,2728.9375,1191,2701.9375,1201,2675.9375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1203" y="2692.0044">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1203" y="2707.1372">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="1203" y="2722.27">participantPositionChange</text><polygon fill="#A80036" points="125,2758.4688,115,2762.4688,125,2766.4688,121,2762.4688" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="119" x2="860" y1="2762.4688" y2="2762.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="131" y="2757.4028">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="149" y="2757.4028">Return success</text><path d="M33,2784.4688 L96,2784.4688 L96,2791.4688 L86,2801.4688 L33,2801.4688 L33,2784.4688 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1462.2344" style="stroke: #000000; stroke-width: 2.0;" width="792" x="33" y="2784.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="48" y="2797.5356">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="111" y="2796.6792">[If action == 'reject']</text><path d="M43,2808.6016 L106,2808.6016 L106,2815.6016 L96,2825.6016 L43,2825.6016 L43,2808.6016 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="954.8438" style="stroke: #000000; stroke-width: 2.0;" width="772" x="43" y="2808.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="58" y="2821.6685">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="121" y="2820.812">[If type == 'position']</text><path d="M119,2830.7344 L119,3203.7344 L369,3203.7344 L369,2840.7344 L359,2830.7344 L119,2830.7344 " fill="#FFFF00" filter="url(#fliqrzwmbjbfe)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M359,2830.7344 L359,2840.7344 L369,2840.7344 L359,2830.7344 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="125" y="2847.8013">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="2862.9341">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="137" y="2878.0669">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="2893.1997">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="137" y="2908.3325">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="137" y="2923.4653">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="149" y="2938.5981">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="149" y="2953.731">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="137" y="2968.8638">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="137" y="2983.9966">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="149" y="2999.1294">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="161" y="3014.2622">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="161" y="3029.395">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="161" y="3044.5278">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="161" y="3059.6606">action: reject,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="161" y="3074.7935">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="161" y="3089.9263">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="173" y="3105.0591">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="173" y="3120.1919">code: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="173" y="3135.3247">description: "action successful"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="161" y="3150.4575">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="149" y="3165.5903">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="137" y="3180.7231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="125" y="3195.856">}</text><polygon fill="#A80036" points="608,3245.1875,618,3249.1875,608,3253.1875,612,3249.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="614" y1="3249.1875" y2="3249.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="3236.5552">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="139" y="3228.9888">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="139" y="3244.1216">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="213" y="3244.1216">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="815" y1="3288.1875" y2="3288.1875"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="48" y="3298.3979">[If type == 'bulk-position']</text><path d="M119,3306.9922 L119,3679.9922 L369,3679.9922 L369,3316.9922 L359,3306.9922 L119,3306.9922 " fill="#FFFF00" filter="url(#fliqrzwmbjbfe)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M359,3306.9922 L359,3316.9922 L369,3316.9922 L359,3306.9922 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="125" y="3324.0591">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="3339.1919">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="137" y="3354.3247">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="3369.4575">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="137" y="3384.5903">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="137" y="3399.7231">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="149" y="3414.856">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="149" y="3429.9888">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="137" y="3445.1216">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="137" y="3460.2544">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="149" y="3475.3872">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="161" y="3490.52">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="161" y="3505.6528">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="161" y="3520.7856">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="161" y="3535.9185">action: reject,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="161" y="3551.0513">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="161" y="3566.1841">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="173" y="3581.3169">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="173" y="3596.4497">code: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="173" y="3611.5825">description: "action successful"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="161" y="3626.7153">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="149" y="3641.8481">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="137" y="3656.981">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="125" y="3672.1138">}</text><polygon fill="#A80036" points="726.5,3721.4453,736.5,3725.4453,726.5,3729.4453,730.5,3725.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="732.5" y1="3725.4453" y2="3725.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="3712.813">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="139" y="3705.2466">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="139" y="3720.3794">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="213" y="3720.3794">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="825" y1="3771.4453" y2="3771.4453"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="96" x="38" y="3781.6558">[action == 'abort']</text><path d="M119,3790.25 L119,4163.25 L525,4163.25 L525,3800.25 L515,3790.25 L119,3790.25 " fill="#FFFF00" filter="url(#fliqrzwmbjbfe)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M515,3790.25 L515,3800.25 L525,3800.25 L515,3790.25 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="125" y="3807.3169">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="3822.4497">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="137" y="3837.5825">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="3852.7153">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="137" y="3867.8481">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="137" y="3882.981">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="149" y="3898.1138">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="149" y="3913.2466">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="137" y="3928.3794">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="137" y="3943.5122">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="149" y="3958.645">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="161" y="3973.7778">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="161" y="3988.9106">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="161" y="4004.0435">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="161" y="4019.1763">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="161" y="4034.3091">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="161" y="4049.4419">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="173" y="4064.5747">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="173" y="4079.7075">code: &lt;payload.errorInformation.errorCode || 5000&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="337" x="173" y="4094.8403">description: &lt;payload.errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="161" y="4109.9731">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="149" y="4125.106">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="137" y="4140.2388">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="125" y="4155.3716">}</text><polygon fill="#A80036" points="608,4204.7031,618,4208.7031,608,4212.7031,612,4208.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="614" y1="4208.7031" y2="4208.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="4196.0708">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="139" y="4188.5044">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="139" y="4203.6372">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="213" y="4203.6372">2003</text><path d="M33,4267.7031 L100,4267.7031 L100,4274.7031 L90,4284.7031 L33,4284.7031 L33,4267.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1674.8281" style="stroke: #000000; stroke-width: 2.0;" width="1367" x="33" y="4267.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="48" y="4280.77">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="512" x="115" y="4279.9136">[type IN ['position','bulk-position'] &amp;&amp; action == 'fail' (Unable to currently trigger this scenario)]</text><polygon fill="#A80036" points="844,4317.1016,854,4321.1016,844,4325.1016,848,4321.1016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="850" y1="4321.1016" y2="4321.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="4308.4692">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="139" y="4300.9028">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="139" y="4316.0356">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="213" y="4316.0356">2003</text><polygon fill="#A80036" points="1264,4346.2344,1274,4350.2344,1264,4354.2344,1268,4350.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866" x2="1270" y1="4350.2344" y2="4350.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="873" y="4345.1685">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="891" y="4345.1685">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fliqrzwmbjbfe)" points="1219,4363.2344,1343,4363.2344,1353,4374.2344,1343,4386.2344,1219,4386.2344,1209,4374.2344,1219,4363.2344" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1221" y="4379.3013">transferStateChange</text><polygon fill="#A80036" points="877,4408.5,867,4412.5,877,4416.5,873,4412.5" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="871" x2="1280" y1="4412.5" y2="4412.5"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="883" y="4407.4341">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="901" y="4407.4341">Return current state of transfer from DB</text><polygon fill="#A80036" points="125,4437.6328,115,4441.6328,125,4445.6328,121,4441.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="119" x2="860" y1="4441.6328" y2="4441.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="131" y="4436.5669">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="149" y="4436.5669">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="156" y1="4470.7656" y2="4470.7656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="156" x2="156" y1="4470.7656" y2="4483.7656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="156" y1="4483.7656" y2="4483.7656"/><polygon fill="#A80036" points="125,4479.7656,115,4483.7656,125,4487.7656,121,4483.7656" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="4465.6997">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="412" x="139" y="4465.6997">Validate current state (transferStateChange.transferStateId == 'FAILED')</text><path d="M43,4498.7656 L356,4498.7656 L356,4505.7656 L346,4515.7656 L43,4515.7656 L43,4498.7656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="286.3281" style="stroke: #000000; stroke-width: 2.0;" width="1347" x="43" y="4498.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="268" x="58" y="4511.8325">Persist Position change and Transfer state</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="156" y1="4537.0313" y2="4537.0313"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="156" x2="156" y1="4537.0313" y2="4550.0313"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="156" y1="4550.0313" y2="4550.0313"/><polygon fill="#A80036" points="125,4546.0313,115,4550.0313,125,4554.0313,121,4550.0313" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="4531.9653">33</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="139" y="4531.9653">transferStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="244" y="4531.9653">= 'FAILED'</text><polygon fill="#A80036" points="844,4590.2969,854,4594.2969,844,4598.2969,848,4594.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="850" y1="4594.2969" y2="4594.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="4581.6646">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="139" y="4574.0981">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="139" y="4589.231">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="213" y="4589.231">2003</text><path d="M805,4609.2969 L1168,4609.2969 L1168,4616.2969 L1158,4626.2969 L805,4626.2969 L805,4609.2969 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="139.6641" style="stroke: #000000; stroke-width: 2.0;" width="575" x="805" y="4609.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="52" x="820" y="4622.3638">Refer to</text><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="875" y="4622.3638">DB TRANSACTION IMPLEMENTATION</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="1099" y="4622.3638">above</text><polygon fill="#A80036" points="1264,4643.5625,1274,4647.5625,1264,4651.5625,1268,4647.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="866" x2="1270" y1="4647.5625" y2="4647.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="873" y="4642.4966">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="891" y="4642.4966">Persist to database</text><polygon fill="#FFFFE0" filter="url(#fliqrzwmbjbfe)" points="1201,4690.5625,1360,4690.5625,1370,4716.5625,1360,4743.5625,1201,4743.5625,1191,4716.5625,1201,4690.5625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1203" y="4706.6294">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1203" y="4721.7622">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="1203" y="4736.895">participantPositionChange</text><polygon fill="#A80036" points="125,4773.0938,115,4777.0938,125,4781.0938,121,4777.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="119" x2="860" y1="4777.0938" y2="4777.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="131" y="4772.0278">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="149" y="4772.0278">Return success</text><path d="M43,4799.0938 L106,4799.0938 L106,4806.0938 L96,4816.0938 L43,4816.0938 L43,4799.0938 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1136.4375" style="stroke: #000000; stroke-width: 2.0;" width="772" x="43" y="4799.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="58" y="4812.1606">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="121" y="4811.3042">[If type =='position']</text><path d="M119,4821.2266 L119,5284.2266 L475,5284.2266 L475,4831.2266 L465,4821.2266 L119,4821.2266 " fill="#FFFF00" filter="url(#fliqrzwmbjbfe)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M465,4821.2266 L465,4831.2266 L475,4831.2266 L465,4821.2266 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="125" y="4838.2935">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="4853.4263">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="137" y="4868.5591">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="4883.6919">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="137" y="4898.8247">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="137" y="4913.9575">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="149" y="4929.0903">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="149" y="4944.2231">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="161" y="4959.356">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="173" y="4974.4888">"errorCode": 3100,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="173" y="4989.6216">"errorDescription": "Transfer failed",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="173" y="5004.7544">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="161" y="5019.8872">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="149" y="5035.02">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="137" y="5050.1528">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="137" y="5065.2856">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="149" y="5080.4185">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="161" y="5095.5513">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="161" y="5110.6841">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="161" y="5125.8169">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="161" y="5140.9497">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="161" y="5156.0825">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="161" y="5171.2153">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="173" y="5186.3481">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="173" y="5201.481">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="173" y="5216.6138">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="161" y="5231.7466">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="149" y="5246.8794">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="137" y="5262.0122">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="125" y="5277.145">}</text><polygon fill="#A80036" points="608,5326.4766,618,5330.4766,608,5334.4766,612,5330.4766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="614" y1="5330.4766" y2="5330.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="5317.8442">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="139" y="5310.2778">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="139" y="5325.4106">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="213" y="5325.4106">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="43" x2="815" y1="5369.4766" y2="5369.4766"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="48" y="5379.687">[If type =='bulk-position']</text><path d="M119,5388.2813 L119,5851.2813 L475,5851.2813 L475,5398.2813 L465,5388.2813 L119,5388.2813 " fill="#FFFF00" filter="url(#fliqrzwmbjbfe)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M465,5388.2813 L465,5398.2813 L475,5398.2813 L465,5388.2813 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="125" y="5405.3481">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="5420.481">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="137" y="5435.6138">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="137" y="5450.7466">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="137" y="5465.8794">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="137" y="5481.0122">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="149" y="5496.145">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="149" y="5511.2778">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="161" y="5526.4106">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="173" y="5541.5435">"errorCode": 3100,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="173" y="5556.6763">"errorDescription": "Transfer failed",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="173" y="5571.8091">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="161" y="5586.9419">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="149" y="5602.0747">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="137" y="5617.2075">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="137" y="5632.3403">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="149" y="5647.4731">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="161" y="5662.606">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="161" y="5677.7388">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="161" y="5692.8716">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="161" y="5708.0044">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="161" y="5723.1372">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="161" y="5738.27">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="173" y="5753.4028">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="173" y="5768.5356">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="173" y="5783.6685">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="161" y="5798.8013">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="149" y="5813.9341">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="137" y="5829.0669">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="125" y="5844.1997">}</text><polygon fill="#A80036" points="726.5,5893.5313,736.5,5897.5313,726.5,5901.5313,730.5,5897.5313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="732.5" y1="5897.5313" y2="5897.5313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="5884.8989">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="139" y="5877.3325">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="139" y="5892.4653">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="213" y="5892.4653">2003</text><!--
@startuml
title 2.3.2. Abort Position Handler Consume (single message, includes individual transfers from Bulk)

autonumber


control "Position Handler" as POS_HANDLER
entity "Position DAO" as POS_DAO
collections "topic-\nnotification" as TOPIC_NOTIFICATIONS
collections "topic-\nbulk-processing" as TOPIC_BULK_PROCESSING
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_NOTIFICATIONS
    participant TOPIC_BULK_PROCESSING
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Abort Position Handler Consume
    opt type IN ['position','bulk-position'] && action == 'timeout-reserved'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
            transferParticipant
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state \n(transferStateChange.transferStateId == 'RESERVED_TIMEOUT')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer state
            POS_HANDLER -> POS_HANDLER: **transferStateId** = 'EXPIRED_RESERVED'
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>DB TRANSACTION IMPLEMENTATION</color>
                activate POS_DAO
                POS_DAO -> DB: Select participantPosition.value FOR UPDATE for payerCurrencyId
                activate DB
                hnote over DB #lightyellow
                    participantPosition
                end note
                DB - -> POS_DAO: Return participantPosition
                deactivate DB
                POS_DAO <-> POS_DAO: **latestPosition** = participantPosition - payload.amount.amount
                POS_DAO->DB: Persist latestPosition to DB for Payer
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = latestPosition
                end note
                activate DB
                deactivate DB
                POS_DAO -> DB: Persist participant position change and state change
                hnote over DB #lightyellow
                        INSERT **transferStateChange** 
                        VALUES (transferStateId)

                        INSERT **participantPositionChange**
                        SET participantPositionId = participantPosition.participantPositionId,
                        transferStateChangeId = transferStateChange.transferStateChangeId,
                        value = latestPosition,
                        reservedValue = participantPosition.reservedValue
                        createdDate = new Date()
                end note
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        alt If type == 'bulk-position'
            note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 3300,
                            "errorDescription": "Transfer expired",
                            "extensionList": <transferMessage.extensionList>
                        }
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: bulk-processing,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
            end note
            POS_HANDLER -> TOPIC_BULK_PROCESSING: Publish Transfer event to Bulk Processing Topic (for Payer) \n<color #FF0000><b>Error codes:</b> 2003</color>
            activate TOPIC_BULK_PROCESSING
            deactivate TOPIC_BULK_PROCESSING
        else If type == 'position'
            note right of POS_HANDLER #yellow
                Message: {
                    id: <transferMessage.transferId>
                    from: <transferMessage.payerFsp>,
                    to: <transferMessage.payeeFsp>,
                    type: application/json
                    content: {
                        headers: <transferHeaders>,
                        payload: {
                            "errorInformation": {
                                "errorCode": 3300,
                                "errorDescription": "Transfer expired",
                                "extensionList": <transferMessage.extensionList>
                            }
                        }
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: notification,
                            action: abort,
                            createdAt: <timestamp>,
                            state: {
                                status: 'error',
                                code: <errorInformation.errorCode>
                                description: <errorInformation.errorDescription>
                            }
                        }
                    }
                }
            end note
            POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
            activate TOPIC_NOTIFICATIONS
            deactivate TOPIC_NOTIFICATIONS
        end
    end
    opt type IN ['position','bulk-position'] && (action IN ['reject', 'abort'])
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state \n(transferStateChange.transferStateId IN ['RECEIVED_REJECT', 'RECEIVED_ERROR'])\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer state
            POS_HANDLER -> POS_HANDLER: **transferStateId** = (action == 'reject' ? 'ABORTED_REJECTED' : 'ABORTED_ERROR' )
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group Refer to <color #blue>DB TRANSACTION IMPLEMENTATION</color> above
                activate POS_DAO
                POS_DAO -> DB: Persist to database
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    participantPosition
                    transferStateChange
                    participantPositionChange
                end note
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        alt If action == 'reject'
            alt If type == 'position'
                note right of POS_HANDLER #yellow
                    Message: {
                        id: <transferMessage.transferId>
                        from: <transferMessage.payerFsp>,
                        to: <transferMessage.payeeFsp>,
                        type: application/json
                        content: {
                            headers: <transferHeaders>,
                            payload: <transferMessage>
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                responseTo: <previous.uuid>,
                                type: notification,
                                action: reject,
                                createdAt: <timestamp>,
                                state: {
                                    status: "success",
                                    code: 0,
                                    description: "action successful"
                                }
                            }
                        }
                    }
                end note
                POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
                activate TOPIC_NOTIFICATIONS
                deactivate TOPIC_NOTIFICATIONS
            else If type == 'bulk-position'
                note right of POS_HANDLER #yellow
                    Message: {
                        id: <transferMessage.transferId>
                        from: <transferMessage.payerFsp>,
                        to: <transferMessage.payeeFsp>,
                        type: application/json
                        content: {
                            headers: <transferHeaders>,
                            payload: <transferMessage>
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                responseTo: <previous.uuid>,
                                type: bulk-processing,
                                action: reject,
                                createdAt: <timestamp>,
                                state: {
                                    status: "success",
                                    code: 0,
                                    description: "action successful"
                                }
                            }
                        }
                    }
                end note
                POS_HANDLER -> TOPIC_BULK_PROCESSING: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
                activate TOPIC_BULK_PROCESSING
                deactivate TOPIC_BULK_PROCESSING
            end
        else action == 'abort'
            note right of POS_HANDLER #yellow
                Message: {
                    id: <transferMessage.transferId>
                    from: <transferMessage.payerFsp>,
                    to: <transferMessage.payeeFsp>,
                    type: application/json
                    content: {
                        headers: <transferHeaders>,
                        payload: <transferMessage>
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: notification,
                            action: abort,
                            createdAt: <timestamp>,
                            state: {
                                status: 'error',
                                code: <payload.errorInformation.errorCode || 5000>
                                description: <payload.errorInformation.errorDescription>
                            }
                        }
                    }
                }
            end note
            POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
            activate TOPIC_NOTIFICATIONS
            deactivate TOPIC_NOTIFICATIONS
        end
    end

    opt type IN ['position','bulk-position'] && action == 'fail' (Unable to currently trigger this scenario)
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'FAILED')

        group Persist Position change and Transfer state
            POS_HANDLER -> POS_HANDLER: **transferStateId** = 'FAILED'
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group Refer to <color #blue>DB TRANSACTION IMPLEMENTATION</color> above
                activate POS_DAO
                POS_DAO -> DB: Persist to database
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    participantPosition
                    transferStateChange
                    participantPositionChange
                end note
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        alt If type =='position'
            note right of POS_HANDLER #yellow
                Message: {
                    id: <transferMessage.transferId>
                    from: <transferMessage.payerFsp>,
                    to: <transferMessage.payeeFsp>,
                    type: application/json
                    content: {
                        headers: <transferHeaders>,
                        payload: {
                            "errorInformation": {
                                "errorCode": 3100,
                                "errorDescription": "Transfer failed",
                                "extensionList": <transferMessage.extensionList>
                            }
                        }
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: notification,
                            action: abort,
                            createdAt: <timestamp>,
                            state: {
                                status: 'error',
                                code: <errorInformation.errorCode>
                                description: <errorInformation.errorDescription>
                            }
                        }
                    }
                }
            end note
            POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
            activate TOPIC_NOTIFICATIONS
            deactivate TOPIC_NOTIFICATIONS
        else If type =='bulk-position'
            note right of POS_HANDLER #yellow
                Message: {
                    id: <transferMessage.transferId>
                    from: <transferMessage.payerFsp>,
                    to: <transferMessage.payeeFsp>,
                    type: application/json
                    content: {
                        headers: <transferHeaders>,
                        payload: {
                            "errorInformation": {
                                "errorCode": 3100,
                                "errorDescription": "Transfer failed",
                                "extensionList": <transferMessage.extensionList>
                            }
                        }
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: bulk-processing,
                            action: abort,
                            createdAt: <timestamp>,
                            state: {
                                status: 'error',
                                code: <errorInformation.errorCode>
                                description: <errorInformation.errorDescription>
                            }
                        }
                    }
                }
            end note
            POS_HANDLER -> TOPIC_BULK_PROCESSING: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
            activate TOPIC_BULK_PROCESSING
            deactivate TOPIC_BULK_PROCESSING
        end
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4479px" preserveAspectRatio="none" style="width:1295px;height:4479px;" version="1.1" viewBox="0 0 1295 4479" width="1295px" zoomAndPan="magnify"><defs><filter height="300%" id="fg6ppja5gzurl" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="275" x="511" y="22.9951">1.4.0. Bulk Processing Handler Consume</text><rect fill="#FFFFE0" height="4434.5078" style="stroke: #A80036; stroke-width: 1.0;" width="1197" x="19" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="568.5" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="63.5" y="173.2891"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="4263.1875" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="213.5" y="128.0234"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="643" y="3680.7578"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="768.5" y="3380.625"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="768.5" y="4271.2734"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878" y="607.2813"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="151.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878" y="2172.7813"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878" y="2353.5781"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878" y="2642.5781"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="150.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878" y="3461.5625"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1163" y="636.4141"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1163" y="2232.1797"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1163" y="2382.7109"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1163" y="2671.7109"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="92.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1163" y="3490.6953"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="4249.1875" style="stroke: #000000; stroke-width: 2.0;" width="1271" x="13" y="135.0234"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="166.0625" style="stroke: #000000; stroke-width: 2.0;" width="405.5" x="145" y="218.2891"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="134.9297" style="stroke: #000000; stroke-width: 2.0;" width="385.5" x="155" y="242.4219"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="443" x="155" y="398.3516"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="3808.1953" style="stroke: #000000; stroke-width: 2.0;" width="1139" x="135" y="569.0156"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="1362.5703" style="stroke: #000000; stroke-width: 2.0;" width="499" x="198" y="757.9453"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="1171.2422" style="stroke: #000000; stroke-width: 2.0;" width="479" x="208" y="942.2734"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="317.4141" style="stroke: #000000; stroke-width: 2.0;" width="378" x="218" y="1035.8047"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="378" x="218" y="1092.0703"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="378" x="218" y="1146.0078"/><rect fill="#FFFFFF" height="84.2031" style="stroke: none; stroke-width: 1.0;" width="378" x="218" y="1199.9453"/><rect fill="#FFFFFF" height="69.0703" style="stroke: none; stroke-width: 1.0;" width="378" x="218" y="1284.1484"/><rect fill="#FFFFFF" height="199.5391" style="stroke: none; stroke-width: 1.0;" width="479" x="208" y="1360.2188"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="170.7344" style="stroke: #000000; stroke-width: 2.0;" width="381" x="218" y="1382.0234"/><rect fill="#FFFFFF" height="69.0703" style="stroke: none; stroke-width: 1.0;" width="381" x="218" y="1483.6875"/><rect fill="#FFFFFF" height="469.5547" style="stroke: none; stroke-width: 1.0;" width="479" x="208" y="1559.7578"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="371.3516" style="stroke: #000000; stroke-width: 2.0;" width="397" x="218" y="1650.9609"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="397" x="218" y="1707.2266"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="397" x="218" y="1761.1641"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="397" x="218" y="1815.1016"/><rect fill="#FFFFFF" height="84.2031" style="stroke: none; stroke-width: 1.0;" width="397" x="218" y="1869.0391"/><rect fill="#FFFFFF" height="69.0703" style="stroke: none; stroke-width: 1.0;" width="397" x="218" y="1953.2422"/><rect fill="#FFFFFF" height="84.2031" style="stroke: none; stroke-width: 1.0;" width="479" x="208" y="2029.3125"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="637.4609" style="stroke: #000000; stroke-width: 2.0;" width="1109" x="155" y="2134.5156"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="125.3359" style="stroke: #000000; stroke-width: 2.0;" width="280" x="218" y="2489.1094"/><rect fill="#FFFFFF" height="69.0703" style="stroke: none; stroke-width: 1.0;" width="280" x="218" y="2545.375"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="1584.2344" style="stroke: #000000; stroke-width: 2.0;" width="1119" x="145" y="2785.9766"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="608.5156" style="stroke: #000000; stroke-width: 2.0;" width="694" x="155" y="2810.1094"/><rect fill="#FFFFFF" height="890.6484" style="stroke: none; stroke-width: 1.0;" width="1119" x="145" y="3425.625"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="681.9141" style="stroke: #000000; stroke-width: 2.0;" width="694" x="155" y="3627.3594"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="1119" x="145" y="4316.2734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="68" x2="68" y1="118.0234" y2="4401.2109"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="218" x2="218" y1="118.0234" y2="4401.2109"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="540" x2="540" y1="118.0234" y2="4401.2109"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="648" x2="648" y1="118.0234" y2="4401.2109"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="773" x2="773" y1="118.0234" y2="4401.2109"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="883" x2="883" y1="118.0234" y2="4401.2109"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1168" x2="1168" y1="118.0234" y2="4401.2109"/><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="83" x="27" y="62.4297"/><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="83" x="23" y="66.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="69" x="30" y="86.4248">topic-bulk-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="69" x="30" y="102.7217">processing</text><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="83" x="27" y="4400.2109"/><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="83" x="23" y="4404.2109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="69" x="30" y="4424.2061">topic-bulk-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="69" x="30" y="4440.5029">processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="165" y="98.4248">Bulk Processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="190.5" y="114.7217">Handler</text><ellipse cx="218.5" cy="69.4297" fill="#FEFECE" filter="url(#fg6ppja5gzurl)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="214.5,57.4297,220.5,52.4297,218.5,57.4297,220.5,62.4297,214.5,57.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="165" y="4413.2061">Bulk Processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="190.5" y="4429.5029">Handler</text><ellipse cx="218.5" cy="4448.8047" fill="#FEFECE" filter="url(#fg6ppja5gzurl)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="214.5,4436.8047,220.5,4431.8047,218.5,4436.8047,220.5,4441.8047,214.5,4436.8047" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="497" y="78.7266"/><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="493" y="82.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="500" y="102.7217">topic-event</text><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="497" y="4400.2109"/><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="493" y="4404.2109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="500" y="4424.2061">topic-event</text><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="602" y="62.4297"/><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="598" y="66.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="619.5" y="86.4248">mongo-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="605" y="102.7217">object-store</text><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="602" y="4400.2109"/><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="598" y="4404.2109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="619.5" y="4424.2061">mongo-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="605" y="4440.5029">object-store</text><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="123" x="712" y="78.7266"/><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="123" x="708" y="82.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="109" x="715" y="102.7217">topic-notification</text><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="123" x="712" y="4400.2109"/><rect fill="#FEFECE" filter="url(#fg6ppja5gzurl)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="123" x="708" y="4404.2109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="109" x="715" y="4424.2061">topic-notification</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="849" y="114.7217">Bulk DAO</text><ellipse cx="883" cy="85.7266" fill="#FEFECE" filter="url(#fg6ppja5gzurl)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="871" x2="895" y1="99.7266" y2="99.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="849" y="4413.2061">Bulk DAO</text><ellipse cx="883" cy="4432.5078" fill="#FEFECE" filter="url(#fg6ppja5gzurl)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="871" x2="895" y1="4446.5078" y2="4446.5078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1124" y="114.7217">Central Store</text><path d="M1150,65.7266 C1150,55.7266 1168,55.7266 1168,55.7266 C1168,55.7266 1186,55.7266 1186,65.7266 L1186,91.7266 C1186,101.7266 1168,101.7266 1168,101.7266 C1168,101.7266 1150,101.7266 1150,91.7266 L1150,65.7266 " fill="#FEFECE" filter="url(#fg6ppja5gzurl)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1150,65.7266 C1150,75.7266 1168,75.7266 1168,75.7266 C1168,75.7266 1186,75.7266 1186,65.7266 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1124" y="4413.2061">Central Store</text><path d="M1150,4426.5078 C1150,4416.5078 1168,4416.5078 1168,4416.5078 C1168,4416.5078 1186,4416.5078 1186,4426.5078 L1186,4452.5078 C1186,4462.5078 1168,4462.5078 1168,4462.5078 C1168,4462.5078 1150,4462.5078 1150,4452.5078 L1150,4426.5078 " fill="#FEFECE" filter="url(#fg6ppja5gzurl)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1150,4426.5078 C1150,4436.5078 1168,4436.5078 1168,4436.5078 C1168,4436.5078 1186,4436.5078 1186,4426.5078 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="63.5" y="173.2891"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="4263.1875" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="213.5" y="128.0234"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="643" y="3680.7578"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="768.5" y="3380.625"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="768.5" y="4271.2734"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878" y="607.2813"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="151.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878" y="2172.7813"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878" y="2353.5781"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878" y="2642.5781"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="150.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="878" y="3461.5625"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1163" y="636.4141"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1163" y="2232.1797"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1163" y="2382.7109"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1163" y="2671.7109"/><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="92.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1163" y="3490.6953"/><path d="M13,135.0234 L272,135.0234 L272,142.0234 L262,152.0234 L13,152.0234 L13,135.0234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4249.1875" style="stroke: #000000; stroke-width: 2.0;" width="1271" x="13" y="135.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="214" x="28" y="148.0903">Bulk Processing Handler Consume</text><polygon fill="#A80036" points="84.5,169.2891,74.5,173.2891,84.5,177.2891,80.5,173.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="78.5" x2="212.5" y1="173.2891" y2="173.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="90.5" y="168.2231">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="101.5" y="168.2231">Consume message</text><path d="M145,218.2891 L228,218.2891 L228,225.2891 L218,235.2891 L145,235.2891 L145,218.2891 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="166.0625" style="stroke: #000000; stroke-width: 2.0;" width="405.5" x="145" y="218.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="160" y="231.356">break</text><path d="M155,242.4219 L293,242.4219 L293,249.4219 L283,259.4219 L155,259.4219 L155,242.4219 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="134.9297" style="stroke: #000000; stroke-width: 2.0;" width="385.5" x="155" y="242.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93" x="170" y="255.4888">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="223.5" x2="265.5" y1="356.3516" y2="356.3516"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="265.5" x2="265.5" y1="356.3516" y2="369.3516"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="224.5" x2="265.5" y1="369.3516" y2="369.3516"/><polygon fill="#A80036" points="234.5,365.3516,224.5,369.3516,234.5,373.3516,230.5,369.3516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="230.5" y="313.4536">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="241.5" y="275.6216">Validate event - Rule:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="241.5" y="290.7544">type == 'bulk-processing' &amp;&amp; action IN</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="241.5" y="305.8872">['prepare-duplicate', 'prepare', 'timeout-received',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="241.5" y="321.02">'fulfil-duplicate', 'commit', 'reject', 'abort',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="241.5" y="336.1528">'timeout-reserved']</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="241.5" y="351.2856">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="321.5" y="351.2856">2001</text><path d="M155,398.3516 L365,398.3516 L365,405.3516 L355,415.3516 L155,415.3516 L155,398.3516 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="443" x="155" y="398.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="170" y="411.4185">Persist Event Information</text><polygon fill="#A80036" points="528.5,457.6172,538.5,461.6172,528.5,465.6172,532.5,461.6172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="223.5" x2="534.5" y1="461.6172" y2="461.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="230.5" y="456.5513">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="241.5" y="456.5513">Publish event information</text><rect fill="#FFFFFF" filter="url(#fg6ppja5gzurl)" height="55.3984" style="stroke: #000000; stroke-width: 2.0;" width="425" x="162" y="469.6172"/><polygon fill="#EEEEEE" points="162,469.6172,226,469.6172,226,476.6172,216,486.6172,162,486.6172,162,469.6172" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="175" y="483.6841">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="306" y="502.6841">Event Handler Consume</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="309" y="517.8169"/><path d="M135,569.0156 L287,569.0156 L287,576.0156 L277,586.0156 L135,586.0156 L135,569.0156 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3808.1953" style="stroke: #000000; stroke-width: 2.0;" width="1139" x="135" y="569.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107" x="150" y="582.0825">Process Message</text><polygon fill="#A80036" points="866,603.2813,876,607.2813,866,611.2813,870,607.2813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="223.5" x2="872" y1="607.2813" y2="607.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="230.5" y="602.2153">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="241.5" y="602.2153">Retrieve current state of Bulk Transfer</text><polygon fill="#A80036" points="1151,632.4141,1161,636.4141,1151,640.4141,1155,636.4141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="888" x2="1157" y1="636.4141" y2="636.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="895" y="631.3481">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="906" y="631.3481">Retrieve current state of Bulk Transfer</text><polygon fill="#FFFFE0" filter="url(#fg6ppja5gzurl)" points="1092,649.4141,1244,649.4141,1254,668.4141,1244,687.4141,1092,687.4141,1082,668.4141,1092,649.4141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="1094" y="665.481">bulkTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1094" y="680.6138">bulkTransferStateChange</text><polygon fill="#A80036" points="899,709.8125,889,713.8125,899,717.8125,895,713.8125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="893" x2="1167" y1="713.8125" y2="713.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="905" y="708.7466">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="916" y="708.7466">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="959" y="708.7466">bulkTransferInfo</text><polygon fill="#A80036" points="234.5,738.9453,224.5,742.9453,234.5,746.9453,230.5,742.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="228.5" x2="882" y1="742.9453" y2="742.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="240.5" y="737.8794">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="251.5" y="737.8794">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="294.5" y="737.8794">bulkTransferInfo</text><path d="M198,757.9453 L422,757.9453 L422,764.9453 L412,774.9453 L198,774.9453 L198,757.9453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1362.5703" style="stroke: #000000; stroke-width: 2.0;" width="499" x="198" y="757.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="213" y="771.0122">Validate Bulk Transfer State</text><path d="M228,780.0781 L228,926.0781 L423,926.0781 L423,790.0781 L413,780.0781 L228,780.0781 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M413,780.0781 L413,790.0781 L423,790.0781 L413,780.0781 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="234" y="797.145">Initialize variables</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="3" x="355" y="797.145">:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="234" y="812.2778">let criteriaState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="234" y="827.4106">let incompleteBulkState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="234" y="842.5435">let completedBulkState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="234" y="857.6763">let bulkTransferState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="234" y="872.8091">let processingState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="14" x="234" y="887.9419">let</text><text fill="#008000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="251" y="887.9419">exitCode = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="326" y="887.9419">(success)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="234" y="903.0747">let errorMessage</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="234" y="918.2075">let produceNotification = false</text><path d="M208,942.2734 L271,942.2734 L271,949.2734 L261,959.2734 L208,959.2734 L208,942.2734 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1171.2422" style="stroke: #000000; stroke-width: 2.0;" width="479" x="208" y="942.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="223" y="955.3403">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="396" x="286" y="954.4839">[bulkTransferInfo.bulkTransferState IN ['RECEIVED', 'PENDING_PREPARE']]</text><path d="M228,964.4063 L228,1019.4063 L499,1019.4063 L499,974.4063 L489,964.4063 L228,964.4063 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M489,964.4063 L489,974.4063 L499,974.4063 L489,964.4063 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="234" y="981.4731">criteriaState = 'RECEIVED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="234" y="996.606">incompleteBulkState = 'PENDING_PREPARE'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="196" x="234" y="1011.7388">completedBulkState = 'ACCEPTED'</text><path d="M218,1035.8047 L281,1035.8047 L281,1042.8047 L271,1052.8047 L218,1052.8047 L218,1035.8047 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="317.4141" style="stroke: #000000; stroke-width: 2.0;" width="378" x="218" y="1035.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="233" y="1048.8716">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="162" x="296" y="1048.0151">[action == 'prepare-duplicate']</text><path d="M228,1057.9375 L228,1082.9375 L490,1082.9375 L490,1067.9375 L480,1057.9375 L228,1057.9375 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M480,1057.9375 L480,1067.9375 L490,1067.9375 L480,1057.9375 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="234" y="1075.0044">processingState = 'RECEIVED_DUPLICATE'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="218" x2="596" y1="1093.0703" y2="1093.0703"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="253" x="223" y="1103.2808">[action == 'prepare' AND state.status == 'error']</text><path d="M228,1111.875 L228,1136.875 L473,1136.875 L473,1121.875 L463,1111.875 L228,1111.875 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M463,1111.875 L463,1121.875 L473,1121.875 L463,1111.875 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="234" y="1128.9419">processingState = 'RECEIVED_INVALID'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="218" x2="596" y1="1147.0078" y2="1147.0078"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="265" x="223" y="1157.2183">[action == 'prepare' AND state.status == 'success']</text><path d="M228,1165.8125 L228,1190.8125 L422,1190.8125 L422,1175.8125 L412,1165.8125 L228,1165.8125 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M412,1165.8125 L412,1175.8125 L422,1175.8125 L412,1165.8125 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="234" y="1182.8794">processingState = 'ACCEPTED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="218" x2="596" y1="1200.9453" y2="1200.9453"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="272" x="223" y="1211.1558">[action IN ['timeout-received', 'timeout-reserved']]</text><path d="M228,1219.75 L228,1274.75 L456,1274.75 L456,1229.75 L446,1219.75 L228,1219.75 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M446,1219.75 L446,1229.75 L456,1229.75 L446,1219.75 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="234" y="1236.8169">incompleteBulkState = null</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="234" y="1251.9497">completedBulkState = 'COMPLETED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="234" y="1267.0825">processingState = 'EXPIRED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="218" x2="596" y1="1285.1484" y2="1285.1484"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="223" y="1295.3589">[all other actions]</text><path d="M228,1303.9531 L228,1343.9531 L582,1343.9531 L582,1313.9531 L572,1303.9531 L228,1303.9531 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M572,1303.9531 L572,1313.9531 L582,1313.9531 L572,1303.9531 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="234" y="1321.02">exitCode = 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="234" y="1336.1528">errorMessage = 'Invalid action for bulk in RECEIVED state'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="208" x2="687" y1="1361.2188" y2="1361.2188"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="285" x="213" y="1371.4292">[bulkTransferInfo.bulkTransferState IN ['ACCEPTED']]</text><path d="M218,1382.0234 L281,1382.0234 L281,1389.0234 L271,1399.0234 L218,1399.0234 L218,1382.0234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="170.7344" style="stroke: #000000; stroke-width: 2.0;" width="381" x="218" y="1382.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="233" y="1395.0903">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="296" y="1394.2339">[action == 'timeout-reserved']</text><path d="M228,1404.1563 L228,1474.1563 L456,1474.1563 L456,1414.1563 L446,1404.1563 L228,1404.1563 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M446,1404.1563 L446,1414.1563 L456,1414.1563 L446,1404.1563 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="234" y="1421.2231">criteriaState = 'ACCEPTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="234" y="1436.356">incompleteBulkState = null</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="234" y="1451.4888">completedBulkState = 'COMPLETED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="234" y="1466.6216">processingState = 'EXPIRED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="218" x2="599" y1="1484.6875" y2="1484.6875"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="223" y="1494.8979">[all other actions]</text><path d="M228,1503.4922 L228,1543.4922 L585,1543.4922 L585,1513.4922 L575,1503.4922 L228,1503.4922 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M575,1503.4922 L575,1513.4922 L585,1513.4922 L575,1503.4922 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="234" y="1520.5591">exitCode = 3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="234" y="1535.6919">errorMessage = 'Invalid action for bulk in ACCEPTED state'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="208" x2="687" y1="1560.7578" y2="1560.7578"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="402" x="213" y="1570.9683">[bulkTransferInfo.bulkTransferState IN ['PROCESSING', 'PENDING_FULFIL']]</text><path d="M228,1579.5625 L228,1634.5625 L485,1634.5625 L485,1589.5625 L475,1579.5625 L228,1579.5625 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M475,1579.5625 L475,1589.5625 L485,1589.5625 L475,1579.5625 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="234" y="1596.6294">criteriaState = 'ACCEPTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="234" y="1611.7622">incompleteBulkState = 'PENDING_FULFIL'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="234" y="1626.895">completedBulkState = 'COMPLETED'</text><path d="M218,1650.9609 L281,1650.9609 L281,1657.9609 L271,1667.9609 L218,1667.9609 L218,1650.9609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="371.3516" style="stroke: #000000; stroke-width: 2.0;" width="397" x="218" y="1650.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="233" y="1664.0278">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="296" y="1663.1714">[action == 'fulfil-duplicate']</text><path d="M228,1673.0938 L228,1698.0938 L470,1698.0938 L470,1683.0938 L460,1673.0938 L228,1673.0938 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M460,1673.0938 L460,1683.0938 L470,1683.0938 L460,1673.0938 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="234" y="1690.1606">processingState = 'FULFIL_DUPLICATE'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="218" x2="615" y1="1708.2266" y2="1708.2266"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="264" x="223" y="1718.437">[action == 'commit' AND state.status == 'success']</text><path d="M228,1727.0313 L228,1752.0313 L433,1752.0313 L433,1737.0313 L423,1727.0313 L228,1727.0313 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M423,1727.0313 L423,1737.0313 L433,1737.0313 L423,1727.0313 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="234" y="1744.0981">processingState = 'COMPLETED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="218" x2="615" y1="1762.1641" y2="1762.1641"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="223" y="1772.3745">[action == 'reject' AND state.status == 'success']</text><path d="M228,1780.9688 L228,1805.9688 L417,1805.9688 L417,1790.9688 L407,1780.9688 L228,1780.9688 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M407,1780.9688 L407,1790.9688 L417,1790.9688 L407,1780.9688 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="234" y="1798.0356">processingState = 'REJECTED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="218" x2="615" y1="1816.1016" y2="1816.1016"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="303" x="223" y="1826.312">[action IN ['commit', 'abort'] AND state.status == 'error']</text><path d="M228,1834.9063 L228,1859.9063 L453,1859.9063 L453,1844.9063 L443,1834.9063 L228,1834.9063 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M443,1834.9063 L443,1844.9063 L453,1844.9063 L443,1834.9063 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="234" y="1851.9731">processingState = 'FULFIL_INVALID'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="218" x2="615" y1="1870.0391" y2="1870.0391"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="223" y="1880.2495">[action == 'timeout-reserved']</text><path d="M228,1888.8438 L228,1943.8438 L456,1943.8438 L456,1898.8438 L446,1888.8438 L228,1888.8438 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M446,1888.8438 L446,1898.8438 L456,1898.8438 L446,1888.8438 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="234" y="1905.9106">incompleteBulkState = null</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="234" y="1921.0435">completedBulkState = 'COMPLETED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="234" y="1936.1763">processingState = 'EXPIRED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="218" x2="615" y1="1954.2422" y2="1954.2422"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="223" y="1964.4526">[all other actions]</text><path d="M228,1973.0469 L228,2013.0469 L601,2013.0469 L601,1983.0469 L591,1973.0469 L228,1973.0469 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M591,1973.0469 L591,1983.0469 L601,1983.0469 L591,1973.0469 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="234" y="1990.1138">exitCode = 4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="234" y="2005.2466">errorMessage = 'Invalid action for bulk in PROCESSING state'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="208" x2="687" y1="2030.3125" y2="2030.3125"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="213" y="2040.5229">[all other ['PENDING_INVALID', 'COMPLETED', 'REJECTED', 'INVALID']]</text><path d="M228,2049.1172 L228,2104.1172 L519,2104.1172 L519,2059.1172 L509,2049.1172 L228,2049.1172 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M509,2049.1172 L509,2059.1172 L519,2059.1172 L509,2049.1172 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="234" y="2066.1841">exitCode = 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="234" y="2081.3169">errorMessage = 'Individual transfer can not be</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="246" y="2096.4497">processed when bulk transfer state is final'</text><path d="M155,2134.5156 L222,2134.5156 L222,2141.5156 L212,2151.5156 L155,2151.5156 L155,2134.5156 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="637.4609" style="stroke: #000000; stroke-width: 2.0;" width="1109" x="155" y="2134.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="170" y="2147.5825">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="237" y="2146.7261">[exitCode == 0 (success)]</text><polygon fill="#A80036" points="866,2168.7813,876,2172.7813,866,2176.7813,870,2172.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="223.5" x2="872" y1="2172.7813" y2="2172.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="230.5" y="2167.7153">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="241.5" y="2167.7153">Persist individual transfer processing state</text><polygon fill="#A80036" points="1151,2228.1797,1161,2232.1797,1151,2236.1797,1155,2232.1797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="888" x2="1157" y1="2232.1797" y2="2232.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="895" y="2211.981">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="906" y="2196.8481">Persist individual transfer processing state</text><text fill="#808080" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="906" y="2211.981">-- store errorCode/errorMessage when</text><text fill="#808080" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="906" y="2227.1138">state.status == 'error'</text><polygon fill="#FFFFE0" filter="url(#fg6ppja5gzurl)" points="1095,2275.1797,1240,2275.1797,1250,2286.1797,1240,2298.1797,1095,2298.1797,1085,2286.1797,1095,2275.1797" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1097" y="2291.2466">bulkTransferAssociation</text><polygon fill="#A80036" points="234.5,2320.4453,224.5,2324.4453,234.5,2328.4453,230.5,2324.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="228.5" x2="882" y1="2324.4453" y2="2324.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="240.5" y="2319.3794">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="258.5" y="2319.3794">Return success</text><polygon fill="#A80036" points="866,2349.5781,876,2353.5781,866,2357.5781,870,2353.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="223.5" x2="872" y1="2353.5781" y2="2353.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="230.5" y="2348.5122">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="248.5" y="2348.5122">Check previously defined completion criteria</text><polygon fill="#A80036" points="1151,2378.7109,1161,2382.7109,1151,2386.7109,1155,2382.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="888" x2="1157" y1="2382.7109" y2="2382.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="895" y="2377.645">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="913" y="2377.645">Select EXISTS (LIMIT 1) in criteriaState</text><polygon fill="#FFFFE0" filter="url(#fg6ppja5gzurl)" points="1095,2395.7109,1240,2395.7109,1250,2406.7109,1240,2418.7109,1095,2418.7109,1085,2406.7109,1095,2395.7109" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1097" y="2411.7778">bulkTransferAssociation</text><polygon fill="#A80036" points="899,2440.9766,889,2444.9766,899,2448.9766,895,2444.9766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="893" x2="1167" y1="2444.9766" y2="2444.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="905" y="2439.9106">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="923" y="2439.9106">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="966" y="2439.9106">existingIndividualTransfer</text><polygon fill="#A80036" points="234.5,2470.1094,224.5,2474.1094,234.5,2478.1094,230.5,2474.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="228.5" x2="882" y1="2474.1094" y2="2474.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="240.5" y="2469.0435">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="258.5" y="2469.0435">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="301.5" y="2469.0435">existingIndividualTransfer</text><path d="M218,2489.1094 L281,2489.1094 L281,2496.1094 L271,2506.1094 L218,2506.1094 L218,2489.1094 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="125.3359" style="stroke: #000000; stroke-width: 2.0;" width="280" x="218" y="2489.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="233" y="2502.1763">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="141" x="296" y="2501.3198">[individual transfer exists]</text><path d="M228,2511.2422 L228,2536.2422 L484,2536.2422 L484,2521.2422 L474,2511.2422 L228,2511.2422 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M474,2511.2422 L474,2521.2422 L484,2521.2422 L474,2511.2422 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="234" y="2528.3091">bulkTransferState = incompleteBulkState</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="218" x2="498" y1="2546.375" y2="2546.375"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="186" x="223" y="2556.5854">[no transfer in criteriaState exists]</text><path d="M228,2565.1797 L228,2605.1797 L481,2605.1797 L481,2575.1797 L471,2565.1797 L228,2565.1797 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M471,2565.1797 L471,2575.1797 L481,2575.1797 L471,2565.1797 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="234" y="2582.2466">bulkTransferState = completedBulkState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="234" y="2597.3794">produceNotification = true</text><polygon fill="#A80036" points="866,2638.5781,876,2642.5781,866,2646.5781,870,2642.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="223.5" x2="872" y1="2642.5781" y2="2642.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="230.5" y="2637.5122">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="248.5" y="2637.5122">Persist bulkTransferState from previous step</text><polygon fill="#A80036" points="1151,2667.7109,1161,2671.7109,1151,2675.7109,1155,2671.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="888" x2="1157" y1="2671.7109" y2="2671.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="895" y="2666.645">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="913" y="2666.645">Persist bulkTransferState</text><polygon fill="#FFFFE0" filter="url(#fg6ppja5gzurl)" points="1092,2714.7109,1244,2714.7109,1254,2725.7109,1244,2737.7109,1092,2737.7109,1082,2725.7109,1092,2714.7109" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1094" y="2730.7778">bulkTransferStateChange</text><polygon fill="#A80036" points="234.5,2759.9766,224.5,2763.9766,234.5,2767.9766,230.5,2763.9766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="228.5" x2="882" y1="2763.9766" y2="2763.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="240.5" y="2758.9106">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="258.5" y="2758.9106">Return success</text><path d="M145,2785.9766 L208,2785.9766 L208,2792.9766 L198,2802.9766 L145,2802.9766 L145,2785.9766 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1584.2344" style="stroke: #000000; stroke-width: 2.0;" width="1119" x="145" y="2785.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="160" y="2799.0435">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="74" x="223" y="2798.187">[exitCode &gt; 0]</text><path d="M155,2810.1094 L378,2810.1094 L378,2817.1094 L368,2827.1094 L155,2827.1094 L155,2810.1094 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="608.5156" style="stroke: #000000; stroke-width: 2.0;" width="694" x="155" y="2810.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="170" y="2823.1763">Send Bulk Error Notification</text><path d="M228,2832.2422 L228,3280.2422 L507,3280.2422 L507,2842.2422 L497,2832.2422 L228,2832.2422 " fill="#FFFF00" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M497,2832.2422 L497,2842.2422 L507,2842.2422 L497,2832.2422 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="234" y="2849.3091">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="234" y="2864.4419">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="246" y="2879.5747">id: &lt;bulkTransferMessage.bulkTransferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="246" y="2894.7075">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="246" y="2909.8403">to: &lt;bulkTransferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="246" y="2924.9731">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="246" y="2940.106">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="258" y="2955.2388">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="258" y="2970.3716">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="270" y="2985.5044">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="282" y="3000.6372">errorCode: exitCode,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="282" y="3015.77">errorMessage: errorMessage</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="270" y="3030.9028">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="258" y="3046.0356">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="246" y="3061.1685">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="246" y="3076.3013">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="258" y="3091.4341">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="270" y="3106.5669">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="270" y="3121.6997">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="270" y="3136.8325">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="270" y="3151.9653">action: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="270" y="3167.0981">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="270" y="3182.231">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="282" y="3197.3638">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="282" y="3212.4966">code: 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="270" y="3227.6294">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="258" y="3242.7622">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="246" y="3257.895">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="234" y="3273.0278">}</text><path d="M228,3295.0938 L228,3335.0938 L491,3335.0938 L491,3305.0938 L481,3295.0938 L228,3295.0938 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M481,3295.0938 L481,3305.0938 L491,3305.0938 L481,3295.0938 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="234" y="3312.1606">Depending on the action decide where to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="234" y="3327.2935">send notification: payer, payee OR both</text><polygon fill="#A80036" points="756.5,3376.625,766.5,3380.625,756.5,3384.625,760.5,3380.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="223.5" x2="762.5" y1="3380.625" y2="3380.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="230.5" y="3367.9927">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="248.5" y="3360.4263">Publish Notification event for Payer/Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="248.5" y="3375.5591">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="328.5" y="3375.5591">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="145" x2="1264" y1="3426.625" y2="3426.625"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="150" y="3436.8354">[produceNotification == true]</text><polygon fill="#A80036" points="866,3457.5625,876,3461.5625,866,3465.5625,870,3461.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="223.5" x2="872" y1="3461.5625" y2="3461.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="230.5" y="3456.4966">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="248.5" y="3456.4966">Request to retrieve all bulk transfer and individual transfer results</text><polygon fill="#A80036" points="1151,3486.6953,1161,3490.6953,1151,3494.6953,1155,3490.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="888" x2="1157" y1="3490.6953" y2="3490.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="895" y="3485.6294">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="913" y="3485.6294">Get bulkTransferResult</text><polygon fill="#FFFFE0" filter="url(#fg6ppja5gzurl)" points="1092,3503.6953,1244,3503.6953,1254,3529.6953,1244,3556.6953,1092,3556.6953,1082,3529.6953,1092,3503.6953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="1094" y="3519.7622">bulkTransfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1094" y="3534.895">bulkTransferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1094" y="3550.0278">bulkTransferAssociation</text><polygon fill="#A80036" points="899,3579.2266,889,3583.2266,899,3587.2266,895,3583.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="893" x2="1167" y1="3583.2266" y2="3583.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="905" y="3578.1606">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="923" y="3578.1606">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="966" y="3578.1606">bulkTransferResult</text><polygon fill="#A80036" points="234.5,3608.3594,224.5,3612.3594,234.5,3616.3594,230.5,3612.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="228.5" x2="882" y1="3612.3594" y2="3612.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="240.5" y="3607.2935">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="258.5" y="3607.2935">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="301.5" y="3607.2935">bulkTransferResult</text><path d="M155,3627.3594 L342,3627.3594 L342,3634.3594 L332,3644.3594 L155,3644.3594 L155,3627.3594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="681.9141" style="stroke: #000000; stroke-width: 2.0;" width="694" x="155" y="3627.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="142" x="170" y="3640.4263">Send Bulk Notification</text><polygon fill="#A80036" points="631,3676.7578,641,3680.7578,631,3684.7578,635,3680.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="223.5" x2="637" y1="3680.7578" y2="3680.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="230.5" y="3668.1255">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="248.5" y="3660.5591">Generate &amp; Persist bulk message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="248.5" y="3675.6919">to object store</text><polygon fill="#A80036" points="234.5,3705.8906,224.5,3709.8906,234.5,3713.8906,230.5,3709.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="228.5" x2="647" y1="3709.8906" y2="3709.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="240.5" y="3704.8247">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="258.5" y="3704.8247">Return reference to the stored object</text><path d="M228,3722.8906 L228,4170.8906 L673,4170.8906 L673,3732.8906 L663,3722.8906 L228,3722.8906 " fill="#FFFF00" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M663,3722.8906 L663,3732.8906 L673,3732.8906 L663,3722.8906 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="234" y="3739.9575">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="234" y="3755.0903">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="246" y="3770.2231">id: &lt;bulkTransferMessage.bulkTransferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="246" y="3785.356">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="246" y="3800.4888">to: &lt;bulkTransferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="246" y="3815.6216">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="246" y="3830.7544">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="258" y="3845.8872">headers: &lt;bulkTransferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="258" y="3861.02">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="270" y="3876.1528">objstore: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="294" y="3891.2856">transactionid: &lt;bulkTransferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="294" y="3906.4185">referenceid: &lt;bulkTransferMessage_ObjectStoreReference_ID&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="270" y="3921.5513">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="258" y="3936.6841">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="246" y="3951.8169">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="246" y="3966.9497">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="258" y="3982.0825">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="270" y="3997.2153">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="270" y="4012.3481">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="270" y="4027.481">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="270" y="4042.6138">action: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="270" y="4057.7466">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="270" y="4072.8794">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="282" y="4088.0122">status: state.status,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="282" y="4103.145">code: state.code</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="270" y="4118.2778">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="258" y="4133.4106">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="246" y="4148.5435">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="234" y="4163.6763">}</text><path d="M228,4185.7422 L228,4225.7422 L491,4225.7422 L491,4195.7422 L481,4185.7422 L228,4185.7422 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M481,4185.7422 L481,4195.7422 L491,4195.7422 L481,4185.7422 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="234" y="4202.8091">Depending on the action decide where to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="234" y="4217.9419">send notification: payer, payee OR both</text><polygon fill="#A80036" points="756.5,4267.2734,766.5,4271.2734,756.5,4275.2734,760.5,4271.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="223.5" x2="762.5" y1="4271.2734" y2="4271.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="230.5" y="4258.6411">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="248.5" y="4251.0747">Publish Notification event for Payer/Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="248.5" y="4266.2075">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="328.5" y="4266.2075">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="145" x2="1264" y1="4317.2734" y2="4317.2734"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="255" x="150" y="4327.4839">[exitCode == 0 &amp;&amp; produceNotification == false]</text><path d="M228,4336.0781 L228,4361.0781 L495,4361.0781 L495,4346.0781 L485,4336.0781 L228,4336.0781 " fill="#D3D3D3" filter="url(#fg6ppja5gzurl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M485,4336.0781 L485,4346.0781 L495,4346.0781 L485,4336.0781 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="234" y="4353.145">Do nothing (await next individual transfer)</text><!--
@startuml
title 1.4.0. Bulk Processing Handler Consume

autonumber



collections "topic-bulk-\nprocessing" as TOPIC_BULK_PROCESSING
control "Bulk Processing\nHandler" as BULK_PROC_HANDLER
collections "topic-event" as TOPIC_EVENTS
collections "mongo-\nobject-store" as OBJECT_STORE
collections "topic-notification" as TOPIC_NOTIFICATION
entity "Bulk DAO" as BULK_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_BULK_PROCESSING
    participant BULK_PROC_HANDLER
    participant TOPIC_EVENTS
    participant OBJECT_STORE
    participant TOPIC_NOTIFICATION
    participant BULK_DAO
    participant DB
end box

activate BULK_PROC_HANDLER
group Bulk Processing Handler Consume
    TOPIC_BULK_PROCESSING <- BULK_PROC_HANDLER: Consume message
    activate TOPIC_BULK_PROCESSING
    deactivate TOPIC_BULK_PROCESSING

    break
        group Validate Event
            BULK_PROC_HANDLER <-> BULK_PROC_HANDLER: Validate event - Rule:\ntype == 'bulk-processing' && action IN\n['prepare-duplicate', 'prepare', 'timeout-received',\n'fulfil-duplicate', 'commit', 'reject', 'abort',\n'timeout-reserved']\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        BULK_PROC_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over BULK_PROC_HANDLER, TOPIC_EVENTS:  Event Handler Consume\n
        |||
    end

    group Process Message
        BULK_PROC_HANDLER -> BULK_DAO: Retrieve current state of Bulk Transfer
        activate BULK_DAO
        BULK_DAO -> DB: Retrieve current state of Bulk Transfer
        activate DB
        hnote over DB #lightyellow
            bulkTransfer
            bulkTransferStateChange
        end note
        BULK_DAO <- - DB: Return **bulkTransferInfo**
        deactivate DB
        BULK_PROC_HANDLER <- - BULK_DAO: Return **bulkTransferInfo**
        deactivate BULK_DAO

        group Validate Bulk Transfer State
            note right of BULK_PROC_HANDLER #lightgrey
                **Initialize variables**:
                let criteriaState
                let incompleteBulkState
                let completedBulkState
                let bulkTransferState
                let processingState
                let <color #green>exitCode = 0</color> (success)
                let errorMessage
                let produceNotification = false
            end note
            alt bulkTransferInfo.bulkTransferState IN ['RECEIVED', 'PENDING_PREPARE']
                note right of BULK_PROC_HANDLER #lightgrey
                    criteriaState = 'RECEIVED'
                    incompleteBulkState = 'PENDING_PREPARE'
                    completedBulkState = 'ACCEPTED'
                end note
                alt action == 'prepare-duplicate'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'RECEIVED_DUPLICATE'
                    end note
                else action == 'prepare' AND state.status == 'error'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'RECEIVED_INVALID'
                    end note
                else action == 'prepare' AND state.status == 'success'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'ACCEPTED'
                    end note
                else action IN ['timeout-received', 'timeout-reserved']
                    note right of BULK_PROC_HANDLER #lightgrey
                        incompleteBulkState = null
                        completedBulkState = 'COMPLETED'
                        processingState = 'EXPIRED'
                    end note
                else all other actions
                    note right of BULK_PROC_HANDLER #lightgrey
                        <color #red>exitCode = 2</color>
                        errorMessage = 'Invalid action for bulk in RECEIVED state'
                    end note
                end
            else bulkTransferInfo.bulkTransferState IN ['ACCEPTED']
                alt action == 'timeout-reserved'
                    note right of BULK_PROC_HANDLER #lightgrey
                        criteriaState = 'ACCEPTED'
                        incompleteBulkState = null
                        completedBulkState = 'COMPLETED'
                        processingState = 'EXPIRED'
                    end note
                else all other actions
                    note right of BULK_PROC_HANDLER #lightgrey
                        <color #red>exitCode = 3</color>
                        errorMessage = 'Invalid action for bulk in ACCEPTED state'
                    end note
                end
            else bulkTransferInfo.bulkTransferState IN ['PROCESSING', 'PENDING_FULFIL']
                note right of BULK_PROC_HANDLER #lightgrey
                    criteriaState = 'ACCEPTED'
                    incompleteBulkState = 'PENDING_FULFIL'
                    completedBulkState = 'COMPLETED'
                end note
                alt action == 'fulfil-duplicate'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'FULFIL_DUPLICATE'
                    end note
                else action == 'commit' AND state.status == 'success'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'COMPLETED'
                    end note
                else action == 'reject' AND state.status == 'success'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'REJECTED'
                    end note
                else action IN ['commit', 'abort'] AND state.status == 'error'
                    note right of BULK_PROC_HANDLER #lightgrey
                        processingState = 'FULFIL_INVALID'
                    end note
                else action == 'timeout-reserved'
                    note right of BULK_PROC_HANDLER #lightgrey
                        incompleteBulkState = null
                        completedBulkState = 'COMPLETED'
                        processingState = 'EXPIRED'
                    end note
                else all other actions
                    note right of BULK_PROC_HANDLER #lightgrey
                        <color #red>exitCode = 4</color>
                        errorMessage = 'Invalid action for bulk in PROCESSING state'
                    end note
                end
            else all other ['PENDING_INVALID', 'COMPLETED', 'REJECTED', 'INVALID']
                note right of BULK_PROC_HANDLER #lightgrey
                    <color #red>exitCode = 1</color>
                    errorMessage = 'Individual transfer can not be
                        processed when bulk transfer state is final'
                end note
            end
        end

        opt exitCode == 0 (success)
            BULK_PROC_HANDLER -> BULK_DAO: Persist individual transfer processing state
            activate BULK_DAO
            BULK_DAO -> DB: Persist individual transfer processing state\n<color #gray>- - store errorCode/errorMessage when</color>\n<color #gray>state.status == 'error'</color>
            activate DB
            hnote over DB #lightyellow
                bulkTransferAssociation
            end note
            deactivate DB
            BULK_PROC_HANDLER <- - BULK_DAO: Return success
            deactivate BULK_DAO

            BULK_PROC_HANDLER -> BULK_DAO: Check previously defined completion criteria
            activate BULK_DAO
            BULK_DAO -> DB: Select EXISTS (LIMIT 1) in criteriaState
            activate DB
            hnote over DB #lightyellow
                bulkTransferAssociation
            end note
            BULK_DAO <- - DB: Return **existingIndividualTransfer**
            deactivate DB
            BULK_PROC_HANDLER <- - BULK_DAO: Return **existingIndividualTransfer**
            deactivate BULK_DAO

            alt individual transfer exists
                note right of BULK_PROC_HANDLER #lightgrey
                    bulkTransferState = incompleteBulkState
                end note
            else no transfer in criteriaState exists
                note right of BULK_PROC_HANDLER #lightgrey
                    bulkTransferState = completedBulkState
                    produceNotification = true
                end note
            end

            BULK_PROC_HANDLER -> BULK_DAO: Persist bulkTransferState from previous step
            activate BULK_DAO
            BULK_DAO -> DB: Persist bulkTransferState
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                bulkTransferStateChange
            end note
            BULK_PROC_HANDLER <- - BULK_DAO: Return success
            deactivate BULK_DAO
        end


        alt exitCode > 0
            group Send Bulk Error Notification
                note right of BULK_PROC_HANDLER #yellow
                    Message:
                    {
                        id: <bulkTransferMessage.bulkTransferId>
                        from: <ledgerName>,
                        to: <bulkTransferMessage.payerFsp>,
                        type: application/json
                        content: {
                            headers: <bulkTransferHeaders>,
                            payload: {
                                errorInformation: {
                                    errorCode: exitCode,
                                    errorMessage: errorMessage
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                responseTo: <previous.uuid>,
                                type: bulk-notification,
                                action: bulk-notification,
                                createdAt: <timestamp>,
                                state: {
                                    status: 'error',
                                    code: 1
                                }
                            }
                        }
                    }
                end note
                note right of BULK_PROC_HANDLER #lightgrey
                    Depending on the action decide where to
                    send notification: payer, payee OR both
                end note
                BULK_PROC_HANDLER -> TOPIC_NOTIFICATION: Publish Notification event for Payer/Payee\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate TOPIC_NOTIFICATION
                deactivate TOPIC_NOTIFICATION
            end
        else produceNotification == true
            BULK_PROC_HANDLER -> BULK_DAO: Request to retrieve all bulk transfer and individual transfer results
            activate BULK_DAO
            BULK_DAO -> DB: Get bulkTransferResult
            activate DB
            hnote over DB #lightyellow
                bulkTransfer
                bulkTransferStateChange
                bulkTransferAssociation
            end note
            BULK_DAO <- - DB: Return **bulkTransferResult**
            deactivate DB
            BULK_PROC_HANDLER <- - BULK_DAO: Return **bulkTransferResult**
            deactivate BULK_DAO

            group Send Bulk Notification
                BULK_PROC_HANDLER -> OBJECT_STORE: Generate & Persist bulk message\nto object store
                activate OBJECT_STORE
                OBJECT_STORE - -> BULK_PROC_HANDLER: Return reference to the stored object
                deactivate OBJECT_STORE
                note right of BULK_PROC_HANDLER #yellow
                    Message:
                    {
                        id: <bulkTransferMessage.bulkTransferId>
                        from: <ledgerName>,
                        to: <bulkTransferMessage.payerFsp>,
                        type: application/json
                        content: {
                            headers: <bulkTransferHeaders>,
                            payload: {
                                objstore: {
                                        transactionid: <bulkTransferId>
                                        referenceid: <bulkTransferMessage_ObjectStoreReference_ID>
                                }
                            }
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                responseTo: <previous.uuid>,
                                type: bulk-notification,
                                action: bulk-notification,
                                createdAt: <timestamp>,
                                state: {
                                    status: state.status,
                                    code: state.code
                                }
                            }
                        }
                    }
                end note
                note right of BULK_PROC_HANDLER #lightgrey
                    Depending on the action decide where to
                    send notification: payer, payee OR both
                end note
                BULK_PROC_HANDLER -> TOPIC_NOTIFICATION: Publish Notification event for Payer/Payee\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate TOPIC_NOTIFICATION
                deactivate TOPIC_NOTIFICATION
            end
        else exitCode == 0 && produceNotification == false
            note right of BULK_PROC_HANDLER #lightgrey
                Do nothing (await next individual transfer)
            end note
        end
    end
end
deactivate BULK_PROC_HANDLER
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
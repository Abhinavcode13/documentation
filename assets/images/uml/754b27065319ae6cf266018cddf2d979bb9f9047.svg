<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1516px" preserveAspectRatio="none" style="width:1382px;height:1516px;" version="1.1" viewBox="0 0 1382 1516" width="1382px" zoomAndPan="magnify"><defs><filter height="300%" id="f18adzx6umsky2" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="560.5" y="22.9951">1.3.2. Fulfil Position Handler Consume</text><rect fill="#FFFFE0" height="1471.2969" style="stroke: #A80036; stroke-width: 1.0;" width="1146" x="29" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="553" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="1304.5703" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="84" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="449" y="1385.2969"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="576" y="186.125"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="499.3906" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="685" y="447.4531"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1122" y="215.2578"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1122" y="500.7188"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1122" y="634.25"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1122" y="741.6484"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="1290.5703" style="stroke: #000000; stroke-width: 2.0;" width="1358" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="560.7891" style="stroke: #000000; stroke-width: 2.0;" width="1338" x="23" y="394.0547"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="456.2578" style="stroke: #000000; stroke-width: 2.0;" width="724" x="627" y="462.4531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="89" x2="89" y1="115.7266" y2="1440.2969"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="454" x2="454" y1="115.7266" y2="1440.2969"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="581" x2="581" y1="115.7266" y2="1440.2969"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="690" x2="690" y1="115.7266" y2="1440.2969"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1127" x2="1127" y1="115.7266" y2="1440.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="33" y="112.4248">Position Handler</text><ellipse cx="89" cy="83.4297" fill="#FEFECE" filter="url(#f18adzx6umsky2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="85,71.4297,91,66.4297,89,71.4297,91,76.4297,85,71.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="33" y="1452.292">Position Handler</text><ellipse cx="89" cy="1471.5938" fill="#FEFECE" filter="url(#f18adzx6umsky2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="85,1459.5938,91,1454.5938,89,1459.5938,91,1464.5938,85,1459.5938" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f18adzx6umsky2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="387" y="76.4297"/><rect fill="#FEFECE" filter="url(#f18adzx6umsky2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="383" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="390" y="100.4248">Notifications-Topic</text><rect fill="#FEFECE" filter="url(#f18adzx6umsky2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="387" y="1439.2969"/><rect fill="#FEFECE" filter="url(#f18adzx6umsky2)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="134" x="383" y="1443.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="120" x="390" y="1463.292">Notifications-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="535" y="112.4248">Position DAO</text><ellipse cx="581" cy="83.4297" fill="#FEFECE" filter="url(#f18adzx6umsky2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="569" x2="593" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="535" y="1452.292">Position DAO</text><ellipse cx="581" cy="1471.5938" fill="#FEFECE" filter="url(#f18adzx6umsky2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="569" x2="593" y1="1485.5938" y2="1485.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="637" y="112.4248">Position Facade</text><ellipse cx="690" cy="83.4297" fill="#FEFECE" filter="url(#f18adzx6umsky2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="678" x2="702" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="637" y="1452.292">Position Facade</text><ellipse cx="690" cy="1471.5938" fill="#FEFECE" filter="url(#f18adzx6umsky2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="678" x2="702" y1="1485.5938" y2="1485.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1083" y="112.4248">Central Store</text><path d="M1109,63.4297 C1109,53.4297 1127,53.4297 1127,53.4297 C1127,53.4297 1145,53.4297 1145,63.4297 L1145,89.4297 C1145,99.4297 1127,99.4297 1127,99.4297 C1127,99.4297 1109,99.4297 1109,89.4297 L1109,63.4297 " fill="#FEFECE" filter="url(#f18adzx6umsky2)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1109,63.4297 C1109,73.4297 1127,73.4297 1127,73.4297 C1127,73.4297 1145,73.4297 1145,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1083" y="1452.292">Central Store</text><path d="M1109,1465.5938 C1109,1455.5938 1127,1455.5938 1127,1455.5938 C1127,1455.5938 1145,1455.5938 1145,1465.5938 L1145,1491.5938 C1145,1501.5938 1127,1501.5938 1127,1501.5938 C1127,1501.5938 1109,1501.5938 1109,1491.5938 L1109,1465.5938 " fill="#FEFECE" filter="url(#f18adzx6umsky2)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1109,1465.5938 C1109,1475.5938 1127,1475.5938 1127,1475.5938 C1127,1475.5938 1145,1475.5938 1145,1465.5938 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="1304.5703" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="84" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="449" y="1385.2969"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="576" y="186.125"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="499.3906" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="685" y="447.4531"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1122" y="215.2578"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1122" y="500.7188"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1122" y="634.25"/><rect fill="#FFFFFF" filter="url(#f18adzx6umsky2)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1122" y="741.6484"/><path d="M13,132.7266 L260,132.7266 L260,139.7266 L250,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1290.5703" style="stroke: #000000; stroke-width: 2.0;" width="1358" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="202" x="28" y="145.7935">Fulfil Position Handler Consume</text><polygon fill="#A80036" points="564,182.125,574,186.125,564,190.125,568,186.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="570" y1="186.125" y2="186.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="101" y="173.4927">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="112" y="165.9263">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="112" y="181.0591">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="186" y="181.0591">2003</text><polygon fill="#A80036" points="1110,211.2578,1120,215.2578,1110,219.2578,1114,215.2578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="586" x2="1116" y1="215.2578" y2="215.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="593" y="210.1919">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="604" y="210.1919">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f18adzx6umsky2)" points="1065,228.2578,1189,228.2578,1199,247.2578,1189,266.2578,1065,266.2578,1055,247.2578,1065,228.2578" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1067" y="244.3247">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="1067" y="259.4575">transferParticipant</text><polygon fill="#A80036" points="597,288.6563,587,292.6563,597,296.6563,593,292.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="591" x2="1126" y1="292.6563" y2="292.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="603" y="287.5903">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="614" y="287.5903">Return current state of transfer from DB</text><polygon fill="#A80036" points="105,317.7891,95,321.7891,105,325.7891,101,321.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="99" x2="580" y1="321.7891" y2="321.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="111" y="316.7231">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="122" y="316.7231">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="136" y1="366.0547" y2="366.0547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="136" x2="136" y1="366.0547" y2="379.0547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="95" x2="136" y1="379.0547" y2="379.0547"/><polygon fill="#A80036" points="105,375.0547,95,379.0547,105,383.0547,101,379.0547" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="101" y="353.4224">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="112" y="345.856">Validate current state (transferState is 'RECEIVED-FULFIL')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="112" y="360.9888">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="186" y="360.9888">2001</text><path d="M23,394.0547 L704,394.0547 L704,401.0547 L694,411.0547 L23,411.0547 L23,394.0547 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="560.7891" style="stroke: #000000; stroke-width: 2.0;" width="1338" x="23" y="394.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="636" x="38" y="407.1216">Persist Position change and Transfer State (with transferState='COMMITTED' on position check pass)</text><polygon fill="#A80036" points="673,443.4531,683,447.4531,673,451.4531,677,447.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="679" y1="447.4531" y2="447.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="101" y="434.8208">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="112" y="427.2544">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="112" y="442.3872">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="186" y="442.3872">2003</text><path d="M627,462.4531 L777,462.4531 L777,469.4531 L767,479.4531 L627,479.4531 L627,462.4531 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="456.2578" style="stroke: #000000; stroke-width: 2.0;" width="724" x="627" y="462.4531"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="642" y="475.52">DB TRANSACTION</text><polygon fill="#A80036" points="1110,496.7188,1120,500.7188,1110,504.7188,1114,500.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="695" x2="1116" y1="500.7188" y2="500.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="702" y="495.6528">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="713" y="495.6528">Select participantPosition.value FOR UPDATE from DB for Payee</text><polygon fill="#FFFFE0" filter="url(#f18adzx6umsky2)" points="1070,513.7188,1184,513.7188,1194,524.7188,1184,536.7188,1070,536.7188,1060,524.7188,1070,513.7188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1072" y="529.7856">participantPosition</text><polygon fill="#A80036" points="706,558.9844,696,562.9844,706,566.9844,702,562.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="700" x2="1126" y1="562.9844" y2="562.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="712" y="557.9185">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="723" y="557.9185">Return participantPosition.value from DB for Payee</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="695" x2="737" y1="592.1172" y2="592.1172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="737" x2="737" y1="592.1172" y2="605.1172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="696" x2="737" y1="605.1172" y2="605.1172"/><polygon fill="#A80036" points="706,601.1172,696,605.1172,706,609.1172,702,605.1172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="702" y="587.0513">9</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="713" y="587.0513">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="806" y="587.0513">= participantPosition.value - payload.amount.amount</text><polygon fill="#A80036" points="1110,630.25,1120,634.25,1110,638.25,1114,634.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="695" x2="1116" y1="634.25" y2="634.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="702" y="629.1841">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="720" y="629.1841">Persist latestPosition to DB for Payee</text><polygon fill="#FFFFE0" filter="url(#f18adzx6umsky2)" points="1037,677.25,1216,677.25,1226,696.25,1216,715.25,1037,715.25,1027,696.25,1037,677.25" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="1039" y="693.3169">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1089" y="693.3169">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1039" y="708.4497">SET value = latestPosition</text><polygon fill="#A80036" points="1110,737.6484,1120,741.6484,1110,745.6484,1114,741.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="695" x2="1116" y1="741.6484" y2="741.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="702" y="736.5825">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="720" y="736.5825">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#f18adzx6umsky2)" points="922,784.6484,1331,784.6484,1341,848.6484,1331,913.6484,922,913.6484,912,848.6484,922,784.6484" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="924" y="800.7153">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="970" y="800.7153">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="1108" y="800.7153">transferStateId = 'COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="927" y="815.8481"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="924" y="830.981">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="970" y="830.981">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="399" x="924" y="846.1138">SET participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="405" x="924" y="861.2466">transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="924" y="876.3794">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="924" y="891.5122">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="924" y="906.645">createdDate = new Date()</text><polygon fill="#A80036" points="105,942.8438,95,946.8438,105,950.8438,101,946.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="99" x2="689" y1="946.8438" y2="946.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="941.7778">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="129" y="941.7778">Return success</text><path d="M99,966.8438 L99,1339.8438 L336,1339.8438 L336,976.8438 L326,966.8438 L99,966.8438 " fill="#FFFF00" filter="url(#f18adzx6umsky2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M326,966.8438 L326,976.8438 L336,976.8438 L326,966.8438 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="105" y="983.9106">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="105" y="999.0435">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="117" y="1014.1763">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="117" y="1029.3091">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="117" y="1044.4419">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="117" y="1059.5747">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="117" y="1074.7075">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="129" y="1089.8403">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="129" y="1104.9731">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="117" y="1120.106">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="117" y="1135.2388">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="129" y="1150.3716">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="141" y="1165.5044">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="141" y="1180.6372">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="141" y="1195.77">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="141" y="1210.9028">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="141" y="1226.0356">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="141" y="1241.1685">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="153" y="1256.3013">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="153" y="1271.4341">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="141" y="1286.5669">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="129" y="1301.6997">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="117" y="1316.8325">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="105" y="1331.9653">}</text><polygon fill="#A80036" points="437,1381.2969,447,1385.2969,437,1389.2969,441,1385.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="443" y1="1385.2969" y2="1385.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="101" y="1372.6646">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="119" y="1365.0981">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="119" y="1380.231">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="193" y="1380.231">2003</text><!--
@startuml
title 1.3.2. Fulfil Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
collections "Notifications-Topic" as TOPIC_NOTIFICATIONS
entity "Position Facade" as POS_FACADE
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant POS_FACADE
    participant DB
end box

activate POS_HANDLER
group Fulfil Position Handler Consume
    POS_HANDLER -> POS_DAO: Request current state of transfer from DB \n<color #FF0000><b>Error code:</b> 2003</color>
    activate POS_DAO
    POS_DAO -> DB: Retrieve current state of transfer from DB
    activate DB
    hnote over DB #lightyellow
        transferStateChange
        transferParticipant
    end note
    DB - -> POS_DAO: Return current state of transfer from DB
    deactivate DB
    POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
    deactivate POS_DAO
    POS_HANDLER <-> POS_HANDLER: Validate current state (transferState is 'RECEIVED-FULFIL')\n<color #FF0000><b>Error code:</b> 2001</color>
    group Persist Position change and Transfer State (with transferState='COMMITTED' on position check pass)
        POS_HANDLER -> POS_FACADE: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
        group <color #blue>DB TRANSACTION</color>
            activate POS_FACADE
            POS_FACADE -> DB: Select participantPosition.value FOR UPDATE from DB for Payee
            activate DB
            hnote over DB #lightyellow
                participantPosition
            end note
            DB - -> POS_FACADE: Return participantPosition.value from DB for Payee
            deactivate DB
            POS_FACADE <-> POS_FACADE: **latestPosition** = participantPosition.value - payload.amount.amount
            POS_FACADE->DB: Persist latestPosition to DB for Payee
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value = latestPosition
            end note
            activate DB
            deactivate DB
            POS_FACADE -> DB: Persist transfer state and participant position change
            hnote over DB #lightyellow
                    INSERT **transferStateChange** transferStateId = 'COMMITTED'

                    INSERT **participantPositionChange**
                    SET participantPositionId = participantPosition.participantPositionId,
                    transferStateChangeId = transferStateChange.transferStateChangeId,
                    value = latestPosition,
                    reservedValue = participantPosition.reservedValue
                    createdDate = new Date()
            end note
            activate DB
            deactivate DB
            deactivate POS_DAO
        end
        POS_FACADE - -> POS_HANDLER: Return success
        deactivate POS_FACADE
    end

    note right of POS_HANDLER #yellow
        Message:
        {
            id: <transferMessage.transferId>
            from: <transferMessage.payerFsp>,
            to: <transferMessage.payeeFsp>,
            type: application/json
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: transfer,
                    action: commit,
                    createdAt: <timestamp>,
                    state: {
                        status: "success",
                        code: 0
                    }
                }
            }
        }
    end note
    POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_NOTIFICATIONS
    deactivate TOPIC_NOTIFICATIONS
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
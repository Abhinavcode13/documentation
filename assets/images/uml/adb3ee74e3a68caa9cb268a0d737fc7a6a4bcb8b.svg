<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4929px" preserveAspectRatio="none" style="width:2214px;height:4929px;" version="1.1" viewBox="0 0 2214 4929" width="2214px" zoomAndPan="magnify"><defs><filter height="300%" id="f1mgx3c2h27js1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="677" x="769.5" y="22.9951">1.3.1. Prepare Position Handler Consume (single message, includes individual transfers from Bulk)</text><rect fill="#FFFFE0" height="4884.0781" style="stroke: #A80036; stroke-width: 1.0;" width="1931" x="39" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="955.5" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="4680.1641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="94" y="144.3203"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="2107.6875" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="765" y="189.5859"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="175.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1559" y="2501.0078"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="372.5156"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="841.5703"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="990.2344"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="107.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="1097.6328"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="1796.0156"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="1918.5469"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="2198.0078"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="2584.4063"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="2604.6172" style="stroke: #000000; stroke-width: 2.0;" width="2190" x="13" y="151.3203"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="2022.4219" style="stroke: #000000; stroke-width: 2.0;" width="1477.5" x="715.5" y="246.7188"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="436.6641" style="stroke: #000000; stroke-width: 2.0;" width="1991" x="23" y="2312.2734"/><rect fill="#FFFFFF" height="362.2656" style="stroke: none; stroke-width: 1.0;" width="1991" x="23" y="2386.6719"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="237.0625" style="stroke: #000000; stroke-width: 2.0;" width="1971" x="33" y="2447.6094"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="1107.5703" style="stroke: #000000; stroke-width: 2.0;" width="712.5" x="23" y="2769.9375"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="1076.4375" style="stroke: #000000; stroke-width: 2.0;" width="692.5" x="33" y="2794.0703"/><rect fill="#FFFFFF" height="537.0547" style="stroke: none; stroke-width: 1.0;" width="692.5" x="33" y="3333.4531"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="925.9766" style="stroke: #000000; stroke-width: 2.0;" width="712.5" x="23" y="3891.5078"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="894.8438" style="stroke: #000000; stroke-width: 2.0;" width="692.5" x="33" y="3915.6406"/><rect fill="#FFFFFF" height="446.2578" style="stroke: none; stroke-width: 1.0;" width="692.5" x="33" y="4364.2266"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="99" x2="99" y1="134.3203" y2="4834.4844"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="477.5" x2="477.5" y1="134.3203" y2="4834.4844"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="635.5" x2="635.5" y1="134.3203" y2="4834.4844"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="769.5" x2="769.5" y1="134.3203" y2="4834.4844"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1564" x2="1564" y1="134.3203" y2="4834.4844"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1922" x2="1922" y1="134.3203" y2="4834.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="43" y="131.0186">Position Handler</text><ellipse cx="99" cy="102.0234" fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="95,90.0234,101,85.0234,99,90.0234,101,95.0234,95,90.0234" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="43" y="4846.4795">Position Handler</text><ellipse cx="99" cy="4865.7813" fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="95,4853.7813,101,4848.7813,99,4853.7813,101,4858.7813,95,4853.7813" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="414.5" y="95.0234"/><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="410.5" y="99.0234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="417.5" y="119.0186">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="414.5" y="4833.4844"/><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="410.5" y="4837.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="417.5" y="4857.4795">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="559.5" y="95.0234"/><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="555.5" y="99.0234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="562.5" y="119.0186">topic-bulk-processing</text><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="559.5" y="4833.4844"/><rect fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="555.5" y="4837.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="562.5" y="4857.4795">topic-bulk-processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="741" y="98.4248">Position</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="725.5" y="114.7217">Management</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="44" x="745" y="131.0186">Facade</text><ellipse cx="770" cy="69.4297" fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="758" x2="782" y1="83.4297" y2="83.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="741" y="4846.4795">Position</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="725.5" y="4862.7764">Management</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="44" x="745" y="4879.0732">Facade</text><ellipse cx="770" cy="4898.375" fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="758" x2="782" y1="4912.375" y2="4912.375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1518" y="131.0186">Position DAO</text><ellipse cx="1564" cy="102.0234" fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1552" x2="1576" y1="116.0234" y2="116.0234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1518" y="4846.4795">Position DAO</text><ellipse cx="1564" cy="4865.7813" fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1552" x2="1576" y1="4879.7813" y2="4879.7813"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1878" y="131.0186">Central Store</text><path d="M1904,82.0234 C1904,72.0234 1922,72.0234 1922,72.0234 C1922,72.0234 1940,72.0234 1940,82.0234 L1940,108.0234 C1940,118.0234 1922,118.0234 1922,118.0234 C1922,118.0234 1904,118.0234 1904,108.0234 L1904,82.0234 " fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1904,82.0234 C1904,92.0234 1922,92.0234 1922,92.0234 C1922,92.0234 1940,92.0234 1940,82.0234 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1878" y="4846.4795">Central Store</text><path d="M1904,4859.7813 C1904,4849.7813 1922,4849.7813 1922,4849.7813 C1922,4849.7813 1940,4849.7813 1940,4859.7813 L1940,4885.7813 C1940,4895.7813 1922,4895.7813 1922,4895.7813 C1922,4895.7813 1904,4895.7813 1904,4885.7813 L1904,4859.7813 " fill="#FEFECE" filter="url(#f1mgx3c2h27js1)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1904,4859.7813 C1904,4869.7813 1922,4869.7813 1922,4869.7813 C1922,4869.7813 1940,4869.7813 1940,4859.7813 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="4680.1641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="94" y="144.3203"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="2107.6875" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="765" y="189.5859"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="175.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1559" y="2501.0078"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="372.5156"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="841.5703"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="990.2344"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="107.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="1097.6328"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="1796.0156"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="1918.5469"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="2198.0078"/><rect fill="#FFFFFF" filter="url(#f1mgx3c2h27js1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1917" y="2584.4063"/><path d="M13,151.3203 L280,151.3203 L280,158.3203 L270,168.3203 L13,168.3203 L13,151.3203 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2604.6172" style="stroke: #000000; stroke-width: 2.0;" width="2190" x="13" y="151.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="222" x="28" y="164.3872">Prepare Position Handler Consume</text><polygon fill="#A80036" points="753,185.5859,763,189.5859,753,193.5859,757,189.5859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="759" y1="189.5859" y2="189.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="111" y="184.52">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="122" y="184.52">Request transfers to be processed</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="817" y1="218.7188" y2="218.7188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="817" x2="817" y1="218.7188" y2="231.7188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="776" x2="817" y1="231.7188" y2="231.7188"/><polygon fill="#A80036" points="786,227.7188,776,231.7188,786,235.7188,782,231.7188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="782" y="213.6528">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="793" y="213.6528">Check 1st transfer to select the Participant and Currency</text><path d="M715.5,246.7188 L865.5,246.7188 L865.5,253.7188 L855.5,263.7188 L715.5,263.7188 L715.5,246.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2022.4219" style="stroke: #000000; stroke-width: 2.0;" width="1477.5" x="715.5" y="246.7188"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="730.5" y="259.7856">DB TRANSACTION</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="817" y1="315.25" y2="315.25"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="817" x2="817" y1="315.25" y2="328.25"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="776" x2="817" y1="328.25" y2="328.25"/><polygon fill="#A80036" points="786,324.25,776,328.25,786,332.25,782,328.25" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="782" y="295.0513">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="490" x="793" y="279.9185">Loop through batch and build list of transferIds and calculate sumTransfersInBatch,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="793" y="295.0513">checking all in Batch are for the correct Paricipant and Currency</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="793" y="310.1841">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="867" y="310.1841">2001, 3100</text><polygon fill="#A80036" points="1905,368.5156,1915,372.5156,1905,376.5156,1909,372.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="1911" y1="372.5156" y2="372.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="782" y="359.8833">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="425" x="793" y="352.3169">Retrieve current state of all transfers in array from DB with select whereIn</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1112" x="793" y="367.4497">(FYI: The two DB transaction model needs to add a mini-state step here (RECEIVED_PREPARE =&gt; RECEIVDED_PREPARE_PROCESSING) so that the transfers are left alone if processing has started)</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="1860,385.5156,1984,385.5156,1994,404.5156,1984,423.5156,1860,423.5156,1850,404.5156,1860,385.5156" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1862" y="401.5825">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="1862" y="416.7153">transferParticipant</text><polygon fill="#A80036" points="786,445.9141,776,449.9141,786,453.9141,782,449.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="780" x2="1921" y1="449.9141" y2="449.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="792" y="444.8481">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="803" y="444.8481">Return current state of all selected transfers from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="817" y1="509.3125" y2="509.3125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="817" x2="817" y1="509.3125" y2="522.3125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="776" x2="817" y1="522.3125" y2="522.3125"/><polygon fill="#A80036" points="786,518.3125,776,522.3125,786,526.3125,782,522.3125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="782" y="489.1138">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="486" x="793" y="473.981">Validate current state (transferStateChange.transferStateId == 'RECEIVED_PREPARE')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="793" y="489.1138">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="867" y="489.1138">2001</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="898" y="489.1138">against failing transfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="793" y="504.2466">Batch is not rejected as a whole.</text><path d="M780,535.3125 L780,756.3125 L2151,756.3125 L2151,545.3125 L2141,535.3125 L780,535.3125 " fill="#D3D3D3" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2141,535.3125 L2141,545.3125 L2151,545.3125 L2141,535.3125 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="786" y="552.3794">List of transfers used during processing</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="116" x="786" y="567.5122">reservedTransfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="905" y="567.5122">is list of transfers to be processed in the batch</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="786" y="582.645">abortedTransfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1091" x="900" y="582.645">is the list of transfers in the incorrect state going into the process. Currently the transferStateChange is set to ABORTED - this should only be done if not already in a final state (idempotency)</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="786" y="597.7778">processedTransfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1223" x="913" y="597.7778">is the list of transfers that have gone through the position management algorithm. Both successful and failed trasnfers appear here as the order and "running position" against each is necessary for reconciliation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="789" y="612.9106"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="786" y="628.0435">Scalar intermidate values used in the algorithm</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="786" y="643.1763">transferAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="892" y="643.1763">= payload.amount.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="786" y="658.3091">sumTransfersInBatch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="925" y="658.3091">= SUM amount against each Transfer in batch</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="786" y="673.4419">currentPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="890" y="673.4419">= participantPosition.value</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="786" y="688.5747">reservedPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="898" y="688.5747">= participantPosition.{original}reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="786" y="703.7075">effectivePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="899" y="703.7075">= currentPosition + reservedPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="786" y="718.8403">heldPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="869" y="718.8403">= effectivePosition + sumTransfersInBatch</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="786" y="733.9731">availablePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="900" y="733.9731">= participantLimit(NetDebitCap) - effectivePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85" x="786" y="749.106">sumReserved</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="874" y="749.106">= SUM of transfers that have met rule criteria and processed</text><path d="M728,771.1719 L728,811.1719 L1963,811.1719 L1963,781.1719 L1953,771.1719 L728,771.1719 " fill="#FBFB77" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1953,771.1719 L1953,781.1719 L1963,781.1719 L1953,771.1719 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="692" x="993.25" y="788.2388">Going to reserve the sum of the valid transfers in the batch against the Participants Positon in the Currency of this batch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="993.25" y="803.3716">and calculate the available position for the Participant to use</text><polygon fill="#A80036" points="1905,837.5703,1915,841.5703,1905,845.5703,1909,841.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="1911" y1="841.5703" y2="841.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="782" y="836.5044">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="793" y="836.5044">Select effectivePosition FOR UPDATE from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="1865,854.5703,1979,854.5703,1989,865.5703,1979,877.5703,1865,877.5703,1855,865.5703,1865,854.5703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1867" y="870.6372">participantPosition</text><polygon fill="#A80036" points="786,899.8359,776,903.8359,786,907.8359,782,903.8359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="780" x2="1921" y1="903.8359" y2="903.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="792" y="898.77">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="472" x="803" y="898.77">Return effectivePosition (currentPosition and reservedPosition) from DB for Payer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="817" y1="948.1016" y2="948.1016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="817" x2="817" y1="948.1016" y2="961.1016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="776" x2="817" y1="961.1016" y2="961.1016"/><polygon fill="#A80036" points="786,957.1016,776,961.1016,786,965.1016,782,961.1016" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="782" y="935.4692">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="793" y="927.9028">Increment reservedValue to heldPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="341" x="793" y="943.0356">(reservedValue = reservedPosition + sumTransfersInBatch)</text><polygon fill="#A80036" points="1905,986.2344,1915,990.2344,1905,994.2344,1909,990.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="1911" y1="990.2344" y2="990.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="782" y="985.1685">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="800" y="985.1685">Persist reservedValue</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="1793,1033.2344,2050,1033.2344,2060,1052.2344,2050,1071.2344,1793,1071.2344,1783,1052.2344,1793,1033.2344" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="1795" y="1049.3013">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1845" y="1049.3013">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="1795" y="1064.4341">SET reservedValue += sumTransfersInBatch</text><polygon fill="#A80036" points="1905,1093.6328,1915,1097.6328,1905,1101.6328,1909,1097.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="1911" y1="1097.6328" y2="1097.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="782" y="1092.5669">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="800" y="1092.5669">Request position limits for Payer Participant</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="1745,1110.6328,2098,1110.6328,2108,1144.6328,2098,1178.6328,1745,1178.6328,1735,1144.6328,1745,1110.6328" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="1747" y="1126.6997">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="1785" y="1126.6997">participantLimit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="1747" y="1141.8325">WHERE participantLimit.limitTypeId = 'NET-DEBIT-CAP'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="1747" y="1156.9653">AND participantLimit.participantId = payload.payerFsp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="349" x="1747" y="1172.0981">AND participantLimit.currencyId = payload.amount.currency</text><polygon fill="#A80036" points="786,1201.2969,776,1205.2969,786,1209.2969,782,1205.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="780" x2="1921" y1="1205.2969" y2="1205.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="792" y="1200.231">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="810" y="1200.231">Return position limits</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="817" y1="1234.4297" y2="1234.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="817" x2="817" y1="1234.4297" y2="1247.4297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="776" x2="817" y1="1247.4297" y2="1247.4297"/><polygon fill="#A80036" points="786,1243.4297,776,1247.4297,786,1251.4297,782,1247.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="782" y="1229.3638">13</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="800" y="1229.3638">availablePosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="638" x="914" y="1229.3638">= participantLimit(netDebitCap) - effectivePosition (same as = netDebitCap - currentPosition - reservedPosition)</text><path d="M728,1260.4297 L728,1300.4297 L1963,1300.4297 L1963,1270.4297 L1953,1260.4297 L728,1260.4297 " fill="#FBFB77" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1953,1260.4297 L1953,1270.4297 L1963,1270.4297 L1953,1260.4297 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="543" x="1067.75" y="1277.4966">For each transfer in the batch, validate the availablility of position to meet the transfer amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="349" x="1067.75" y="1292.6294">this will be as per the position algorithm documented below</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="817" y1="1345.9609" y2="1345.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="817" x2="817" y1="1345.9609" y2="1358.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="776" x2="817" y1="1358.9609" y2="1358.9609"/><polygon fill="#A80036" points="786,1354.9609,776,1358.9609,786,1362.9609,782,1358.9609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="782" y="1333.3286">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="376" x="800" y="1325.7622">Validate availablePosition for each tranfser (see algorithm below)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="800" y="1340.895">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="874" y="1340.895">4001</text><path d="M780,1371.9609 L780,1638.9609 L2050,1638.9609 L2050,1381.9609 L2040,1371.9609 L780,1371.9609 " fill="#D3D3D3" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2040,1371.9609 L2040,1381.9609 L2050,1381.9609 L2040,1371.9609 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="521" x="786" y="1389.0278">01: sumReserved = 0 // Record the sum of the transfers we allow to progress to RESERVED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="506" x="786" y="1404.1606">02: sumProcessed =0 // Record the sum of the transfers already processed in this batch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="992" x="786" y="1419.2935">03: processedTransfers = {} // The list of processed transfers - so that we can store the additional information around the decision. Most importantly the "running" position</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="786" y="1434.4263">04: foreach transfer in reservedTransfers</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="798" y="1449.5591">05: sumProcessed += transfer.amount // the total processed so far</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="164" x="1185" y="1449.5591">(NEED TO UPDATE IN CODE)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="798" y="1464.6919">06: if availablePosition &gt;= transfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="810" y="1479.8247">07: transfer.state = "RESERVED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="810" y="1494.9575">08: availablePosition -= preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="810" y="1510.0903">09: sumRESERVED += preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="798" y="1525.2231">10: else</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="810" y="1540.356">11: preparedTransfer.state = "ABORTED"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="612" x="810" y="1555.4888">12: preparedTransfer.reason = "Net Debit Cap exceeded by this request at this time, please try again later"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="798" y="1570.6216">13: end if</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="931" x="798" y="1585.7544">14: runningPosition = currentPosition + sumReserved // the initial value of the Participants position plus the total value that has been accepted in the batch so far</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="498" x="798" y="1600.8872">15: runningReservedValue = sumTransfersInBatch - sumProcessed + reservedPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="164" x="1299" y="1600.8872">(NEED TO UPDATE IN CODE)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="1466" y="1600.8872">// the running down of the total reserved value at the begining of the batch.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1237" x="798" y="1616.02">16: Add transfer to the processedTransfer list recording the transfer state and running position and reserved values { transferState, transfer, rawMessage, transferAmount,  runningPosition, runningReservedValue }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="786" y="1631.1528">16: end foreach</text><path d="M728,1653.2188 L728,1708.2188 L1963,1708.2188 L1963,1663.2188 L1953,1653.2188 L728,1653.2188 " fill="#FBFB77" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1953,1653.2188 L1953,1663.2188 L1963,1663.2188 L1953,1653.2188 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="795" x="796.75" y="1670.2856">Once the outcome for all transfers is known,update the Participant's position and remove the reserved amount associated with the batch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="595" x="796.75" y="1685.4185">(If there are any alarm limits, process those returning limits in which the threshold has been breached)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1085" x="796.75" y="1700.5513">Do a bulk insert of the trasnferStateChanges associated with processing, using the result to complete the participantPositionChange and bulk insert of these to persist the running position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="817" y1="1753.8828" y2="1753.8828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="817" x2="817" y1="1753.8828" y2="1766.8828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="776" x2="817" y1="1766.8828" y2="1766.8828"/><polygon fill="#A80036" points="786,1762.8828,776,1766.8828,786,1770.8828,782,1766.8828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="782" y="1741.2505">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="800" y="1733.6841">Assess any limit thresholds on the final position</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="800" y="1748.8169">adding to alarm list if triggered</text><polygon fill="#A80036" points="1905,1792.0156,1915,1796.0156,1905,1800.0156,1909,1796.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="1911" y1="1796.0156" y2="1796.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="782" y="1790.9497">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="800" y="1790.9497">Persist latest position</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="35" x="926" y="1790.9497">value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="964" y="1790.9497">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93" x="990" y="1790.9497">reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="1086" y="1790.9497">to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="1807,1839.0156,2037,1839.0156,2047,1865.0156,2037,1892.0156,1807,1892.0156,1797,1865.0156,1807,1839.0156" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="1809" y="1855.0825">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1859" y="1855.0825">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="1809" y="1870.2153">SET value += sumRESERVED,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1809" y="1885.3481">reservedValue -= sumTransfersInBatch</text><polygon fill="#A80036" points="1905,1914.5469,1915,1918.5469,1905,1922.5469,1909,1918.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="1911" y1="1918.5469" y2="1918.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="782" y="1913.481">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="800" y="1913.481">Bulk persist transferStateChange for all processedTransfers</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="1671,1961.5469,2173,1961.5469,2183,1995.5469,2173,2029.5469,1671,2029.5469,1661,1995.5469,1671,1961.5469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="1673" y="1977.6138">batch INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1755" y="1977.6138">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="498" x="1673" y="1992.7466">select for update from transfer table where transferId in ([transferBatch.transferId,...])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="1673" y="2007.8794">build list of transferStateChanges from transferBatch</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1676" y="2023.0122"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="817" y1="2056.2109" y2="2056.2109"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="817" x2="817" y1="2056.2109" y2="2069.2109"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="776" x2="817" y1="2069.2109" y2="2069.2109"/><polygon fill="#A80036" points="786,2065.2109,776,2069.2109,786,2073.2109,782,2069.2109" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="782" y="2051.145">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="693" x="800" y="2051.145">Populate batchParticipantPositionChange from the resultant transferStateChange and the earlier processedTransfer list</text><path d="M780,2082.2109 L780,2167.2109 L1232,2167.2109 L1232,2092.2109 L1222,2082.2109 L780,2082.2109 " fill="#D3D3D3" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1222,2082.2109 L1222,2092.2109 L1232,2092.2109 L1222,2082.2109 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="786" y="2099.2778">Effectively:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="419" x="798" y="2114.4106">SET transferStateChangeId = processedTransfer.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="798" y="2129.5435">participantPositionId = preparedTransfer.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="798" y="2144.6763">value = preparedTransfer.positionValue,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="337" x="798" y="2159.8091">reservedValue = preparedTransfer.positionReservedValue</text><polygon fill="#A80036" points="1905,2194.0078,1915,2198.0078,1905,2202.0078,1909,2198.0078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="775" x2="1911" y1="2198.0078" y2="2198.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="782" y="2192.9419">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="800" y="2192.9419">Bulk persist the participant position change for all processedTransfers</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="1775,2241.0078,2069,2241.0078,2079,2252.0078,2069,2264.0078,1775,2264.0078,1765,2252.0078,1775,2241.0078" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="1777" y="2257.0747">batch INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="1859" y="2257.0747">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="2067" y="2257.0747"/><polygon fill="#A80036" points="115,2293.2734,105,2297.2734,115,2301.2734,111,2297.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="109" x2="769" y1="2297.2734" y2="2297.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="2292.2075">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="139" y="2292.2075">Return a map of transferIds and their transferStateChanges</text><path d="M23,2312.2734 L86,2312.2734 L86,2319.2734 L76,2329.2734 L23,2329.2734 L23,2312.2734 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="436.6641" style="stroke: #000000; stroke-width: 2.0;" width="1991" x="23" y="2312.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="38" y="2325.3403">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="293" x="101" y="2324.4839">[Calculate &amp; Validate Latest Position Prepare (success)]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="146" y1="2365.6719" y2="2365.6719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="146" x2="146" y1="2365.6719" y2="2378.6719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="146" y1="2378.6719" y2="2378.6719"/><polygon fill="#A80036" points="115,2374.6719,105,2378.6719,115,2382.6719,111,2378.6719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="2353.0396">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="129" y="2345.4731">Notifications for Position Validation Success</text><text fill="#FF00FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="337" x="129" y="2360.606">Reference: Postion Validation Success case (Prepare)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="2014" y1="2387.6719" y2="2387.6719"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="288" x="28" y="2397.8823">[Calculate &amp; Validate Latest Position Prepare (failure)]</text><path d="M109,2406.4766 L109,2431.4766 L232,2431.4766 L232,2416.4766 L222,2406.4766 L109,2406.4766 " fill="#FF0000" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M222,2406.4766 L222,2416.4766 L232,2416.4766 L222,2406.4766 " fill="#FF0000" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="115" y="2423.5435">Validation failure!</text><path d="M33,2447.6094 L556,2447.6094 L556,2454.6094 L546,2464.6094 L33,2464.6094 L33,2447.6094 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="237.0625" style="stroke: #000000; stroke-width: 2.0;" width="1971" x="33" y="2447.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="478" x="48" y="2460.6763">Persist Transfer State (with transferState='ABORTED' on position check fail)</text><polygon fill="#A80036" points="1547,2497.0078,1557,2501.0078,1547,2505.0078,1551,2501.0078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="1553" y1="2501.0078" y2="2501.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="2488.3755">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="129" y="2480.8091">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="129" y="2495.9419">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="203" y="2495.9419">2003</text><path d="M109,2514.0078 L109,2554.0078 L738,2554.0078 L738,2524.0078 L728,2514.0078 L109,2514.0078 " fill="#D3D3D3" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M728,2514.0078 L728,2524.0078 L738,2524.0078 L728,2514.0078 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="115" y="2531.0747">transferStateChange.state = "ABORTED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="608" x="115" y="2546.2075">transferStateChange.reason = "Net Debit Cap exceeded by this request at this time, please try again later"</text><polygon fill="#A80036" points="1905,2580.4063,1915,2584.4063,1905,2588.4063,1909,2584.4063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1569" x2="1911" y1="2584.4063" y2="2584.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1576" y="2579.3403">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="1594" y="2579.3403">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f1mgx3c2h27js1)" points="1860,2627.4063,1984,2627.4063,1994,2638.4063,1984,2650.4063,1860,2650.4063,1850,2638.4063,1860,2627.4063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1862" y="2643.4731">transferStateChange</text><polygon fill="#A80036" points="115,2672.6719,105,2676.6719,115,2680.6719,111,2676.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="109" x2="1563" y1="2676.6719" y2="2676.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="2671.606">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="139" y="2671.606">Return success</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="146" y1="2727.9375" y2="2727.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="146" x2="146" y1="2727.9375" y2="2740.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="146" y1="2740.9375" y2="2740.9375"/><polygon fill="#A80036" points="115,2736.9375,105,2740.9375,115,2744.9375,111,2740.9375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="2715.3052">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="129" y="2707.7388">Notifications for failures</text><text fill="#FF00FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="316" x="129" y="2722.8716">Reference: Failure in Postion Validation (Prepare)</text><path d="M23,2769.9375 L384,2769.9375 L384,2776.9375 L374,2786.9375 L23,2786.9375 L23,2769.9375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1107.5703" style="stroke: #000000; stroke-width: 2.0;" width="712.5" x="23" y="2769.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="316" x="38" y="2783.0044">Reference: Failure in Postion Validation (Prepare)</text><path d="M33,2794.0703 L96,2794.0703 L96,2801.0703 L86,2811.0703 L33,2811.0703 L33,2794.0703 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1076.4375" style="stroke: #000000; stroke-width: 2.0;" width="692.5" x="33" y="2794.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="48" y="2807.1372">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="137" x="111" y="2806.2808">[If type == 'bulk-prepare']</text><path d="M109,2816.2031 L109,3279.2031 L487,3279.2031 L487,2826.2031 L477,2816.2031 L109,2816.2031 " fill="#FFFF00" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M477,2816.2031 L477,2826.2031 L487,2826.2031 L477,2816.2031 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="115" y="2833.27">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="127" y="2848.4028">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="139" y="2863.5356">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="139" y="2878.6685">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="139" y="2893.8013">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="139" y="2908.9341">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="139" y="2924.0669">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="151" y="2939.1997">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="151" y="2954.3325">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="163" y="2969.4653">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="175" y="2984.5981">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="175" y="2999.731">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="175" y="3014.8638">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="151" y="3029.9966">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="139" y="3045.1294">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="139" y="3060.2622">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="151" y="3075.395">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="3090.5278">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="163" y="3105.6606">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="163" y="3120.7935">type: bulk-notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="163" y="3135.9263">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="163" y="3151.0591">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="163" y="3166.1919">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="175" y="3181.3247">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="175" y="3196.4575">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="175" y="3211.5903">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="163" y="3226.7231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="151" y="3241.856">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="139" y="3256.9888">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="127" y="3272.1216">}</text><polygon fill="#A80036" points="623.5,3321.4531,633.5,3325.4531,623.5,3329.4531,627.5,3325.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="629.5" y1="3325.4531" y2="3325.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="3312.8208">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="446" x="129" y="3305.2544">Publish Position failure event (in Prepare) to Bulk Processing Topic (for Payer)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="129" y="3320.3872">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="209" y="3320.3872">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="725.5" y1="3334.4531" y2="3334.4531"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="38" y="3344.6636">[If type == 'prepare']</text><path d="M109,3353.2578 L109,3816.2578 L487,3816.2578 L487,3363.2578 L477,3353.2578 L109,3353.2578 " fill="#FFFF00" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M477,3353.2578 L477,3363.2578 L487,3363.2578 L477,3353.2578 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="115" y="3370.3247">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="127" y="3385.4575">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="139" y="3400.5903">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="139" y="3415.7231">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="139" y="3430.856">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="139" y="3445.9888">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="139" y="3461.1216">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="151" y="3476.2544">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="151" y="3491.3872">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="163" y="3506.52">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="175" y="3521.6528">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="175" y="3536.7856">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="175" y="3551.9185">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="151" y="3567.0513">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="139" y="3582.1841">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="139" y="3597.3169">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="151" y="3612.4497">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="3627.5825">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="163" y="3642.7153">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="163" y="3657.8481">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="163" y="3672.981">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="163" y="3688.1138">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="163" y="3703.2466">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="175" y="3718.3794">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="175" y="3733.5122">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="175" y="3748.645">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="163" y="3763.7778">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="151" y="3778.9106">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="139" y="3794.0435">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="127" y="3809.1763">}</text><polygon fill="#A80036" points="466,3858.5078,476,3862.5078,466,3866.5078,470,3862.5078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="472" y1="3862.5078" y2="3862.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="3849.8755">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="129" y="3842.3091">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="129" y="3857.4419">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="203" y="3857.4419">2003</text><path d="M23,3891.5078 L405,3891.5078 L405,3898.5078 L395,3908.5078 L23,3908.5078 L23,3891.5078 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="925.9766" style="stroke: #000000; stroke-width: 2.0;" width="712.5" x="23" y="3891.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="337" x="38" y="3904.5747">Reference: Postion Validation Success case (Prepare)</text><path d="M33,3915.6406 L96,3915.6406 L96,3922.6406 L86,3932.6406 L33,3932.6406 L33,3915.6406 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="894.8438" style="stroke: #000000; stroke-width: 2.0;" width="692.5" x="33" y="3915.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="48" y="3928.7075">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="137" x="111" y="3927.8511">[If type == 'bulk-prepare']</text><path d="M109,3937.7734 L109,4310.7734 L358,4310.7734 L358,3947.7734 L348,3937.7734 L109,3937.7734 " fill="#FFFF00" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M348,3937.7734 L348,3947.7734 L358,3947.7734 L348,3937.7734 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="115" y="3954.8403">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="127" y="3969.9731">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="139" y="3985.106">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="139" y="4000.2388">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="139" y="4015.3716">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="139" y="4030.5044">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="139" y="4045.6372">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="151" y="4060.77">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="151" y="4075.9028">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="139" y="4091.0356">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="139" y="4106.1685">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="151" y="4121.3013">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="4136.4341">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="163" y="4151.5669">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="163" y="4166.6997">type: bulk-transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="163" y="4181.8325">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="163" y="4196.9653">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="163" y="4212.0981">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="175" y="4227.231">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="175" y="4242.3638">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="163" y="4257.4966">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="151" y="4272.6294">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="139" y="4287.7622">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="127" y="4302.895">}</text><polygon fill="#A80036" points="623.5,4352.2266,633.5,4356.2266,623.5,4360.2266,627.5,4356.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="629.5" y1="4356.2266" y2="4356.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="4343.5942">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="129" y="4336.0278">Publish Position Success event (in Prepare) to Bulk Processing Topic</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="129" y="4351.1606">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="209" y="4351.1606">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="725.5" y1="4365.2266" y2="4365.2266"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="38" y="4375.437">[If type == 'prepare']</text><path d="M109,4384.0313 L109,4757.0313 L358,4757.0313 L358,4394.0313 L348,4384.0313 L109,4384.0313 " fill="#FFFF00" filter="url(#f1mgx3c2h27js1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M348,4384.0313 L348,4394.0313 L358,4394.0313 L348,4384.0313 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="115" y="4401.0981">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="127" y="4416.231">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="139" y="4431.3638">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="139" y="4446.4966">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="139" y="4461.6294">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="139" y="4476.7622">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="139" y="4491.895">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="151" y="4507.0278">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="151" y="4522.1606">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="139" y="4537.2935">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="139" y="4552.4263">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="151" y="4567.5591">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="163" y="4582.6919">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="163" y="4597.8247">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="163" y="4612.9575">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="163" y="4628.0903">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="163" y="4643.2231">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="163" y="4658.356">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="175" y="4673.4888">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="175" y="4688.6216">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="163" y="4703.7544">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="151" y="4718.8872">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="139" y="4734.02">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="127" y="4749.1528">}</text><polygon fill="#A80036" points="466,4798.4844,476,4802.4844,466,4806.4844,470,4802.4844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="472" y1="4802.4844" y2="4802.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="4789.8521">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="129" y="4782.2856">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="129" y="4797.4185">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="203" y="4797.4185">2003</text><!--
@startuml
title 1.3.1. Prepare Position Handler Consume (single message, includes individual transfers from Bulk)

autonumber


control "Position Handler" as POS_HANDLER

entity "Position\nManagement\nFacade" as POS_MGMT
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
collections "topic-bulk-processing" as TOPIC_BULK_PROCESSING
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_NOTIFICATIONS
    participant TOPIC_BULK_PROCESSING
    participant POS_MGMT
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Prepare Position Handler Consume
    POS_HANDLER -> POS_MGMT: Request transfers to be processed
    activate POS_MGMT
    POS_MGMT -> POS_MGMT: Check 1st transfer to select the Participant and Currency
    group <color #blue>DB TRANSACTION</color>
        POS_MGMT -> POS_MGMT: Loop through batch and build list of transferIds and calculate sumTransfersInBatch,\nchecking all in Batch are for the correct Paricipant and Currency\n<color #FF0000><b>Error code:</b> 2001, 3100</color>
        POS_MGMT -> DB: Retrieve current state of all transfers in array from DB with select whereIn\n(FYI: The two DB transaction model needs to add a mini-state step here (RECEIVED_PREPARE => RECEIVDED_PREPARE_PROCESSING) so that the transfers are left alone if processing has started)
        activate DB
        hnote over DB #lightyellow
            transferStateChange
            transferParticipant
        end note
        DB - -> POS_MGMT: Return current state of all selected transfers from DB
        deactivate DB
        POS_MGMT <-> POS_MGMT: Validate current state (transferStateChange.transferStateId == 'RECEIVED_PREPARE')\n<color #FF0000><b>Error code:</b> 2001</color> against failing transfers\nBatch is not rejected as a whole.

        note right of POS_MGMT #lightgray
            List of transfers used during processing
            **reservedTransfers** is list of transfers to be processed in the batch
            **abortedTransfers** is the list of transfers in the incorrect state going into the process. Currently the transferStateChange is set to ABORTED - this should only be done if not already in a final state (idempotency)
            **processedTransfers** is the list of transfers that have gone through the position management algorithm. Both successful and failed trasnfers appear here as the order and "running position" against each is necessary for reconciliation

            Scalar intermidate values used in the algorithm
            **transferAmount** = payload.amount.amount
            **sumTransfersInBatch** = SUM amount against each Transfer in batch
            **currentPosition** = participantPosition.value
            **reservedPosition** = participantPosition.{original}reservedValue
            **effectivePosition** = currentPosition + reservedPosition
            **heldPosition** = effectivePosition + sumTransfersInBatch
            **availablePosition** = participantLimit(NetDebitCap) - effectivePosition
            **sumReserved** = SUM of transfers that have met rule criteria and processed
        end note
        note over POS_MGMT,DB
            Going to reserve the sum of the valid transfers in the batch against the Participants Positon in the Currency of this batch
            and calculate the available position for the Participant to use
        end note
        POS_MGMT -> DB: Select effectivePosition FOR UPDATE from DB for Payer 
        activate DB
        hnote over DB #lightyellow
            participantPosition
        end note
        DB - -> POS_MGMT: Return effectivePosition (currentPosition and reservedPosition) from DB for Payer
        deactivate DB
        POS_MGMT -> POS_MGMT: Increment reservedValue to heldPosition\n(reservedValue = reservedPosition + sumTransfersInBatch)
        POS_MGMT -> DB: Persist reservedValue
        activate DB
        hnote over DB #lightyellow
            UPDATE **participantPosition**
            SET reservedValue += sumTransfersInBatch
        end note
        deactivate DB
        
        
        POS_MGMT -> DB: Request position limits for Payer Participant
        activate DB
        hnote over DB #lightyellow
            FROM **participantLimit**
            WHERE participantLimit.limitTypeId = 'NET-DEBIT-CAP'
            AND participantLimit.participantId = payload.payerFsp
            AND participantLimit.currencyId = payload.amount.currency
        end note
        DB - -> POS_MGMT: Return position limits
        deactivate DB
        POS_MGMT <-> POS_MGMT: **availablePosition** = participantLimit(netDebitCap) - effectivePosition (same as = netDebitCap - currentPosition - reservedPosition)
        note over POS_MGMT,DB
            For each transfer in the batch, validate the availablility of position to meet the transfer amount
            this will be as per the position algorithm documented below
        end note
        POS_MGMT <-> POS_MGMT: Validate availablePosition for each tranfser (see algorithm below)\n<color #FF0000><b>Error code:</b> 4001</color>
        note right of POS_MGMT #lightgray
            01: sumReserved = 0 // Record the sum of the transfers we allow to progress to RESERVED 
            02: sumProcessed =0 // Record the sum of the transfers already processed in this batch
            03: processedTransfers = {} // The list of processed transfers - so that we can store the additional information around the decision. Most importantly the "running" position
            04: foreach transfer in reservedTransfers
                05: sumProcessed += transfer.amount // the total processed so far **(NEED TO UPDATE IN CODE)**
                06: if availablePosition >= transfer.amount
                    07: transfer.state = "RESERVED"
                    08: availablePosition -= preparedTransfer.amount
                    09: sumRESERVED += preparedTransfer.amount
                10: else
                    11: preparedTransfer.state = "ABORTED"
                    12: preparedTransfer.reason = "Net Debit Cap exceeded by this request at this time, please try again later"
                13: end if
                14: runningPosition = currentPosition + sumReserved // the initial value of the Participants position plus the total value that has been accepted in the batch so far
                15: runningReservedValue = sumTransfersInBatch - sumProcessed + reservedPosition **(NEED TO UPDATE IN CODE)** // the running down of the total reserved value at the begining of the batch.
                16: Add transfer to the processedTransfer list recording the transfer state and running position and reserved values { transferState, transfer, rawMessage, transferAmount,  runningPosition, runningReservedValue }
            16: end foreach
        end note
        note over POS_MGMT,DB
            Once the outcome for all transfers is known,update the Participant's position and remove the reserved amount associated with the batch
            (If there are any alarm limits, process those returning limits in which the threshold has been breached)
            Do a bulk insert of the trasnferStateChanges associated with processing, using the result to complete the participantPositionChange and bulk insert of these to persist the running position
        end note
        POS_MGMT->POS_MGMT: Assess any limit thresholds on the final position\nadding to alarm list if triggered
        
        POS_MGMT->DB: Persist latest position **value** and **reservedValue** to DB for Payer
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value += sumRESERVED,
                reservedValue -= sumTransfersInBatch
            end note
            activate DB
            deactivate DB

        POS_MGMT -> DB: Bulk persist transferStateChange for all processedTransfers
        hnote over DB #lightyellow
                batch INSERT **transferStateChange**
                select for update from transfer table where transferId in ([transferBatch.transferId,...])
                build list of transferStateChanges from transferBatch
                
        end note
        activate DB
        deactivate DB
        
        POS_MGMT->POS_MGMT: Populate batchParticipantPositionChange from the resultant transferStateChange and the earlier processedTransfer list

        note right of POS_MGMT #lightgray
            Effectively:  
                SET transferStateChangeId = processedTransfer.transferStateChangeId,
                participantPositionId = preparedTransfer.participantPositionId,
                value = preparedTransfer.positionValue,
                reservedValue = preparedTransfer.positionReservedValue
        end note
        POS_MGMT -> DB: Bulk persist the participant position change for all processedTransfers
        hnote over DB #lightyellow
                batch INSERT **participantPositionChange**            
        end note
        activate DB
        deactivate DB
    end
    POS_MGMT - -> POS_HANDLER: Return a map of transferIds and their transferStateChanges
    deactivate POS_MGMT
    alt Calculate & Validate Latest Position Prepare (success)
        POS_HANDLER -> POS_HANDLER: Notifications for Position Validation Success \n<color Magenta><b>Reference: Postion Validation Success case (Prepare)</b></color>
   else Calculate & Validate Latest Position Prepare (failure)
        note right of POS_HANDLER #red: Validation failure!

        group Persist Transfer State (with transferState='ABORTED' on position check fail)
            POS_HANDLER -> POS_DAO: Request to persist transfer\n<color #FF0000><b>Error code:</b> 2003</color>
            activate POS_DAO
            note right of POS_HANDLER #lightgray
                transferStateChange.state = "ABORTED",
                transferStateChange.reason = "Net Debit Cap exceeded by this request at this time, please try again later"
            end note
            POS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        POS_HANDLER -> POS_HANDLER: Notifications for failures\n<color Magenta><b>Reference: Failure in Postion Validation (Prepare) </b></color>
   end
end


group Reference: Failure in Postion Validation (Prepare)
    alt If type == 'bulk-prepare'
        note right of POS_HANDLER #yellow
        Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 4001,
                            "errorDescription": "Payer FSP insufficient liquidity",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: bulk-notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_BULK_PROCESSING: Publish Position failure event (in Prepare) to Bulk Processing Topic (for Payer) \n<color #FF0000><b>Error codes:</b> 2003</color>
    else If type == 'prepare'
        note right of POS_HANDLER #yellow
        Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 4001,
                            "errorDescription": "Payer FSP insufficient liquidity",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error code:</b> 2003</color>
    end
    
end

group Reference: Postion Validation Success case (Prepare)
    alt If type == 'bulk-prepare'
        note right of POS_HANDLER #yellow
        Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: bulk-transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_BULK_PROCESSING: Publish Position Success event (in Prepare) to Bulk Processing Topic\n<color #FF0000><b>Error codes:</b> 2003</color>
    else If type == 'prepare'
        note right of POS_HANDLER #yellow
        Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
    end
    
end

deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
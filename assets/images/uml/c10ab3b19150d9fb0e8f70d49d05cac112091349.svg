<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4234px" preserveAspectRatio="none" style="width:1548px;height:4234px;" version="1.1" viewBox="0 0 1548 4234" width="1548px" zoomAndPan="magnify"><defs><filter height="300%" id="fhc4fk3mpusav" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="269" x="640.5" y="22.9951">1.3.3. Abort Position Handler Consume</text><rect fill="#FFFFE0" height="4189.2344" style="stroke: #A80036; stroke-width: 1.0;" width="1291.5" x="39" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="635.75" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="4022.5078" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="94" y="125.7266"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="734" y="1557.4922"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="734" y="3005.5938"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="734" y="4096.2344"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="857.5" y="210.2578"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="514.5234" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="857.5" y="513.7188"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="857.5" y="1662.8906"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="182.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="857.5" y="1951.2188"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="857.5" y="3110.9922"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="182.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="857.5" y="3384.1875"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="239.3906"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="566.9844"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="700.5156"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="807.9141"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="1692.0234"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="2004.4844"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="3140.125"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="3437.4531"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="4008.5078" style="stroke: #000000; stroke-width: 2.0;" width="1524" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="1438.6328" style="stroke: #000000; stroke-width: 2.0;" width="1504" x="23" y="156.8594"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="618.0547" style="stroke: #000000; stroke-width: 2.0;" width="1484" x="33" y="418.1875"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="471.3906" style="stroke: #000000; stroke-width: 2.0;" width="700.5" x="806.5" y="528.7188"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="1434.1016" style="stroke: #000000; stroke-width: 2.0;" width="1379" x="23" y="1609.4922"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="286.3281" style="stroke: #000000; stroke-width: 2.0;" width="1359" x="33" y="1855.6875"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="139.6641" style="stroke: #000000; stroke-width: 2.0;" width="575.5" x="806.5" y="1966.2188"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="806.3125" style="stroke: #000000; stroke-width: 2.0;" width="430" x="99" y="2156.0156"/><rect fill="#FFFFFF" height="401.9922" style="stroke: none; stroke-width: 1.0;" width="430" x="99" y="2560.3359"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="1076.6406" style="stroke: #000000; stroke-width: 2.0;" width="1379" x="23" y="3057.5938"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="286.3281" style="stroke: #000000; stroke-width: 2.0;" width="1359" x="33" y="3288.6563"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="139.6641" style="stroke: #000000; stroke-width: 2.0;" width="575.5" x="806.5" y="3399.1875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="99" x2="99" y1="115.7266" y2="4158.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="738.5" x2="738.5" y1="115.7266" y2="4158.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="862.5" x2="862.5" y1="115.7266" y2="4158.2344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1282.5" x2="1282.5" y1="115.7266" y2="4158.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="43" y="112.4248">Position Handler</text><ellipse cx="99" cy="83.4297" fill="#FEFECE" filter="url(#fhc4fk3mpusav)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="95,71.4297,101,66.4297,99,71.4297,101,76.4297,95,71.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="43" y="4170.2295">Position Handler</text><ellipse cx="99" cy="4189.5313" fill="#FEFECE" filter="url(#fhc4fk3mpusav)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="95,4177.5313,101,4172.5313,99,4177.5313,101,4182.5313,95,4177.5313" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fhc4fk3mpusav)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="675.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#fhc4fk3mpusav)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="671.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="678.5" y="100.4248">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fhc4fk3mpusav)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="675.5" y="4157.2344"/><rect fill="#FEFECE" filter="url(#fhc4fk3mpusav)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="671.5" y="4161.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="678.5" y="4181.2295">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="816.5" y="112.4248">Position DAO</text><ellipse cx="862.5" cy="83.4297" fill="#FEFECE" filter="url(#fhc4fk3mpusav)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="850.5" x2="874.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="816.5" y="4170.2295">Position DAO</text><ellipse cx="862.5" cy="4189.5313" fill="#FEFECE" filter="url(#fhc4fk3mpusav)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="850.5" x2="874.5" y1="4203.5313" y2="4203.5313"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1238.5" y="112.4248">Central Store</text><path d="M1264.5,63.4297 C1264.5,53.4297 1282.5,53.4297 1282.5,53.4297 C1282.5,53.4297 1300.5,53.4297 1300.5,63.4297 L1300.5,89.4297 C1300.5,99.4297 1282.5,99.4297 1282.5,99.4297 C1282.5,99.4297 1264.5,99.4297 1264.5,89.4297 L1264.5,63.4297 " fill="#FEFECE" filter="url(#fhc4fk3mpusav)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1264.5,63.4297 C1264.5,73.4297 1282.5,73.4297 1282.5,73.4297 C1282.5,73.4297 1300.5,73.4297 1300.5,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1238.5" y="4170.2295">Central Store</text><path d="M1264.5,4183.5313 C1264.5,4173.5313 1282.5,4173.5313 1282.5,4173.5313 C1282.5,4173.5313 1300.5,4173.5313 1300.5,4183.5313 L1300.5,4209.5313 C1300.5,4219.5313 1282.5,4219.5313 1282.5,4219.5313 C1282.5,4219.5313 1264.5,4219.5313 1264.5,4209.5313 L1264.5,4183.5313 " fill="#FEFECE" filter="url(#fhc4fk3mpusav)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1264.5,4183.5313 C1264.5,4193.5313 1282.5,4193.5313 1282.5,4193.5313 C1282.5,4193.5313 1300.5,4193.5313 1300.5,4183.5313 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="4022.5078" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="94" y="125.7266"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="734" y="1557.4922"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="734" y="3005.5938"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="734" y="4096.2344"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="857.5" y="210.2578"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="514.5234" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="857.5" y="513.7188"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="857.5" y="1662.8906"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="182.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="857.5" y="1951.2188"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="857.5" y="3110.9922"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="182.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="857.5" y="3384.1875"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="239.3906"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="566.9844"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="700.5156"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="807.9141"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="1692.0234"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="2004.4844"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="3140.125"/><rect fill="#FFFFFF" filter="url(#fhc4fk3mpusav)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="3437.4531"/><path d="M13,132.7266 L264,132.7266 L264,139.7266 L254,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4008.5078" style="stroke: #000000; stroke-width: 2.0;" width="1524" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="28" y="145.7935">Abort Position Handler Consume</text><path d="M23,156.8594 L90,156.8594 L90,163.8594 L80,173.8594 L23,173.8594 L23,156.8594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1438.6328" style="stroke: #000000; stroke-width: 2.0;" width="1504" x="23" y="156.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="169.9263">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="273" x="105" y="169.0698">[type == 'position' &amp;&amp; action == 'timeout-reserved']</text><polygon fill="#A80036" points="845.5,206.2578,855.5,210.2578,845.5,214.2578,849.5,210.2578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="851.5" y1="210.2578" y2="210.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="111" y="197.6255">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="122" y="190.0591">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="122" y="205.1919">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="196" y="205.1919">2003</text><polygon fill="#A80036" points="1265.5,235.3906,1275.5,239.3906,1265.5,243.3906,1269.5,239.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="867.5" x2="1271.5" y1="239.3906" y2="239.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="874.5" y="234.3247">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="885.5" y="234.3247">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1220,252.3906,1344,252.3906,1354,271.3906,1344,290.3906,1220,290.3906,1210,271.3906,1220,252.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1222" y="268.4575">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="1222" y="283.5903">transferParticipant</text><polygon fill="#A80036" points="878.5,312.7891,868.5,316.7891,878.5,320.7891,874.5,316.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="872.5" x2="1281.5" y1="316.7891" y2="316.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="884.5" y="311.7231">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="895.5" y="311.7231">Return current state of transfer from DB</text><polygon fill="#A80036" points="115,341.9219,105,345.9219,115,349.9219,111,345.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="109" x2="861.5" y1="345.9219" y2="345.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="121" y="340.856">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="132" y="340.856">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="146" y1="390.1875" y2="390.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="146" x2="146" y1="390.1875" y2="403.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="146" y1="403.1875" y2="403.1875"/><polygon fill="#A80036" points="115,399.1875,105,403.1875,115,407.1875,111,403.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="111" y="377.5552">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="492" x="122" y="369.9888">Validate current state (transferStateChange.transferStateId == 'RESERVED_TIMEOUT')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="122" y="385.1216">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="196" y="385.1216">2001</text><path d="M33,418.1875 L346,418.1875 L346,425.1875 L336,435.1875 L33,435.1875 L33,418.1875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="618.0547" style="stroke: #000000; stroke-width: 2.0;" width="1484" x="33" y="418.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="268" x="48" y="431.2544">Persist Position change and Transfer state</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="146" y1="456.4531" y2="456.4531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="146" x2="146" y1="456.4531" y2="469.4531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="146" y1="469.4531" y2="469.4531"/><polygon fill="#A80036" points="115,465.4531,105,469.4531,115,473.4531,111,469.4531" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="111" y="451.3872">6</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="122" y="451.3872">transferStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="227" y="451.3872">= 'EXPIRED_RESERVED'</text><polygon fill="#A80036" points="845.5,509.7188,855.5,513.7188,845.5,517.7188,849.5,513.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="851.5" y1="513.7188" y2="513.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="111" y="501.0864">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="122" y="493.52">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="122" y="508.6528">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="196" y="508.6528">2003</text><path d="M806.5,528.7188 L1072.5,528.7188 L1072.5,535.7188 L1062.5,545.7188 L806.5,545.7188 L806.5,528.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="471.3906" style="stroke: #000000; stroke-width: 2.0;" width="700.5" x="806.5" y="528.7188"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="821.5" y="541.7856">DB TRANSACTION IMPLEMENTATION</text><polygon fill="#A80036" points="1265.5,562.9844,1275.5,566.9844,1265.5,570.9844,1269.5,566.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="867.5" x2="1271.5" y1="566.9844" y2="566.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="874.5" y="561.9185">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="885.5" y="561.9185">Select participantPosition.value FOR UPDATE for payerCurrencyId</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1225,579.9844,1339,579.9844,1349,590.9844,1339,602.9844,1225,602.9844,1215,590.9844,1225,579.9844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1227" y="596.0513">participantPosition</text><polygon fill="#A80036" points="878.5,625.25,868.5,629.25,878.5,633.25,874.5,629.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="872.5" x2="1281.5" y1="629.25" y2="629.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="884.5" y="624.1841">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="895.5" y="624.1841">Return participantPosition</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="867.5" x2="909.5" y1="658.3828" y2="658.3828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="909.5" x2="909.5" y1="658.3828" y2="671.3828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="868.5" x2="909.5" y1="671.3828" y2="671.3828"/><polygon fill="#A80036" points="878.5,667.3828,868.5,671.3828,878.5,675.3828,874.5,671.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="874.5" y="653.3169">10</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="892.5" y="653.3169">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="985.5" y="653.3169">= participantPosition - payload.amount.amount</text><polygon fill="#A80036" points="1265.5,696.5156,1275.5,700.5156,1265.5,704.5156,1269.5,700.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="867.5" x2="1271.5" y1="700.5156" y2="700.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="874.5" y="695.4497">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="892.5" y="695.4497">Persist latestPosition to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1193,743.5156,1372,743.5156,1382,762.5156,1372,781.5156,1193,781.5156,1183,762.5156,1193,743.5156" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="1195" y="759.5825">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1245" y="759.5825">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1195" y="774.7153">SET value = latestPosition</text><polygon fill="#A80036" points="1265.5,803.9141,1275.5,807.9141,1265.5,811.9141,1269.5,807.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="867.5" x2="1271.5" y1="807.9141" y2="807.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="874.5" y="802.8481">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="892.5" y="802.8481">Persist participant position change and state change</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1078,850.9141,1487,850.9141,1497,922.9141,1487,994.9141,1078,994.9141,1068,922.9141,1078,850.9141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="1080" y="866.981">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1126" y="866.981">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1264" y="866.981"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="1080" y="882.1138">VALUES (transferStateId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1083" y="897.2466"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="1080" y="912.3794">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="1126" y="912.3794">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="399" x="1080" y="927.5122">SET participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="405" x="1080" y="942.645">transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1080" y="957.7778">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="1080" y="972.9106">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="1080" y="988.0435">createdDate = new Date()</text><polygon fill="#A80036" points="115,1024.2422,105,1028.2422,115,1032.2422,111,1028.2422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="109" x2="861.5" y1="1028.2422" y2="1028.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="1023.1763">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="139" y="1023.1763">Return success</text><path d="M109,1048.2422 L109,1511.2422 L465,1511.2422 L465,1058.2422 L455,1048.2422 L109,1048.2422 " fill="#FFFF00" filter="url(#fhc4fk3mpusav)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M455,1048.2422 L455,1058.2422 L465,1058.2422 L455,1048.2422 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="115" y="1065.3091">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="127" y="1080.4419">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="127" y="1095.5747">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="127" y="1110.7075">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="127" y="1125.8403">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="127" y="1140.9731">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="139" y="1156.106">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="139" y="1171.2388">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="154" y="1186.3716">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="166" y="1201.5044">"errorCode": 3300,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="166" y="1216.6372">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="166" y="1231.77">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="154" y="1246.9028">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="139" y="1262.0356">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="127" y="1277.1685">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="127" y="1292.3013">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="139" y="1307.4341">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="151" y="1322.5669">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="151" y="1337.6997">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="151" y="1352.8325">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="151" y="1367.9653">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="151" y="1383.0981">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="151" y="1398.231">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="163" y="1413.3638">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="163" y="1428.4966">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="163" y="1443.6294">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="151" y="1458.7622">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="139" y="1473.895">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="127" y="1489.0278">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="115" y="1504.1606">}</text><polygon fill="#A80036" points="722,1553.4922,732,1557.4922,722,1561.4922,726,1557.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="728" y1="1557.4922" y2="1557.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="1544.8599">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="129" y="1537.2935">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="129" y="1552.4263">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="203" y="1552.4263">2003</text><path d="M23,1609.4922 L90,1609.4922 L90,1616.4922 L80,1626.4922 L23,1626.4922 L23,1609.4922 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1434.1016" style="stroke: #000000; stroke-width: 2.0;" width="1379" x="23" y="1609.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="1622.5591">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="270" x="105" y="1621.7026">[type == 'position' &amp;&amp; (action IN ['reject', 'abort'])]</text><polygon fill="#A80036" points="845.5,1658.8906,855.5,1662.8906,845.5,1666.8906,849.5,1662.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="851.5" y1="1662.8906" y2="1662.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="1650.2583">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="129" y="1642.6919">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="129" y="1657.8247">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="203" y="1657.8247">2003</text><polygon fill="#A80036" points="1265.5,1688.0234,1275.5,1692.0234,1265.5,1696.0234,1269.5,1692.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="867.5" x2="1271.5" y1="1692.0234" y2="1692.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="874.5" y="1686.9575">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="892.5" y="1686.9575">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1220,1705.0234,1344,1705.0234,1354,1716.0234,1344,1728.0234,1220,1728.0234,1210,1716.0234,1220,1705.0234" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1222" y="1721.0903">transferStateChange</text><polygon fill="#A80036" points="878.5,1750.2891,868.5,1754.2891,878.5,1758.2891,874.5,1754.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="872.5" x2="1281.5" y1="1754.2891" y2="1754.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="884.5" y="1749.2231">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="902.5" y="1749.2231">Return current state of transfer from DB</text><polygon fill="#A80036" points="115,1779.4219,105,1783.4219,115,1787.4219,111,1783.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="109" x2="861.5" y1="1783.4219" y2="1783.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="1778.356">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="139" y="1778.356">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="146" y1="1827.6875" y2="1827.6875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="146" x2="146" y1="1827.6875" y2="1840.6875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="146" y1="1840.6875" y2="1840.6875"/><polygon fill="#A80036" points="115,1836.6875,105,1840.6875,115,1844.6875,111,1840.6875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="1815.0552">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="598" x="129" y="1807.4888">Validate current state (transferStateChange.transferStateId IN ['RECEIVED_REJECT', 'RECEIVED_ERROR'])</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="129" y="1822.6216">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="203" y="1822.6216">2001</text><path d="M33,1855.6875 L346,1855.6875 L346,1862.6875 L336,1872.6875 L33,1872.6875 L33,1855.6875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="286.3281" style="stroke: #000000; stroke-width: 2.0;" width="1359" x="33" y="1855.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="268" x="48" y="1868.7544">Persist Position change and Transfer state</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="146" y1="1893.9531" y2="1893.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="146" x2="146" y1="1893.9531" y2="1906.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="146" y1="1906.9531" y2="1906.9531"/><polygon fill="#A80036" points="115,1902.9531,105,1906.9531,115,1910.9531,111,1906.9531" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="1888.8872">20</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="129" y="1888.8872">transferStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="234" y="1888.8872">= (action == 'reject' ? 'ABORTED_REJECTED' : 'ABORTED_ERROR' )</text><polygon fill="#A80036" points="845.5,1947.2188,855.5,1951.2188,845.5,1955.2188,849.5,1951.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="851.5" y1="1951.2188" y2="1951.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="1938.5864">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="129" y="1931.02">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="129" y="1946.1528">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="203" y="1946.1528">2003</text><path d="M806.5,1966.2188 L1169.5,1966.2188 L1169.5,1973.2188 L1159.5,1983.2188 L806.5,1983.2188 L806.5,1966.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="139.6641" style="stroke: #000000; stroke-width: 2.0;" width="575.5" x="806.5" y="1966.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="52" x="821.5" y="1979.2856">Refer to</text><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="876.5" y="1979.2856">DB TRANSACTION IMPLEMENTATION</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="1100.5" y="1979.2856">above</text><polygon fill="#A80036" points="1265.5,2000.4844,1275.5,2004.4844,1265.5,2008.4844,1269.5,2004.4844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="867.5" x2="1271.5" y1="2004.4844" y2="2004.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="874.5" y="1999.4185">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="892.5" y="1999.4185">Persist to database</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1203,2047.4844,1362,2047.4844,1372,2073.4844,1362,2100.4844,1203,2100.4844,1193,2073.4844,1203,2047.4844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1205" y="2063.5513">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1205" y="2078.6841">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="1205" y="2093.8169">participantPositionChange</text><polygon fill="#A80036" points="115,2130.0156,105,2134.0156,115,2138.0156,111,2134.0156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="109" x2="861.5" y1="2134.0156" y2="2134.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="2128.9497">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="139" y="2128.9497">Return success</text><path d="M99,2156.0156 L162,2156.0156 L162,2163.0156 L152,2173.0156 L99,2173.0156 L99,2156.0156 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="806.3125" style="stroke: #000000; stroke-width: 2.0;" width="430" x="99" y="2156.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114" y="2169.0825">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="177" y="2168.2261">[action == 'reject']</text><path d="M109,2178.1484 L109,2551.1484 L359,2551.1484 L359,2188.1484 L349,2178.1484 L109,2178.1484 " fill="#FFFF00" filter="url(#fhc4fk3mpusav)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M349,2178.1484 L349,2188.1484 L359,2188.1484 L349,2178.1484 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="115" y="2195.2153">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="127" y="2210.3481">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="127" y="2225.481">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="127" y="2240.6138">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="127" y="2255.7466">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="127" y="2270.8794">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="139" y="2286.0122">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="139" y="2301.145">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="127" y="2316.2778">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="127" y="2331.4106">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="139" y="2346.5435">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="151" y="2361.6763">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="151" y="2376.8091">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="151" y="2391.9419">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="151" y="2407.0747">action: reject,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="151" y="2422.2075">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="151" y="2437.3403">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="163" y="2452.4731">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="163" y="2467.606">code: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="163" y="2482.7388">description: "action successful"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="151" y="2497.8716">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="139" y="2513.0044">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="127" y="2528.1372">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="115" y="2543.27">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="99" x2="529" y1="2561.3359" y2="2561.3359"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="96" x="104" y="2571.5464">[action == 'abort']</text><path d="M109,2580.1406 L109,2953.1406 L515,2953.1406 L515,2590.1406 L505,2580.1406 L109,2580.1406 " fill="#FFFF00" filter="url(#fhc4fk3mpusav)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M505,2580.1406 L505,2590.1406 L515,2590.1406 L505,2580.1406 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="115" y="2597.2075">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="127" y="2612.3403">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="127" y="2627.4731">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="127" y="2642.606">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="127" y="2657.7388">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="127" y="2672.8716">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="139" y="2688.0044">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="139" y="2703.1372">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="127" y="2718.27">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="127" y="2733.4028">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="139" y="2748.5356">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="151" y="2763.6685">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="151" y="2778.8013">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="151" y="2793.9341">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="151" y="2809.0669">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="151" y="2824.1997">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="151" y="2839.3325">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="163" y="2854.4653">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="163" y="2869.5981">code: &lt;payload.errorInformation.errorCode || 5000&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="337" x="163" y="2884.731">description: &lt;payload.errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="151" y="2899.8638">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="139" y="2914.9966">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="127" y="2930.1294">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="115" y="2945.2622">}</text><polygon fill="#A80036" points="722,3001.5938,732,3005.5938,722,3009.5938,726,3005.5938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="728" y1="3005.5938" y2="3005.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="2992.9614">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="129" y="2985.395">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="129" y="3000.5278">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="203" y="3000.5278">2003</text><path d="M23,3057.5938 L90,3057.5938 L90,3064.5938 L80,3074.5938 L23,3074.5938 L23,3057.5938 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1076.6406" style="stroke: #000000; stroke-width: 2.0;" width="1379" x="23" y="3057.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="3070.6606">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="423" x="105" y="3069.8042">[type == 'position' &amp;&amp; action == 'fail' (Unable to currently trigger this scenario)]</text><polygon fill="#A80036" points="845.5,3106.9922,855.5,3110.9922,845.5,3114.9922,849.5,3110.9922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="851.5" y1="3110.9922" y2="3110.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="3098.3599">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="129" y="3090.7935">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="129" y="3105.9263">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="203" y="3105.9263">2003</text><polygon fill="#A80036" points="1265.5,3136.125,1275.5,3140.125,1265.5,3144.125,1269.5,3140.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="867.5" x2="1271.5" y1="3140.125" y2="3140.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="874.5" y="3135.0591">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="892.5" y="3135.0591">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1220,3153.125,1344,3153.125,1354,3164.125,1344,3176.125,1220,3176.125,1210,3164.125,1220,3153.125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1222" y="3169.1919">transferStateChange</text><polygon fill="#A80036" points="878.5,3198.3906,868.5,3202.3906,878.5,3206.3906,874.5,3202.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="872.5" x2="1281.5" y1="3202.3906" y2="3202.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="884.5" y="3197.3247">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="902.5" y="3197.3247">Return current state of transfer from DB</text><polygon fill="#A80036" points="115,3227.5234,105,3231.5234,115,3235.5234,111,3231.5234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="109" x2="861.5" y1="3231.5234" y2="3231.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="3226.4575">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="139" y="3226.4575">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="146" y1="3260.6563" y2="3260.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="146" x2="146" y1="3260.6563" y2="3273.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="146" y1="3273.6563" y2="3273.6563"/><polygon fill="#A80036" points="115,3269.6563,105,3273.6563,115,3277.6563,111,3273.6563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="3255.5903">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="412" x="129" y="3255.5903">Validate current state (transferStateChange.transferStateId == 'FAILED')</text><path d="M33,3288.6563 L346,3288.6563 L346,3295.6563 L336,3305.6563 L33,3305.6563 L33,3288.6563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="286.3281" style="stroke: #000000; stroke-width: 2.0;" width="1359" x="33" y="3288.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="268" x="48" y="3301.7231">Persist Position change and Transfer state</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="146" y1="3326.9219" y2="3326.9219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="146" x2="146" y1="3326.9219" y2="3339.9219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="146" y1="3339.9219" y2="3339.9219"/><polygon fill="#A80036" points="115,3335.9219,105,3339.9219,115,3343.9219,111,3339.9219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="3321.856">30</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="129" y="3321.856">transferStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="234" y="3321.856">= 'FAILED'</text><polygon fill="#A80036" points="845.5,3380.1875,855.5,3384.1875,845.5,3388.1875,849.5,3384.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="851.5" y1="3384.1875" y2="3384.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="3371.5552">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="129" y="3363.9888">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="129" y="3379.1216">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="203" y="3379.1216">2003</text><path d="M806.5,3399.1875 L1169.5,3399.1875 L1169.5,3406.1875 L1159.5,3416.1875 L806.5,3416.1875 L806.5,3399.1875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="139.6641" style="stroke: #000000; stroke-width: 2.0;" width="575.5" x="806.5" y="3399.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="52" x="821.5" y="3412.2544">Refer to</text><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="221" x="876.5" y="3412.2544">DB TRANSACTION IMPLEMENTATION</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="1100.5" y="3412.2544">above</text><polygon fill="#A80036" points="1265.5,3433.4531,1275.5,3437.4531,1265.5,3441.4531,1269.5,3437.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="867.5" x2="1271.5" y1="3437.4531" y2="3437.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="874.5" y="3432.3872">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="892.5" y="3432.3872">Persist to database</text><polygon fill="#FFFFE0" filter="url(#fhc4fk3mpusav)" points="1203,3480.4531,1362,3480.4531,1372,3506.4531,1362,3533.4531,1203,3533.4531,1193,3506.4531,1203,3480.4531" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1205" y="3496.52">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1205" y="3511.6528">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="1205" y="3526.7856">participantPositionChange</text><polygon fill="#A80036" points="115,3562.9844,105,3566.9844,115,3570.9844,111,3566.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="109" x2="861.5" y1="3566.9844" y2="3566.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="121" y="3561.9185">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="139" y="3561.9185">Return success</text><path d="M109,3586.9844 L109,4049.9844 L465,4049.9844 L465,3596.9844 L455,3586.9844 L109,3586.9844 " fill="#FFFF00" filter="url(#fhc4fk3mpusav)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M455,3586.9844 L455,3596.9844 L465,3596.9844 L455,3586.9844 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="115" y="3604.0513">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="127" y="3619.1841">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="127" y="3634.3169">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="127" y="3649.4497">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="127" y="3664.5825">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="127" y="3679.7153">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="139" y="3694.8481">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="139" y="3709.981">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="154" y="3725.1138">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="166" y="3740.2466">"errorCode": 3100,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="166" y="3755.3794">"errorDescription": "Transfer failed",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="166" y="3770.5122">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="154" y="3785.645">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="142" y="3800.7778">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="127" y="3815.9106">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="127" y="3831.0435">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="139" y="3846.1763">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="151" y="3861.3091">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="151" y="3876.4419">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="151" y="3891.5747">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="151" y="3906.7075">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="151" y="3921.8403">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="151" y="3936.9731">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="163" y="3952.106">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="163" y="3967.2388">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="163" y="3982.3716">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="151" y="3997.5044">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="139" y="4012.6372">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="127" y="4027.77">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="115" y="4042.9028">}</text><polygon fill="#A80036" points="722,4092.2344,732,4096.2344,722,4100.2344,726,4096.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="728" y1="4096.2344" y2="4096.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="4083.6021">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="129" y="4076.0356">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="129" y="4091.1685">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="203" y="4091.1685">2003</text><!--
@startuml
title 1.3.3. Abort Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
entity "Position DAO" as POS_DAO
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Abort Position Handler Consume
    opt type == 'position' && action == 'timeout-reserved'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
            transferParticipant
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'RESERVED_TIMEOUT')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer state
            POS_HANDLER -> POS_HANDLER: **transferStateId** = 'EXPIRED_RESERVED'
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>DB TRANSACTION IMPLEMENTATION</color>
                activate POS_DAO
                POS_DAO -> DB: Select participantPosition.value FOR UPDATE for payerCurrencyId
                activate DB
                hnote over DB #lightyellow
                    participantPosition
                end note
                DB - -> POS_DAO: Return participantPosition
                deactivate DB
                POS_DAO <-> POS_DAO: **latestPosition** = participantPosition - payload.amount.amount
                POS_DAO->DB: Persist latestPosition to DB for Payer
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = latestPosition
                end note
                activate DB
                deactivate DB
                POS_DAO -> DB: Persist participant position change and state change
                hnote over DB #lightyellow
                        INSERT **transferStateChange** 
                        VALUES (transferStateId)

                        INSERT **participantPositionChange**
                        SET participantPositionId = participantPosition.participantPositionId,
                        transferStateChangeId = transferStateChange.transferStateChangeId,
                        value = latestPosition,
                        reservedValue = participantPosition.reservedValue
                        createdDate = new Date()
                end note
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3300,
                             "errorDescription": "Transfer expired",
                             "extensionList": <transferMessage.extensionList>
                         }
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
    opt type == 'position' && (action IN ['reject', 'abort'])
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId IN ['RECEIVED_REJECT', 'RECEIVED_ERROR'])\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer state
            POS_HANDLER -> POS_HANDLER: **transferStateId** = (action == 'reject' ? 'ABORTED_REJECTED' : 'ABORTED_ERROR' )
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group Refer to <color #blue>DB TRANSACTION IMPLEMENTATION</color> above
                activate POS_DAO
                POS_DAO -> DB: Persist to database
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    participantPosition
                    transferStateChange
                    participantPositionChange
                end note
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        alt action == 'reject'
            note right of POS_HANDLER #yellow
                Message: {
                    id: <transferMessage.transferId>
                    from: <transferMessage.payerFsp>,
                    to: <transferMessage.payeeFsp>,
                    type: application/json
                    content: {
                        headers: <transferHeaders>,
                        payload: <transferMessage>
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: notification,
                            action: reject,
                            createdAt: <timestamp>,
                            state: {
                                status: "success",
                                code: 0,
                                description: "action successful"
                            }
                        }
                    }
                }
            end note
        else action == 'abort'
            note right of POS_HANDLER #yellow
                Message: {
                    id: <transferMessage.transferId>
                    from: <transferMessage.payerFsp>,
                    to: <transferMessage.payeeFsp>,
                    type: application/json
                    content: {
                        headers: <transferHeaders>,
                        payload: <transferMessage>
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            responseTo: <previous.uuid>,
                            type: notification,
                            action: abort,
                            createdAt: <timestamp>,
                            state: {
                                status: 'error',
                                code: <payload.errorInformation.errorCode || 5000>
                                description: <payload.errorInformation.errorDescription>
                            }
                        }
                    }
                }
            end note
        end
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end

    opt type == 'position' && action == 'fail' (Unable to currently trigger this scenario)
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'FAILED')

        group Persist Position change and Transfer state
            POS_HANDLER -> POS_HANDLER: **transferStateId** = 'FAILED'
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group Refer to <color #blue>DB TRANSACTION IMPLEMENTATION</color> above
                activate POS_DAO
                POS_DAO -> DB: Persist to database
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    participantPosition
                    transferStateChange
                    participantPositionChange
                end note
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3100,
                             "errorDescription": "Transfer failed",
                             "extensionList": <transferMessage.extensionList>
                         }
                     }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
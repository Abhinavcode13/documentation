<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2023px" preserveAspectRatio="none" style="width:1495px;height:2023px;" version="1.1" viewBox="0 0 1495 2023" width="1495px" zoomAndPan="magnify"><defs><filter height="300%" id="f3ull9nkzf53w" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="657" x="420" y="22.9951">2.3.1. Fulfil Position Handler Consume (single message, includes individual transfers from Bulk)</text><rect fill="#FFFFE0" height="1978.6875" style="stroke: #A80036; stroke-width: 1.0;" width="1258.5" x="29" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="609.25" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="1811.9609" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="84" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="449" y="1885.6875"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="571" y="1409.4297"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="688.5" y="186.125"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="499.3906" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="797.5" y="447.4531"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1234.5" y="215.2578"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1234.5" y="500.7188"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1234.5" y="634.25"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1234.5" y="741.6484"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="1797.9609" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="560.7891" style="stroke: #000000; stroke-width: 2.0;" width="1451" x="23" y="394.0547"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="456.2578" style="stroke: #000000; stroke-width: 2.0;" width="724.5" x="739.5" y="462.4531"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="954.8438" style="stroke: #000000; stroke-width: 2.0;" width="624.5" x="23" y="968.8438"/><rect fill="#FFFFFF" height="476.2578" style="stroke: none; stroke-width: 1.0;" width="624.5" x="23" y="1447.4297"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="89" x2="89" y1="115.7266" y2="1947.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="453.5" x2="453.5" y1="115.7266" y2="1947.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="575.5" x2="575.5" y1="115.7266" y2="1947.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="693.5" x2="693.5" y1="115.7266" y2="1947.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="802.5" x2="802.5" y1="115.7266" y2="1947.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1239.5" x2="1239.5" y1="115.7266" y2="1947.6875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="33" y="112.4248">Position Handler</text><ellipse cx="89" cy="83.4297" fill="#FEFECE" filter="url(#f3ull9nkzf53w)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="85,71.4297,91,66.4297,89,71.4297,91,76.4297,85,71.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="33" y="1959.6826">Position Handler</text><ellipse cx="89" cy="1978.9844" fill="#FEFECE" filter="url(#f3ull9nkzf53w)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="85,1966.9844,91,1961.9844,89,1966.9844,91,1971.9844,85,1966.9844" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f3ull9nkzf53w)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="407.5" y="60.1328"/><rect fill="#FEFECE" filter="url(#f3ull9nkzf53w)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="403.5" y="64.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="431.5" y="84.1279">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="410.5" y="100.4248">notifications</text><rect fill="#FEFECE" filter="url(#f3ull9nkzf53w)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="407.5" y="1946.6875"/><rect fill="#FEFECE" filter="url(#f3ull9nkzf53w)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="403.5" y="1950.6875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="431.5" y="1970.6826">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="410.5" y="1986.9795">notifications</text><rect fill="#FEFECE" filter="url(#f3ull9nkzf53w)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="518.5" y="60.1328"/><rect fill="#FEFECE" filter="url(#f3ull9nkzf53w)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="514.5" y="64.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="553.5" y="84.1279">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="521.5" y="100.4248">bulk-processing</text><rect fill="#FEFECE" filter="url(#f3ull9nkzf53w)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="518.5" y="1946.6875"/><rect fill="#FEFECE" filter="url(#f3ull9nkzf53w)" height="46.5938" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="514.5" y="1950.6875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="553.5" y="1970.6826">topic-</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="521.5" y="1986.9795">bulk-processing</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="647.5" y="112.4248">Position DAO</text><ellipse cx="693.5" cy="83.4297" fill="#FEFECE" filter="url(#f3ull9nkzf53w)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="681.5" x2="705.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="647.5" y="1959.6826">Position DAO</text><ellipse cx="693.5" cy="1978.9844" fill="#FEFECE" filter="url(#f3ull9nkzf53w)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="681.5" x2="705.5" y1="1992.9844" y2="1992.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="749.5" y="112.4248">Position Facade</text><ellipse cx="802.5" cy="83.4297" fill="#FEFECE" filter="url(#f3ull9nkzf53w)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="790.5" x2="814.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="749.5" y="1959.6826">Position Facade</text><ellipse cx="802.5" cy="1978.9844" fill="#FEFECE" filter="url(#f3ull9nkzf53w)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="790.5" x2="814.5" y1="1992.9844" y2="1992.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1195.5" y="112.4248">Central Store</text><path d="M1221.5,63.4297 C1221.5,53.4297 1239.5,53.4297 1239.5,53.4297 C1239.5,53.4297 1257.5,53.4297 1257.5,63.4297 L1257.5,89.4297 C1257.5,99.4297 1239.5,99.4297 1239.5,99.4297 C1239.5,99.4297 1221.5,99.4297 1221.5,89.4297 L1221.5,63.4297 " fill="#FEFECE" filter="url(#f3ull9nkzf53w)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1221.5,63.4297 C1221.5,73.4297 1239.5,73.4297 1239.5,73.4297 C1239.5,73.4297 1257.5,73.4297 1257.5,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1195.5" y="1959.6826">Central Store</text><path d="M1221.5,1972.9844 C1221.5,1962.9844 1239.5,1962.9844 1239.5,1962.9844 C1239.5,1962.9844 1257.5,1962.9844 1257.5,1972.9844 L1257.5,1998.9844 C1257.5,2008.9844 1239.5,2008.9844 1239.5,2008.9844 C1239.5,2008.9844 1221.5,2008.9844 1221.5,1998.9844 L1221.5,1972.9844 " fill="#FEFECE" filter="url(#f3ull9nkzf53w)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1221.5,1972.9844 C1221.5,1982.9844 1239.5,1982.9844 1239.5,1982.9844 C1239.5,1982.9844 1257.5,1982.9844 1257.5,1972.9844 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="1811.9609" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="84" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="449" y="1885.6875"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="571" y="1409.4297"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="688.5" y="186.125"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="499.3906" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="797.5" y="447.4531"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1234.5" y="215.2578"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1234.5" y="500.7188"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1234.5" y="634.25"/><rect fill="#FFFFFF" filter="url(#f3ull9nkzf53w)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1234.5" y="741.6484"/><path d="M13,132.7266 L260,132.7266 L260,139.7266 L250,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1797.9609" style="stroke: #000000; stroke-width: 2.0;" width="1471" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="202" x="28" y="145.7935">Fulfil Position Handler Consume</text><polygon fill="#A80036" points="676.5,182.125,686.5,186.125,676.5,190.125,680.5,186.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="682.5" y1="186.125" y2="186.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="101" y="173.4927">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="112" y="165.9263">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="112" y="181.0591">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="186" y="181.0591">2003</text><polygon fill="#A80036" points="1222.5,211.2578,1232.5,215.2578,1222.5,219.2578,1226.5,215.2578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="698.5" x2="1228.5" y1="215.2578" y2="215.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="705.5" y="210.1919">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="716.5" y="210.1919">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f3ull9nkzf53w)" points="1177,228.2578,1301,228.2578,1311,247.2578,1301,266.2578,1177,266.2578,1167,247.2578,1177,228.2578" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1179" y="244.3247">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="1179" y="259.4575">transferParticipant</text><polygon fill="#A80036" points="709.5,288.6563,699.5,292.6563,709.5,296.6563,705.5,292.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="703.5" x2="1238.5" y1="292.6563" y2="292.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="715.5" y="287.5903">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="726.5" y="287.5903">Return current state of transfer from DB</text><polygon fill="#A80036" points="105,317.7891,95,321.7891,105,325.7891,101,321.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="99" x2="692.5" y1="321.7891" y2="321.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="111" y="316.7231">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="122" y="316.7231">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="136" y1="366.0547" y2="366.0547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="136" x2="136" y1="366.0547" y2="379.0547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="95" x2="136" y1="379.0547" y2="379.0547"/><polygon fill="#A80036" points="105,375.0547,95,379.0547,105,383.0547,101,379.0547" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="101" y="353.4224">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="112" y="345.856">Validate current state (transferState is 'RECEIVED-FULFIL')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="112" y="360.9888">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="186" y="360.9888">2001</text><path d="M23,394.0547 L704,394.0547 L704,401.0547 L694,411.0547 L23,411.0547 L23,394.0547 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="560.7891" style="stroke: #000000; stroke-width: 2.0;" width="1451" x="23" y="394.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="636" x="38" y="407.1216">Persist Position change and Transfer State (with transferState='COMMITTED' on position check pass)</text><polygon fill="#A80036" points="785.5,443.4531,795.5,447.4531,785.5,451.4531,789.5,447.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="791.5" y1="447.4531" y2="447.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="101" y="434.8208">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="112" y="427.2544">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="112" y="442.3872">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="186" y="442.3872">2003</text><path d="M739.5,462.4531 L889.5,462.4531 L889.5,469.4531 L879.5,479.4531 L739.5,479.4531 L739.5,462.4531 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="456.2578" style="stroke: #000000; stroke-width: 2.0;" width="724.5" x="739.5" y="462.4531"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="754.5" y="475.52">DB TRANSACTION</text><polygon fill="#A80036" points="1222.5,496.7188,1232.5,500.7188,1222.5,504.7188,1226.5,500.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="807.5" x2="1228.5" y1="500.7188" y2="500.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="814.5" y="495.6528">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="825.5" y="495.6528">Select participantPosition.value FOR UPDATE from DB for Payee</text><polygon fill="#FFFFE0" filter="url(#f3ull9nkzf53w)" points="1182,513.7188,1296,513.7188,1306,524.7188,1296,536.7188,1182,536.7188,1172,524.7188,1182,513.7188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1184" y="529.7856">participantPosition</text><polygon fill="#A80036" points="818.5,558.9844,808.5,562.9844,818.5,566.9844,814.5,562.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="812.5" x2="1238.5" y1="562.9844" y2="562.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="824.5" y="557.9185">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="835.5" y="557.9185">Return participantPosition.value from DB for Payee</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="807.5" x2="849.5" y1="592.1172" y2="592.1172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="849.5" x2="849.5" y1="592.1172" y2="605.1172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="808.5" x2="849.5" y1="605.1172" y2="605.1172"/><polygon fill="#A80036" points="818.5,601.1172,808.5,605.1172,818.5,609.1172,814.5,605.1172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="814.5" y="587.0513">9</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="825.5" y="587.0513">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="918.5" y="587.0513">= participantPosition.value - payload.amount.amount</text><polygon fill="#A80036" points="1222.5,630.25,1232.5,634.25,1222.5,638.25,1226.5,634.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="807.5" x2="1228.5" y1="634.25" y2="634.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="814.5" y="629.1841">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="832.5" y="629.1841">Persist latestPosition to DB for Payee</text><polygon fill="#FFFFE0" filter="url(#f3ull9nkzf53w)" points="1150,677.25,1329,677.25,1339,696.25,1329,715.25,1150,715.25,1140,696.25,1150,677.25" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="1152" y="693.3169">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1202" y="693.3169">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1152" y="708.4497">SET value = latestPosition</text><polygon fill="#A80036" points="1222.5,737.6484,1232.5,741.6484,1222.5,745.6484,1226.5,741.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="807.5" x2="1228.5" y1="741.6484" y2="741.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="814.5" y="736.5825">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="832.5" y="736.5825">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#f3ull9nkzf53w)" points="1035,784.6484,1444,784.6484,1454,848.6484,1444,913.6484,1035,913.6484,1025,848.6484,1035,784.6484" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="1037" y="800.7153">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="1083" y="800.7153">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="1221" y="800.7153">transferStateId = 'COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1040" y="815.8481"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="1037" y="830.981">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="1083" y="830.981">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="399" x="1037" y="846.1138">SET participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="405" x="1037" y="861.2466">transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="1037" y="876.3794">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="1037" y="891.5122">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="1037" y="906.645">createdDate = new Date()</text><polygon fill="#A80036" points="105,942.8438,95,946.8438,105,950.8438,101,946.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="99" x2="801.5" y1="946.8438" y2="946.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="111" y="941.7778">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="129" y="941.7778">Return success</text><path d="M23,968.8438 L86,968.8438 L86,975.8438 L76,985.8438 L23,985.8438 L23,968.8438 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="954.8438" style="stroke: #000000; stroke-width: 2.0;" width="624.5" x="23" y="968.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="38" y="981.9106">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="101" y="981.0542">[If type == 'bulk-position']</text><path d="M99,990.9766 L99,1363.9766 L336,1363.9766 L336,1000.9766 L326,990.9766 L99,990.9766 " fill="#FFFF00" filter="url(#f3ull9nkzf53w)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M326,990.9766 L326,1000.9766 L336,1000.9766 L326,990.9766 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="105" y="1008.0435">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="105" y="1023.1763">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="117" y="1038.3091">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="117" y="1053.4419">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="117" y="1068.5747">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="117" y="1083.7075">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="117" y="1098.8403">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="129" y="1113.9731">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="129" y="1129.106">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="117" y="1144.2388">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="117" y="1159.3716">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="129" y="1174.5044">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="141" y="1189.6372">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="141" y="1204.77">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="141" y="1219.9028">type: bulk-processing,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="141" y="1235.0356">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="141" y="1250.1685">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="141" y="1265.3013">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="153" y="1280.4341">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="153" y="1295.5669">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="141" y="1310.6997">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="129" y="1325.8325">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="117" y="1340.9653">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="105" y="1356.0981">}</text><polygon fill="#A80036" points="559,1405.4297,569,1409.4297,559,1413.4297,563,1409.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="565" y1="1409.4297" y2="1409.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="101" y="1396.7974">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="119" y="1389.231">Publish Transfer event to Bulk Processing Topic</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="119" y="1404.3638">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="199" y="1404.3638">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="647.5" y1="1448.4297" y2="1448.4297"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="28" y="1458.6401">[If type == 'position']</text><path d="M99,1467.2344 L99,1840.2344 L336,1840.2344 L336,1477.2344 L326,1467.2344 L99,1467.2344 " fill="#FFFF00" filter="url(#f3ull9nkzf53w)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M326,1467.2344 L326,1477.2344 L336,1477.2344 L326,1467.2344 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="105" y="1484.3013">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="105" y="1499.4341">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="117" y="1514.5669">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="117" y="1529.6997">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="117" y="1544.8325">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="117" y="1559.9653">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="117" y="1575.0981">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="129" y="1590.231">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="129" y="1605.3638">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="117" y="1620.4966">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="117" y="1635.6294">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="129" y="1650.7622">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="141" y="1665.895">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="141" y="1681.0278">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="141" y="1696.1606">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="141" y="1711.2935">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="141" y="1726.4263">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="141" y="1741.5591">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="153" y="1756.6919">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="153" y="1771.8247">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="141" y="1786.9575">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="129" y="1802.0903">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="117" y="1817.2231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="105" y="1832.356">}</text><polygon fill="#A80036" points="437,1881.6875,447,1885.6875,437,1889.6875,441,1885.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="443" y1="1885.6875" y2="1885.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="101" y="1873.0552">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="119" y="1865.4888">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="119" y="1880.6216">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="193" y="1880.6216">2003</text><!--
@startuml
title 2.3.1. Fulfil Position Handler Consume (single message, includes individual transfers from Bulk)

autonumber


control "Position Handler" as POS_HANDLER
collections "topic-\nnotifications" as TOPIC_NOTIFICATIONS
collections "topic-\nbulk-processing" as TOPIC_BULK_PROCESSING
entity "Position Facade" as POS_FACADE
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_NOTIFICATIONS
    participant TOPIC_BULK_PROCESSING
    participant POS_DAO
    participant POS_FACADE
    participant DB
end box

activate POS_HANDLER
group Fulfil Position Handler Consume
    POS_HANDLER -> POS_DAO: Request current state of transfer from DB \n<color #FF0000><b>Error code:</b> 2003</color>
    activate POS_DAO
    POS_DAO -> DB: Retrieve current state of transfer from DB
    activate DB
    hnote over DB #lightyellow
        transferStateChange
        transferParticipant
    end note
    DB - -> POS_DAO: Return current state of transfer from DB
    deactivate DB
    POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
    deactivate POS_DAO
    POS_HANDLER <-> POS_HANDLER: Validate current state (transferState is 'RECEIVED-FULFIL')\n<color #FF0000><b>Error code:</b> 2001</color>
    group Persist Position change and Transfer State (with transferState='COMMITTED' on position check pass)
        POS_HANDLER -> POS_FACADE: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
        group <color #blue>DB TRANSACTION</color>
            activate POS_FACADE
            POS_FACADE -> DB: Select participantPosition.value FOR UPDATE from DB for Payee
            activate DB
            hnote over DB #lightyellow
                participantPosition
            end note
            DB - -> POS_FACADE: Return participantPosition.value from DB for Payee
            deactivate DB
            POS_FACADE <-> POS_FACADE: **latestPosition** = participantPosition.value - payload.amount.amount
            POS_FACADE->DB: Persist latestPosition to DB for Payee
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value = latestPosition
            end note
            activate DB
            deactivate DB
            POS_FACADE -> DB: Persist transfer state and participant position change
            hnote over DB #lightyellow
                    INSERT **transferStateChange** transferStateId = 'COMMITTED'

                    INSERT **participantPositionChange**
                    SET participantPositionId = participantPosition.participantPositionId,
                    transferStateChangeId = transferStateChange.transferStateChangeId,
                    value = latestPosition,
                    reservedValue = participantPosition.reservedValue
                    createdDate = new Date()
            end note
            activate DB
            deactivate DB
            deactivate POS_DAO
        end
        POS_FACADE - -> POS_HANDLER: Return success
        deactivate POS_FACADE
    end

    alt If type == 'bulk-position'
        note right of POS_HANDLER #yellow
        Message:
        {
            id: <transferMessage.transferId>
            from: <transferMessage.payerFsp>,
            to: <transferMessage.payeeFsp>,
            type: application/json
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: bulk-processing,
                    action: commit,
                    createdAt: <timestamp>,
                    state: {
                        status: "success",
                        code: 0
                    }
                }
            }
        }
        end note
        POS_HANDLER -> TOPIC_BULK_PROCESSING: Publish Transfer event to Bulk Processing Topic\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_BULK_PROCESSING
        deactivate TOPIC_BULK_PROCESSING
    else If type == 'position'
        note right of POS_HANDLER #yellow
        Message:
        {
            id: <transferMessage.transferId>
            from: <transferMessage.payerFsp>,
            to: <transferMessage.payeeFsp>,
            type: application/json
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: notification,
                    action: commit,
                    createdAt: <timestamp>,
                    state: {
                        status: "success",
                        code: 0
                    }
                }
            }
        }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end

end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2262px" preserveAspectRatio="none" style="width:1794px;height:2262px;" version="1.1" viewBox="0 0 1794 2262" width="1794px" zoomAndPan="magnify"><defs><filter height="300%" id="f1r7rlfkwlb9eh" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="359" x="718.5" y="22.9951">1.1.1.b. Prepare Handler Consume (batch messages)</text><rect fill="#FFFFE0" height="2217.1563" style="stroke: #A80036; stroke-width: 1.0;" width="1710.5" x="19" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="825.25" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="99" y="170.9922"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="2050.4297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="445" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="923" y="2124.1563"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1312.5" y="955.0469"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1312.5" y="1579.4375"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1422.5" y="424.9219"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1422.5" y="689.9844"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1676.5" y="454.0547"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1676.5" y="719.1172"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1676.5" y="984.1797"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1676.5" y="1608.5703"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="2036.4297" style="stroke: #000000; stroke-width: 2.0;" width="1770" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="760.5" x="366" y="215.9922"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="251.0625" style="stroke: #000000; stroke-width: 2.0;" width="1369.5" x="366" y="386.6563"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="251.0625" style="stroke: #000000; stroke-width: 2.0;" width="1369.5" x="366" y="651.7188"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="208.9297" style="stroke: #000000; stroke-width: 2.0;" width="1369.5" x="366" y="916.7813"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="1022.4453" style="stroke: #000000; stroke-width: 2.0;" width="1427" x="346" y="1139.7109"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="363.3281" style="stroke: #000000; stroke-width: 2.0;" width="582" x="356" y="1163.8438"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="561" x="366" y="1187.9766"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="562" x="366" y="1261.2422"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="506" x="366" y="1334.5078"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="167.6641" style="stroke: #000000; stroke-width: 2.0;" width="1397" x="366" y="1541.1719"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="104" x2="104" y1="115.7266" y2="2186.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="450" x2="450" y1="115.7266" y2="2186.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="927.5" x2="927.5" y1="115.7266" y2="2186.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1068.5" x2="1068.5" y1="115.7266" y2="2186.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1193.5" x2="1193.5" y1="115.7266" y2="2186.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1317.5" x2="1317.5" y1="115.7266" y2="2186.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1427.5" x2="1427.5" y1="115.7266" y2="2186.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1681.5" x2="1681.5" y1="115.7266" y2="2186.1563"/><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="154" x="27" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="154" x="23" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="140" x="30" y="100.4248">topic-transfer-prepare</text><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="154" x="27" y="2185.1563"/><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="154" x="23" y="2189.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="140" x="30" y="2209.1514">topic-transfer-prepare</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="142" x="376" y="112.4248">Prepare Event Handler</text><ellipse cx="450" cy="83.4297" fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="446,71.4297,452,66.4297,450,71.4297,452,76.4297,446,71.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="142" x="376" y="2198.1514">Prepare Event Handler</text><ellipse cx="450" cy="2217.4531" fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="446,2205.4531,452,2200.4531,450,2205.4531,452,2210.4531,446,2205.4531" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="849.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="845.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="143" x="852.5" y="100.4248">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="849.5" y="2185.1563"/><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="845.5" y="2189.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="143" x="852.5" y="2209.1514">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="88" x="1024.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="88" x="1020.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="74" x="1027.5" y="100.4248">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="88" x="1024.5" y="2185.1563"/><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="88" x="1020.5" y="2189.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="74" x="1027.5" y="2209.1514">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1130.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1126.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="1133.5" y="100.4248">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1130.5" y="2185.1563"/><rect fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1126.5" y="2189.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="1133.5" y="2209.1514">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1271.5" y="112.4248">Position DAO</text><ellipse cx="1317.5" cy="83.4297" fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1305.5" x2="1329.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="86" x="1271.5" y="2198.1514">Position DAO</text><ellipse cx="1317.5" cy="2217.4531" fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1305.5" x2="1329.5" y1="2231.4531" y2="2231.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="1373.5" y="112.4248">Participant DAO</text><ellipse cx="1427.5" cy="83.4297" fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1415.5" x2="1439.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="1373.5" y="2198.1514">Participant DAO</text><ellipse cx="1427.5" cy="2217.4531" fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1415.5" x2="1439.5" y1="2231.4531" y2="2231.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1637.5" y="112.4248">Central Store</text><path d="M1663.5,63.4297 C1663.5,53.4297 1681.5,53.4297 1681.5,53.4297 C1681.5,53.4297 1699.5,53.4297 1699.5,63.4297 L1699.5,89.4297 C1699.5,99.4297 1681.5,99.4297 1681.5,99.4297 C1681.5,99.4297 1663.5,99.4297 1663.5,89.4297 L1663.5,63.4297 " fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1663.5,63.4297 C1663.5,73.4297 1681.5,73.4297 1681.5,73.4297 C1681.5,73.4297 1699.5,73.4297 1699.5,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1637.5" y="2198.1514">Central Store</text><path d="M1663.5,2211.4531 C1663.5,2201.4531 1681.5,2201.4531 1681.5,2201.4531 C1681.5,2201.4531 1699.5,2201.4531 1699.5,2211.4531 L1699.5,2237.4531 C1699.5,2247.4531 1681.5,2247.4531 1681.5,2247.4531 C1681.5,2247.4531 1663.5,2247.4531 1663.5,2237.4531 L1663.5,2211.4531 " fill="#FEFECE" filter="url(#f1r7rlfkwlb9eh)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1663.5,2211.4531 C1663.5,2221.4531 1681.5,2221.4531 1681.5,2221.4531 C1681.5,2221.4531 1699.5,2221.4531 1699.5,2211.4531 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="99" y="170.9922"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="2050.4297" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="445" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="923" y="2124.1563"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1312.5" y="955.0469"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1312.5" y="1579.4375"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1422.5" y="424.9219"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1422.5" y="689.9844"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1676.5" y="454.0547"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1676.5" y="719.1172"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1676.5" y="984.1797"/><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1676.5" y="1608.5703"/><path d="M13,132.7266 L225,132.7266 L225,139.7266 L215,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2036.4297" style="stroke: #000000; stroke-width: 2.0;" width="1770" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="167" x="28" y="145.7935">Prepare Handler Consume</text><polygon fill="#A80036" points="120,166.9922,110,170.9922,120,174.9922,116,170.9922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="114" x2="444" y1="170.9922" y2="170.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="126" y="165.9263">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="137" y="165.9263">Consume Prepare event batch of messages for Payer</text><path d="M366,215.9922 L576,215.9922 L576,222.9922 L566,232.9922 L366,232.9922 L366,215.9922 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="760.5" x="366" y="215.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="381" y="229.0591">Persist Event Information</text><polygon fill="#A80036" points="1056.5,275.2578,1066.5,279.2578,1056.5,283.2578,1060.5,279.2578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="1062.5" y1="279.2578" y2="279.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="462" y="274.1919">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="473" y="274.1919">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1r7rlfkwlb9eh)" height="55.3984" style="stroke: #000000; stroke-width: 2.0;" width="742.5" x="373" y="287.2578"/><polygon fill="#EEEEEE" points="373,287.2578,437,287.2578,437,294.2578,427,304.2578,373,304.2578,373,287.2578" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="386" y="301.3247">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="654.25" y="320.3247">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="27" x="803.25" y="320.3247">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="803.25" x2="830.25" y1="322.3247" y2="322.3247"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="830.25" y="320.3247">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="657.25" y="335.4575"/><path d="M366,386.6563 L607,386.6563 L607,393.6563 L597,403.6563 L366,403.6563 L366,386.6563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="251.0625" style="stroke: #000000; stroke-width: 2.0;" width="1369.5" x="366" y="386.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="196" x="381" y="399.7231">Fetch batch Payer information</text><polygon fill="#A80036" points="1410.5,420.9219,1420.5,424.9219,1410.5,428.9219,1414.5,424.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="1416.5" y1="424.9219" y2="424.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="462" y="419.856">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="473" y="419.856">Request to retrieve batch of Payer Participant details (if it exists)</text><polygon fill="#A80036" points="1664.5,450.0547,1674.5,454.0547,1664.5,458.0547,1668.5,454.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1432.5" x2="1670.5" y1="454.0547" y2="454.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="1439.5" y="448.9888">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1450.5" y="448.9888">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#f1r7rlfkwlb9eh)" points="1648,467.0547,1715,467.0547,1725,478.0547,1715,490.0547,1648,490.0547,1638,478.0547,1648,467.0547" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="1650" y="483.1216">participant</text><polygon fill="#A80036" points="1443.5,512.3203,1433.5,516.3203,1443.5,520.3203,1439.5,516.3203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1437.5" x2="1680.5" y1="516.3203" y2="516.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="1449.5" y="511.2544">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="1460.5" y="511.2544">Return Participant details if it exists</text><polygon fill="#A80036" points="466,541.4531,456,545.4531,466,549.4531,462,545.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="460" x2="1426.5" y1="545.4531" y2="545.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="472" y="540.3872">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="483" y="540.3872">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="497" y1="574.5859" y2="574.5859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="497" x2="497" y1="574.5859" y2="587.5859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="456" x2="497" y1="587.5859" y2="587.5859"/><polygon fill="#A80036" points="466,583.5859,456,587.5859,466,591.5859,462,587.5859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="462" y="569.52">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="473" y="569.52">Validate Payer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="497" y1="616.7188" y2="616.7188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="497" x2="497" y1="616.7188" y2="629.7188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="456" x2="497" y1="629.7188" y2="629.7188"/><polygon fill="#A80036" points="466,625.7188,456,629.7188,466,633.7188,462,629.7188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="462" y="611.6528">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="473" y="611.6528">store result set in var: $LIST_PARTICIPANTS_DETAILS_PAYER</text><path d="M366,651.7188 L609,651.7188 L609,658.7188 L599,668.7188 L366,668.7188 L366,651.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="251.0625" style="stroke: #000000; stroke-width: 2.0;" width="1369.5" x="366" y="651.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="381" y="664.7856">Fetch batch Payee information</text><polygon fill="#A80036" points="1410.5,685.9844,1420.5,689.9844,1410.5,693.9844,1414.5,689.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="1416.5" y1="689.9844" y2="689.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="462" y="684.9185">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="473" y="684.9185">Request to retrieve batch of Payee Participant details (if it exists)</text><polygon fill="#A80036" points="1664.5,715.1172,1674.5,719.1172,1664.5,723.1172,1668.5,719.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1432.5" x2="1670.5" y1="719.1172" y2="719.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1439.5" y="714.0513">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="1457.5" y="714.0513">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#f1r7rlfkwlb9eh)" points="1648,732.1172,1715,732.1172,1725,743.1172,1715,755.1172,1648,755.1172,1638,743.1172,1648,732.1172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="1650" y="748.1841">participant</text><polygon fill="#A80036" points="1443.5,777.3828,1433.5,781.3828,1443.5,785.3828,1439.5,781.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1437.5" x2="1680.5" y1="781.3828" y2="781.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1449.5" y="776.3169">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="1467.5" y="776.3169">Return Participant details if it exists</text><polygon fill="#A80036" points="466,806.5156,456,810.5156,466,814.5156,462,810.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="460" x2="1426.5" y1="810.5156" y2="810.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="472" y="805.4497">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="490" y="805.4497">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="497" y1="839.6484" y2="839.6484"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="497" x2="497" y1="839.6484" y2="852.6484"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="456" x2="497" y1="852.6484" y2="852.6484"/><polygon fill="#A80036" points="466,848.6484,456,852.6484,466,856.6484,462,852.6484" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="462" y="834.5825">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="480" y="834.5825">Validate Payee</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="497" y1="881.7813" y2="881.7813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="497" x2="497" y1="881.7813" y2="894.7813"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="456" x2="497" y1="894.7813" y2="894.7813"/><polygon fill="#A80036" points="466,890.7813,456,894.7813,466,898.7813,462,894.7813" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="462" y="876.7153">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="480" y="876.7153">store result set in var: $LIST_PARTICIPANTS_DETAILS_PAYEE</text><path d="M366,916.7813 L565,916.7813 L565,923.7813 L555,933.7813 L366,933.7813 L366,916.7813 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="208.9297" style="stroke: #000000; stroke-width: 2.0;" width="1369.5" x="366" y="916.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="381" y="929.8481">Fetch batch of transfers</text><polygon fill="#A80036" points="1300.5,951.0469,1310.5,955.0469,1300.5,959.0469,1304.5,955.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="1306.5" y1="955.0469" y2="955.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="462" y="949.981">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="480" y="949.981">Request to retrieve batch of Transfers (if it exists)</text><polygon fill="#A80036" points="1664.5,980.1797,1674.5,984.1797,1664.5,988.1797,1668.5,984.1797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1322.5" x2="1670.5" y1="984.1797" y2="984.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1329.5" y="979.1138">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="1347.5" y="979.1138">Request batch of Transfers</text><polygon fill="#FFFFE0" filter="url(#f1r7rlfkwlb9eh)" points="1656,997.1797,1706,997.1797,1716,1008.1797,1706,1020.1797,1656,1020.1797,1646,1008.1797,1656,997.1797" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1658" y="1013.2466">transfer</text><polygon fill="#A80036" points="1333.5,1042.4453,1323.5,1046.4453,1333.5,1050.4453,1329.5,1046.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1327.5" x2="1680.5" y1="1046.4453" y2="1046.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1339.5" y="1041.3794">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="1357.5" y="1041.3794">Return batch of Transfers (if it exists)</text><polygon fill="#A80036" points="466,1071.5781,456,1075.5781,466,1079.5781,462,1075.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="460" x2="1316.5" y1="1075.5781" y2="1075.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="472" y="1070.5122">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="490" y="1070.5122">Return batch of Transfer (if it exists)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="497" y1="1104.7109" y2="1104.7109"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="497" x2="497" y1="1104.7109" y2="1117.7109"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="456" x2="497" y1="1117.7109" y2="1117.7109"/><polygon fill="#A80036" points="466,1113.7109,456,1117.7109,466,1121.7109,462,1117.7109" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="462" y="1099.645">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="480" y="1099.645">store result set in var: $LIST_TRANSFERS</text><path d="M346,1139.7109 L419,1139.7109 L419,1146.7109 L409,1156.7109 L346,1156.7109 L346,1139.7109 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1022.4453" style="stroke: #000000; stroke-width: 2.0;" width="1427" x="346" y="1139.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="361" y="1152.7778">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="147" x="434" y="1151.9214">[for each message in batch]</text><path d="M356,1163.8438 L566,1163.8438 L566,1170.8438 L556,1180.8438 L356,1180.8438 L356,1163.8438 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="363.3281" style="stroke: #000000; stroke-width: 2.0;" width="582" x="356" y="1163.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="371" y="1176.9106">Validate Prepare Transfer</text><path d="M366,1187.9766 L505,1187.9766 L505,1194.9766 L495,1204.9766 L366,1204.9766 L366,1187.9766 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="561" x="366" y="1187.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="94" x="381" y="1201.0435">Validate Payer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="497" y1="1226.2422" y2="1226.2422"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="497" x2="497" y1="1226.2422" y2="1239.2422"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="456" x2="497" y1="1239.2422" y2="1239.2422"/><polygon fill="#A80036" points="466,1235.2422,456,1239.2422,466,1243.2422,462,1239.2422" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="462" y="1221.1763">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="435" x="480" y="1221.1763">Validate Payer against in-memory var $LIST_PARTICIPANTS_DETAILS_PAYER</text><path d="M366,1261.2422 L507,1261.2422 L507,1268.2422 L497,1278.2422 L366,1278.2422 L366,1261.2422 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="562" x="366" y="1261.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="96" x="381" y="1274.3091">Validate Payee</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="497" y1="1299.5078" y2="1299.5078"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="497" x2="497" y1="1299.5078" y2="1312.5078"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="456" x2="497" y1="1312.5078" y2="1312.5078"/><polygon fill="#A80036" points="466,1308.5078,456,1312.5078,466,1316.5078,462,1312.5078" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="462" y="1294.4419">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="480" y="1294.4419">Validate Payee against in-memory var $LIST_PARTICIPANTS_DETAILS_PAYEE</text><path d="M366,1334.5078 L514,1334.5078 L514,1341.5078 L504,1351.5078 L366,1351.5078 L366,1334.5078 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="506" x="366" y="1334.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="381" y="1347.5747">Duplicate check</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="497" y1="1372.7734" y2="1372.7734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="497" x2="497" y1="1372.7734" y2="1385.7734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="456" x2="497" y1="1385.7734" y2="1385.7734"/><polygon fill="#A80036" points="466,1381.7734,456,1385.7734,466,1389.7734,462,1385.7734" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="462" y="1367.7075">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="480" y="1367.7075">Validate duplicate Check against in-memory var $LIST_TRANSFERS</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="497" y1="1421.9063" y2="1421.9063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="497" x2="497" y1="1421.9063" y2="1434.9063"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="456" x2="497" y1="1434.9063" y2="1434.9063"/><polygon fill="#A80036" points="466,1430.9063,456,1434.9063,466,1438.9063,462,1434.9063" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="462" y="1416.8403">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="480" y="1416.8403">Validate amount</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="497" y1="1464.0391" y2="1464.0391"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="497" x2="497" y1="1464.0391" y2="1477.0391"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="456" x2="497" y1="1477.0391" y2="1477.0391"/><polygon fill="#A80036" points="466,1473.0391,456,1477.0391,466,1481.0391,462,1477.0391" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="462" y="1458.9731">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="480" y="1458.9731">Validate crypto-condition</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="497" y1="1506.1719" y2="1506.1719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="497" x2="497" y1="1506.1719" y2="1519.1719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="456" x2="497" y1="1519.1719" y2="1519.1719"/><polygon fill="#A80036" points="466,1515.1719,456,1519.1719,466,1523.1719,462,1519.1719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="462" y="1501.106">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="480" y="1501.106">Validate message signature (to be confirmed in future requirement)</text><path d="M366,1541.1719 L872,1541.1719 L872,1548.1719 L862,1558.1719 L366,1558.1719 L366,1541.1719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="167.6641" style="stroke: #000000; stroke-width: 2.0;" width="1397" x="366" y="1541.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="461" x="381" y="1554.2388">Persist Transfer State (with transferState='RECEIVED' on validation pass)</text><polygon fill="#A80036" points="1300.5,1575.4375,1310.5,1579.4375,1300.5,1583.4375,1304.5,1579.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="1306.5" y1="1579.4375" y2="1579.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="462" y="1574.3716">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="480" y="1574.3716">Request to persist transfer</text><polygon fill="#A80036" points="1664.5,1604.5703,1674.5,1608.5703,1664.5,1612.5703,1668.5,1608.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1322.5" x2="1670.5" y1="1608.5703" y2="1608.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="1329.5" y="1603.5044">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="1347.5" y="1603.5044">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#f1r7rlfkwlb9eh)" points="1619,1651.5703,1743,1651.5703,1753,1662.5703,1743,1674.5703,1619,1674.5703,1609,1662.5703,1619,1651.5703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="1621" y="1667.6372">transferStateChange</text><polygon fill="#A80036" points="466,1696.8359,456,1700.8359,466,1704.8359,462,1700.8359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="460" x2="1316.5" y1="1700.8359" y2="1700.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="472" y="1695.77">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="490" y="1695.77">Return success</text><path d="M460,1720.8359 L460,2093.8359 L697,2093.8359 L697,1730.8359 L687,1720.8359 L460,1720.8359 " fill="#FFFF00" filter="url(#f1r7rlfkwlb9eh)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M687,1720.8359 L687,1730.8359 L697,1730.8359 L687,1720.8359 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="466" y="1737.9028">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="466" y="1753.0356">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="478" y="1768.1685">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="478" y="1783.3013">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="478" y="1798.4341">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="478" y="1813.5669">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="478" y="1828.6997">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="490" y="1843.8325">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="490" y="1858.9653">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="478" y="1874.0981">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="478" y="1889.231">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="490" y="1904.3638">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="502" y="1919.4966">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="502" y="1934.6294">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="502" y="1949.7622">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="502" y="1964.895">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="502" y="1980.0278">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="502" y="1995.1606">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="514" y="2010.2935">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="514" y="2025.4263">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="502" y="2040.5591">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="490" y="2055.6919">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="478" y="2070.8247">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="466" y="2085.9575">}</text><polygon fill="#A80036" points="911,2120.1563,921,2124.1563,911,2128.1563,915,2124.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="455" x2="917" y1="2124.1563" y2="2124.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="462" y="2119.0903">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="480" y="2119.0903">Route &amp; Publish Position event for Payer</text><!--
@startuml
title 1.1.1.b. Prepare Handler Consume (batch messages)

autonumber


collections "topic-transfer-prepare" as TOPIC_TRANSFER_PREPARE
control "Prepare Event Handler" as PREP_HANDLER
collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
collections "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
entity "Participant DAO" as PARTICIPANT_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_TRANSFER_PREPARE
    participant PREP_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant PARTICIPANT_DAO
    participant DB
end box

activate PREP_HANDLER
group Prepare Handler Consume
    TOPIC_TRANSFER_PREPARE <- PREP_HANDLER: Consume Prepare event batch of messages for Payer
    activate TOPIC_TRANSFER_PREPARE
    deactivate TOPIC_TRANSFER_PREPARE
    group Persist Event Information
        |||
        PREP_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg 9.1.0]]} \n
        |||
    end

    group Fetch batch Payer information
        PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve batch of Payer Participant details (if it exists)
        activate PARTICIPANT_DAO
        PARTICIPANT_DAO -> DB: Request Participant details
        hnote over DB #lightyellow
            participant
        end note
        activate DB
        PARTICIPANT_DAO <- - DB: Return Participant details if it exists
        deactivate DB
        PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
        deactivate PARTICIPANT_DAO
        PREP_HANDLER <-> PREP_HANDLER: Validate Payer
        PREP_HANDLER -> PREP_HANDLER: store result set in var: $LIST_PARTICIPANTS_DETAILS_PAYER
    end

    group Fetch batch Payee information
        PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve batch of Payee Participant details (if it exists)
        activate PARTICIPANT_DAO
        PARTICIPANT_DAO -> DB: Request Participant details
        hnote over DB #lightyellow
            participant
        end note
        activate DB
        PARTICIPANT_DAO <- - DB: Return Participant details if it exists
        deactivate DB
        PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
        deactivate PARTICIPANT_DAO
        PREP_HANDLER <-> PREP_HANDLER: Validate Payee
        PREP_HANDLER -> PREP_HANDLER: store result set in var: $LIST_PARTICIPANTS_DETAILS_PAYEE
    end

    group Fetch batch of transfers
        PREP_HANDLER -> POS_DAO: Request to retrieve batch of Transfers (if it exists)
        activate POS_DAO
        POS_DAO -> DB: Request batch of Transfers
        hnote over DB #lightyellow
            transfer
        end note
        activate DB
        POS_DAO <- - DB: Return batch of Transfers (if it exists)
        deactivate DB
        POS_DAO - -> PREP_HANDLER: Return batch of Transfer (if it exists)
        deactivate POS_DAO
        PREP_HANDLER -> PREP_HANDLER: store result set in var: $LIST_TRANSFERS
    end

    loop for each message in batch

        group Validate Prepare Transfer
            group Validate Payer
                PREP_HANDLER <-> PREP_HANDLER: Validate Payer against in-memory var $LIST_PARTICIPANTS_DETAILS_PAYER
            end
            group Validate Payee
                PREP_HANDLER <-> PREP_HANDLER: Validate Payee against in-memory var $LIST_PARTICIPANTS_DETAILS_PAYEE
            end
            group Duplicate check
                PREP_HANDLER <-> PREP_HANDLER: Validate duplicate Check against in-memory var $LIST_TRANSFERS
            end
            PREP_HANDLER <-> PREP_HANDLER: Validate amount
            PREP_HANDLER <-> PREP_HANDLER: Validate crypto-condition
            PREP_HANDLER <-> PREP_HANDLER: Validate message signature (to be confirmed in future requirement)
        end

        group Persist Transfer State (with transferState='RECEIVED' on validation pass)
            PREP_HANDLER -> POS_DAO: Request to persist transfer
            activate POS_DAO
            POS_DAO -> DB: Persist transfer
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            POS_DAO - -> PREP_HANDLER: Return success
            deactivate POS_DAO
        end

        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: position,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payer
        activate TOPIC_TRANSFER_POSITION
        deactivate TOPIC_TRANSFER_POSITION
    end
end
deactivate PREP_HANDLER
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
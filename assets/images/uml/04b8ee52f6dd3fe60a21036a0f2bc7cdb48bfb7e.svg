<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2029px" preserveAspectRatio="none" style="width:628px;height:2029px;" version="1.1" viewBox="0 0 628 2029" width="628px" zoomAndPan="magnify"><defs><filter height="300%" id="f7uct21up5rt1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="539" x="45" y="22.9951">5.1.0.b. Transfer state and position change (transferStateAndPositionChange)</text><rect fill="#FFFFE0" height="1984.6875" style="stroke: #A80036; stroke-width: 1.0;" width="329.5" x="33" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="148.75" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="516.25" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="309.5" y="316.0547"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="309.5" y="885.5703"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="309.5" y="1007.7734"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="309.5" y="1122.1719"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="309.5" y="1323.1016"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="309.5" y="1637.8281"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="1803.9609" style="stroke: #000000; stroke-width: 2.0;" width="603" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="246.7344" style="stroke: #000000; stroke-width: 2.0;" width="569" x="27" y="847.3047"/><rect fill="#FFFFFF" height="122.2031" style="stroke: none; stroke-width: 1.0;" width="569" x="27" y="971.8359"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="300.7266" style="stroke: #000000; stroke-width: 2.0;" width="502" x="27" y="1214.5703"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="56.2656" style="stroke: #000000; stroke-width: 2.0;" width="296" x="77" y="1238.7031"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="300.7266" style="stroke: #000000; stroke-width: 2.0;" width="502" x="27" y="1529.2969"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="56.2656" style="stroke: #000000; stroke-width: 2.0;" width="296" x="77" y="1553.4297"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="82" x2="82" y1="115.7266" y2="1953.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="314.5" x2="314.5" y1="115.7266" y2="1953.6875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="37" y="112.4248">Transfer DAO</text><ellipse cx="82.5" cy="83.4297" fill="#FEFECE" filter="url(#f7uct21up5rt1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="70.5" x2="94.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="37" y="1965.6826">Transfer DAO</text><ellipse cx="82.5" cy="1984.9844" fill="#FEFECE" filter="url(#f7uct21up5rt1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="70.5" x2="94.5" y1="1998.9844" y2="1998.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="270.5" y="112.4248">Central Store</text><path d="M296.5,63.4297 C296.5,53.4297 314.5,53.4297 314.5,53.4297 C314.5,53.4297 332.5,53.4297 332.5,63.4297 L332.5,89.4297 C332.5,99.4297 314.5,99.4297 314.5,99.4297 C314.5,99.4297 296.5,99.4297 296.5,89.4297 L296.5,63.4297 " fill="#FEFECE" filter="url(#f7uct21up5rt1)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M296.5,63.4297 C296.5,73.4297 314.5,73.4297 314.5,73.4297 C314.5,73.4297 332.5,73.4297 332.5,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="270.5" y="1965.6826">Central Store</text><path d="M296.5,1978.9844 C296.5,1968.9844 314.5,1968.9844 314.5,1968.9844 C314.5,1968.9844 332.5,1968.9844 332.5,1978.9844 L332.5,2004.9844 C332.5,2014.9844 314.5,2014.9844 314.5,2014.9844 C314.5,2014.9844 296.5,2014.9844 296.5,2004.9844 L296.5,1978.9844 " fill="#FEFECE" filter="url(#f7uct21up5rt1)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M296.5,1978.9844 C296.5,1988.9844 314.5,1988.9844 314.5,1988.9844 C314.5,1988.9844 332.5,1988.9844 332.5,1978.9844 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="516.25" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="309.5" y="316.0547"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="309.5" y="885.5703"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="309.5" y="1007.7734"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="309.5" y="1122.1719"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="309.5" y="1323.1016"/><rect fill="#FFFFFF" filter="url(#f7uct21up5rt1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="309.5" y="1637.8281"/><path d="M13,132.7266 L355,132.7266 L355,139.7266 L345,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1803.9609" style="stroke: #000000; stroke-width: 2.0;" width="603" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="297" x="28" y="145.7935">transferStateAndPositionUpdate (param1, trx)</text><path d="M87,154.8594 L87,285.8594 L340,285.8594 L340,164.8594 L330,154.8594 L87,154.8594 " fill="#D3D3D3" filter="url(#f7uct21up5rt1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M330,154.8594 L330,164.8594 L340,164.8594 L330,154.8594 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="49" x="93" y="171.9263">param1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="145" y="171.9263">= {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="105" y="187.0591">transferId: {payload.transferId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="105" y="202.1919">transferStateId: "enum",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="105" y="217.3247">reason: {payload.reason},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="105" y="232.4575">createdDate: {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="105" y="247.5903">drUpdated: "boolean",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="105" y="262.7231">crUpdated: "boolean"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="93" y="277.856">}</text><polygon fill="#A80036" points="297.5,312.0547,307.5,316.0547,297.5,320.0547,301.5,316.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="82.5" x2="303.5" y1="316.0547" y2="316.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="89.5" y="310.9888">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="100.5" y="310.9888">Select all required info</text><polygon fill="#FFFFE0" filter="url(#f7uct21up5rt1)" points="104,329.0547,524,329.0547,534,567.0547,524,806.0547,104,806.0547,94,567.0547,104,329.0547" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="106" y="345.1216">SELECT dr.participantCurrencyId AS drAccountId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="118" y="360.2544">dr.amount AS drAmount, drp.participantPositionId AS drPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="118" y="375.3872">drp.value AS drPositionValue, drp.reservedValue AS drReservedValue,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="118" y="390.52">cr.participantCurrencyId AS crAccountId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="118" y="405.6528">cr.amount AS crAmount, crp.participantPositionId AS crPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="118" y="420.7856">crp.value AS crPositionValue, crp.reservedValue AS crReservedValue,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="118" y="435.9185">tsc.transferStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="106" y="451.0513">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="53" x="144" y="451.0513">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="200" y="451.0513">t</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="106" y="466.1841">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="136" y="466.1841">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="265" y="466.1841">dr</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="106" y="481.3169">ON dr.transferId = t.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="106" y="496.4497">AND dr.amount &gt; 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="106" y="511.5825">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="136" y="511.5825">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="270" y="511.5825">drpc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="106" y="526.7153">ON drpc.participantCurrencyId = dr.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="106" y="541.8481">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="136" y="541.8481">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="264" y="541.8481">drp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="106" y="556.981">ON drp.participantCurrencyId = dr.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="106" y="572.1138">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="136" y="572.1138">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="265" y="572.1138">cr</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="106" y="587.2466">ON cr.transferId = t.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="106" y="602.3794">AND cr.amount &lt; 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="106" y="617.5122">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="136" y="617.5122">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="270" y="617.5122">crpc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="337" x="106" y="632.645">ON crpc.participantCurrencyId = dr.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="106" y="647.7778">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="136" y="647.7778">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="264" y="647.7778">crp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="106" y="662.9106">ON crp.participantCurrencyId = cr.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="106" y="678.0435">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="136" y="678.0435">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="274" y="678.0435">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="106" y="693.1763">ON tsc.transferId = t.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="106" y="708.3091">WHERE t.transferId = param1.tranferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="106" y="723.4419">AND drpc.ledgerAccountTypeId IN('POSITION', 'SETTLEMENT', '</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="118" y="738.5747">HUB_RECONCILIATION', 'HUB_MULTILATERAL_SETTLEMENT')</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="106" y="753.7075">AND crpc.ledgerAccountTypeId IN('POSITION', 'SETTLEMENT', '</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="118" y="768.8403">HUB_RECONCILIATION', 'HUB_MULTILATERAL_SETTLEMENT')</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="106" y="783.9731">ORDER BY transferStateChangeId DESC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="106" y="799.106">LIMIT 1</text><polygon fill="#A80036" points="93.5,828.3047,83.5,832.3047,93.5,836.3047,89.5,832.3047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="87.5" x2="313.5" y1="832.3047" y2="832.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="99.5" y="827.2388">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="110.5" y="827.2388">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="153.5" y="827.2388">info</text><path d="M27,847.3047 L94,847.3047 L94,854.3047 L84,864.3047 L27,864.3047 L27,847.3047 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="246.7344" style="stroke: #000000; stroke-width: 2.0;" width="569" x="27" y="847.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="42" y="860.3716">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="225" x="109" y="859.5151">[param1.transferStateId == 'COMMITTED']</text><polygon fill="#A80036" points="297.5,881.5703,307.5,885.5703,297.5,889.5703,301.5,885.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="82.5" x2="303.5" y1="885.5703" y2="885.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="89.5" y="880.5044">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="100.5" y="880.5044">Change transfer state</text><polygon fill="#FFFFE0" filter="url(#f7uct21up5rt1)" points="52,928.5703,576,928.5703,586,947.5703,576,966.5703,52,966.5703,42,947.5703,52,928.5703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="54" y="944.6372">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="134" y="944.6372">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="272" y="944.6372">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="520" x="54" y="959.77">VALUES ({param1.transferId, 'RECEIVED_FULFIL', {param1.reason}, {param1.createdDate})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="27" x2="596" y1="972.8359" y2="972.8359"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="209" x="32" y="983.0464">[param1.transferStateId == 'ABORTED']</text><polygon fill="#A80036" points="297.5,1003.7734,307.5,1007.7734,297.5,1011.7734,301.5,1007.7734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="82.5" x2="303.5" y1="1007.7734" y2="1007.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="89.5" y="1002.7075">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="100.5" y="1002.7075">Change transfer state</text><polygon fill="#FFFFE0" filter="url(#f7uct21up5rt1)" points="61,1050.7734,568,1050.7734,578,1069.7734,568,1088.7734,61,1088.7734,51,1069.7734,61,1050.7734" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="63" y="1066.8403">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="143" y="1066.8403">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="281" y="1066.8403">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="475" x="63" y="1081.9731">VALUES ({param1.transferId, 'REJECTED', {param1.reason}, {param1.createdDate})</text><polygon fill="#A80036" points="297.5,1118.1719,307.5,1122.1719,297.5,1126.1719,301.5,1122.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="82.5" x2="303.5" y1="1122.1719" y2="1122.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="89.5" y="1117.106">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="100.5" y="1117.106">Change transfer state</text><polygon fill="#FFFFE0" filter="url(#f7uct21up5rt1)" points="33,1135.1719,596,1135.1719,606,1154.1719,596,1173.1719,33,1173.1719,23,1154.1719,33,1135.1719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="35" y="1151.2388">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="115" y="1151.2388">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="253" y="1151.2388">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="559" x="35" y="1166.3716">VALUES ({param1.transferId, {param1.transferStateId}, {param1.reason}, {param1.createdDate})</text><polygon fill="#A80036" points="93.5,1195.5703,83.5,1199.5703,93.5,1203.5703,89.5,1199.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="87.5" x2="313.5" y1="1199.5703" y2="1199.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="99.5" y="1194.5044">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="110.5" y="1194.5044">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="153.5" y="1194.5044">transferStateChangeId</text><path d="M27,1214.5703 L94,1214.5703 L94,1221.5703 L84,1231.5703 L27,1231.5703 L27,1214.5703 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="300.7266" style="stroke: #000000; stroke-width: 2.0;" width="502" x="27" y="1214.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="42" y="1227.6372">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="109" y="1226.7808">[param1.drUpdated == true]</text><path d="M77,1238.7031 L144,1238.7031 L144,1245.7031 L134,1255.7031 L77,1255.7031 L77,1238.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="56.2656" style="stroke: #000000; stroke-width: 2.0;" width="296" x="77" y="1238.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="92" y="1251.77">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="209" x="159" y="1250.9136">[param1.transferStateId == 'ABORTED']</text><path d="M87,1260.8359 L87,1285.8359 L297,1285.8359 L297,1270.8359 L287,1260.8359 L87,1260.8359 " fill="#D3D3D3" filter="url(#f7uct21up5rt1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M287,1260.8359 L287,1270.8359 L297,1270.8359 L287,1260.8359 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="93" y="1277.9028">info.drAmount = -info.drAmount</text><polygon fill="#A80036" points="297.5,1319.1016,307.5,1323.1016,297.5,1327.1016,301.5,1323.1016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="82.5" x2="303.5" y1="1323.1016" y2="1323.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="89.5" y="1318.0356">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="100.5" y="1318.0356">Change DR position</text><polygon fill="#FFFFE0" filter="url(#f7uct21up5rt1)" points="120,1366.1016,509,1366.1016,519,1438.1016,509,1510.1016,120,1510.1016,110,1438.1016,120,1366.1016" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="122" y="1382.1685">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="172" y="1382.1685">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="122" y="1397.3013">SET value = {info.drPositionValue + info.drAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="122" y="1412.4341">WHERE participantPositionId = {info.drPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="125" y="1427.5669"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="122" y="1442.6997">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="202" y="1442.6997">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="377" y="1442.6997">(participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="134" y="1457.8325">transferStateChangeId, value, reservedValue, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="122" y="1472.9653">VALUES ({info.drPositionId}, {transferStateChangeId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="134" y="1488.0981">{info.drPositionValue + info.drAmount}, {info.drReservedValue},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="134" y="1503.231">{param1.createdDate})</text><path d="M27,1529.2969 L94,1529.2969 L94,1536.2969 L84,1546.2969 L27,1546.2969 L27,1529.2969 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="300.7266" style="stroke: #000000; stroke-width: 2.0;" width="502" x="27" y="1529.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="42" y="1542.3638">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="150" x="109" y="1541.5073">[param1.crUpdated == true]</text><path d="M77,1553.4297 L144,1553.4297 L144,1560.4297 L134,1570.4297 L77,1570.4297 L77,1553.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="56.2656" style="stroke: #000000; stroke-width: 2.0;" width="296" x="77" y="1553.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="92" y="1566.4966">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="209" x="159" y="1565.6401">[param1.transferStateId == 'ABORTED']</text><path d="M87,1575.5625 L87,1600.5625 L293,1600.5625 L293,1585.5625 L283,1575.5625 L87,1575.5625 " fill="#D3D3D3" filter="url(#f7uct21up5rt1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M283,1575.5625 L283,1585.5625 L293,1585.5625 L283,1575.5625 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="93" y="1592.6294">info.crAmount = -info.crAmount</text><polygon fill="#A80036" points="297.5,1633.8281,307.5,1637.8281,297.5,1641.8281,301.5,1637.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="82.5" x2="303.5" y1="1637.8281" y2="1637.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="89.5" y="1632.7622">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="100.5" y="1632.7622">Change CR position</text><polygon fill="#FFFFE0" filter="url(#f7uct21up5rt1)" points="120,1680.8281,509,1680.8281,519,1752.8281,509,1824.8281,120,1824.8281,110,1752.8281,120,1680.8281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="122" y="1696.895">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="172" y="1696.895">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="122" y="1712.0278">SET value = {info.crPositionValue + info.crAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="122" y="1727.1606">WHERE participantPositionId = {info.crPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="125" y="1742.2935"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="122" y="1757.4263">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="202" y="1757.4263">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="377" y="1757.4263">(participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="134" y="1772.5591">transferStateChangeId, value, reservedValue, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="122" y="1787.6919">VALUES ({info.crPositionId}, {transferStateChangeId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="365" x="134" y="1802.8247">{info.crPositionValue + info.crAmount}, {info.crReservedValue},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="134" y="1817.9575">{param1.createdDate})</text><path d="M87,1842.0234 L87,1927.0234 L445,1927.0234 L445,1852.0234 L435,1842.0234 L87,1842.0234 " fill="#D3D3D3" filter="url(#f7uct21up5rt1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M435,1842.0234 L435,1852.0234 L445,1852.0234 L435,1842.0234 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="42" x="93" y="1859.0903">return</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="138" y="1859.0903">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="105" y="1874.2231">transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="105" y="1889.356">drPositionValue: {info.drPositionValue + info.drAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="105" y="1904.4888">crPositionValue: {info.crPositionValue + info.crAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="93" y="1919.6216">}</text><!--
@startuml
title 5.1.0.b. Transfer state and position change (transferStateAndPositionChange)

autonumber


entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TRANSFER_DAO
    participant DB
end box

group transferStateAndPositionUpdate (param1, trx)
    note right of TRANSFER_DAO #lightgray
        **param1** = {
            transferId: {payload.transferId},
            transferStateId: "enum",
            reason: {payload.reason},
            createdDate: {transactionTimestamp},
            drUpdated: "boolean",
            crUpdated: "boolean"
        }
    end note

    TRANSFER_DAO -> DB: Select all required info
    activate DB
    hnote over DB #lightyellow
        SELECT dr.participantCurrencyId AS drAccountId,
            dr.amount AS drAmount, drp.participantPositionId AS drPositionId,
            drp.value AS drPositionValue, drp.reservedValue AS drReservedValue,
            cr.participantCurrencyId AS crAccountId,
            cr.amount AS crAmount, crp.participantPositionId AS crPositionId,
            crp.value AS crPositionValue, crp.reservedValue AS crReservedValue,
            tsc.transferStateId
        FROM **transfer** t
        JOIN **transferParticipant** dr
        ON dr.transferId = t.transferId
        AND dr.amount > 0
        JOIN **participantCurrency** drpc
        ON drpc.participantCurrencyId = dr.participantCurrencyId
        JOIN **participantPosition** drp
        ON drp.participantCurrencyId = dr.participantCurrencyId
        JOIN **transferParticipant** cr
        ON cr.transferId = t.transferId
        AND cr.amount < 0
        JOIN **participantCurrency** crpc
        ON crpc.participantCurrencyId = dr.participantCurrencyId
        JOIN **participantPosition** crp
        ON crp.participantCurrencyId = cr.participantCurrencyId
        JOIN **transferStateChange** tsc
        ON tsc.transferId = t.transferId
        WHERE t.transferId = param1.tranferId
        AND drpc.ledgerAccountTypeId IN('POSITION', 'SETTLEMENT', '
            HUB_RECONCILIATION', 'HUB_MULTILATERAL_SETTLEMENT')
        AND crpc.ledgerAccountTypeId IN('POSITION', 'SETTLEMENT', '
            HUB_RECONCILIATION', 'HUB_MULTILATERAL_SETTLEMENT')
        ORDER BY transferStateChangeId DESC
        LIMIT 1
    end hnote
    TRANSFER_DAO <- - DB: Return **info**
    deactivate DB

    opt param1.transferStateId == 'COMMITTED'
        TRANSFER_DAO -> DB: Change transfer state
        activate DB
        deactivate DB
        hnote over DB #lightyellow
            INSERT INTO **transferStateChange** (transferId, transferStateId, reason, createdDate)
            VALUES ({param1.transferId, 'RECEIVED_FULFIL', {param1.reason}, {param1.createdDate})
        end hnote
    else param1.transferStateId == 'ABORTED'
        TRANSFER_DAO -> DB: Change transfer state
        activate DB
        deactivate DB
        hnote over DB #lightyellow
            INSERT INTO **transferStateChange** (transferId, transferStateId, reason, createdDate)
            VALUES ({param1.transferId, 'REJECTED', {param1.reason}, {param1.createdDate})
        end hnote
    end

    TRANSFER_DAO -> DB: Change transfer state
    activate DB
    hnote over DB #lightyellow
        INSERT INTO **transferStateChange** (transferId, transferStateId, reason, createdDate)
        VALUES ({param1.transferId, {param1.transferStateId}, {param1.reason}, {param1.createdDate})
    end hnote
    TRANSFER_DAO <- - DB: Return **transferStateChangeId**
    deactivate DB

    opt param1.drUpdated == true
        opt param1.transferStateId == 'ABORTED'
            note right of TRANSFER_DAO #lightgray
                info.drAmount = -info.drAmount
            end note
        end

        TRANSFER_DAO -> DB: Change DR position
        activate DB
        deactivate DB
        hnote over DB #lightyellow
            UPDATE **participantPosition**
            SET value = {info.drPositionValue + info.drAmount}
            WHERE participantPositionId = {info.drPositionId}

            INSERT INTO **participantPositionChange** (participantPositionId,
                transferStateChangeId, value, reservedValue, createdDate)
            VALUES ({info.drPositionId}, {transferStateChangeId},
                {info.drPositionValue + info.drAmount}, {info.drReservedValue},
                {param1.createdDate})
        end hnote
    end

    opt param1.crUpdated == true
        opt param1.transferStateId == 'ABORTED'
            note right of TRANSFER_DAO #lightgray
                info.crAmount = -info.crAmount
            end note
        end

        TRANSFER_DAO -> DB: Change CR position
        activate DB
        deactivate DB
        hnote over DB #lightyellow
            UPDATE **participantPosition**
            SET value = {info.crPositionValue + info.crAmount}
            WHERE participantPositionId = {info.crPositionId}

            INSERT INTO **participantPositionChange** (participantPositionId,
                transferStateChangeId, value, reservedValue, createdDate)
            VALUES ({info.crPositionId}, {transferStateChangeId},
                {info.crPositionValue + info.crAmount}, {info.crReservedValue},
                {param1.createdDate})
        end hnote
    end

    note right of TRANSFER_DAO #lightgray
        **return** {
            transferStateChangeId,
            drPositionValue: {info.drPositionValue + info.drAmount}
            crPositionValue: {info.crPositionValue + info.crAmount}
        }
    end note
end
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="10742px" preserveAspectRatio="none" style="width:1252px;height:10742px;" version="1.1" viewBox="0 0 1252 10742" width="1252px" zoomAndPan="magnify"><defs><filter height="300%" id="f1myjnxkoqygsf" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="505" x="374.5" y="22.9951">6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)</text><rect fill="#FFB6C1" height="10696.7969" style="stroke: #A80036; stroke-width: 1.0;" width="107" x="103" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="118" y="46.3638">Central HUB</text><rect fill="#90EE90" height="10696.7969" style="stroke: #A80036; stroke-width: 1.0;" width="357" x="241" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="123" x="358" y="46.3638">Settlement Service</text><rect fill="#FFFFE0" height="10696.7969" style="stroke: #A80036; stroke-width: 1.0;" width="110" x="948.5" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="104" x="951.5" y="46.3638">Central Services</text><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="10489.0703" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="151.5" y="146.7266"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="10101.1484" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="316.5" y="518.6484"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="9223.1094" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="533.5" y="562.9141"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="153.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="616.1797"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="228.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="798.375"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="183.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="1056.2344"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="107.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="1268.6953"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="7395.0313"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="7558.8281"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="8729.4531"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="8862.9844"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="9581.3594"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="9672.7578"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="10474.0703" style="stroke: #000000; stroke-width: 2.0;" width="1229" x="12" y="153.7266"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="9179.9766" style="stroke: #000000; stroke-width: 2.0;" width="788" x="443" y="577.9141"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="761.4141" style="stroke: #000000; stroke-width: 2.0;" width="421" x="473" y="2650.3203"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="379.8906" style="stroke: #000000; stroke-width: 2.0;" width="346" x="538" y="3024.8438"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="346" x="538" y="3081.1094"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="346" x="538" y="3135.0469"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="346" x="538" y="3188.9844"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="346" x="538" y="3242.9219"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="346" x="538" y="3296.8594"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="346" x="538" y="3350.7969"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="131.9297" style="stroke: #000000; stroke-width: 2.0;" width="310" x="538" y="3613.2656"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="623.2109" style="stroke: #000000; stroke-width: 2.0;" width="502" x="528" y="3880.5938"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="325.9531" style="stroke: #000000; stroke-width: 2.0;" width="367" x="538" y="4170.8516"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="367" x="538" y="4227.1172"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="367" x="538" y="4281.0547"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="367" x="538" y="4334.9922"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="367" x="538" y="4388.9297"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="367" x="538" y="4442.8672"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="2488.1016" style="stroke: #000000; stroke-width: 2.0;" width="752" x="453" y="4854.6641"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="2330.3047" style="stroke: #000000; stroke-width: 2.0;" width="732" x="463" y="5005.4609"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="2217.9063" style="stroke: #000000; stroke-width: 2.0;" width="712" x="473" y="5110.8594"/><rect fill="#FFFFFF" height="186.8672" style="stroke: none; stroke-width: 1.0;" width="712" x="473" y="5300.0547"/><rect fill="#FFFFFF" height="247.3984" style="stroke: none; stroke-width: 1.0;" width="712" x="473" y="5486.9219"/><rect fill="#FFFFFF" height="338.1953" style="stroke: none; stroke-width: 1.0;" width="712" x="473" y="5734.3203"/><rect fill="#FFFFFF" height="14.8047" style="stroke: none; stroke-width: 1.0;" width="712" x="473" y="6072.5156"/><rect fill="#FFFFFF" height="14.8047" style="stroke: none; stroke-width: 1.0;" width="712" x="473" y="6087.3203"/><rect fill="#FFFFFF" height="14.8047" style="stroke: none; stroke-width: 1.0;" width="712" x="473" y="6102.125"/><rect fill="#FFFFFF" height="977.2422" style="stroke: none; stroke-width: 1.0;" width="712" x="473" y="6116.9297"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="313.5234" style="stroke: #000000; stroke-width: 2.0;" width="483" x="538" y="6773.6484"/><rect fill="#FFFFFF" height="234.5938" style="stroke: none; stroke-width: 1.0;" width="712" x="473" y="7094.1719"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="394.2578" style="stroke: #000000; stroke-width: 2.0;" width="746" x="473" y="7356.7656"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="468.7344" style="stroke: #000000; stroke-width: 2.0;" width="584.5" x="473" y="7765.0234"/><rect fill="#FFFFFF" height="155.4688" style="stroke: none; stroke-width: 1.0;" width="584.5" x="473" y="7922.8203"/><rect fill="#FFFFFF" height="155.4688" style="stroke: none; stroke-width: 1.0;" width="584.5" x="473" y="8078.2891"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="686.3594" style="stroke: #000000; stroke-width: 2.0;" width="714" x="473" y="8247.7578"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="329.7656" style="stroke: #000000; stroke-width: 2.0;" width="659" x="518" y="8371.5547"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="244.3672" style="stroke: #000000; stroke-width: 2.0;" width="639" x="528" y="8449.9531"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="125.0781" style="stroke: #000000; stroke-width: 2.0;" width="557" x="538" y="8562.2422"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="802.7734" style="stroke: #000000; stroke-width: 2.0;" width="700" x="463" y="8948.1172"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="463.4453" style="stroke: #000000; stroke-width: 2.0;" width="521" x="538" y="9011.3828"/><rect fill="#FFFFFF" height="81.875" style="stroke: none; stroke-width: 1.0;" width="521" x="538" y="9093.3906"/><rect fill="#FFFFFF" height="81.875" style="stroke: none; stroke-width: 1.0;" width="521" x="538" y="9175.2656"/><rect fill="#FFFFFF" height="94.6797" style="stroke: none; stroke-width: 1.0;" width="521" x="538" y="9257.1406"/><rect fill="#FFFFFF" height="81.875" style="stroke: none; stroke-width: 1.0;" width="521" x="538" y="9351.8203"/><rect fill="#FFFFFF" height="41.1328" style="stroke: none; stroke-width: 1.0;" width="521" x="538" y="9433.6953"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="255.0625" style="stroke: #000000; stroke-width: 2.0;" width="680" x="473" y="9488.8281"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="156" x2="156" y1="136.7266" y2="10644.7969"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="321" x2="321" y1="136.7266" y2="10644.7969"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="538" x2="538" y1="136.7266" y2="10644.7969"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1003.5" x2="1003.5" y1="136.7266" y2="10644.7969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="107" y="133.4248">Hub Employee</text><ellipse cx="156.5" cy="63.4297" fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M156.5,71.4297 L156.5,98.4297 M143.5,79.4297 L169.5,79.4297 M156.5,98.4297 L143.5,113.4297 M156.5,98.4297 L169.5,113.4297 " fill="none" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="107" y="10656.792">Hub Employee</text><ellipse cx="156.5" cy="10670.0938" fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M156.5,10678.0938 L156.5,10705.0938 M143.5,10686.0938 L169.5,10686.0938 M156.5,10705.0938 L143.5,10720.0938 M156.5,10705.0938 L169.5,10720.0938 " fill="none" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="245" y="133.4248">Settlement Service API</text><path d="M301,92.4297 L301,116.4297 M301,104.4297 L318,104.4297 " fill="none" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="330" cy="104.4297" fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="245" y="10656.792">Settlement Service API</text><path d="M301,10664.0938 L301,10688.0938 M301,10676.0938 L318,10676.0938 " fill="none" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="330" cy="10676.0938" fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="483" y="133.4248">Settlement DAO</text><ellipse cx="538.5" cy="104.4297" fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="526.5" x2="550.5" y1="118.4297" y2="118.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="483" y="10656.792">Settlement DAO</text><ellipse cx="538.5" cy="10676.0938" fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="526.5" x2="550.5" y1="10690.0938" y2="10690.0938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="959.5" y="133.4248">Central Store</text><path d="M985.5,84.4297 C985.5,74.4297 1003.5,74.4297 1003.5,74.4297 C1003.5,74.4297 1021.5,74.4297 1021.5,84.4297 L1021.5,110.4297 C1021.5,120.4297 1003.5,120.4297 1003.5,120.4297 C1003.5,120.4297 985.5,120.4297 985.5,110.4297 L985.5,84.4297 " fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M985.5,84.4297 C985.5,94.4297 1003.5,94.4297 1003.5,94.4297 C1003.5,94.4297 1021.5,94.4297 1021.5,84.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="959.5" y="10656.792">Central Store</text><path d="M985.5,10670.0938 C985.5,10660.0938 1003.5,10660.0938 1003.5,10660.0938 C1003.5,10660.0938 1021.5,10660.0938 1021.5,10670.0938 L1021.5,10696.0938 C1021.5,10706.0938 1003.5,10706.0938 1003.5,10706.0938 C1003.5,10706.0938 985.5,10706.0938 985.5,10696.0938 L985.5,10670.0938 " fill="#FEFECE" filter="url(#f1myjnxkoqygsf)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M985.5,10670.0938 C985.5,10680.0938 1003.5,10680.0938 1003.5,10680.0938 C1003.5,10680.0938 1021.5,10680.0938 1021.5,10670.0938 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="10489.0703" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="151.5" y="146.7266"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="10101.1484" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="316.5" y="518.6484"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="9223.1094" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="533.5" y="562.9141"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="153.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="616.1797"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="228.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="798.375"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="183.3281" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="1056.2344"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="107.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="1268.6953"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="7395.0313"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="7558.8281"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="8729.4531"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="8862.9844"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="9581.3594"/><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="998.5" y="9672.7578"/><path d="M12,153.7266 L323,153.7266 L323,160.7266 L313,170.7266 L12,170.7266 L12,153.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="10474.0703" style="stroke: #000000; stroke-width: 2.0;" width="1229" x="12" y="153.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="266" x="27" y="166.7935">Acknowledgement of Settlement Transfer</text><path d="M166,175.8594 L166,487.8594 L800,487.8594 L800,185.8594 L790,175.8594 L166,175.8594 " fill="#FFFF00" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M790,175.8594 L790,185.8594 L800,185.8594 L790,175.8594 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="172" y="192.9263">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="184" y="208.0591">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="196" y="223.1919">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="208" y="238.3247">"id": 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="208" y="253.4575">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="220" y="268.5903">{ "id": 1, "state": "PENDING_SETTLEMENT", "reason": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="556" x="220" y="283.7231">{ "id": 2, "state": "PS_TRANSFERS_RECORDED", "reason": &lt;string&gt;, "externalReference": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="374" x="220" y="298.856">{ "id": 3, "state": "PS_TRANSFERS_RESERVED", "reason": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="565" x="220" y="313.9888">{ "id": 4, "state": "PS_TRANSFERS_COMMITTED", "reason": &lt;string&gt;, "externalReference": &lt;string&gt; },</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="220" y="329.1216">{ "id": 5, "state": "SETTLED", "reason": &lt;string&gt; }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="208" y="344.2544">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="196" y="359.3872">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="196" y="374.52">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="208" y="389.6528">"id": 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="208" y="404.7856">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="220" y="419.9185">{ "id": 6, "state": "SETTLED", "reason": &lt;string&gt; }</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="208" y="435.0513">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="196" y="450.1841">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="184" y="465.3169">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="172" y="480.4497">}</text><polygon fill="#A80036" points="304.5,514.6484,314.5,518.6484,304.5,522.6484,308.5,518.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="161.5" x2="310.5" y1="518.6484" y2="518.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="168.5" y="513.5825">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="179.5" y="513.5825">PUT - /settlement/{id}</text><polygon fill="#A80036" points="521.5,558.9141,531.5,562.9141,521.5,566.9141,525.5,562.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="326.5" x2="527.5" y1="562.9141" y2="562.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="333.5" y="550.2817">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="344.5" y="542.7153">updateSettlementById routine</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="71" x="344.5" y="557.8481">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="418.5" y="557.8481">2001</text><path d="M443,577.9141 L593,577.9141 L593,584.9141 L583,594.9141 L443,594.9141 L443,577.9141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="9179.9766" style="stroke: #000000; stroke-width: 2.0;" width="788" x="443" y="577.9141"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="458" y="590.981">DB TRANSACTION</text><polygon fill="#A80036" points="986.5,612.1797,996.5,616.1797,986.5,620.1797,990.5,616.1797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="992.5" y1="616.1797" y2="616.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="550.5" y="611.1138">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="561.5" y="611.1138">Retrieve settlement information</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="830,629.1797,1177,629.1797,1187,685.1797,1177,742.1797,830,742.1797,820,685.1797,830,629.1797" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="832" y="645.2466">SELECT s.settlementId, ssc.settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="844" y="660.3794">ssc.reason, ssc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="832" y="675.5122">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="870" y="675.5122">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="6" x="945" y="675.5122">s</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="832" y="690.645">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="862" y="690.645">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1019" y="690.645">ssc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="832" y="705.7778">ON ssc.settlementStateChangeId = s.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="832" y="720.9106">WHERE s.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="832" y="736.0435">FOR UPDATE</text><polygon fill="#A80036" points="554.5,765.2422,544.5,769.2422,554.5,773.2422,550.5,769.2422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="548.5" x2="1002.5" y1="769.2422" y2="769.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="560.5" y="764.1763">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="571.5" y="764.1763">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="614.5" y="764.1763">settlementData</text><polygon fill="#A80036" points="986.5,794.375,996.5,798.375,986.5,802.375,990.5,798.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="992.5" y1="798.375" y2="798.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="550.5" y="793.3091">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="561.5" y="793.3091">Retrive settlement accounts information</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="826,811.375,1180,811.375,1190,905.375,1180,1000.375,826,1000.375,816,905.375,826,811.375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="828" y="827.4419">SELECT pc.participantId, spc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="840" y="842.5747">spcsc.settlementStateId, spcsc.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="840" y="857.7075">spcsc.createdDate, spc.netAmount, pc.currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="840" y="872.8403">spc.settlementParticipantCurrencyId AS</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1073" y="872.8403">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="828" y="887.9731">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="866" y="887.9731">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="20" x="1072" y="887.9731">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="828" y="903.106">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="285" x="858" y="903.106">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1146" y="903.106">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="828" y="918.2388">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="828" y="933.3716">spc.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="828" y="948.5044">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="858" y="948.5044">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="14" x="992" y="948.5044">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="828" y="963.6372">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="828" y="978.77">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="828" y="993.9028">FOR UPDATE</text><polygon fill="#A80036" points="554.5,1023.1016,544.5,1027.1016,554.5,1031.1016,550.5,1027.1016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="548.5" x2="1002.5" y1="1027.1016" y2="1027.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="560.5" y="1022.0356">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="571.5" y="1022.0356">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="153" x="614.5" y="1022.0356">settlementAccountsList</text><polygon fill="#A80036" points="986.5,1052.2344,996.5,1056.2344,986.5,1060.2344,990.5,1056.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="992.5" y1="1056.2344" y2="1056.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="550.5" y="1051.1685">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="561.5" y="1051.1685">Retrive settlement windows information</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="796,1069.2344,1211,1069.2344,1221,1141.2344,1211,1213.2344,796,1213.2344,786,1141.2344,796,1069.2344" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="798" y="1085.3013">SELECT ssw.settlementWindowId, swsc.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="810" y="1100.4341">swsc.reason, swsc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="798" y="1115.5669">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="195" x="836" y="1115.5669">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1034" y="1115.5669">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="798" y="1130.6997">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="828" y="1130.6997">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="953" y="1130.6997">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="798" y="1145.8325">ON sw.settlementWindow = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="798" y="1160.9653">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="204" x="828" y="1160.9653">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1035" y="1160.9653">swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="798" y="1176.0981">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="798" y="1191.231">WHERE ssw.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="798" y="1206.3638">FOR UPDATE</text><polygon fill="#A80036" points="554.5,1235.5625,544.5,1239.5625,554.5,1243.5625,550.5,1239.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="548.5" x2="1002.5" y1="1239.5625" y2="1239.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="560.5" y="1234.4966">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="571.5" y="1234.4966">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="614.5" y="1234.4966">windowsList</text><polygon fill="#A80036" points="986.5,1264.6953,996.5,1268.6953,986.5,1272.6953,990.5,1268.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="992.5" y1="1268.6953" y2="1268.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="550.5" y="1263.6294">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="561.5" y="1263.6294">Retrieve settlement windows accounts information</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="820,1281.6953,1186,1281.6953,1196,1315.6953,1186,1349.6953,820,1349.6953,810,1315.6953,820,1281.6953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="822" y="1297.7622">SELECT DISTINCT settlementWindowId, participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="822" y="1312.895">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="860" y="1312.895">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="822" y="1328.0278">WHERE settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="822" y="1343.1606">FOR UPDATE</text><polygon fill="#A80036" points="554.5,1372.3594,544.5,1376.3594,554.5,1380.3594,550.5,1376.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="548.5" x2="1002.5" y1="1376.3594" y2="1376.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="560.5" y="1371.2935">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="578.5" y="1371.2935">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="621.5" y="1371.2935">windowsAccountsList</text><path d="M548,1389.3594 L548,1459.3594 L1009,1459.3594 L1009,1399.3594 L999,1389.3594 L548,1389.3594 " fill="#ADD8E6" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M999,1389.3594 L999,1399.3594 L1009,1399.3594 L999,1389.3594 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="415" x="554" y="1406.4263">All objects below are done for the purposes of the syncronous request.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="554" y="1421.5591">If at same point Node process memory limit is reached we may decide to:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="440" x="554" y="1436.6919">A. Limit the amount of transfers per window and windows per settlement or</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="554" y="1451.8247">B. Move to asyncronous processing where we don't need these objects</text><path d="M548,1473.8906 L548,2345.8906 L1182,2345.8906 L1182,1483.8906 L1172,1473.8906 L548,1473.8906 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1172,1473.8906 L1172,1483.8906 L1182,1483.8906 L1172,1473.8906 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="554" y="1490.9575">Available raw datasets from DB:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="554" y="1506.0903">settlementData</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="660" y="1506.0903">contains information about settlement and its current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="153" x="554" y="1521.2231">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="710" y="1521.2231">holds information about all accounts and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77" x="554" y="1536.356">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="634" y="1536.356">has information about all windows and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="135" x="554" y="1551.4888">windowsAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="692" y="1551.4888">has information about all accounts and windows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="557" y="1566.6216"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="554" y="1581.7544">Local variables and objects:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="130" x="554" y="1596.8872">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="684" y="1596.8872">: { // (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="793" y="1596.8872">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="927" y="1596.8872">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="566" y="1612.02">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="552" x="566" y="1627.1528">psTransfersRecordedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RECORDED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="543" x="566" y="1642.2856">psTransfersReservedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RESERVED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="568" x="566" y="1657.4185">psTransfersCommittedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_COMMITTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="566" y="1672.5513">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="566" y="1687.6841">abortedCount: &lt;integer&gt; // count of accounts in ABORTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="554" y="1702.8169">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="554" y="1717.9497">settlementAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="711" y="1717.9497">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="74" x="554" y="1733.0825">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="628" y="1733.0825">: { // same as previous but accessed by account id (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1001" y="1733.0825">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1135" y="1733.0825">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="566" y="1748.2153">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="578" y="1763.3481">id: participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="578" y="1778.481">state: settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="578" y="1793.6138">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="578" y="1808.7466">createdDate: createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="578" y="1823.8794">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="590" y="1839.0122">amount: netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="590" y="1854.145">currency: currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="578" y="1869.2778">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="429" x="578" y="1884.4106">participantId: participantId, // could be used to reconstruct allParticipants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="578" y="1899.5435">key:</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="603" y="1899.5435">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="625" y="1899.5435">// will be used to insert new state for settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="566" y="1914.6763">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="554" y="1929.8091">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="554" y="1944.9419">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="462" x="626" y="1944.9419">: { // same as settlementWindows response object with initial data (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="1091" y="1944.9419">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1163" y="1944.9419">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="464" x="566" y="1960.0747">settlementWindowId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="578" y="1975.2075">id: settlementWindowId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="578" y="1990.3403">state: settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="578" y="2005.4731">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="578" y="2020.606">createdDate: createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="566" y="2035.7388">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="554" y="2050.8716">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="554" y="2066.0044">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="666" y="2066.0044">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="464" x="566" y="2081.1372">settlementWindowId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="578" y="2096.27">id: settlementWindowId // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="578" y="2111.4028">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="552" x="578" y="2126.5356">psTransfersRecordedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RECORDED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="543" x="578" y="2141.6685">psTransfersReservedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_RESERVED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="568" x="578" y="2156.8013">psTransfersCommittedCount: &lt;integer&gt;, // count of accounts in PS_TRANSFERS_COMMITTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="578" y="2171.9341">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="578" y="2187.0669">abortedCount: &lt;integer&gt; // count of accounts in ABORTED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="566" y="2202.1997">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="554" y="2217.3325">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="554" y="2232.4653">windowsAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="693" y="2232.4653">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="554" y="2247.5981">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="668" y="2247.5981">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="566" y="2262.731">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="578" y="2277.8638">id: participantCurrencyId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="578" y="2292.9966">windows: [] // array of windows to which the account settlement spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="566" y="2308.1294">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="554" y="2323.2622">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="14" x="554" y="2338.395">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="571" y="2338.395">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="719" y="2338.395">= now()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="2401.5938" y2="2401.5938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="2401.5938" y2="2414.5938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="2414.5938" y2="2414.5938"/><polygon fill="#A80036" points="554.5,2410.5938,544.5,2414.5938,554.5,2418.5938,550.5,2414.5938" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="2396.5278">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="568.5" y="2396.5278">Declare and initialize variables</text><path d="M548,2427.5938 L548,2633.5938 L820,2633.5938 L820,2437.5938 L810,2427.5938 L548,2427.5938 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M810,2427.5938 L810,2437.5938 L820,2437.5938 L810,2427.5938 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="554" y="2444.6606">let settlementAccounts = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="566" y="2459.7935">pendingSettlementCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="566" y="2474.9263">psTransfersRecordedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="566" y="2490.0591">psTransfersReservedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="566" y="2505.1919">psTransfersCommittedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="566" y="2520.3247">settledCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="566" y="2535.4575">abortedCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="566" y="2550.5903">unknownCount: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="554" y="2565.7231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="554" y="2580.856">let allAccounts = {} // declare map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="554" y="2595.9888">let pid // participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="554" y="2611.1216">let aid // accountId (participantCurrencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="554" y="2626.2544">let state</text><path d="M473,2650.3203 L546,2650.3203 L546,2657.3203 L536,2667.3203 L473,2667.3203 L473,2650.3203 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="761.4141" style="stroke: #000000; stroke-width: 2.0;" width="421" x="473" y="2650.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="488" y="2663.3872">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="196" x="561" y="2662.5308">[settlementAccountsList as account]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="2688.5859" y2="2688.5859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="2688.5859" y2="2701.5859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="2701.5859" y2="2701.5859"/><polygon fill="#A80036" points="554.5,2697.5859,544.5,2701.5859,554.5,2705.5859,550.5,2701.5859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="2683.52">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="568.5" y="2683.52">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="74" x="623.5" y="2683.52">allAccounts</text><path d="M548,2714.5859 L548,2966.5859 L779,2966.5859 L779,2724.5859 L769,2714.5859 L548,2714.5859 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M769,2714.5859 L769,2724.5859 L779,2724.5859 L769,2714.5859 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="554" y="2731.6528">pid = account.participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="554" y="2746.7856">aid = account.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="554" y="2761.9185">state = account.settlementStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="557" y="2777.0513"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="554" y="2792.1841">allAccounts[aid] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="566" y="2807.3169">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="566" y="2822.4497">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="566" y="2837.5825">reason: account.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="566" y="2852.7153">createDate: account.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="566" y="2867.8481">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="578" y="2882.981">amount: account.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="578" y="2898.1138">currency: account.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="566" y="2913.2466">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="566" y="2928.3794">participantId: pid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="566" y="2943.5122">key: account.key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="554" y="2958.645">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="2996.8438" y2="2996.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="2996.8438" y2="3009.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="3009.8438" y2="3009.8438"/><polygon fill="#A80036" points="554.5,3005.8438,544.5,3009.8438,554.5,3013.8438,550.5,3009.8438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="2991.7778">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="568.5" y="2991.7778">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="130" x="623.5" y="2991.7778">settlementAccounts</text><path d="M538,3024.8438 L601,3024.8438 L601,3031.8438 L591,3041.8438 L538,3041.8438 L538,3024.8438 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="379.8906" style="stroke: #000000; stroke-width: 2.0;" width="346" x="538" y="3024.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="553" y="3037.9106">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="616" y="3037.0542">[state == 'PENDING_SETTLEMENT']</text><path d="M548,3046.9766 L548,3071.9766 L848,3071.9766 L848,3056.9766 L838,3046.9766 L548,3046.9766 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M838,3046.9766 L838,3056.9766 L848,3056.9766 L838,3046.9766 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="554" y="3064.0435">settlementAccounts.pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="884" y1="3082.1094" y2="3082.1094"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="199" x="543" y="3092.3198">[state == 'PS_TRANSFERS_RECORDED']</text><path d="M548,3100.9141 L548,3125.9141 L863,3125.9141 L863,3110.9141 L853,3100.9141 L548,3100.9141 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M853,3100.9141 L853,3110.9141 L863,3110.9141 L853,3100.9141 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="554" y="3117.981">settlementAccounts.psTransfersRecordedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="884" y1="3136.0469" y2="3136.0469"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="194" x="543" y="3146.2573">[state == 'PS_TRANSFERS_RESERVED']</text><path d="M548,3154.8516 L548,3179.8516 L860,3179.8516 L860,3164.8516 L850,3154.8516 L548,3154.8516 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M850,3154.8516 L850,3164.8516 L860,3164.8516 L850,3154.8516 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="554" y="3171.9185">settlementAccounts.psTransfersReservedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="884" y1="3189.9844" y2="3189.9844"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="543" y="3200.1948">[state == 'PS_TRANSFERS_COMMITTED']</text><path d="M548,3208.7891 L548,3233.7891 L870,3233.7891 L870,3218.7891 L860,3208.7891 L548,3208.7891 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M860,3208.7891 L860,3218.7891 L870,3218.7891 L860,3208.7891 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="554" y="3225.856">settlementAccounts.psTransfersCommittedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="884" y1="3243.9219" y2="3243.9219"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="543" y="3254.1323">[state == 'SETTLED']</text><path d="M548,3262.7266 L548,3287.7266 L776,3287.7266 L776,3272.7266 L766,3262.7266 L548,3262.7266 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M766,3262.7266 L766,3272.7266 L776,3272.7266 L766,3262.7266 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="554" y="3279.7935">settlementAccounts.settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="884" y1="3297.8594" y2="3297.8594"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="543" y="3308.0698">[state == 'ABORTED']</text><path d="M548,3316.6641 L548,3341.6641 L784,3341.6641 L784,3326.6641 L774,3316.6641 L548,3316.6641 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M774,3316.6641 L774,3326.6641 L784,3326.6641 L774,3316.6641 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="554" y="3333.731">settlementAccounts.abortedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="884" y1="3351.7969" y2="3351.7969"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="47" x="543" y="3362.0073">[default]</text><path d="M548,3370.6016 L548,3395.6016 L793,3395.6016 L793,3380.6016 L783,3370.6016 L548,3370.6016 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M783,3370.6016 L783,3380.6016 L793,3380.6016 L783,3370.6016 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="554" y="3387.6685">settlementAccounts.unknownCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="3439.8672" y2="3439.8672"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="3439.8672" y2="3452.8672"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="3452.8672" y2="3452.8672"/><polygon fill="#A80036" points="554.5,3448.8672,544.5,3452.8672,554.5,3456.8672,550.5,3452.8672" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="3434.8013">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="568.5" y="3434.8013">Make a copy of settlementAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="802.5" y="3434.8013">settlementAccountsInit</text><path d="M548,3465.8672 L548,3490.8672 L934,3490.8672 L934,3475.8672 L924,3465.8672 L548,3465.8672 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M924,3465.8672 L924,3475.8672 L934,3475.8672 L924,3465.8672 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="365" x="554" y="3482.9341">settlementAccountsInit = Object.assign({}, settlementAccounts)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="3546.1328" y2="3546.1328"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="3546.1328" y2="3559.1328"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="3559.1328" y2="3559.1328"/><polygon fill="#A80036" points="554.5,3555.1328,544.5,3559.1328,554.5,3563.1328,550.5,3559.1328" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="3541.0669">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="568.5" y="3541.0669">Declare and populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="697.5" y="3541.0669">allWindows</text><path d="M548,3572.1328 L548,3597.1328 L764,3597.1328 L764,3582.1328 L754,3572.1328 L548,3572.1328 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M754,3572.1328 L754,3582.1328 L764,3582.1328 L754,3572.1328 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="554" y="3589.1997">let allWindows = {} // declare map</text><path d="M538,3613.2656 L611,3613.2656 L611,3620.2656 L601,3630.2656 L538,3630.2656 L538,3613.2656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="131.9297" style="stroke: #000000; stroke-width: 2.0;" width="310" x="538" y="3613.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="553" y="3626.3325">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="133" x="626" y="3625.4761">[windowsList as window]</text><path d="M548,3635.3984 L548,3735.3984 L834,3735.3984 L834,3645.3984 L824,3635.3984 L548,3635.3984 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M824,3635.3984 L824,3645.3984 L834,3645.3984 L824,3635.3984 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="554" y="3652.4653">allWindows[window.settlementWindowId] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="566" y="3667.5981">id: window.settlementWindowId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="566" y="3682.731">state: window.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="566" y="3697.8638">reason: window.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="566" y="3712.9966">createDate: window.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="554" y="3728.1294">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="3798.3281" y2="3798.3281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="3798.3281" y2="3811.3281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="3811.3281" y2="3811.3281"/><polygon fill="#A80036" points="554.5,3807.3281,544.5,3811.3281,554.5,3815.3281,550.5,3811.3281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="3793.2622">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="568.5" y="3793.2622">Declare and populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="697.5" y="3793.2622">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="814.5" y="3793.2622">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="840.5" y="3793.2622">windowsAccounts</text><path d="M548,3824.3281 L548,3864.3281 L804,3864.3281 L804,3834.3281 L794,3824.3281 L548,3824.3281 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M794,3824.3281 L794,3834.3281 L804,3834.3281 L794,3824.3281 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="554" y="3841.395">let accountsWindows = {} // declare map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="554" y="3856.5278">let windowsAccounts = {} // declare map</text><path d="M528,3880.5938 L601,3880.5938 L601,3887.5938 L591,3897.5938 L528,3897.5938 L528,3880.5938 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="623.2109" style="stroke: #000000; stroke-width: 2.0;" width="502" x="528" y="3880.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="543" y="3893.6606">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="177" x="616" y="3892.8042">[windowsAccountsList as record]</text><path d="M548,3902.7266 L548,4154.7266 L1016,4154.7266 L1016,3912.7266 L1006,3902.7266 L548,3902.7266 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1006,3902.7266 L1006,3912.7266 L1016,3912.7266 L1006,3902.7266 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="554" y="3919.7935">wid = record.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="554" y="3934.9263">aid = record.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="554" y="3950.0591">state = allAccounts[aid]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="557" y="3965.1919"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="438" x="554" y="3980.3247">accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="566" y="3995.4575">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="566" y="4010.5903">windows: []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="554" y="4025.7231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="554" y="4040.856">accountsWindows[aid].windows.push(wid)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="557" y="4055.9888"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="554" y="4071.1216">windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="566" y="4086.2544">id: wid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="566" y="4101.3872">pendingSettlementCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="566" y="4116.52">settledCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="566" y="4131.6528">abortedCount: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="554" y="4146.7856">}</text><path d="M538,4170.8516 L601,4170.8516 L601,4177.8516 L591,4187.8516 L538,4187.8516 L538,4170.8516 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="325.9531" style="stroke: #000000; stroke-width: 2.0;" width="367" x="538" y="4170.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="553" y="4183.9185">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="616" y="4183.062">[state == 'PENDING_SETTLEMENT']</text><path d="M548,4192.9844 L548,4217.9844 L869,4217.9844 L869,4202.9844 L859,4192.9844 L548,4192.9844 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M859,4192.9844 L859,4202.9844 L869,4202.9844 L859,4192.9844 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="554" y="4210.0513">windowsAccounts[wid].pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="905" y1="4228.1172" y2="4228.1172"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="199" x="543" y="4238.3276">[state == 'PS_TRANSFERS_RECORDED']</text><path d="M548,4246.9219 L548,4271.9219 L884,4271.9219 L884,4256.9219 L874,4246.9219 L548,4246.9219 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M874,4246.9219 L874,4256.9219 L884,4256.9219 L874,4246.9219 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="554" y="4263.9888">windowsAccounts[wid].psTransfersRecordedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="905" y1="4282.0547" y2="4282.0547"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="194" x="543" y="4292.2651">[state == 'PS_TRANSFERS_RESERVED']</text><path d="M548,4300.8594 L548,4325.8594 L881,4325.8594 L881,4310.8594 L871,4300.8594 L548,4300.8594 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M871,4300.8594 L871,4310.8594 L881,4310.8594 L871,4300.8594 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="554" y="4317.9263">windowsAccounts[wid].psTransfersReservedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="905" y1="4335.9922" y2="4335.9922"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="543" y="4346.2026">[state == 'PS_TRANSFERS_COMMITTED']</text><path d="M548,4354.7969 L548,4379.7969 L891,4379.7969 L891,4364.7969 L881,4354.7969 L548,4354.7969 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M881,4354.7969 L881,4364.7969 L891,4364.7969 L881,4354.7969 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="554" y="4371.8638">windowsAccounts[wid].psTransfersCommittedCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="905" y1="4389.9297" y2="4389.9297"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="543" y="4400.1401">[state == 'SETTLED']</text><path d="M548,4408.7344 L548,4433.7344 L797,4433.7344 L797,4418.7344 L787,4408.7344 L548,4408.7344 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M787,4408.7344 L787,4418.7344 L797,4418.7344 L787,4408.7344 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="554" y="4425.8013">windowsAccounts[wid].settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="905" y1="4443.8672" y2="4443.8672"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="543" y="4454.0776">[state == 'ABORTED']</text><path d="M548,4462.6719 L548,4487.6719 L805,4487.6719 L805,4472.6719 L795,4462.6719 L548,4462.6719 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M795,4462.6719 L795,4472.6719 L805,4472.6719 L795,4462.6719 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="554" y="4479.7388">windowsAccounts[wid].abortedCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="4531.9375" y2="4531.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="4531.9375" y2="4544.9375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="4544.9375" y2="4544.9375"/><polygon fill="#A80036" points="554.5,4540.9375,544.5,4544.9375,554.5,4548.9375,550.5,4544.9375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="4526.8716">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="568.5" y="4526.8716">Make a copy of windowsAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="794.5" y="4526.8716">windowsAccountsInit</text><path d="M548,4557.9375 L548,4582.9375 L918,4582.9375 L918,4567.9375 L908,4557.9375 L548,4557.9375 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M908,4557.9375 L908,4567.9375 L918,4567.9375 L908,4557.9375 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="349" x="554" y="4575.0044">windowsAccountsInit = Object.assign({}, windowsAccounts)</text><path d="M548,4622.0703 L548,4813.0703 L1182,4813.0703 L1182,4632.0703 L1172,4622.0703 L548,4622.0703 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1172,4622.0703 L1172,4632.0703 L1182,4632.0703 L1172,4622.0703 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="554" y="4639.1372">Available objects after the setup:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="130" x="554" y="4654.27">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="687" y="4654.27">is used for tracing settlement state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="74" x="554" y="4669.4028">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="431" x="631" y="4669.4028">is helper object, same as previous, providing direct access to account by id</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="554" y="4684.5356">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="335" x="629" y="4684.5356">has window information for all windows in the settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="554" y="4699.6685">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="669" y="4699.6685">is used for tracing settlement window state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="114" x="554" y="4714.8013">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="456" x="671" y="4714.8013">is helper object to show the list of windows to which settlement account spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="557" y="4729.9341"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="554" y="4745.0669">Now we are ready to process the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="51" x="748" y="4745.0669">payload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="3" x="799" y="4745.0669">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="79" x="554" y="4760.1997">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="531" x="636" y="4760.1997">= [] // part of the response object that lists the affected participants and respective accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="554" y="4775.3325">affectedWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="668" y="4775.3325">= [] // array of the affected windows</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="285" x="554" y="4790.4653">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="842" y="4790.4653">= [] // array to collect inserts to the table</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="123" x="554" y="4805.5981">processedAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="429" x="680" y="4805.5981">= [] // array to log processed accounts and restrict subsequent processing</text><path d="M453,4854.6641 L526,4854.6641 L526,4861.6641 L516,4871.6641 L453,4871.6641 L453,4854.6641 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2488.1016" style="stroke: #000000; stroke-width: 2.0;" width="752" x="453" y="4854.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="468" y="4867.731">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="214" x="541" y="4866.8745">[let participant IN payload.participants]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="4892.9297" y2="4892.9297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="4892.9297" y2="4905.9297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="4905.9297" y2="4905.9297"/><polygon fill="#A80036" points="554.5,4901.9297,544.5,4905.9297,554.5,4909.9297,550.5,4905.9297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="4887.8638">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="568.5" y="4887.8638">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="702.5" y="4887.8638">participantPayload</text><path d="M548,4918.9297 L548,4988.9297 L902,4988.9297 L902,4928.9297 L892,4918.9297 L548,4918.9297 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M892,4918.9297 L892,4928.9297 L902,4928.9297 L892,4918.9297 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="554" y="4935.9966">let participantPayload = payload.participants[participant]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="554" y="4951.1294">participants.push({id: participantPayload.id, accounts: []})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="554" y="4966.2622">let pi = participants.length - 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="554" y="4981.395">participant = participants[pi]</text><path d="M463,5005.4609 L536,5005.4609 L536,5012.4609 L526,5022.4609 L463,5022.4609 L463,5005.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2330.3047" style="stroke: #000000; stroke-width: 2.0;" width="732" x="463" y="5005.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="478" y="5018.5278">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="242" x="551" y="5017.6714">[let account IN participantPayload.accounts]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="5043.7266" y2="5043.7266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="5043.7266" y2="5056.7266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="5056.7266" y2="5056.7266"/><polygon fill="#A80036" points="554.5,5052.7266,544.5,5056.7266,554.5,5060.7266,550.5,5056.7266" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="5038.6606">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="568.5" y="5038.6606">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="702.5" y="5038.6606">accountPayload</text><path d="M548,5069.7266 L548,5094.7266 L912,5094.7266 L912,5079.7266 L902,5069.7266 L548,5069.7266 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M902,5069.7266 L902,5079.7266 L912,5079.7266 L902,5069.7266 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="554" y="5086.7935">let accountPayload = participantPayload.accounts[account]</text><path d="M473,5110.8594 L536,5110.8594 L536,5117.8594 L526,5127.8594 L473,5127.8594 L473,5110.8594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2217.9063" style="stroke: #000000; stroke-width: 2.0;" width="712" x="473" y="5110.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="488" y="5123.9263">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="251" x="551" y="5123.0698">[allAccounts[accountPayload.id] == undefined]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="5149.125" y2="5149.125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="5149.125" y2="5162.125"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="5162.125" y2="5162.125"/><polygon fill="#A80036" points="554.5,5158.125,544.5,5162.125,554.5,5166.125,550.5,5162.125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="5144.0591">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="568.5" y="5144.0591">If the account doesn't match the settlement</text><path d="M548,5175.125 L548,5290.125 L812,5290.125 L812,5185.125 L802,5175.125 L548,5175.125 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M802,5175.125 L802,5185.125 L812,5185.125 L802,5175.125 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="554" y="5192.1919">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="566" y="5207.3247">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="566" y="5222.4575">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="578" y="5237.5903">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="578" y="5252.7231">errorDescription: 'Account not found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="566" y="5267.856">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="9" x="554" y="5282.9888">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="473" x2="1185" y1="5301.0547" y2="5301.0547"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="385" x="478" y="5311.2651">[participantPayload.id != allAccounts[accountPayload.id].participantId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="5335.9922" y2="5335.9922"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="5335.9922" y2="5348.9922"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="5348.9922" y2="5348.9922"/><polygon fill="#A80036" points="554.5,5344.9922,544.5,5348.9922,554.5,5352.9922,550.5,5348.9922" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="5330.9263">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="568.5" y="5330.9263">If the account doesn't match the participant</text><path d="M548,5361.9922 L548,5476.9922 L899,5476.9922 L899,5371.9922 L889,5361.9922 L548,5361.9922 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M889,5361.9922 L889,5371.9922 L899,5371.9922 L889,5361.9922 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="554" y="5379.0591">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="566" y="5394.1919">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="566" y="5409.3247">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="578" y="5424.4575">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="578" y="5439.5903">errorDescription: 'Participant and account mismatch'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="566" y="5454.7231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="9" x="554" y="5469.856">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="473" x2="1185" y1="5487.9219" y2="5487.9219"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="290" x="478" y="5498.1323">[processedAccounts.indexOf(accountPayload.id) &gt; -1]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="5522.8594" y2="5522.8594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="5522.8594" y2="5535.8594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="5535.8594" y2="5535.8594"/><polygon fill="#A80036" points="554.5,5531.8594,544.5,5535.8594,554.5,5539.8594,550.5,5535.8594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="5517.7935">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="416" x="568.5" y="5517.7935">If the account has been previosly processed (duplicated in the payload)</text><path d="M548,5548.8594 L548,5724.8594 L1028,5724.8594 L1028,5558.8594 L1018,5548.8594 L548,5548.8594 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1018,5548.8594 L1018,5558.8594 L1028,5558.8594 L1018,5548.8594 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="554" y="5565.9263">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="566" y="5581.0591">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="566" y="5596.1919">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="566" y="5611.3247">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="566" y="5626.4575">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="566" y="5641.5903">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="566" y="5656.7231">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="578" y="5671.856">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="578" y="5686.9888">errorDescription: 'Account already processed once'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="566" y="5702.1216">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="9" x="554" y="5717.2544">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="473" x2="1185" y1="5735.3203" y2="5735.3203"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="359" x="478" y="5745.5308">[allAccounts[account.id].state == accountPayload.state // allowed]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="5770.2578" y2="5770.2578"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="5770.2578" y2="5783.2578"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="5783.2578" y2="5783.2578"/><polygon fill="#A80036" points="554.5,5779.2578,544.5,5783.2578,554.5,5787.2578,550.5,5783.2578" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="5765.1919">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="568.5" y="5765.1919">Same-state reason amendment is always allowed</text><path d="M548,5796.2578 L548,6063.2578 L1028,6063.2578 L1028,5806.2578 L1018,5796.2578 L548,5796.2578 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1018,5796.2578 L1018,5806.2578 L1028,5806.2578 L1018,5796.2578 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="554" y="5813.3247">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="554" y="5828.4575">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="566" y="5843.5903">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="566" y="5858.7231">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="566" y="5873.856">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="566" y="5888.9888">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="566" y="5904.1216">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="566" y="5919.2544">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="9" x="554" y="5934.3872">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="554" y="5949.52">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="566" y="5964.6528">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="566" y="5979.7856">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="566" y="5994.9185">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="566" y="6010.0513">externalReference: accountPayload.externalReference</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="9" x="554" y="6025.1841">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="376" x="554" y="6040.3169">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="376" x="554" y="6055.4497">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="473" x2="1185" y1="6073.5156" y2="6073.5156"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="569" x="478" y="6083.7261">[settlementData.state == 'PENDING_SETTLEMENT' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_RECORDED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="473" x2="1185" y1="6088.3203" y2="6088.3203"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="584" x="478" y="6098.5308">[settlementData.state == 'PS_TRANSFERS_RECORDED' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_RESERVED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="473" x2="1185" y1="6103.125" y2="6103.125"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="592" x="478" y="6113.3354">[settlementData.state == 'PS_TRANSFERS_RESERVED' &amp;&amp; accountPayload.state == 'PS_TRANSFERS_COMMITTED']</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="473" x2="1185" y1="6117.9297" y2="6117.9297"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="707" x="478" y="6128.1401">[settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING' &amp;&amp; accountPayload.state == 'SETTLED']</text><path d="M548,6136.7344 L548,6176.7344 L1020,6176.7344 L1020,6146.7344 L1010,6136.7344 L548,6136.7344 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1010,6136.7344 L1010,6146.7344 L1020,6146.7344 L1010,6136.7344 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="31" x="554" y="6153.8013">Note</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="585" y="6153.8013">: Since we previously checked same-state, here we don't need to match</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="451" x="554" y="6168.9341">allAccounts[account.id].state == settlementData.state. We can safely assume it.</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="6207.1328" y2="6207.1328"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="6207.1328" y2="6220.1328"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="6220.1328" y2="6220.1328"/><polygon fill="#A80036" points="554.5,6216.1328,544.5,6220.1328,554.5,6224.1328,550.5,6220.1328" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="6202.0669">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="568.5" y="6202.0669">Settlement acknowledgement</text><path d="M548,6233.1328 L548,6757.1328 L1077,6757.1328 L1077,6243.1328 L1067,6233.1328 L548,6233.1328 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1067,6233.1328 L1067,6243.1328 L1077,6243.1328 L1067,6233.1328 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="554" y="6250.1997">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="554" y="6265.3325">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="566" y="6280.4653">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="566" y="6295.5981">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="566" y="6310.731">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="566" y="6325.8638">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="566" y="6340.9966">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="566" y="6356.1294">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="9" x="554" y="6371.2622">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="554" y="6386.395">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="566" y="6401.5278">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="566" y="6416.6606">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="566" y="6431.7935">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="566" y="6446.9263">externalReference: accountPayload.externalReference,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="566" y="6462.0591"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="566" y="6462.0591">settlementTransferId: Uuid() -- only for PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="9" x="554" y="6477.1919">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="554" y="6492.3247">if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="566" y="6507.4575">settlementAccounts.pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="566" y="6522.5903">settlementAccounts.psTransfersRecordedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="554" y="6537.7231">} else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="566" y="6552.856">settlementAccounts.psTransfersRecordedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="566" y="6567.9888">settlementAccounts.psTransfersReservedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="376" x="554" y="6583.1216">} else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="566" y="6598.2544">settlementAccounts.psTransfersReservedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="566" y="6613.3872">settlementAccounts.psTransfersCommittedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="554" y="6628.52">} else if (accountPayload.state == 'SETTLED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="566" y="6643.6528">settlementAccounts.psTransfersCommittedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="566" y="6658.7856">settlementAccounts.settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="554" y="6673.9185">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="554" y="6689.0513">allAccounts[accountPayload.id].state = accountPayload.state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="376" x="554" y="6704.1841">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="508" x="554" y="6719.3169">allAccounts[accountPayload.id].externalReference = accountPayload.externalReference</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="376" x="554" y="6734.4497">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="554" y="6749.5825">let settlementWindowId</text><path d="M538,6773.6484 L611,6773.6484 L611,6780.6484 L601,6790.6484 L538,6790.6484 L538,6773.6484 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="313.5234" style="stroke: #000000; stroke-width: 2.0;" width="483" x="538" y="6773.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="553" y="6786.7153">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="314" x="626" y="6785.8589">[let aw IN accountsWindows[accountPayload.id].windows]</text><path d="M548,6795.7813 L548,7077.7813 L1007,7077.7813 L1007,6805.7813 L997,6795.7813 L548,6795.7813 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M997,6795.7813 L997,6805.7813 L1007,6805.7813 L997,6795.7813 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="438" x="554" y="6812.8481">settlementWindowId = accountsWindows[accountPayload.id].windows[aw]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="557" y="6827.981"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="554" y="6843.1138">if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="566" y="6858.2466">windowsAccounts[settlementWindowId].pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="416" x="566" y="6873.3794">windowsAccounts[settlementWindowId].psTransfersRecordedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="554" y="6888.5122">} else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="410" x="566" y="6903.645">windowsAccounts[settlementWindowId].psTransfersRecordedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="413" x="566" y="6918.7778">windowsAccounts[settlementWindowId].psTransfersReservedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="376" x="554" y="6933.9106">} else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="566" y="6949.0435">windowsAccounts[settlementWindowId].psTransfersReservedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="566" y="6964.1763">windowsAccounts[settlementWindowId].psTransfersCommittedCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="554" y="6979.3091">} else if (accountPayload.state == 'SETTLED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="417" x="566" y="6994.4419">windowsAccounts[settlementWindowId].psTransfersCommittedCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="566" y="7009.5747">windowsAccounts[settlementWindowId].settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="554" y="7024.7075">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="554" y="7039.8403">if (affectedWindows.indexOf(settlementWindowId) &lt; 0) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="566" y="7054.9731">affectedWindows.push(settlementWindowId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="554" y="7070.106">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="473" x2="1185" y1="7095.1719" y2="7095.1719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="7117.3047" y2="7117.3047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="7117.3047" y2="7130.3047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="7130.3047" y2="7130.3047"/><polygon fill="#A80036" points="554.5,7126.3047,544.5,7130.3047,554.5,7134.3047,550.5,7130.3047" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="7112.2388">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="568.5" y="7112.2388">All other state transitions are not permitted</text><path d="M548,7143.3047 L548,7319.3047 L1028,7319.3047 L1028,7153.3047 L1018,7143.3047 L548,7143.3047 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1018,7143.3047 L1018,7153.3047 L1028,7153.3047 L1018,7143.3047 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="554" y="7160.3716">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="566" y="7175.5044">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="566" y="7190.6372">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="566" y="7205.77">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="566" y="7220.9028">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="566" y="7236.0356">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="566" y="7251.1685">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="578" y="7266.3013">errorCode: &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="578" y="7281.4341">errorDescription: 'State change not allowed'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="566" y="7296.5669">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="9" x="554" y="7311.6997">})</text><path d="M473,7356.7656 L875,7356.7656 L875,7363.7656 L865,7373.7656 L473,7373.7656 L473,7356.7656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="394.2578" style="stroke: #000000; stroke-width: 2.0;" width="746" x="473" y="7356.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="357" x="488" y="7369.8325">Bulk insert settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="986.5,7391.0313,996.5,7395.0313,986.5,7399.0313,990.5,7395.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="992.5" y1="7395.0313" y2="7395.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="7389.9653">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="568.5" y="7389.9653">Insert settlementParticipantCurrencyStateChange</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="876,7408.0313,1130,7408.0313,1140,7419.0313,1130,7431.0313,876,7431.0313,866,7419.0313,876,7408.0313" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="878" y="7424.0981">settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="554.5,7453.2969,544.5,7457.2969,554.5,7461.2969,550.5,7457.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="548.5" x2="1002.5" y1="7457.2969" y2="7457.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="560.5" y="7452.231">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="578.5" y="7452.231">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="322" x="621.5" y="7452.231">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="7516.6953" y2="7516.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="7516.6953" y2="7529.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="7529.6953" y2="7529.6953"/><polygon fill="#A80036" points="554.5,7525.6953,544.5,7529.6953,554.5,7533.6953,550.5,7529.6953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="7496.4966">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="568.5" y="7481.3638">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="568.5" y="7496.4966">to settlementParticipantCurrencyIdList in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="568.5" y="7511.6294">issue the following update in one knex command</text><polygon fill="#A80036" points="986.5,7554.8281,996.5,7558.8281,986.5,7562.8281,990.5,7558.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="992.5" y1="7558.8281" y2="7558.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="7553.7622">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="568.5" y="7553.7622">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="807,7601.8281,1199,7601.8281,1209,7673.8281,1199,7745.8281,807,7745.8281,797,7673.8281,807,7601.8281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="809" y="7617.895">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="859" y="7617.895">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="809" y="7633.0278">SET currentStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="821" y="7648.1606">{settlementParticipantCurrencyStateChangeIdList},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="821" y="7663.2935"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="821" y="7663.2935">settlementTransferId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="821" y="7678.4263"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="376" x="821" y="7678.4263">settlementParticipantCurrencyStateChange.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="821" y="7693.5591"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="821" y="7693.5591">-- only for PENDING_SETTLEMENT to PS_TRANSFERS_RECORDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="809" y="7708.6919">WHERE settlementParticipantCurrencyId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="833" y="7723.8247">{settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="833" y="7738.9575">.settlementParticipantCurrencyIdList}</text><path d="M473,7765.0234 L536,7765.0234 L536,7772.0234 L526,7782.0234 L473,7782.0234 L473,7765.0234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="468.7344" style="stroke: #000000; stroke-width: 2.0;" width="584.5" x="473" y="7765.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="488" y="7778.0903">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="266" x="551" y="7777.2339">[settlementData.state == 'PENDING_SETTLEMENT']</text><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="85.6641" style="stroke: #000000; stroke-width: 2.0;" width="566.5" x="480" y="7807.1563"/><polygon fill="#EEEEEE" points="480,7807.1563,544,7807.1563,544,7814.1563,534,7824.1563,480,7824.1563,480,7807.1563" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="493" y="7821.2231">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="602.25" y="7840.2231">Settlement Transfer Prepare {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.1-prepare.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.1-prepare.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="27" x="773.25" y="7840.2231">6.3.1</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="773.25" x2="800.25" y1="7842.2231" y2="7842.2231"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="800.25" y="7840.2231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="605.25" y="7855.356"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="42" x="602.25" y="7870.4888">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="644.25" y="7870.4888">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="605.25" y="7885.6216"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="473" x2="1057.5" y1="7923.8203" y2="7923.8203"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="286" x="478" y="7934.0308">[settlementData.state == 'PS_TRANSFERS_RECORDED']</text><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="85.6641" style="stroke: #000000; stroke-width: 2.0;" width="566.5" x="480" y="7962.625"/><polygon fill="#EEEEEE" points="480,7962.625,544,7962.625,544,7969.625,534,7979.625,480,7979.625,480,7962.625" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="493" y="7976.6919">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="602.25" y="7995.6919">Settlement Transfer Reserve {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.2-reserve.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.2-reserve.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="27" x="773.25" y="7995.6919">6.3.2</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="773.25" x2="800.25" y1="7997.6919" y2="7997.6919"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="800.25" y="7995.6919">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="605.25" y="8010.8247"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="42" x="602.25" y="8025.9575">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="644.25" y="8025.9575">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="605.25" y="8041.0903"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="473" x2="1057.5" y1="8079.2891" y2="8079.2891"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="478" y="8089.4995">[settlementData.state == 'PS_TRANSFERS_RESERVED']</text><rect fill="#FFFFFF" filter="url(#f1myjnxkoqygsf)" height="85.6641" style="stroke: #000000; stroke-width: 2.0;" width="566.5" x="480" y="8118.0938"/><polygon fill="#EEEEEE" points="480,8118.0938,544,8118.0938,544,8125.0938,534,8135.0938,480,8135.0938,480,8118.0938" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="493" y="8132.1606">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="602.25" y="8151.1606">Settlement Transfer Commit {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.3-commit.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.3-commit.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="27" x="772.25" y="8151.1606">6.3.3</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="772.25" x2="799.25" y1="8153.1606" y2="8153.1606"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="799.25" y="8151.1606">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="605.25" y="8166.2935"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="42" x="602.25" y="8181.4263">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="644.25" y="8181.4263">: settlementId, transactionTimestamp, enums, trx</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="605.25" y="8196.5591"/><path d="M473,8247.7578 L845,8247.7578 L845,8254.7578 L835,8264.7578 L473,8264.7578 L473,8247.7578 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="686.3594" style="stroke: #000000; stroke-width: 2.0;" width="714" x="473" y="8247.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="327" x="488" y="8260.8247">Prepare and insert settlementWindowStateChange</text><path d="M548,8269.8906 L548,8354.8906 L832,8354.8906 L832,8279.8906 L822,8269.8906 L548,8269.8906 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M822,8269.8906 L822,8279.8906 L832,8279.8906 L822,8269.8906 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="554" y="8286.9575">let settlementWindowStateChange = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="554" y="8302.0903">let settlementWindows = [] // response object</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="554" y="8317.2231">let windowAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="554" y="8332.356">let windowAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="93" x="554" y="8347.4888">let windowState</text><path d="M518,8371.5547 L591,8371.5547 L591,8378.5547 L581,8388.5547 L518,8388.5547 L518,8371.5547 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="329.7656" style="stroke: #000000; stroke-width: 2.0;" width="659" x="518" y="8371.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="533" y="8384.6216">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="606" y="8383.7651">[let aw IN affectedWindows]</text><path d="M548,8393.6875 L548,8433.6875 L958,8433.6875 L958,8403.6875 L948,8393.6875 L548,8393.6875 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M948,8393.6875 L948,8403.6875 L958,8403.6875 L948,8393.6875 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="554" y="8410.7544">windowAccountsInit = windowAccountsInit[affectedWindows[aw]]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="355" x="554" y="8425.8872">windowAccounts = windowsAccounts[affectedWindows[aw]]</text><path d="M528,8449.9531 L595,8449.9531 L595,8456.9531 L585,8466.9531 L528,8466.9531 L528,8449.9531 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="244.3672" style="stroke: #000000; stroke-width: 2.0;" width="639" x="528" y="8449.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="543" y="8463.02">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="501" x="610" y="8462.1636">[windowAccounts.pendingSettlementCount != windowAccountsInit.pendingSettlementCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="534" x="610" y="8474.9683">|| windowAccounts.psTransfersRecordedCount != windowAccountsInit.psTransfersRecordedCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="528" x="610" y="8487.7729">|| windowAccounts.psTransfersReservedCount != windowAccountsInit.psTransfersReservedCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="552" x="610" y="8500.5776">|| windowAccounts.psTransfersCommittedCount != windowAccountsInit.psTransfersCommittedCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="386" x="610" y="8513.3823">|| windowAccounts.settledCount != windowAccountsInit.settledCount]</text><path d="M548,8521.1094 L548,8546.1094 L926,8546.1094 L926,8531.1094 L916,8521.1094 L548,8521.1094 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M916,8521.1094 L916,8531.1094 L926,8531.1094 L916,8521.1094 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="554" y="8538.1763">settlementWindows.push(allWindows[affectedWindows[aw]])</text><path d="M538,8562.2422 L605,8562.2422 L605,8569.2422 L595,8579.2422 L538,8579.2422 L538,8562.2422 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="125.0781" style="stroke: #000000; stroke-width: 2.0;" width="557" x="538" y="8562.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="553" y="8575.3091">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="279" x="620" y="8574.4526">[windowAccounts.psTransfersCommittedCount == 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="215" x="620" y="8587.2573">&amp;&amp; windowAccounts.abortedCount == 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="209" x="620" y="8600.062">&amp;&amp; windowAccounts.settledCound &gt; 0]</text><path d="M548,8607.7891 L548,8677.7891 L1081,8677.7891 L1081,8617.7891 L1071,8607.7891 L548,8607.7891 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1071,8607.7891 L1071,8617.7891 L1081,8617.7891 L1071,8607.7891 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="554" y="8624.856">allWindows[affectedWindows[aw]].state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="554" y="8639.9888">allWindows[affectedWindows[aw]].reason = 'All window settlement accounts are settled'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="554" y="8655.1216">allWindows[affectedWindows[aw]].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="425" x="554" y="8670.2544">settlementWindowStateChange.push(allWindows[affectedWindows[aw]])</text><polygon fill="#A80036" points="986.5,8725.4531,996.5,8729.4531,986.5,8733.4531,990.5,8729.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="992.5" y1="8729.4531" y2="8729.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="8724.3872">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="568.5" y="8724.3872">Insert settlementWindowStateChange</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="910,8742.4531,1097,8742.4531,1107,8753.4531,1097,8765.4531,910,8765.4531,900,8753.4531,910,8742.4531" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="912" y="8758.52">settlementWindowStateChange</text><polygon fill="#A80036" points="554.5,8787.7188,544.5,8791.7188,554.5,8795.7188,550.5,8791.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="548.5" x2="1002.5" y1="8791.7188" y2="8791.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="560.5" y="8786.6528">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="578.5" y="8786.6528">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="241" x="621.5" y="8786.6528">settlementWindowStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="585.5" y1="8820.8516" y2="8820.8516"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="585.5" x2="585.5" y1="8820.8516" y2="8833.8516"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="544.5" x2="585.5" y1="8833.8516" y2="8833.8516"/><polygon fill="#A80036" points="554.5,8829.8516,544.5,8833.8516,554.5,8837.8516,550.5,8833.8516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="8815.7856">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="568.5" y="8815.7856">Merge ids to prepare for single update command</text><polygon fill="#A80036" points="986.5,8858.9844,996.5,8862.9844,986.5,8866.9844,990.5,8862.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="992.5" y1="8862.9844" y2="8862.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="8857.9185">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="568.5" y="8857.9185">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="846,8905.9844,1161,8905.9844,1171,8916.9844,1161,8928.9844,846,8928.9844,836,8916.9844,846,8905.9844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="848" y="8922.0513">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="898" y="8922.0513">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1020" y="8922.0513">.currentStateChangeIds</text><path d="M463,8948.1172 L785,8948.1172 L785,8955.1172 L775,8965.1172 L463,8965.1172 L463,8948.1172 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="802.7734" style="stroke: #000000; stroke-width: 2.0;" width="700" x="463" y="8948.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="277" x="478" y="8961.1841">Prepare and insert settlementStateChange</text><path d="M548,8970.25 L548,8995.25 L766,8995.25 L766,8980.25 L756,8970.25 L548,8970.25 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M756,8970.25 L756,8980.25 L766,8980.25 L756,8970.25 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="554" y="8987.3169">let settlementStateChanged = true</text><path d="M538,9011.3828 L601,9011.3828 L601,9018.3828 L591,9028.3828 L538,9028.3828 L538,9011.3828 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="463.4453" style="stroke: #000000; stroke-width: 2.0;" width="521" x="538" y="9011.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="553" y="9024.4497">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="262" x="616" y="9023.5933">[settlementData.state == 'PENDING_SETTLEMENT'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="294" x="616" y="9036.3979">&amp;&amp; settlementAccounts.pendingSettlementCount == 0]</text><path d="M548,9044.125 L548,9084.125 L1036,9084.125 L1036,9054.125 L1026,9044.125 L548,9044.125 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1026,9044.125 L1026,9054.125 L1036,9054.125 L1026,9044.125 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="554" y="9061.1919">settlementData.state = 'PS_TRANSFERS_RECORDED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="554" y="9076.3247">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RECORDED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="1059" y1="9094.3906" y2="9094.3906"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="543" y="9104.6011">[settlementData.state == 'PS_TRANSFERS_RECORDED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="305" x="543" y="9117.4058">&amp;&amp; settlementAccounts.psTransfersRecordedCount == 0]</text><path d="M548,9126 L548,9166 L1030,9166 L1030,9136 L1020,9126 L548,9126 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1020,9126 L1020,9136 L1030,9136 L1020,9126 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="554" y="9143.0669">settlementData.state = 'PS_TRANSFERS_RESERVED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="461" x="554" y="9158.1997">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RESERVED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="1059" y1="9176.2656" y2="9176.2656"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="277" x="543" y="9186.4761">[settlementData.state == 'PS_TRANSFERS_RESERVED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="302" x="543" y="9199.2808">&amp;&amp; settlementAccounts.psTransfersReservedCount == 0]</text><path d="M548,9207.875 L548,9247.875 L1045,9247.875 L1045,9217.875 L1035,9207.875 L548,9207.875 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1035,9207.875 L1035,9217.875 L1045,9217.875 L1035,9207.875 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="554" y="9224.9419">settlementData.state = 'PS_TRANSFERS_COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="554" y="9240.0747">settlementData.reason = 'All settlement accounts are PS_TRANSFERS_COMMITTED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="1059" y1="9258.1406" y2="9258.1406"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="290" x="543" y="9268.3511">[settlementData.state == 'PS_TRANSFERS_COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="304" x="543" y="9281.1558">&amp;&amp; settlementAccounts.psTransfersCommittedCount &gt; 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="223" x="543" y="9293.9604">&amp;&amp; settlementAccounts.settledCount &gt; 0]</text><path d="M548,9302.5547 L548,9342.5547 L948,9342.5547 L948,9312.5547 L938,9302.5547 L548,9302.5547 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M938,9302.5547 L938,9312.5547 L948,9312.5547 L938,9302.5547 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="554" y="9319.6216">settlementData.state = 'SETTLING'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="554" y="9334.7544">settlementData.reason = 'Some settlement accounts are SETTLED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="1059" y1="9352.8203" y2="9352.8203"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="504" x="543" y="9363.0308">[(settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING')</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="314" x="543" y="9375.8354">&amp;&amp; settlementAccounts.psTransfersCommittedCount == 0]</text><path d="M548,9384.4297 L548,9424.4297 L929,9424.4297 L929,9394.4297 L919,9384.4297 L548,9384.4297 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M919,9384.4297 L919,9394.4297 L929,9394.4297 L919,9384.4297 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="554" y="9401.4966">settlementData.state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="554" y="9416.6294">settlementData.reason = 'All settlement accounts are SETTLED'</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="538" x2="1059" y1="9434.6953" y2="9434.6953"/><path d="M548,9440.6953 L548,9465.6953 L752,9465.6953 L752,9450.6953 L742,9440.6953 L548,9440.6953 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M742,9440.6953 L742,9450.6953 L752,9450.6953 L742,9440.6953 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="554" y="9457.7622">settlementStateChanged = false</text><path d="M473,9488.8281 L540,9488.8281 L540,9495.8281 L530,9505.8281 L473,9505.8281 L473,9488.8281 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="255.0625" style="stroke: #000000; stroke-width: 2.0;" width="680" x="473" y="9488.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="488" y="9501.895">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="181" x="555" y="9501.0386">[settlementStateChanged == true]</text><path d="M548,9510.9609 L548,9550.9609 L851,9550.9609 L851,9520.9609 L841,9510.9609 L548,9510.9609 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M841,9510.9609 L841,9520.9609 L851,9520.9609 L841,9510.9609 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="554" y="9528.0278">settlementData.createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="554" y="9543.1606">settlementStateChange.push(settlementData)</text><polygon fill="#A80036" points="986.5,9577.3594,996.5,9581.3594,986.5,9585.3594,990.5,9581.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="992.5" y1="9581.3594" y2="9581.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="9576.2935">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="568.5" y="9576.2935">Insert settlementStateChange</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="934,9594.3594,1073,9594.3594,1083,9605.3594,1073,9617.3594,934,9617.3594,924,9605.3594,934,9594.3594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="936" y="9610.4263">settlementStateChange</text><polygon fill="#A80036" points="554.5,9639.625,544.5,9643.625,554.5,9647.625,550.5,9643.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="548.5" x2="1002.5" y1="9643.625" y2="9643.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="560.5" y="9638.5591">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="40" x="578.5" y="9638.5591">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="621.5" y="9638.5591">settlementStateChangeId</text><polygon fill="#A80036" points="986.5,9668.7578,996.5,9672.7578,986.5,9676.7578,990.5,9672.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="992.5" y1="9672.7578" y2="9672.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="550.5" y="9667.6919">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="568.5" y="9667.6919">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" points="874,9715.7578,1133,9715.7578,1143,9726.7578,1133,9738.7578,874,9738.7578,864,9726.7578,874,9715.7578" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="876" y="9731.8247">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="926" y="9731.8247">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="998" y="9731.8247">.currentStateChangeId</text><polygon fill="#A80036" points="337.5,9782.0234,327.5,9786.0234,337.5,9790.0234,333.5,9786.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="331.5" x2="537.5" y1="9786.0234" y2="9786.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="343.5" y="9780.9575">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="361.5" y="9780.9575">Return transaction result</text><path d="M46,9799.0234 L46,10429.0234 L307,10429.0234 L307,9809.0234 L297,9799.0234 L46,9799.0234 " fill="#D3D3D3" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M297,9799.0234 L297,9809.0234 L307,9809.0234 L297,9799.0234 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="52" y="9816.0903">Samples:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="52" y="9831.2231">"</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="128" x="57" y="9831.2231">settlementWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="185" y="9831.2231">": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="64" y="9846.356">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="76" y="9861.4888">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="76" y="9876.6216">"state": &lt;enum&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="76" y="9891.7544">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="76" y="9906.8872">"createdDate": &lt;date&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="64" y="9922.02">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="52" y="9937.1528">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="52" y="9952.2856">"</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="79" x="57" y="9952.2856">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="136" y="9952.2856">": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="64" y="9967.4185">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="76" y="9982.5513">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="76" y="9997.6841">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="88" y="10012.8169">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="100" y="10027.9497">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="100" y="10043.0825">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="100" y="10058.2153">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="100" y="10073.3481">"externalReference": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="100" y="10088.481">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="10103.6138">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="112" y="10118.7466">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="112" y="10133.8794">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="100" y="10149.0122">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="88" y="10164.145">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="88" y="10179.2778">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="100" y="10194.4106">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="100" y="10209.5435">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="100" y="10224.6763">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="100" y="10239.8091">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="10254.9419">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="112" y="10270.0747">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="112" y="10285.2075">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="100" y="10300.3403">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="100" y="10315.4731">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="112" y="10330.606">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="112" y="10345.7388">"errorDescription": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="100" y="10360.8716">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="88" y="10376.0044">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="76" y="10391.1372">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="64" y="10406.27">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="52" y="10421.4028">]</text><path d="M22,10443.4688 L22,10589.4688 L307,10589.4688 L307,10453.4688 L297,10443.4688 L22,10443.4688 " fill="#FFFFE0" filter="url(#f1myjnxkoqygsf)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M297,10443.4688 L297,10453.4688 L307,10453.4688 L297,10443.4688 " fill="#FFFFE0" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="28" y="10460.5356">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="34" y="10475.6685">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="40" y="10490.8013">"id": {id},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="40" y="10505.9341">"state": settlementData.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="40" y="10521.0669">"createdDate": settlementData.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="40" y="10536.1997">"settlementWindows": settlementWindows,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="40" y="10551.3325">"participants": participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="34" y="10566.4653">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="28" y="10581.5981">]</text><polygon fill="#A80036" points="172.5,10615.7969,162.5,10619.7969,172.5,10623.7969,168.5,10619.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="166.5" x2="320.5" y1="10619.7969" y2="10619.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14" x="178.5" y="10614.731">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="196.5" y="10614.731">Return response</text><!--
@startuml
title 6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Acknowledgement of Settlement Transfer
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "participants": [
                {
                    "id": 1
                    "accounts" : [
                        { "id": 1, "state": "PENDING_SETTLEMENT", "reason": <string> },
                        { "id": 2, "state": "PS_TRANSFERS_RECORDED", "reason": <string>, "externalReference": <string> },
                        { "id": 3, "state": "PS_TRANSFERS_RESERVED", "reason": <string> },
                        { "id": 4, "state": "PS_TRANSFERS_COMMITTED", "reason": <string>, "externalReference": <string> },
                        { "id": 5, "state": "SETTLED", "reason": <string> }
                    ]
                },
                {
                    "id": 2
                    "accounts" : [
                        { "id": 6, "state": "SETTLED", "reason": <string> }
                    ]
                }
            ]
        }
    end note

    OPERATOR -> SSAPI: PUT - /settlement/{id}
    activate SSAPI
    SSAPI -> SETTLE_DAO: updateSettlementById routine\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    group <color #blue>DB TRANSACTION</color>
        SETTLE_DAO -> DB: Retrieve settlement information
        activate DB
        hnote over DB #lightyellow
            SELECT s.settlementId, ssc.settlementStateId,
                ssc.reason, ssc.createdDate
            FROM **settlement** s
            JOIN **settlementStateChange** ssc
            ON ssc.settlementStateChangeId = s.currentStateChangeId
            WHERE s.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementData**
        deactivate DB

        SETTLE_DAO -> DB: Retrive settlement accounts information
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId,
                spcsc.settlementStateId, spcsc.reason,
                spcsc.createdDate, spc.netAmount, pc.currencyId,
                spc.settlementParticipantCurrencyId AS <color #0000FF>key</color>
            FROM **settlementParticipantCurrency** spc
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId =
            spc.currentStateChangeId
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementAccountsList**
        deactivate DB

        SETTLE_DAO -> DB: Retrive settlement windows information
        activate DB
        hnote over DB #lightyellow
            SELECT ssw.settlementWindowId, swsc.settlementWindowStateId,
                swsc.reason, swsc.createdDate
            FROM **settlementSettlementWindow** ssw
            JOIN **settlementWindow** sw
            ON sw.settlementWindow = ssw.settlementWindowId
            JOIN **settlementWindowStateChange** swsc
            ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
            WHERE ssw.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **windowsList**
        deactivate DB

        SETTLE_DAO -> DB: Retrieve settlement windows accounts information
        activate DB
        hnote over DB #lightyellow
            SELECT DISTINCT settlementWindowId, participantCurrencyId
            FROM **settlementTransferParticipant**
            WHERE settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **windowsAccountsList**
        deactivate DB

        note right of SETTLE_DAO #lightblue
            All objects below are done for the purposes of the syncronous request.
            If at same point Node process memory limit is reached we may decide to:
            A. Limit the amount of transfers per window and windows per settlement or
            B. Move to asyncronous processing where we don't need these objects
        end note
        note right of SETTLE_DAO #lightgray
            Available raw datasets from DB:
            **settlementData** contains information about settlement and its current state/reason
            **settlementAccountsList** holds information about all accounts and their current state/reason
            **windowsList** has information about all windows and their current state/reason
            **windowsAccountsList** has information about all accounts and windows

            Local variables and objects:
            **settlementAccounts**: { // (derived from <color 0000FF>settlementAccountsList</color>)
                pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                psTransfersRecordedCount: <integer>, // count of accounts in PS_TRANSFERS_RECORDED state
                psTransfersReservedCount: <integer>, // count of accounts in PS_TRANSFERS_RESERVED state
                psTransfersCommittedCount: <integer>, // count of accounts in PS_TRANSFERS_COMMITTED state
                settledCount: <integer>, // count of accounts in SETTLED state
                abortedCount: <integer> // count of accounts in ABORTED state
            }
            **settlementAccountsInit** copy of previous object to be preserved for comparission at the end
            **allAccounts**: { // same as previous but accessed by account id (derived from <color 0000FF>settlementAccountsList</color>)
                participantCurrencyId_key: { // number used to access the object in map-like style
                    id: participantCurrencyId,
                    state: settlementStateId,
                    reason: reason,
                    createdDate: createdDate,
                    netSettlementAmount: {
                        amount: netAmount,
                        currency: currencyId
                    },
                    participantId: participantId, // could be used to reconstruct allParticipants
                    key: <color 0000FF>key</color> // will be used to insert new state for settlementParticipantCurrency
                }
            }
            **allWindows**: { // same as settlementWindows response object with initial data (derived from <color 0000FF>windowsList</color>)
                settlementWindowId_key: { // number used to access the object in map-like style
                    id: settlementWindowId, // same as key value
                    state: settlementWindowStateId,
                    reason: reason,
                    createdDate: createdDate
                }
            }
            **windowsAccounts**: {
                settlementWindowId_key: { // number used to access the object in map-like style
                    id: settlementWindowId // same as key value
                    pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                    psTransfersRecordedCount: <integer>, // count of accounts in PS_TRANSFERS_RECORDED state
                    psTransfersReservedCount: <integer>, // count of accounts in PS_TRANSFERS_RESERVED state
                    psTransfersCommittedCount: <integer>, // count of accounts in PS_TRANSFERS_COMMITTED state
                    settledCount: <integer>, // count of accounts in SETTLED state
                    abortedCount: <integer> // count of accounts in ABORTED state
                }
            }
            **windowsAccountsInit** copy of previous object to be preserved for comparission at the end
            **accountsWindows**: {
                participantCurrencyId_key: { // number used to access the object in map-like style
                    id: participantCurrencyId, // same as key value
                    windows: [] // array of windows to which the account settlement spans
                }
            }
            let **transactionTimestamp** = now()
        end note
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and initialize variables
        note right of SETTLE_DAO #lightgray
            let settlementAccounts = {
                pendingSettlementCount: 0,
                psTransfersRecordedCount: 0,
                psTransfersReservedCount: 0,
                psTransfersCommittedCount: 0,
                settledCount: 0,
                abortedCount: 0,
                unknownCount: 0
            }
            let allAccounts = {} // declare map
            let pid // participantId
            let aid // accountId (participantCurrencyId)
            let state
        end note

        loop settlementAccountsList as account
            SETTLE_DAO -> SETTLE_DAO: Populate **allAccounts**
            note right of SETTLE_DAO #lightgray
                pid = account.participantId
                aid = account.participantCurrencyId
                state = account.settlementStateId

                allAccounts[aid] = {
                    id: aid,
                    state,
                    reason: account.reason,
                    createDate: account.createdDate,
                    netSettlementAmount: {
                        amount: account.netAmount,
                        currency: account.currencyId
                    },
                    participantId: pid,
                    key: account.key
                }
            end note

            SETTLE_DAO -> SETTLE_DAO: Populate **settlementAccounts**
            alt state == 'PENDING_SETTLEMENT'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.pendingSettlementCount++
                end note
            else state == 'PS_TRANSFERS_RECORDED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersRecordedCount++
                end note
            else state == 'PS_TRANSFERS_RESERVED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersReservedCount++
                end note
            else state == 'PS_TRANSFERS_COMMITTED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.psTransfersCommittedCount++
                end note
            else state == 'SETTLED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.settledCount++
                end note
            else state == 'ABORTED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.abortedCount++
                end note
            else default
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.unknownCount++
                end note
            end
        end
        SETTLE_DAO -> SETTLE_DAO: Make a copy of settlementAccounts into **settlementAccountsInit**
        note right of SETTLE_DAO #lightgray
            settlementAccountsInit = Object.assign({}, settlementAccounts)
        end note
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and populate **allWindows**
        note right of SETTLE_DAO #lightgray
            let allWindows = {} // declare map
        end note
        loop windowsList as window
            note right of SETTLE_DAO #lightgray
                allWindows[window.settlementWindowId] = {
                    id: window.settlementWindowId,
                    state: window.settlementWindowStateId,
                    reason: window.reason,
                    createDate: window.createdDate
                }
            end note
        end
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and populate **accountsWindows** and **windowsAccounts**
        note right of SETTLE_DAO #lightgray
            let accountsWindows = {} // declare map
            let windowsAccounts = {} // declare map
        end note
        loop windowsAccountsList as record
            note right of SETTLE_DAO #lightgray
                wid = record.settlementWindowId
                aid = record.participantCurrencyId
                state = allAccounts[aid]

                accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {
                    id: aid,
                    windows: []
                }
                accountsWindows[aid].windows.push(wid)

                windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {
                    id: wid,
                    pendingSettlementCount: 0,
                    settledCount: 0,
                    abortedCount: 0
                }
            end note
            alt state == 'PENDING_SETTLEMENT'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].pendingSettlementCount++
                end note
            else state == 'PS_TRANSFERS_RECORDED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].psTransfersRecordedCount++
                end note
            else state == 'PS_TRANSFERS_RESERVED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].psTransfersReservedCount++
                end note
            else state == 'PS_TRANSFERS_COMMITTED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].psTransfersCommittedCount++
                end note
            else state == 'SETTLED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].settledCount++
                end note
            else state == 'ABORTED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].abortedCount++
                end note
            end
        end
        SETTLE_DAO -> SETTLE_DAO: Make a copy of windowsAccounts into **windowsAccountsInit**
        note right of SETTLE_DAO #lightgray
            windowsAccountsInit = Object.assign({}, windowsAccounts)
        end note
        |||
        note right of SETTLE_DAO #lightgray
            Available objects after the setup:
            **settlementAccounts** is used for tracing settlement state and state transition allowance
            **allAccounts** is helper object, same as previous, providing direct access to account by id
            **allWindows** has window information for all windows in the settlement
            **windowsAccounts** is used for tracing settlement window state and state transition allowance
            **accountsWindows** is helper object to show the list of windows to which settlement account spans

            Now we are ready to process the **payload**:
            **participants** = [] // part of the response object that lists the affected participants and respective accounts
            **affectedWindows** = [] // array of the affected windows
            **settlementParticipantCurrencyStateChange** = [] // array to collect inserts to the table
            **processedAccounts** = [] // array to log processed accounts and restrict subsequent processing
        end note
        |||
        loop let participant IN payload.participants
            SETTLE_DAO -> SETTLE_DAO: Loop payload for each **participantPayload**
            note right of SETTLE_DAO #lightgray
                let participantPayload = payload.participants[participant]
                participants.push({id: participantPayload.id, accounts: []})
                let pi = participants.length - 1
                participant = participants[pi]
            end note

            loop let account IN participantPayload.accounts
                SETTLE_DAO -> SETTLE_DAO: Loop payload for each **accountPayload**
                note right of SETTLE_DAO #lightgray
                    let accountPayload = participantPayload.accounts[account]
                end note
                alt allAccounts[accountPayload.id] == undefined
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the settlement
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account not found'
                            }
                        })
                    end note
                else participantPayload.id != allAccounts[accountPayload.id].participantId
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the participant
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Participant and account mismatch'
                            }
                        })
                    end note
                else processedAccounts.indexOf(accountPayload.id) > -1
                    SETTLE_DAO -> SETTLE_DAO: If the account has been previosly processed (duplicated in the payload)
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account already processed once'
                            }
                        })
                    end note
                else allAccounts[account.id].state == accountPayload.state // allowed
                    SETTLE_DAO -> SETTLE_DAO: Same-state reason amendment is always allowed
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference
                        })
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                    end note
                else settlementData.state == 'PENDING_SETTLEMENT' && accountPayload.state == 'PS_TRANSFERS_RECORDED'
                else settlementData.state == 'PS_TRANSFERS_RECORDED' && accountPayload.state == 'PS_TRANSFERS_RESERVED'
                else settlementData.state == 'PS_TRANSFERS_RESERVED' && accountPayload.state == 'PS_TRANSFERS_COMMITTED'
                else settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING' && accountPayload.state == 'SETTLED'
                    note right of SETTLE_DAO #lightgray
                        **Note**: Since we previously checked same-state, here we don't need to match
                        allAccounts[account.id].state == settlementData.state. We can safely assume it.
                    end note

                    SETTLE_DAO -> SETTLE_DAO: Settlement acknowledgement
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason,
                            externalReference: accountPayload.externalReference,
                            <color #blue>settlementTransferId: Uuid() - - only for PS_TRANSFERS_RECORDED</color>
                        })
                        if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {
                            settlementAccounts.pendingSettlementCount- -
                            settlementAccounts.psTransfersRecordedCount++
                        } else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {
                            settlementAccounts.psTransfersRecordedCount- -
                            settlementAccounts.psTransfersReservedCount++
                        } else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {
                            settlementAccounts.psTransfersReservedCount- -
                            settlementAccounts.psTransfersCommittedCount++
                        } else if (accountPayload.state == 'SETTLED') {
                            settlementAccounts.psTransfersCommittedCount- -
                            settlementAccounts.settledCount++
                        }
                        allAccounts[accountPayload.id].state = accountPayload.state
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].externalReference = accountPayload.externalReference
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                        let settlementWindowId
                    end note
                    loop let aw IN accountsWindows[accountPayload.id].windows
                        note right of SETTLE_DAO #lightgray
                            settlementWindowId = accountsWindows[accountPayload.id].windows[aw]

                            if (accountPayload.state == 'PS_TRANSFERS_RECORDED') {
                                windowsAccounts[settlementWindowId].pendingSettlementCount- -
                                windowsAccounts[settlementWindowId].psTransfersRecordedCount++
                            } else if (accountPayload.state == 'PS_TRANSFERS_RESERVED') {
                                windowsAccounts[settlementWindowId].psTransfersRecordedCount- -
                                windowsAccounts[settlementWindowId].psTransfersReservedCount++
                            } else if (accountPayload.state == 'PS_TRANSFERS_COMMITTED') {
                                windowsAccounts[settlementWindowId].psTransfersReservedCount- -
                                windowsAccounts[settlementWindowId].psTransfersCommittedCount++
                            } else if (accountPayload.state == 'SETTLED') {
                                windowsAccounts[settlementWindowId].psTransfersCommittedCount- -
                                windowsAccounts[settlementWindowId].settledCount++
                            }
                            if (affectedWindows.indexOf(settlementWindowId) < 0) {
                                affectedWindows.push(settlementWindowId)
                            }
                        end note
                    end
                else
                    SETTLE_DAO -> SETTLE_DAO: All other state transitions are not permitted
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: <integer>,
                                errorDescription: 'State change not allowed'
                            }
                        })
                    end note
                end
            end
        end
        group Bulk insert settlementParticipantCurrencyStateChange
            SETTLE_DAO -> DB: Insert settlementParticipantCurrencyStateChange
            activate DB
            hnote over DB #lightyellow
                settlementParticipantCurrencyStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto settlementParticipantCurrencyIdList in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId =
                    {settlementParticipantCurrencyStateChangeIdList},
                    <color 00F>settlementTransferId =</color>
                    <color 00F>settlementParticipantCurrencyStateChange.settlementTransferId</color>
                    <color 00F>- - only for PENDING_SETTLEMENT to PS_TRANSFERS_RECORDED</color>
                WHERE settlementParticipantCurrencyId =
                        {settlementParticipantCurrencyStateChange
                        .settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB
        end

        alt settlementData.state == 'PENDING_SETTLEMENT'
            |||
            ref over SETTLE_DAO, DB: Settlement Transfer Prepare {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.1-prepare.svg 6.3.1]]}\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
            |||
        else settlementData.state == 'PS_TRANSFERS_RECORDED'
            |||
            ref over SETTLE_DAO, DB: Settlement Transfer Reserve {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.2-reserve.svg 6.3.2]]}\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
            |||
        else settlementData.state == 'PS_TRANSFERS_RESERVED'
            |||
            ref over SETTLE_DAO, DB: Settlement Transfer Commit {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-settransfer-6.3.3-commit.svg 6.3.3]]}\n\n**Inputs**: settlementId, transactionTimestamp, enums, trx\n
            |||
        end

        group Prepare and insert settlementWindowStateChange
            note right of SETTLE_DAO #lightgray
                let settlementWindowStateChange = []
                let settlementWindows = [] // response object
                let windowAccountsInit
                let windowAccounts
                let windowState
            end note

            loop let aw IN affectedWindows
                note right of SETTLE_DAO #lightgray
                    windowAccountsInit = windowAccountsInit[affectedWindows[aw]]
                    windowAccounts = windowsAccounts[affectedWindows[aw]]
                end note
                opt windowAccounts.pendingSettlementCount != windowAccountsInit.pendingSettlementCount\n|| windowAccounts.psTransfersRecordedCount != windowAccountsInit.psTransfersRecordedCount\n|| windowAccounts.psTransfersReservedCount != windowAccountsInit.psTransfersReservedCount\n|| windowAccounts.psTransfersCommittedCount != windowAccountsInit.psTransfersCommittedCount\n|| windowAccounts.settledCount != windowAccountsInit.settledCount
                    note right of SETTLE_DAO #lightgray
                        settlementWindows.push(allWindows[affectedWindows[aw]])
                    end note

                    opt windowAccounts.psTransfersCommittedCount == 0\n&& windowAccounts.abortedCount == 0\n&& windowAccounts.settledCound > 0
                        note right of SETTLE_DAO #lightgray
                            allWindows[affectedWindows[aw]].state = 'SETTLED'
                            allWindows[affectedWindows[aw]].reason = 'All window settlement accounts are settled'
                            allWindows[affectedWindows[aw]].createdDate = currentTimestamp
                            settlementWindowStateChange.push(allWindows[affectedWindows[aw]])
                        end note
                    end
                end
            end

            SETTLE_DAO -> DB: Insert settlementWindowStateChange
            activate DB
            hnote over DB #lightyellow
                settlementWindowStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementWindowStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge ids to prepare for single update command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**.currentStateChangeIds
            end hnote
            deactivate DB
        end

        group Prepare and insert settlementStateChange
            note right of SETTLE_DAO #lightgray
                let settlementStateChanged = true
            end note
            alt settlementData.state == 'PENDING_SETTLEMENT'\n&& settlementAccounts.pendingSettlementCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_RECORDED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RECORDED'
                end note
            else settlementData.state == 'PS_TRANSFERS_RECORDED'\n&& settlementAccounts.psTransfersRecordedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_RESERVED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_RESERVED'
                end note
            else settlementData.state == 'PS_TRANSFERS_RESERVED'\n&& settlementAccounts.psTransfersReservedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'PS_TRANSFERS_COMMITTED'
                    settlementData.reason = 'All settlement accounts are PS_TRANSFERS_COMMITTED'
                end note
            else settlementData.state == 'PS_TRANSFERS_COMMITTED'\n&& settlementAccounts.psTransfersCommittedCount > 0\n&& settlementAccounts.settledCount > 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'SETTLING'
                    settlementData.reason = 'Some settlement accounts are SETTLED'
                end note
            else (settlementData.state == 'PS_TRANSFERS_COMMITTED' || settlementData.state == 'SETTLING')\n&& settlementAccounts.psTransfersCommittedCount == 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'SETTLED'
                    settlementData.reason = 'All settlement accounts are SETTLED'
                end note
            else
                note right of SETTLE_DAO #lightgray
                    settlementStateChanged = false
                end note
            end
            opt settlementStateChanged == true
                note right of SETTLE_DAO #lightgray
                    settlementData.createdDate = currentTimestamp
                    settlementStateChange.push(settlementData)
                end note

                SETTLE_DAO -> DB: Insert settlementStateChange
                activate DB
                hnote over DB #lightyellow
                    settlementStateChange
                end hnote
                SETTLE_DAO <- - DB: Return **settlementStateChangeId**
                deactivate DB

                SETTLE_DAO -> DB: Update pointer to current state change id
                activate DB
                hnote over DB #lightyellow
                    UPDATE **settlement**.currentStateChangeId
                end hnote
                deactivate DB
            end
        end
    end
    SSAPI <- - SETTLE_DAO: Return transaction result
    deactivate SETTLE_DAO

    note left of SSAPI #lightgray
        Samples:
        "**settlementWindows**": [
            {
                "id": <integer>,
                "state": <enum>,
                "reason": <string>,
                "createdDate": <date>
            }
        ]
        "**participants**": [
            {
                "id": <integer>,
                "accounts": [
                    {
                        "id": <integer>,
                        "state": "SETTLED",
                        "reason": <string>,
                        "externalReference": <string>,
                        "createdDate": <date>,
                        "netSettlementAmount": {
                            "amount": <decimal>,
                            "currency": <enum>
                        }
                    },
                    {
                        "id": <integer>,
                        "state": "PENDING_SETTLEMENT",
                        "reason": <string>,
                        "createdDate": <date>,
                        "netSettlementAmount": {
                            "amount": <decimal>,
                            "currency": <enum>
                        },
                        "errorInformation": {
                            "errorCode": <integer>,
                            "errorDescription": <string>
                        }
                    }
                ]
            }
        ]
    end note

    note left of SSAPI #lightyellow
        [
          {
            "id": {id},
            "state": settlementData.state,
            "createdDate": settlementData.createdDate,
            "settlementWindows": settlementWindows,
            "participants": participants
          }
        ]
    end note

    SSAPI -> OPERATOR: Return response
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.02(Fri Mar 09 17:20:44 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_212-b04
Operating System: Linux
OS Version: 4.15.0-1035-aws
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
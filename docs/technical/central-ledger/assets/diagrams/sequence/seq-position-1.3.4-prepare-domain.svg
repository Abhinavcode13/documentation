<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3601px" preserveAspectRatio="none" style="width:1721px;height:3601px;" version="1.1" viewBox="0 0 1721 3601" width="1721px" zoomAndPan="magnify">
  <defs>
    <filter height="300%" id="f9ypl268pdabb" width="300%" x="-1" y="-1">
      <feGaussianBlur result="blurOut" stdDeviation="2.0"/>
      <feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/>
      <feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/>
      <feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/>
    </filter>
  </defs>
  <g>
    <text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="269" x="724" y="28.708">1.3.1. Position Prepare Facade</text>
    <rect fill="#FFFFE0" height="3554.3828" style="stroke:#A80036;stroke-width:1.0;" width="1579.5" x="36" y="40.9531"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="770.25" y="53.02">Central Service</text>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="2048.8203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="121.5" y="132.3828"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="77.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="265.1797"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="62.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="734.2344"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="30" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="882.8984"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="107.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="990.2969"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="30" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="1749.2109"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="30" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="1871.7422"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="30" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="2151.2031"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="116.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="2822.2578"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="30" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536" y="2669.9219"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="30" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536" y="3468.0391"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="3373.6563" style="stroke:#000000;stroke-width:2.0;" width="1697" x="10" y="139.3828"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="1276.7031" style="stroke:#000000;stroke-width:2.0;" width="1601.5" x="20" y="2229.3359"/>
    <rect fill="#FFFFFF" height="798.1172" style="stroke:none;stroke-width:1.0;" width="1601.5" x="20" y="2707.9219"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="177.9297" style="stroke:#000000;stroke-width:2.0;" width="1471" x="30" y="2768.8594"/>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="126" x2="126" y1="122.3828" y2="3530.0391"/>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1412.5" x2="1412.5" y1="122.3828" y2="3530.0391"/>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1540.5" x2="1540.5" y1="122.3828" y2="3530.0391"/>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="167" x="40" y="119.0811">Position Prepare Facade</text>
    <ellipse cx="126.5" cy="90.0859" fill="#FEFECE" filter="url(#f9ypl268pdabb)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/>
    <polygon fill="#A80036" points="122.5,78.0859,128.5,73.0859,126.5,78.0859,128.5,83.0859,122.5,78.0859" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="167" x="40" y="3542.0342">Position Prepare Facade</text>
    <ellipse cx="126.5" cy="3561.3359" fill="#FEFECE" filter="url(#f9ypl268pdabb)" rx="12" ry="12" style="stroke:#A80036;stroke-width:2.0;"/>
    <polygon fill="#A80036" points="122.5,3549.3359,128.5,3544.3359,126.5,3549.3359,128.5,3554.3359,122.5,3549.3359" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1364.5" y="119.0811">Central Store</text>
    <path d="M1394.5,70.0859 C1394.5,60.0859 1412.5,60.0859 1412.5,60.0859 C1412.5,60.0859 1430.5,60.0859 1430.5,70.0859 L1430.5,96.0859 C1430.5,106.0859 1412.5,106.0859 1412.5,106.0859 C1412.5,106.0859 1394.5,106.0859 1394.5,96.0859 L1394.5,70.0859 " fill="#FEFECE" filter="url(#f9ypl268pdabb)" style="stroke:#000000;stroke-width:1.5;"/>
    <path d="M1394.5,70.0859 C1394.5,80.0859 1412.5,80.0859 1412.5,80.0859 C1412.5,80.0859 1430.5,80.0859 1430.5,70.0859 " fill="none" style="stroke:#000000;stroke-width:1.5;"/>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1364.5" y="3542.0342">Central Store</text>
    <path d="M1394.5,3555.3359 C1394.5,3545.3359 1412.5,3545.3359 1412.5,3545.3359 C1412.5,3545.3359 1430.5,3545.3359 1430.5,3555.3359 L1430.5,3581.3359 C1430.5,3591.3359 1412.5,3591.3359 1412.5,3591.3359 C1412.5,3591.3359 1394.5,3591.3359 1394.5,3581.3359 L1394.5,3555.3359 " fill="#FEFECE" filter="url(#f9ypl268pdabb)" style="stroke:#000000;stroke-width:1.5;"/>
    <path d="M1394.5,3555.3359 C1394.5,3565.3359 1412.5,3565.3359 1412.5,3565.3359 C1412.5,3565.3359 1430.5,3565.3359 1430.5,3555.3359 " fill="none" style="stroke:#000000;stroke-width:1.5;"/>
    <rect fill="#FEFECE" filter="url(#f9ypl268pdabb)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="133" x="1474.5" y="83.0859"/>
    <rect fill="#FEFECE" filter="url(#f9ypl268pdabb)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="133" x="1470.5" y="87.0859"/>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="1477.5" y="107.0811">Notification-Topic</text>
    <rect fill="#FEFECE" filter="url(#f9ypl268pdabb)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="133" x="1474.5" y="3529.0391"/>
    <rect fill="#FEFECE" filter="url(#f9ypl268pdabb)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="133" x="1470.5" y="3533.0391"/>
    <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="1477.5" y="3553.0342">Notification-Topic</text>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="2048.8203" style="stroke:#A80036;stroke-width:1.0;" width="10" x="121.5" y="132.3828"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="77.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="265.1797"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="62.2656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="734.2344"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="30" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="882.8984"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="107.6641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="990.2969"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="30" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="1749.2109"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="30" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="1871.7422"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="30" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="2151.2031"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="116.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1407.5" y="2822.2578"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="30" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536" y="2669.9219"/>
    <rect fill="#FFFFFF" filter="url(#f9ypl268pdabb)" height="30" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1536" y="3468.0391"/>
    <path d="M10,139.3828 L311,139.3828 L311,146.3828 L301,156.3828 L10,156.3828 L10,139.3828 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/>
    <rect fill="none" height="3373.6563" style="stroke:#000000;stroke-width:2.0;" width="1697" x="10" y="139.3828"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="256" x="25" y="152.4497">Prepare Position Batch Processing</text>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="173.5" y1="207.9141" y2="207.9141"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="173.5" x2="173.5" y1="207.9141" y2="220.9141"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="132.5" x2="173.5" y1="220.9141" y2="220.9141"/>
    <polygon fill="#A80036" points="142.5,216.9141,132.5,220.9141,142.5,224.9141,138.5,220.9141" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="138.5" y="187.7153">1</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="529" x="151.5" y="172.5825">Loop through batch and build list of transferIds and calculate sumTransfersInBatch,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="151.5" y="187.7153">checking all in Batch are for the correct Paricipant and Currency</text>
    <text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="151.5" y="202.8481">Error code:</text>
    <text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="237.5" y="202.8481">2001, 3100</text>
    <polygon fill="#A80036" points="1395.5,261.1797,1405.5,265.1797,1395.5,269.1797,1399.5,265.1797" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="1401.5" y1="265.1797" y2="265.1797"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="138.5" y="252.5474">2</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="151.5" y="244.981">Retrieve current state of all transfers in array from DB with select whereIn</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1244" x="151.5" y="260.1138">(FYI: The two DB transaction model needs to add a mini-state step here (RECEIVED_PREPARE =&gt; RECEIVDED_PREPARE_PROCESSING) so that the transfers are left alone if processing has started)</text>
    <polygon fill="#FFFFE0" filter="url(#f9ypl268pdabb)" points="1343,278.1797,1481,278.1797,1491,297.1797,1481,316.1797,1343,316.1797,1333,297.1797,1343,278.1797" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1345" y="294.2466">transferStateChange</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="1345" y="309.3794">transferParticipant</text>
    <polygon fill="#A80036" points="142.5,338.5781,132.5,342.5781,142.5,346.5781,138.5,342.5781" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="136.5" x2="1411.5" y1="342.5781" y2="342.5781"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="148.5" y="337.5122">3</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="161.5" y="337.5122">Return current state of all selected transfers from DB</text>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="173.5" y1="401.9766" y2="401.9766"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="173.5" x2="173.5" y1="401.9766" y2="414.9766"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="132.5" x2="173.5" y1="414.9766" y2="414.9766"/>
    <polygon fill="#A80036" points="142.5,410.9766,132.5,414.9766,142.5,418.9766,138.5,414.9766" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="138.5" y="381.7778">4</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="550" x="151.5" y="366.645">Validate current state (transferStateChange.transferStateId == &apos;RECEIVED_PREPARE&apos;)</text>
    <text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="151.5" y="381.7778">Error code:</text>
    <text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="237.5" y="381.7778">2001</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="273.5" y="381.7778">against failing transfers</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="151.5" y="396.9106">Batch is not rejected as a whole.</text>
    <path d="M136,427.9766 L136,648.9766 L1652,648.9766 L1652,437.9766 L1642,427.9766 L136,427.9766 " fill="#D3D3D3" filter="url(#f9ypl268pdabb)" style="stroke:#A80036;stroke-width:1.0;"/>
    <path d="M1642,427.9766 L1642,437.9766 L1652,437.9766 L1642,427.9766 " fill="#D3D3D3" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="142" y="445.0435">List of transfers used during processing</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="142" y="460.1763">reservedTransfers</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="280" y="460.1763">is list of transfers to be processed in the batch</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="128" x="142" y="475.3091">abortedTransfers</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1212" x="274" y="475.3091">is the list of transfers in the incorrect state going into the process. Currently the transferStateChange is set to ABORTED - this should only be done if not already in a final state (idempotency)</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="142" y="490.4419">processedTransfers</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1345" x="292" y="490.4419">is the list of transfers that have gone through the position management algorithm. Both successful and failed trasnfers appear here as the order and &quot;running position&quot; against each is necessary for reconciliation</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="146" y="505.5747"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="142" y="520.7075">Scalar intermidate values used in the algorithm</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="116" x="142" y="535.8403">transferAmount</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="262" y="535.8403">= payload.amount.amount</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="155" x="142" y="550.9731">sumTransfersInBatch</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="301" y="550.9731">= SUM amount against each Transfer in batch</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="142" y="566.106">currentPosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="258" y="566.106">= participantPosition.value</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="142" y="581.2388">reservedPosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="270" y="581.2388">= participantPosition.{original}reservedValue</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="142" y="596.3716">effectivePosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="270" y="596.3716">= currentPosition + reservedPosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="91" x="142" y="611.5044">heldPosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="237" y="611.5044">= effectivePosition + sumTransfersInBatch</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="142" y="626.6372">availablePosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="271" y="626.6372">=</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="288" x="286" y="626.6372">if settlement model delay is IMMEDIATE then:</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="452" x="578" y="626.6372">settlementBalance + participantLimit(NetDebitCap) - effectivePosition,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="65" x="1034" y="626.6372">otherwise:</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="1103" y="626.6372">participantLimit(NetDebitCap) - effectivePosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="142" y="641.77">sumReserved</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="246" y="641.77">= SUM of transfers that have met rule criteria and processed</text>
    <path d="M61,663.8359 L61,703.8359 L1476,703.8359 L1476,673.8359 L1466,663.8359 L61,663.8359 " fill="#FBFB77" filter="url(#f9ypl268pdabb)" style="stroke:#A80036;stroke-width:1.0;"/>
    <path d="M1466,663.8359 L1466,673.8359 L1476,673.8359 L1466,663.8359 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="768" x="378.25" y="680.9028">Going to reserve the sum of the valid transfers in the batch against the Participants Positon in the Currency of this batch</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="378.25" y="696.0356">and calculate the available position for the Participant to use</text>
    <polygon fill="#A80036" points="1395.5,730.2344,1405.5,734.2344,1395.5,738.2344,1399.5,734.2344" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="1401.5" y1="734.2344" y2="734.2344"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="138.5" y="729.1685">5</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="351" x="151.5" y="729.1685">Select effectivePosition FOR UPDATE from DB for Payer</text>
    <polygon fill="#FFFFE0" filter="url(#f9ypl268pdabb)" points="1351,747.2344,1473,747.2344,1483,758.2344,1473,770.2344,1351,770.2344,1341,758.2344,1351,747.2344" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="1353" y="763.3013">participantPosition</text>
    <polygon fill="#A80036" points="142.5,792.5,132.5,796.5,142.5,800.5,138.5,796.5" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="136.5" x2="1411.5" y1="796.5" y2="796.5"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="148.5" y="791.4341">6</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="516" x="161.5" y="791.4341">Return effectivePosition (currentPosition and reservedPosition) from DB for Payer</text>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="173.5" y1="840.7656" y2="840.7656"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="173.5" x2="173.5" y1="840.7656" y2="853.7656"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="132.5" x2="173.5" y1="853.7656" y2="853.7656"/>
    <polygon fill="#A80036" points="142.5,849.7656,132.5,853.7656,142.5,857.7656,138.5,853.7656" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="138.5" y="828.1333">7</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="151.5" y="820.5669">Increment reservedValue to heldPosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="381" x="151.5" y="835.6997">(reservedValue = reservedPosition + sumTransfersInBatch)</text>
    <polygon fill="#A80036" points="1395.5,878.8984,1405.5,882.8984,1395.5,886.8984,1399.5,882.8984" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="1401.5" y1="882.8984" y2="882.8984"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="138.5" y="877.8325">8</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="151.5" y="877.8325">Persist reservedValue</text>
    <polygon fill="#FFFFE0" filter="url(#f9ypl268pdabb)" points="1268,925.8984,1557,925.8984,1567,944.8984,1557,963.8984,1268,963.8984,1258,944.8984,1268,925.8984" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="1270" y="941.9653">UPDATE</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="1326" y="941.9653">participantPosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="1270" y="957.0981">SET reservedValue += sumTransfersInBatch</text>
    <polygon fill="#A80036" points="1395.5,986.2969,1405.5,990.2969,1395.5,994.2969,1399.5,990.2969" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="1401.5" y1="990.2969" y2="990.2969"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="138.5" y="985.231">9</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="151.5" y="985.231">Request position limits for Payer Participant</text>
    <polygon fill="#FFFFE0" filter="url(#f9ypl268pdabb)" points="1218,1003.2969,1606,1003.2969,1616,1037.2969,1606,1071.2969,1218,1071.2969,1208,1037.2969,1218,1003.2969" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1220" y="1019.3638">FROM</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="1260" y="1019.3638">participantLimit</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="1220" y="1034.4966">WHERE participantLimit.limitTypeId = &apos;NET-DEBIT-CAP&apos;</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="1220" y="1049.6294">AND participantLimit.participantId = payload.payerFsp</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="1220" y="1064.7622">AND participantLimit.currencyId = payload.amount.currency</text>
    <polygon fill="#A80036" points="142.5,1093.9609,132.5,1097.9609,142.5,1101.9609,138.5,1097.9609" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="136.5" x2="1411.5" y1="1097.9609" y2="1097.9609"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="148.5" y="1092.895">10</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="170.5" y="1092.895">Return position limits</text>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="173.5" y1="1187.625" y2="1187.625"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="173.5" x2="173.5" y1="1187.625" y2="1200.625"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="132.5" x2="173.5" y1="1200.625" y2="1200.625"/>
    <polygon fill="#A80036" points="142.5,1196.625,132.5,1200.625,142.5,1204.625,138.5,1200.625" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="138.5" y="1152.2935">11</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="160.5" y="1122.0278">availablePosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="289.5" y="1122.0278">=</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="288" x="304.5" y="1122.0278">if settlement model delay is IMMEDIATE then:</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="164.5" y="1137.1606">settlementBalance + participantLimit(NetDebitCap) - effectivePosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="164.5" y="1152.2935"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="65" x="164.5" y="1152.2935">otherwise:</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="164.5" y="1167.4263">participantLimit(NetDebitCap) - effectivePosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="549" x="160.5" y="1182.5591">(same as = (settlementBalance?) + netDebitCap - currentPosition - reservedPosition)</text>
    <path d="M61,1213.625 L61,1253.625 L1476,1253.625 L1476,1223.625 L1466,1213.625 L61,1213.625 " fill="#FBFB77" filter="url(#f9ypl268pdabb)" style="stroke:#A80036;stroke-width:1.0;"/>
    <path d="M1466,1213.625 L1466,1223.625 L1476,1223.625 L1466,1213.625 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="603" x="460.75" y="1230.6919">For each transfer in the batch, validate the availablility of position to meet the transfer amount</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="378" x="460.75" y="1245.8247">this will be as per the position algorithm documented below</text>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="173.5" y1="1299.1563" y2="1299.1563"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="173.5" x2="173.5" y1="1299.1563" y2="1312.1563"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="132.5" x2="173.5" y1="1312.1563" y2="1312.1563"/>
    <polygon fill="#A80036" points="142.5,1308.1563,132.5,1312.1563,142.5,1316.1563,138.5,1312.1563" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="138.5" y="1286.5239">12</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="160.5" y="1278.9575">Validate availablePosition for each tranfser (see algorithm below)</text>
    <text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="160.5" y="1294.0903">Error code:</text>
    <text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="246.5" y="1294.0903">4001</text>
    <path d="M136,1325.1563 L136,1592.1563 L1537,1592.1563 L1537,1335.1563 L1527,1325.1563 L136,1325.1563 " fill="#D3D3D3" filter="url(#f9ypl268pdabb)" style="stroke:#A80036;stroke-width:1.0;"/>
    <path d="M1527,1325.1563 L1527,1335.1563 L1537,1335.1563 L1527,1325.1563 " fill="#D3D3D3" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="579" x="142" y="1342.2231">01: sumReserved = 0 // Record the sum of the transfers we allow to progress to RESERVED</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="563" x="142" y="1357.356">02: sumProcessed =0 // Record the sum of the transfers already processed in this batch</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1090" x="142" y="1372.4888">03: processedTransfers = {} // The list of processed transfers - so that we can store the additional information around the decision. Most importantly the &quot;running&quot; position</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="142" y="1387.6216">04: foreach transfer in reservedTransfers</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="158" y="1402.7544">05: sumProcessed += transfer.amount // the total processed so far</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="205" x="594" y="1402.7544">(NEED TO UPDATE IN CODE)</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="158" y="1417.8872">06: if availablePosition &gt;= transfer.amount</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="174" y="1433.02">07: transfer.state = &quot;RESERVED&quot;</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="318" x="174" y="1448.1528">08: availablePosition -= preparedTransfer.amount</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="174" y="1463.2856">09: sumRESERVED += preparedTransfer.amount</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="158" y="1478.4185">10: else</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="174" y="1493.5513">11: preparedTransfer.state = &quot;ABORTED&quot;</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="686" x="174" y="1508.6841">12: preparedTransfer.reason = &quot;Net Debit Cap exceeded by this request at this time, please try again later&quot;</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="59" x="158" y="1523.8169">13: end if</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1031" x="158" y="1538.9497">14: runningPosition = currentPosition + sumReserved // the initial value of the Participants position plus the total value that has been accepted in the batch so far</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="553" x="158" y="1554.0825">15: runningReservedValue = sumTransfersInBatch - sumProcessed + reservedPosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="205" x="715" y="1554.0825">(NEED TO UPDATE IN CODE)</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="479" x="924" y="1554.0825">// the running down of the total reserved value at the begining of the batch.</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1364" x="158" y="1569.2153">16: Add transfer to the processedTransfer list recording the transfer state and running position and reserved values { transferState, transfer, rawMessage, transferAmount,  runningPosition, runningReservedValue }</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="142" y="1584.3481">16: end foreach</text>
    <path d="M61,1606.4141 L61,1661.4141 L1476,1661.4141 L1476,1616.4141 L1466,1606.4141 L61,1606.4141 " fill="#FBFB77" filter="url(#f9ypl268pdabb)" style="stroke:#A80036;stroke-width:1.0;"/>
    <path d="M1466,1606.4141 L1466,1616.4141 L1476,1616.4141 L1466,1606.4141 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="874" x="165.25" y="1623.481">Once the outcome for all transfers is known,update the Participant&apos;s position and remove the reserved amount associated with the batch</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="654" x="165.25" y="1638.6138">(If there are any alarm limits, process those returning limits in which the threshold has been breached)</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="1194" x="165.25" y="1653.7466">Do a bulk insert of the trasnferStateChanges associated with processing, using the result to complete the participantPositionChange and bulk insert of these to persist the running position</text>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="173.5" y1="1707.0781" y2="1707.0781"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="173.5" x2="173.5" y1="1707.0781" y2="1720.0781"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="132.5" x2="173.5" y1="1720.0781" y2="1720.0781"/>
    <polygon fill="#A80036" points="142.5,1716.0781,132.5,1720.0781,142.5,1724.0781,138.5,1720.0781" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="138.5" y="1694.4458">13</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="160.5" y="1686.8794">Assess any limit thresholds on the final position</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="196" x="160.5" y="1702.0122">adding to alarm list if triggered</text>
    <polygon fill="#A80036" points="1395.5,1745.2109,1405.5,1749.2109,1395.5,1753.2109,1399.5,1749.2109" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="1401.5" y1="1749.2109" y2="1749.2109"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="138.5" y="1744.145">14</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="160.5" y="1744.145">Persist latest position</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="301.5" y="1744.145">value</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="344.5" y="1744.145">and</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="372.5" y="1744.145">reservedValue</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="482.5" y="1744.145">to DB for Payer</text>
    <polygon fill="#FFFFE0" filter="url(#f9ypl268pdabb)" points="1285,1792.2109,1540,1792.2109,1550,1818.2109,1540,1845.2109,1285,1845.2109,1275,1818.2109,1285,1792.2109" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="1287" y="1808.2778">UPDATE</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="1343" y="1808.2778">participantPosition</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="1287" y="1823.4106">SET value += sumRESERVED,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="1287" y="1838.5435">reservedValue -= sumTransfersInBatch</text>
    <polygon fill="#A80036" points="1395.5,1867.7422,1405.5,1871.7422,1395.5,1875.7422,1399.5,1871.7422" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="1401.5" y1="1871.7422" y2="1871.7422"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="138.5" y="1866.6763">15</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="160.5" y="1866.6763">Bulk persist transferStateChange for all processedTransfers</text>
    <polygon fill="#FFFFE0" filter="url(#f9ypl268pdabb)" points="1137,1914.7422,1687,1914.7422,1697,1948.7422,1687,1982.7422,1137,1982.7422,1127,1948.7422,1137,1914.7422" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="1139" y="1930.8091">batch INSERT</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1228" y="1930.8091">transferStateChange</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="546" x="1139" y="1945.9419">select for update from transfer table where transferId in ([transferBatch.transferId,...])</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="1139" y="1961.0747">build list of transferStateChanges from transferBatch</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1143" y="1976.2075"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="173.5" y1="2009.4063" y2="2009.4063"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="173.5" x2="173.5" y1="2009.4063" y2="2022.4063"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="132.5" x2="173.5" y1="2022.4063" y2="2022.4063"/>
    <polygon fill="#A80036" points="142.5,2018.4063,132.5,2022.4063,142.5,2026.4063,138.5,2022.4063" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="138.5" y="2004.3403">16</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="762" x="160.5" y="2004.3403">Populate batchParticipantPositionChange from the resultant transferStateChange and the earlier processedTransfer list</text>
    <path d="M136,2035.4063 L136,2120.4063 L636,2120.4063 L636,2045.4063 L626,2035.4063 L136,2035.4063 " fill="#D3D3D3" filter="url(#f9ypl268pdabb)" style="stroke:#A80036;stroke-width:1.0;"/>
    <path d="M626,2035.4063 L626,2045.4063 L636,2045.4063 L626,2035.4063 " fill="#D3D3D3" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="142" y="2052.4731">Effectively:</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="463" x="158" y="2067.606">SET transferStateChangeId = processedTransfer.transferStateChangeId,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="158" y="2082.7388">participantPositionId = preparedTransfer.participantPositionId,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="158" y="2097.8716">value = preparedTransfer.positionValue,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="158" y="2113.0044">reservedValue = preparedTransfer.positionReservedValue</text>
    <polygon fill="#A80036" points="1395.5,2147.2031,1405.5,2151.2031,1395.5,2155.2031,1399.5,2151.2031" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="131.5" x2="1401.5" y1="2151.2031" y2="2151.2031"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="138.5" y="2146.1372">17</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="444" x="160.5" y="2146.1372">Bulk persist the participant position change for all processedTransfers</text>
    <polygon fill="#FFFFE0" filter="url(#f9ypl268pdabb)" points="1268,2194.2031,1557,2194.2031,1567,2205.2031,1557,2217.2031,1268,2217.2031,1258,2205.2031,1268,2194.2031" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="1270" y="2210.27">batch INSERT</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="196" x="1359" y="2210.27">participantPositionChange</text>
    <path d="M20,2229.3359 L84,2229.3359 L84,2236.3359 L74,2246.3359 L20,2246.3359 L20,2229.3359 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/>
    <rect fill="none" height="1276.7031" style="stroke:#000000;stroke-width:2.0;" width="1601.5" x="20" y="2229.3359"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="35" y="2242.4028">alt</text>
    <text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="361" x="99" y="2241.5464">[Calculate &amp; Validate Latest Position Prepare (success)]</text>
    <path d="M131,2251.4688 L131,2624.4688 L401,2624.4688 L401,2261.4688 L391,2251.4688 L131,2251.4688 " fill="#FFFF00" filter="url(#f9ypl268pdabb)" style="stroke:#A80036;stroke-width:1.0;"/>
    <path d="M391,2251.4688 L391,2261.4688 L401,2261.4688 L391,2251.4688 " fill="#FFFF00" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="137" y="2268.5356">Message:</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="137" y="2283.6685">{</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="153" y="2298.8013">id: &lt;transferMessage.transferId&gt;</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="153" y="2313.9341">from: &lt;transferMessage.payerFsp&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="153" y="2329.0669">to: &lt;transferMessage.payeeFsp&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="153" y="2344.1997">type: application/json</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="153" y="2359.3325">content: {</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="169" y="2374.4653">headers: &lt;transferHeaders&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="169" y="2389.5981">payload: &lt;transferMessage&gt;</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="153" y="2404.731">},</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="153" y="2419.8638">metadata: {</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="169" y="2434.9966">event: {</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="185" y="2450.1294">id: &lt;uuid&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="185" y="2465.2622">responseTo: &lt;previous.uuid&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="185" y="2480.395">type: transfer,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="185" y="2495.5278">action: prepare,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="185" y="2510.6606">createdAt: &lt;timestamp&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="185" y="2525.7935">state: {</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="201" y="2540.9263">status: &quot;success&quot;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="201" y="2556.0591">code: 0</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="185" y="2571.1919">}</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="169" y="2586.3247">}</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="153" y="2601.4575">}</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="137" y="2616.5903">}</text>
    <polygon fill="#A80036" points="1524,2665.9219,1534,2669.9219,1524,2673.9219,1528,2669.9219" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="126.5" x2="1530" y1="2669.9219" y2="2669.9219"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="133.5" y="2657.2896">18</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="155.5" y="2649.7231">Publish Notification event</text>
    <text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="155.5" y="2664.856">Error code:</text>
    <text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="241.5" y="2664.856">2003</text>
    <line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="20" x2="1621.5" y1="2708.9219" y2="2708.9219"/>
    <text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="352" x="25" y="2719.1323">[Calculate &amp; Validate Latest Position Prepare (failure)]</text>
    <path d="M131,2727.7266 L131,2752.7266 L263,2752.7266 L263,2737.7266 L253,2727.7266 L131,2727.7266 " fill="#FF0000" filter="url(#f9ypl268pdabb)" style="stroke:#A80036;stroke-width:1.0;"/>
    <path d="M253,2727.7266 L253,2737.7266 L263,2737.7266 L253,2727.7266 " fill="#FF0000" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="137" y="2744.7935">Validation failure!</text>
    <path d="M30,2768.8594 L638,2768.8594 L638,2775.8594 L628,2785.8594 L30,2785.8594 L30,2768.8594 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/>
    <rect fill="none" height="177.9297" style="stroke:#000000;stroke-width:2.0;" width="1471" x="30" y="2768.8594"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="563" x="45" y="2781.9263">Persist Transfer State (with transferState=&apos;ABORTED&apos; on position check fail)</text>
    <polygon fill="#A80036" points="1395.5,2818.2578,1405.5,2822.2578,1395.5,2826.2578,1399.5,2822.2578" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="126.5" x2="1401.5" y1="2822.2578" y2="2822.2578"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="133.5" y="2809.6255">19</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="155.5" y="2802.0591">Request to persist transfer</text>
    <text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="155.5" y="2817.1919">Error code:</text>
    <text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="241.5" y="2817.1919">2003</text>
    <path d="M131,2835.2578 L131,2875.2578 L838,2875.2578 L838,2845.2578 L828,2835.2578 L131,2835.2578 " fill="#D3D3D3" filter="url(#f9ypl268pdabb)" style="stroke:#A80036;stroke-width:1.0;"/>
    <path d="M828,2835.2578 L828,2845.2578 L838,2845.2578 L828,2835.2578 " fill="#D3D3D3" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="137" y="2852.3247">transferStateChange.state = &quot;ABORTED&quot;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="686" x="137" y="2867.4575">transferStateChange.reason = &quot;Net Debit Cap exceeded by this request at this time, please try again later&quot;</text>
    <polygon fill="#FFFFE0" filter="url(#f9ypl268pdabb)" points="1343,2889.5234,1481,2889.5234,1491,2900.5234,1481,2912.5234,1343,2912.5234,1333,2900.5234,1343,2889.5234" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1345" y="2905.5903">transferStateChange</text>
    <polygon fill="#A80036" points="137.5,2934.7891,127.5,2938.7891,137.5,2942.7891,133.5,2938.7891" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="131.5" x2="1411.5" y1="2938.7891" y2="2938.7891"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="143.5" y="2933.7231">20</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="165.5" y="2933.7231">Return success</text>
    <path d="M131,2958.7891 L131,3421.7891 L539,3421.7891 L539,2968.7891 L529,2958.7891 L131,2958.7891 " fill="#FFFF00" filter="url(#f9ypl268pdabb)" style="stroke:#A80036;stroke-width:1.0;"/>
    <path d="M529,2958.7891 L529,2968.7891 L539,2968.7891 L529,2958.7891 " fill="#FFFF00" style="stroke:#A80036;stroke-width:1.0;"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="137" y="2975.856">Message:</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="137" y="2990.9888">{</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="153" y="3006.1216">id: &lt;transferMessage.transferId&gt;</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="153" y="3021.2544">from: &lt;ledgerName&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="153" y="3036.3872">to: &lt;transferMessage.payerFsp&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="153" y="3051.52">type: application/json</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="153" y="3066.6528">content: {</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="169" y="3081.7856">headers: &lt;transferHeaders&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="169" y="3096.9185">payload: {</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="185" y="3112.0513">&quot;errorInformation&quot;: {</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="201" y="3127.1841">&quot;errorCode&quot;: 4001,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="201" y="3142.3169">&quot;errorDescription&quot;: &quot;Payer FSP insufficient liquidity&quot;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="201" y="3157.4497">&quot;extensionList&quot;: &lt;transferMessage.extensionList&gt;</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="169" y="3172.5825">}</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="153" y="3187.7153">},</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="153" y="3202.8481">metadata: {</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="169" y="3217.981">event: {</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="185" y="3233.1138">id: &lt;uuid&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="185" y="3248.2466">responseTo: &lt;previous.uuid&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="185" y="3263.3794">type: notification,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="185" y="3278.5122">action: prepare,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="185" y="3293.645">createdAt: &lt;timestamp&gt;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="185" y="3308.7778">state: {</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="201" y="3323.9106">status: &apos;error&apos;,</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="201" y="3339.0435">code: &lt;errorInformation.errorCode&gt;</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="201" y="3354.1763">description: &lt;errorInformation.errorDescription&gt;</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="185" y="3369.3091">}</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="169" y="3384.4419">}</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="153" y="3399.5747">}</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="137" y="3414.7075">}</text>
    <polygon fill="#A80036" points="1524,3464.0391,1534,3468.0391,1524,3472.0391,1528,3468.0391" style="stroke:#A80036;stroke-width:1.0;"/>
    <line style="stroke:#A80036;stroke-width:1.0;" x1="126.5" x2="1530" y1="3468.0391" y2="3468.0391"/>
    <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="133.5" y="3455.4067">21</text>
    <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="155.5" y="3447.8403">Publish Notification (failure) event for Payer</text>
    <text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="155.5" y="3462.9731">Error code:</text>
    <text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="241.5" y="3462.9731">2003</text>
  </g>
</svg>
